<!doctype html>
<html lang="en">
<head>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Star Cars ‚Äî v48 Upgraded</title>
<style>
:root{
  --bg1:#0b1020;--bg2:#0e1a36;--card:#131a2b;--ink:#e9eef7;--mut:#a3b2cc;
  --pri:#53a8ff;--ok:#2ecc71;--bad:#ff6b6b;--line:#26324a
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;font:14px/1.45 system-ui,Segoe UI,Roboto,Arial;color:var(--ink);
  background:radial-gradient(1200px 800px at 10% -10%,#1a2e5f 0%,rgba(26,46,95,0) 60%),
             radial-gradient(900px 700px at 120% 0%,#0a5ea1 0%,rgba(10,94,161,0) 60%),
             linear-gradient(160deg,var(--bg1),var(--bg2))
}
a{color:var(--pri)}
header{
  display:flex;gap:12px;align-items:center;justify-content:space-between;
  padding:12px 14px;border-bottom:1px solid var(--line);
  background:rgba(10,16,30,.7);backdrop-filter:blur(6px);position:sticky;top:0;z-index:5
}
#logoBox{width:40px;height:40px;border-radius:12px;background:linear-gradient(135deg,#53a8ff,#7a5cff);display:grid;place-items:center;font-weight:900;overflow:hidden}
#logoBox img{width:100%;height:100%;object-fit:contain}
.hdr-actions button{margin-left:6px}
nav{
  display:flex;flex-wrap:wrap;gap:6px;padding:10px 14px;border-bottom:1px solid var(--line);
  background:rgba(10,16,30,.55);backdrop-filter:blur(6px);position:sticky;top:64px;z-index:4
}
nav button{background:#17233a;border:1px solid var(--line);color:var(--ink);padding:8px 10px;border-radius:10px;cursor:pointer}
nav button.active{background:var(--pri);border-color:transparent;color:#001029;font-weight:700}
main{padding:16px;max-width:1200px;margin:auto}
.card{background:rgba(19,26,43,.92);border:1px solid var(--line);border-radius:14px;padding:14px;margin-bottom:14px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
.row{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
.grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.grid3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
.grid4{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
input,select,textarea{background:#0f1628;border:1px solid var(--line);color:var(--ink);padding:8px;border-radius:10px;min-width:120px}
label{display:flex;flex-direction:column;gap:6px;font-size:12px;color:var(--mut)}
textarea{min-height:88px;width:100%}
small,.small{color:var(--mut);font-size:12px}
button{background:#182845;border:1px solid var(--line);color:var(--ink);padding:8px 10px;border-radius:10px;cursor:pointer}
button.primary{background:var(--pri);border-color:#2b7be0;color:#031226}
button.danger{background:#321722;border-color:#5a2a3d;color:#ffc9c9}
.table{width:100%;border-collapse:collapse}
.table th,.table td{border:1px solid var(--line);padding:6px 8px}
.table th{background:#0c1526;text-align:left}
.right{text-align:right}
.badge{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid var(--line);background:#0f1a2d}
footer{padding:30px 0;color:#8ea3c6;text-align:center}
#loginOverlay{position:fixed;inset:0;display:none;place-items:center;background:rgba(3,6,12,.7);z-index:10}
.loginCard{width:360px;max-width:90vw}
kbd{background:#0b1230;border:1px solid #22325e;border-radius:6px;padding:1px 6px}
.stat{font-size:28px;font-weight:800}
.previewStrip{display:flex;gap:6px;flex-wrap:wrap;margin-top:6px}
.previewStrip img{width:56px;height:56px;object-fit:cover;border-radius:8px;border:1px solid var(--line)}

button:disabled {
  opacity: 0.5;
  cursor: not-allowed;
  background: #0a1420 !important;
  border-color: #1a2438 !important;
  color: #6b7a99 !important;
}

button.primary:disabled {
  background: #1a4a7a !important;
  border-color: #1a4a7a !important;
  color: #6b7a99 !important;
}

</style>

</head><script>
(function(){
  if (window.__starcars_bootstrap__) return;
  window.__starcars_bootstrap__ = true;

  // Safe CSV helper (fixed regex + quotes escaping)
  function toCSV(rows, headers){
    const esc = v => {
      const s = (v == null) ? '' : String(v);
      return /[",\n]/.test(s) ? `"${s.replace(/"/g,'""')}"` : s;
    };
    const head = headers || ((rows && rows[0]) ? Object.keys(rows[0]) : []);
    const lines = [head.join(",")];
    for (const r of (rows || [])) lines.push(head.map(h => esc(r && r[h])).join(","));
    return lines.join("\n");
  }

  // Full JSON backup (includes audit + user passwords)
  window.backupJSON = function(){
    try{
      const data = JSON.stringify(window.db || {}, null, 2);
      const a = document.createElement("a");
      a.href = URL.createObjectURL(new Blob([data], {type:"application/json"}));
      a.download = "starcars_backup_" + new Date().toISOString().slice(0,19).replace(/[:T]/g,"-") + ".json";
      a.click();
      if (typeof window.addAudit === "function") window.addAudit("export","backup","","Full JSON backup");
    }catch(e){ alert("Backup failed: " + (e.message||e)); }
  };

// Merge-from-backup with id-based merge for ALL arrays
window.restoreJSONMerge = function () {
  const i = document.createElement('input');
  i.type = 'file';
  i.accept = '.json,application/json';

  i.onchange = () => {
    const f = i.files && i.files[0];
    if (!f) return;

    const fr = new FileReader();
    fr.onload = () => {
      try {
        const incoming = JSON.parse(fr.result || '{}');
        const db = (window.db = window.db || {});

        for (const k of Object.keys(incoming)) {
          const val = incoming[k];

          if (k === 'audit') {
            // Replace audit log
            db.audit = Array.isArray(val) ? val.slice() : (db.audit || []);
            continue;
          }

          if (Array.isArray(val)) {
            // üîÅ Same id-merge logic as Gist pull ‚Äì works for:
            // vehicles, vehicleExpenses, showroomExpenses, sales, credits,
            // partners (directors), investors, users, todo, etc.
            const localArr = Array.isArray(db[k]) ? db[k] : [];
            const byId = Object.create(null);
            const noId = [];

            for (const item of localArr) {
              if (item && item.id) {
                byId[item.id] = item;
              } else {
                noId.push(item);
              }
            }

            for (const item of val) {
              if (item && item.id) {
                byId[item.id] = item; // backup wins
              } else {
                noId.push(item);
              }
            }

            db[k] = [...noId, ...Object.values(byId)];

            // Fix users & directors special rules
            if (k === 'users' && typeof window.normalizePerms === 'function') {
              db.users = (db.users || []).map(u => {
                u.perms = window.normalizePerms(u.perms);
                return u;
              });
            }

            if (k === 'partners') {
              db.partners = (db.partners || []).filter((p, i, arr) =>
                arr.findIndex(pp =>
                  String(pp.name || '').trim().toLowerCase() ===
                  String(p.name || '').trim().toLowerCase()
                ) === i
              );
            }

            continue;
          }

          if (val && typeof val === 'object') {
            db[k] = Object.assign({}, db[k] || {}, val);
          } else {
            db[k] = val;
          }
        }

        if (typeof window.saveDB === 'function') window.saveDB();
        try {
          if (typeof window.renderAlertBell === 'function') window.renderAlertBell();
        } catch (_) {}
        if (typeof window.addAudit === 'function') {
          window.addAudit('import', 'backup', '', 'Merged JSON backup (id-merge)');
        }
        alert('Merged from backup');
        markPullUsed();
        applyPullLockUI && applyPullLockUI();
        if (typeof window.render === 'function') window.render();
      } catch (e) {
        alert('Bad JSON: ' + (e.message || e));
      }
    };
    fr.readAsText(f);
  };

  i.click();
};

  // Replace-from-backup
  window.restoreJSONReplace = function(){
    const i = document.createElement("input"); i.type = "file"; i.accept = ".json,application/json";
    i.onchange = () => {
      const f = i.files && i.files[0]; if(!f) return;
      const fr = new FileReader();
      fr.onload = () => {
        try{
          const incoming = JSON.parse(fr.result || "{}");
          window.db = (incoming && typeof incoming === "object") ? incoming : {};
          window.db.audit = window.db.audit || [];
          if (Array.isArray(window.db.users) && typeof window.normalizePerms === "function"){
            window.db.users = window.db.users.map(u => { u.perms = window.normalizePerms(u.perms); return u; });
          }
          window.saveDB && window.saveDB();
          try{ window.renderAlertBell && window.renderAlertBell(); }catch(_){}
          if (typeof window.addAudit === "function") window.addAudit("import","backup","","Replaced from JSON backup");
          alert("Replaced from backup");
          markPullUsed();
          applyPullLockUI && applyPullLockUI();
          window.render && window.render();
        }catch(e){ alert("Bad JSON: " + (e.message||e)); }
      };
      fr.readAsText(f);
    };
    i.click();
  };

  // Export everything as a single CSV (sectioned)
  window.exportAllCSV = function(){
    const db = window.db || {};
    const parts = [];
    parts.push("=== Vehicles ===");         parts.push(toCSV(db.vehicles||[]));
    parts.push(""); parts.push("=== Sales ==="); parts.push(toCSV(db.sales||[]));
    parts.push(""); parts.push("=== ShowroomExpenses ==="); parts.push(toCSV(db.showroomExpenses||[]));
    parts.push(""); parts.push("=== Investors ==="); parts.push(toCSV(db.investors||[]));
    parts.push(""); parts.push("=== Audit ==="); parts.push(toCSV(db.audit||[]));
    const a = document.createElement("a");
    a.href = URL.createObjectURL(new Blob([parts.join("\n")], {type:"text/csv"}));
    a.download = "starcars_export_all_" + new Date().toISOString().slice(0,19).replace(/[:T]/g,"-") + ".csv";
    a.click();
    if (typeof window.addAudit === "function") window.addAudit("export","csv","","Export all CSV (sections)");
  };
})();
</script>

<body>
<header>
  <div style="display:flex;gap:10px;align-items:center">
    <div id="logoBox">SC</div>
    <div>
      <div style="font-weight:900">Star Cars London Ltd</div>
      <div class="small">Dealer Backoffice </div>
    </div>
  </div>
  <div class="hdr-actions">
    <span id="who" class="small"></span>
    <span id="backupInfo" class="small" style="margin-left:10px;margin-right:10px;"></span>

    <!-- üîç Global search -->
    <input id="global_search"
           placeholder="Search reg / name / invoice / phone"
           onkeydown="if(event.key==='Enter'){globalSearch();}"
           style="max-width:260px;margin-right:6px;">
    <button onclick="globalSearch()">Search</button>

    <button onclick="switchUser()">Switch User</button>
    <button onclick="changeMyPass()">Change Password</button>
    <button onclick="logout()">Logout</button>
    <button onclick="backupJSON()">Backup</button>
    <button onclick="restoreJSONMerge()">Restore (merge)</button>
    <button onclick="restoreJSONReplace()">Restore (replace)</button>
    <button onclick="exportAllCSV()">Export CSVs</button>
  </div>
</header>
<nav id="nav"></nav>
<main id="app"></main>
<footer>¬© Star Cars London Ltd</footer>

<div id="loginOverlay">
  <div class="card loginCard">
    <h2>Login</h2>
    <div class="row">
      <input id="li_user" placeholder="username">
      <input id="li_pass" placeholder="password" type="password">
      <button class="primary" onclick="doLogin()">Login</button>
    </div>
  </div>
</div>

<script>
/* ========= Core utils ========= */
const DBKEY='starcars_db_v48u'; const GHTOKENKEY='starcars_github_token';
function loadDB(){ try{ return JSON.parse(localStorage.getItem(DBKEY)||'{}'); }catch(e){ return {}; } }
function saveDB(){
  try {
    // Normal save
    localStorage.setItem(DBKEY, JSON.stringify(db));
  } catch (e) {
    console.error('saveDB quota error:', e);

    // If localStorage is full, try to free the old snapshot key first
    try {
      localStorage.removeItem('starcars_last_snapshot');
    } catch (_) {}

    try {
      // Make a slim copy of DB for storage
      const slim = JSON.parse(JSON.stringify(db || {}));

      // Trim very large audit log to keep newest 1000 entries
      if (Array.isArray(slim.audit) && slim.audit.length > 1000) {
        slim.audit = slim.audit.slice(0, 1000);
      }

      // (Optional) you can also trim deleted map if it gets huge
      if (slim.deleted && typeof slim.deleted === 'object') {
        Object.keys(slim.deleted).forEach(section => {
          const entries = Object.entries(slim.deleted[section] || {});
          if (entries.length > 1000) {
            // keep latest 1000 deletions
            entries.sort((a,b)=>String(b[1]).localeCompare(String(a[1])));
            const trimmed = entries.slice(0,1000);
            const newMap = {};
            trimmed.forEach(([id, ts]) => newMap[id] = ts);
            slim.deleted[section] = newMap;
          }
        });
      }

      localStorage.setItem(DBKEY, JSON.stringify(slim));
      alert('Local storage was nearly full.\nOld history was trimmed but your main data was saved.');
    } catch (e2) {
      alert('Save failed due to browser storage limit:\n' + (e2.message || e2));
    }
  }
}
function uid(){ return Math.random().toString(36).slice(2)+Date.now().toString(36); }
function fmtMoney(n){ n=Number(n||0); const s=n<0?'-':''; n=Math.abs(n); return s+'¬£'+n.toFixed(2); }
function ddmmyyyy(d){
  if(!d) return '';
  const t=(d||'').split('T')[0]||d;
  const a=t.split('-'); // yyyy-mm-dd
  return a.length===3 ? (a[2]+'-'+a[1]+'-'+a[0]) : d; // dd-mm-yyyy
}
function ymStr(d){ return (d||'').slice(0,7); } // yyyy-mm

function lastDayOfMonth(ym) {
  // ym = "YYYY-MM"
  const [y, m] = ym.split('-').map(Number);
  // Day 0 of next month = last day of current month
  const d = new Date(y, m, 0);
  return d.toISOString().slice(0, 10); // YYYY-MM-DD
}

// ===== Option 8 helpers =====
function findVehicleByReg(reg){
  reg = String(reg||'').trim().toUpperCase();
  if(!reg) return null;
  return (db.vehicles||[]).find(v => String(v.reg||'').trim().toUpperCase() === reg) || null;
}

function vehicleTotalCostByVehicleId(vehicleId){
  const v = (db.vehicles||[]).find(x=>x.id===vehicleId) || {};
  const purchase = Number(v.purchase||0);
  const exp = (db.vehicleExpenses||[])
    .filter(e => e.vehicleId === vehicleId)
    .reduce((t,e)=> t + Number(e.amount||0), 0);
  return { purchase, exp, total: purchase + exp };
}

function mcId(ym, type, a, b, c) {
  // stable, deterministic IDs for MonthClose postings
  const safe = (x) => String(x || '').trim().toLowerCase().replace(/[^a-z0-9]+/g,'_').slice(0,60);
  return `mc_${safe(ym)}_${safe(type)}_${safe(a)}_${safe(b)}_${safe(c)}`;
}

function _parseDateSafe(s){
  if(!s) return null;
  const d = new Date(s);
  return isNaN(d) ? null : d;
}
function daysToDate(dateStr){
  const d = _parseDateSafe(dateStr);
  if(!d) return null;
  const now = new Date();
  return Math.ceil((d - now) / (1000*60*60*24));
}

function getMotExpiry(v){
  // support different keys your DB may have
  return v.motExpiry || v.mot || v.motDue || v.mot_expiry || '';
}

function motBucketsFromVehicles(list){
  let expired=0, d30=0, d60=0, d90=0, noMot=0;
  (list||[]).forEach(v=>{
    const exp = getMotExpiry(v);
    const dt = daysToDate(exp);
    if(dt===null){ noMot++; return; }
    if(dt < 0) expired++;
    else if(dt <= 30) d30++;
    else if(dt <= 60) d60++;
    else if(dt <= 90) d90++;
  });
  return {expired,d30,d60,d90,noMot};
}

function filterByMotDays(list, maxDays){
  // maxDays = -1 means expired only
  return (list||[]).filter(v=>{
    const exp = getMotExpiry(v);
    const dt = daysToDate(exp);
    if(dt===null) return false;
    if(maxDays === -1) return dt < 0;
    return dt >= 0 && dt <= maxDays;
  });
}

function openPrintable(html){
  try{
    const blob=new Blob([html],{type:'text/html'});
    const url=URL.createObjectURL(blob);
    const w=window.open(url,'_blank','noopener');
    if(w){ setTimeout(()=>URL.revokeObjectURL(url),10000); return true; }
  }catch(e){}
  const iframe=document.createElement('iframe');
  iframe.style.position='fixed';iframe.style.right='0';iframe.style.bottom='0';iframe.style.width='0';iframe.style.height='0';iframe.style.border='0';
  document.body.appendChild(iframe);
  iframe.addEventListener('load',()=>{ try{ iframe.contentWindow.focus(); setTimeout(()=>iframe.contentWindow.print(),50);}catch(e){} });
  iframe.srcdoc=html; return false;
}

// Export Vehicles as CSV (respects MOT filter)
function exportVehiclesCSV() {
    const vehicles = db.vehicles || [];
    
    // Apply the same filters as the current view
    const searchTerm   = (document.getElementById('veh_search')?.value || '').toLowerCase().trim();
    const instockOnly  = document.getElementById('veh_instock')?.checked;
    const soldOnly     = document.getElementById('veh_soldonly')?.checked;
    const investorOnly = document.getElementById('veh_investoronly')?.checked;
    const pxOnly       = document.getElementById('veh_pxonly')?.checked;
    const motFilter    = document.getElementById('veh_motFilter')?.value || '';
    
    let filteredVehicles = vehicles.filter(v => {
        // Stock status
        if (instockOnly && v.status === 'sold') return false;
        if (soldOnly    && v.status !== 'sold') return false;
        
        // Investor stock only
        if (investorOnly && v.ownerType !== 'investor') return false;
        
        // Part-ex only
        if (pxOnly && v.supplier !== 'PART-EX') return false;
        
        // Search (reg / make / model / supplier)
        if (searchTerm) {
            const hay = (
                (v.reg    || '') + ' ' +
                (v.make   || '') + ' ' +
                (v.model  || '') + ' ' +
                (v.supplier || '')
            ).toLowerCase();
            if (!hay.includes(searchTerm)) return false;
        }
        
        // MOT expiry filter ‚Äì SAME logic as viewVehicles()
        if (motFilter) {
            const motDate = v.motExpiry || v.lastMotExpiry || '';
            if (!motDate) return false;
            
            const expiry = new Date(motDate);
            const today  = new Date();
            today.setHours(0, 0, 0, 0);
            expiry.setHours(0, 0, 0, 0);
            const diffMs   = expiry - today;
            const diffDays = Math.ceil(diffMs / (1000 * 60 * 60 * 24));
            
            switch (motFilter) {
                case 'expired':
                    if (diffDays >= 0) return false;   // only truly expired
                    break;
                case '30':
                    if (diffDays <= 0 || diffDays > 30) return false;
                    break;
                case '60':
                    if (diffDays <= 0 || diffDays > 60) return false;
                    break;
                case '90':
                    if (diffDays <= 0 || diffDays > 90) return false;
                    break;
                case 'valid':
                    if (diffDays < 0) return false;    // skip expired
                    break;
            }
        }
        
        return true;
    });
    
    // CSV headers
    const headers = [
        'REG', 'Make', 'Model', 'Colour', 'Fuel', 'Mileage', 
        'First Registration', 'Purchase Date', 'Purchase Price', 
        'Owner Type', 'Investor', 'Status', 'Supplier', 'Supplier Note',
        'VIN', 'Created At', 'Last MOT Date', 'Last MOT Expiry', 'Last MOT Mileage'
    ];
    
    // Rows
    const rows = filteredVehicles.map(v => [
        v.reg || '',
        v.make || '',
        v.model || '',
        v.colour || '',
        v.fuel || '',
        v.mileage || 0,
        ddmmyyyy(v.firstReg || ''),
        ddmmyyyy(v.purchaseDate || ''),
        Number(v.purchase || 0).toFixed(2),
        v.ownerType || 'owned',
        v.investor || '',
        v.status || '',
        v.supplier || '',
        v.supplierNote || '',
        v.vin || '',
        v.createdAt || '',
        v.lastMotDate || '',
        v.lastMotExpiry || '',
        v.lastMotMileage || ''
    ]);
    
    const csvContent = [
        headers.join(','),
        ...rows.map(row => row.map(cell => 
            typeof cell === 'string' && (cell.includes(',') || cell.includes('"') || cell.includes('\n'))
                ? `"${cell.replace(/"/g,'""')}"`
                : cell
        ).join(','))
    ].join('\n');
    
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    const url  = URL.createObjectURL(blob);
    link.href = url;
    link.download = `vehicles_export_${new Date().toISOString().slice(0, 10)}.csv`;
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    if (typeof addAudit === 'function') {
        addAudit('export', 'vehicles', '', `Exported ${filteredVehicles.length} vehicles to CSV`);
    }
}

// Export Sales as CSV
function exportSalesCSV() {
  const sales = db.sales || [];

  const headers = [
    'Date',
    'Invoice #',
    'Reg',
    'Make',
    'Model',
    'Customer',
    'Phone',
    'Email',
    'Sale Price',
    'Lead Source',
    'Finance Company',
    'Warranty Type',
    'Warranty Months',
    'Finance Payout Paid',
    'Finance Payout Date',
    'Finance Payout Amount'
  ];

  const lines = [];
  lines.push(headers.join(','));

  sales.forEach(s => {
    const v = (db.vehicles || []).find(v => v.id === s.vehicleId) || {};

    const row = [
      ddmmyyyy(s.date),
      s.invNo || '',
      v.reg || '',
      v.make || '',
      v.model || '',
      s.buyer || '',
      s.phone || '',
      s.email || '',
      Number(s.salePrice || 0).toFixed(2),
      s.leadSource || '',
      s.financeCompany || '',
      s.warrantyType || '',
      s.warrantyMonths || 0,
      (s.financePayoutPaid ? 'yes' : 'no'),
      s.financePayoutDate || '',
      Number(s.financePayoutAmount || 0).toFixed(2)
    ].map(cell => {
      const str = String(cell == null ? '' : cell);
      if (str.includes(',') || str.includes('"') || str.includes('\n')) {
        return '"' + str.replace(/"/g, '""') + '"';
      }
      return str;
    });

    lines.push(row.join(','));
  });

  const csv = lines.join('\n');
  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  const url  = URL.createObjectURL(blob);
  const a    = document.createElement('a');

  a.href = url;
  a.download = 'sales_export_' + new Date().toISOString().slice(0,10) + '.csv';
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);

  setTimeout(() => URL.revokeObjectURL(url), 10000);

  if (typeof addAudit === 'function') {
    addAudit('export', 'sales', '', `Exported ${sales.length} sales to CSV`);
  }
}

// DVLA Response Validation Helper
function validateDVLAResponse(data) {
  if (!data || typeof data !== 'object') {
    return { isValid: false, error: 'Invalid response format' };
  }
  
  // Check if we have at least some vehicle data
  const hasData = data.make || data.colour || data.fuel || data.vin || 
                 (data.raw && (data.raw.make || data.raw.colour || data.raw.fuelType));
  
  return { 
    isValid: !!hasData, 
    fieldsFound: {
      make: !!data.make,
      model: !!data.model,
      colour: !!data.colour,
      fuel: !!data.fuel,
      vin: !!data.vin
    }
  };
}

/* ========= DB init ========= */
let db = loadDB();
window.db = db;
db.deleted = db.deleted || {};
if (!db.lastPush) db.lastPush = {};
db.company = db.company || {};
let pushEnabled = false;
const DEFAULT_TABS=['Dashboard','Vehicles','Expenses','Showroom','Sales','Sold','Credit','Purchase Invoice','Customer Complaints','Directors','Investors','Reports','Alerts','To-Do','Users','Settings'];

// Show backup status in header
try { renderBackupInfo(); } catch(e) {}

// Add to the core utils section
let changeTracker = {
  lastSnapshot: null,
  changes: {},
  init: function() {
    // Start with no persisted snapshot to save space in localStorage
    this.lastSnapshot = null;
    this.changes = {};

    // Clean up old big snapshot key from previous versions (one-time)
    try {
      localStorage.removeItem('starcars_last_snapshot');
    } catch(e) {
      console.warn('Could not remove old snapshot key:', e);
    }
  },
  
  saveSnapshot: function() {
    // Keep snapshot only in memory (not in localStorage) to avoid quota issues
    this.lastSnapshot = JSON.parse(JSON.stringify(window.db || {}));
  },
  
  trackChange: function(section, id, operation, data) {
    // Track a change (add, update, delete)
    if (!this.changes[section]) {
      this.changes[section] = [];
    }
    
    this.changes[section].push({
      id: id,
      operation: operation,
      data: data,
      timestamp: new Date().toISOString(),
      user: session ? session.username : 'unknown'
    });
  },
  
  getChanges: function() {
    return this.changes;
  },
  
  clearChanges: function() {
    this.changes = {};
  },
  
  // Compare current state with last snapshot to find all changes
  detectAllChanges: function() {
    if (!this.lastSnapshot) {
      return null; // No baseline to compare against
    }
    
    const current = window.db || {};
    const previous = this.lastSnapshot;
    const changes = {};
    
    // Track array changes
    const sections = ['vehicles', 'sales', 'vehicleExpenses', 'showroomExpenses', 
                     'credits', 'purchaseInvoices', 'complaints', 'investors', 
                     'partners', 'todo', 'users', 'audit'];
    
    sections.forEach(section => {
      const currentArr = current[section] || [];
      const previousArr = previous[section] || [];
      
      // Create maps for easy comparison
      const currentMap = new Map(currentArr.map(item => [item.id, item]));
      const previousMap = new Map(previousArr.map(item => [item.id, item]));
      
      const sectionChanges = [];
      
      // Find new items
      currentArr.forEach(item => {
        if (!previousMap.has(item.id)) {
          sectionChanges.push({
            id: item.id,
            operation: 'add',
            data: item
          });
        }
      });
      
      // Find modified items
      currentArr.forEach(item => {
        if (previousMap.has(item.id)) {
          const prevItem = previousMap.get(item.id);
          if (JSON.stringify(item) !== JSON.stringify(prevItem)) {
            sectionChanges.push({
              id: item.id,
              operation: 'update',
              data: item
            });
          }
        }
      });
      
      // Find deleted items (only if we're tracking deletions)
      if (db.deleted && db.deleted[section]) {
        Object.keys(db.deleted[section] || {}).forEach(id => {
          if (previousMap.has(id) && !currentMap.has(id)) {
            sectionChanges.push({
              id: id,
              operation: 'delete',
              data: { id: id, deletedAt: db.deleted[section][id] }
            });
          }
        });
      }
      
      if (sectionChanges.length > 0) {
        changes[section] = sectionChanges;
      }
    });
    
    // Track object changes (company settings)
    if (JSON.stringify(current.company || {}) !== JSON.stringify(previous.company || {})) {
      changes.company = {
        operation: 'update',
        data: current.company || {}
      };
    }
    
    return changes;
  }
};

// Initialize change tracker
changeTracker.init();

// Save initial snapshot if none exists
if (!changeTracker.lastSnapshot) {
  changeTracker.saveSnapshot();
}

function defaultPerms(){ const tabs={}; DEFAULT_TABS.forEach(t=>tabs[t]=true); return {tabs,actions:{view:true,add:true,edit:true,del:true},profit:true,settings:true}; }
function normalizePerms(perms){
  const base=defaultPerms(); const p=Object.assign({},base,perms||{});
  p.tabs=Object.assign({},base.tabs,(perms&&perms.tabs)||{});
  p.actions=Object.assign({},base.actions,(perms&&perms.actions)||{});
  if(typeof p.profit!=='boolean') p.profit=!!(perms&&perms.profit);
  if(typeof p.settings!=='boolean') p.settings=!!(perms&&perms.settings);
  DEFAULT_TABS.forEach(t=>{ if(typeof p.tabs[t]!=='boolean') p.tabs[t]=true; });
  return p;
}

db.users=db.users||[
  {id:'u1',username:'admin',password:'admin',role:'admin',perms:defaultPerms()},
  {id:'u2',username:'staff',password:'1234',role:'user',perms:(()=>{const p=defaultPerms();p.profit=false;p.settings=false;p.tabs['Directors']=false;p.tabs['Investors']=false;p.tabs['Users']=false;p.tabs['Settings']=false;return p;})()}
];
db.users=(db.users||[]).map(u=>{u.perms=normalizePerms(u.perms);return u;});
db.company=db.company||{
  name:'Star Cars London Ltd',address:'Park Farm, Sewardstone Road, London E4 7RG',phone:'',email:'',
  vatNumber:'',companyNumber:'',terms:'All vehicles supplied under CRA 2015. See full T&Cs.',
  logo:'',dvlaProxy:'',dvlaKey:'',dvsaKey:'',dvsaProxy:'',gistId:'',
  openingBank:0,openingCash:0,
  invoiceFontPx:12, logoMaxW:140, logoMaxH:80
};
db.vehicles=db.vehicles||[]; db.vehicleExpenses=db.vehicleExpenses||[]; db.showroomExpenses=db.showroomExpenses||[]; db.sales=db.sales||[]; db.credits=db.credits||[]; db.complaints = db.complaints || [];
db.partners=db.partners||[{id:'p1',name:'Director A',balance:0,tx:[]},{id:'p2',name:'Director B',balance:0,tx:[]}];
// Ensure partners are unique by name (fix duplicate directors from backup)
db.partners = (db.partners||[]).filter((p,i,arr)=> arr.findIndex(q=>String(q.name||'').trim().toLowerCase()===String(p.name||'').trim().toLowerCase())===i);

db.investors=db.investors||[]; db.audit=db.audit||[]; db.todo=db.todo||[];
db.purchaseInvoices = db.purchaseInvoices || []; // Add purchase invoices array

/* ========= Session / Header / Logo ========= */
let session=JSON.parse(sessionStorage.getItem('starcars_sess')||'null'); if(!session){ showLogin(true); }
function showLogin(show){ document.getElementById('loginOverlay').style.display=show?'grid':'none'; }

function checkPullStatusOnLogin(){
  // If you already use lastPulledAt logic, keep it consistent
  try{
    const t = Number(sessionStorage.getItem('starcars_last_pulled_at') || 0);
    if(!t){
      // lock push until first pull
      if (typeof disablePushButton === "function") disablePushButton();
    } else {
      if (typeof enablePushButton === "function") enablePushButton();
    }
  }catch(e){
    // never block login if something goes wrong
    console.warn("checkPullStatusOnLogin error:", e);
  }
}

function doLogin(){
  const u=document.getElementById('li_user').value.trim(); const p=document.getElementById('li_pass').value;
  const user=(db.users||[]).find(x=>x.username===u&&x.password===p);
  if(!user){alert('Wrong login');return;}
  if ((db.company && db.company.requireGist === true) && !db.company.gistBootstrapped) {
    alert('Please go to Settings ‚Üí Integrations and Pull Users from your Gist first.');
    return;
  }
  if (user.role==='admin' && (db.company && db.company.disableAdminLogin === true)) {
    alert('Admin login is disabled on this build.');
    return;
  }
  session={username:user.username,role:user.role}; sessionStorage.setItem('starcars_sess',JSON.stringify(session));
  showLogin(false); initHeader(); render(); checkPullStatusOnLogin();
  
  // Disable push button on login
  disablePushButton();
}

function logout(){sessionStorage.removeItem('starcars_sess'); sessionStorage.removeItem('starcars_pull_used'); session=null; showLogin(true); initHeader();}
function switchUser(){ logout(); }
function initHeader(){ const el=document.getElementById('who'); el.textContent=session?('Logged in: '+session.username+' ('+session.role+')'):'Not logged in'; refreshLogoBox(); }

function disablePushButton() {
  pushEnabled = false;
  sessionStorage.setItem('starcars_push_enabled', 'false');
  
  // Disable push button in settings
  const pushBtn = document.querySelector('#c_push');
  if (pushBtn) {
    pushBtn.disabled = true;
    pushBtn.style.opacity = '0.5';
    pushBtn.style.cursor = 'not-allowed';
  }
}

function enablePushButton() {
  pushEnabled = true;
  sessionStorage.setItem('starcars_push_enabled', 'true');
  
  // Enable push button in settings
  const pushBtn = document.querySelector('#c_push');
  if (pushBtn) {
    pushBtn.disabled = false;
    pushBtn.style.opacity = '1';
    pushBtn.style.cursor = 'pointer';
  }
}

function isPullUsed(){
  return sessionStorage.getItem('starcars_pull_used') === 'true';
}

function markPullUsed() {
  sessionStorage.setItem('starcars_pull_used', 'true');
}

function applyPullLockUI(){
  // If pull is done, unlock everything
  if (isPullUsed()){
    document.querySelectorAll('[data-pull-lock="1"]').forEach(el=>{
      el.disabled = false;
      el.removeAttribute('data-pull-lock');
      el.removeAttribute('title');
    });
    const note = document.getElementById('pullLockNote');
    if (note) note.remove();
    return;
  }

  // Not pulled yet -> lock app inputs/buttons (but NOT header/nav)
  const app = document.getElementById('app');
  if (!app) return;

  // Show a note at the top of the current tab
  if (!document.getElementById('pullLockNote')){
    const note = document.createElement('div');
    note.id = 'pullLockNote';
    note.className = 'card';
    note.style.borderColor = '#ff6b6b';
    note.innerHTML = `
      <div style="font-weight:800">‚ö†Ô∏è Editing locked</div>
      <div class="small" style="margin-top:4px">
        You must use <b>Pull</b> first on this device to avoid overwriting other PCs.
        Go to <b>Settings ‚Üí Pull (Gist ‚Üí App)</b>.
      </div>
      <div class="row" style="margin-top:10px">
        <button class="primary" id="goSettingsPull">Go to Settings</button>
      </div>
    `;
    app.prepend(note);
    note.querySelector('#goSettingsPull').onclick = () => setTab('Settings');
  }

  // Allowlist (things we still want enabled inside Settings)
  const allowIds = new Set([
    'c_pull',        // Pull (Normal)
    'syncPullHard',  // Pull (Hard)
    'c_isave',       // Save Integrations
    'c_gistId', 'c_ghToken',
    'c_autoSync', 'c_autoSyncSec'
  ]);

  // Disable everything editable inside #app except allowlist
  app.querySelectorAll('button, input, select, textarea').forEach(el=>{
    if (allowIds.has(el.id)) return;

    // If element is inside Settings tab, still lock it unless allowlisted
    el.disabled = true;
    el.setAttribute('data-pull-lock', '1');
    el.title = 'Locked until you Pull from Gist';
  });
}

function refreshLogoBox(){ const lb=document.getElementById('logoBox'); const logo=(db.company.logo||'').trim(); if(logo){ lb.innerHTML='<img alt="logo" src="'+logo+'">'; } else { lb.textContent='SC'; } }
initHeader();

function changeMyPass(){
  if(!session){ return alert('Not logged in'); }
  const u = (db.users||[]).find(x=>x.username===session.username);
  if(!u){ return alert('User not found'); }
  const p1 = prompt('Enter new password for '+u.username+':'); if(p1===null) return;
  if(!p1.trim()){ return alert('Password cannot be empty'); }
  const p2 = prompt('Confirm new password:'); if(p2===null) return;
  if(p1!==p2){ return alert('Passwords do not match'); }
  u.password = p1; saveDB(); try{renderAlertBell();}catch(e){}; addAudit('update','userPass',u.id,'Self-change for '+u.username); alert('Password updated.');
}
function currentUser(){ return (db.users||[]).find(x=>session&&x.username===session.username); }
function canTab(tab){ const u=currentUser(); return !!(u&&u.perms&&u.perms.tabs&&u.perms.tabs[tab]); }
function canProfit(){ const u=currentUser(); return !!(u&&u.perms&&u.perms.profit); }
function canSettings(){ const u=currentUser(); return !!(u&&u.perms&&u.perms.settings); }
function canAction(act){ const u=currentUser(); return !!(u&&u.perms&&u.perms.actions&&u.perms.actions[act]); }

function addAudit(action, entity, entityId, details){ 
  try{ 
    db.audit.unshift({
      id:uid(),
      ts:new Date().toISOString(),
      user:session?session.username:'(anon)',
      action,
      entity,
      entityId,
      details:details||''
    }); 
    
    if(db.audit.length>5000) db.audit.length=5000; 
    
    // Track the change
    changeTracker.trackChange(entity, entityId, action, details);
    
    saveDB(); 
    try{renderAlertBell();}catch(e){}; 
  }catch(e){}
}

function renderBackupInfo(){
   try {
    const el = document.getElementById('backupInfo');
    if (!el || !window.db) return;

    db.company = db.company || {};
    const last = db.company.lastBackupDate;

    if (!last) {
      el.textContent = 'No backup recorded';
      el.style.color = '#d9534f'; // red
       return;
    }

    const today = new Date().toISOString().slice(0,10);
    if (last === today) {
      el.textContent = 'Last backup: today';
      el.style.color = ''; // normal
    } else {
      el.textContent = 'Last backup: ' + ddmmyyyy(last);
      el.style.color = '#f0ad4e'; // amber
    }
  } catch(e) {
    // silent fail ‚Äì nothing critical
  }
}

/* ========= Backup / Restore / CSV ========= */
function backupJSON(){
  try{
    const data = JSON.stringify(db, null, 2); // full DB including db.audit and user passwords

    // create blob + object URL
    const blob = new Blob([data], {type:'application/json'});
    const url = URL.createObjectURL(blob);

    // create the anchor element correctly (was missing: `a` was not declared)
    const a = document.createElement('a');
    a.href = url;
    a.download = 'starcars_backup_' + new Date().toISOString().slice(0,19).replace(/[:T]/g,'-') + '.json';
    a.style.display = 'none';
    document.body.appendChild(a);
    a.click();
    // cleanup
    document.body.removeChild(a);
    URL.revokeObjectURL(url);

    // Record backup timestamp in DB
    db.company = db.company || {};
    const nowIso = new Date().toISOString();
    db.company.lastBackupTs = nowIso;
    db.company.lastBackupDate = nowIso.slice(0,10);
    saveDB();

    if (typeof addAudit === 'function') {
      addAudit('export','backup','','Full JSON backup');
    }

    if (typeof renderBackupInfo === 'function') {
      renderBackupInfo();
    }
  }catch(e){
    alert('Backup failed: '+(e.message||e));
  }
}

// Merge-from-backup with id-based merge for ALL arrays
function restoreJSONMerge() {
  const i = document.createElement('input');
  i.type = 'file';
  i.accept = '.json,application/json';

  i.onchange = () => {
    const f = i.files && i.files[0];
    if (!f) return;

    const fr = new FileReader();
    fr.onload = () => {
      try {
        const incoming = JSON.parse(fr.result || '{}');
        if (!incoming || typeof incoming !== 'object') {
          throw new Error('Backup file has no data');
        }

        // Make sure db exists
        db = db || {};

        // If backup contains deleted map, merge it first
        if (incoming.deleted && typeof mergeDeletedMaps === 'function') {
          db.deleted = mergeDeletedMaps(db.deleted, incoming.deleted);
        } else {
          db.deleted = db.deleted || {};
        }

        Object.keys(incoming).forEach(k => {
          const val = incoming[k];

          if (k === 'audit') {
            // Replace audit log with backup audit
            db.audit = Array.isArray(val) ? val.slice() : (db.audit || []);
            return;
          }

          if (k === 'deleted') {
            // Already merged above
            return;
          }

          if (Array.isArray(val)) {
            // üîÅ Merge ANY array by id: vehicles, sales, expenses, showroomExpenses,
            // vehicleExpenses, investors, credits, complaints, todo, users, partners, etc.
            const localArr = Array.isArray(db[k]) ? db[k] : [];
            const byId = Object.create(null);
            const noId = [];

            // Start from local (current browser) data
            for (const item of localArr) {
              if (item && item.id) {
                byId[item.id] = item;
              } else {
                noId.push(item);
              }
            }

            // Apply incoming backup: overwrite same-id items, add new ones
            for (const item of val) {
              if (item && item.id) {
                byId[item.id] = item; // backup wins on conflicts
              } else {
                noId.push(item);
              }
            }

            db[k] = [...noId, ...Object.values(byId)];

            // Users: normalise permissions
            if (k === 'users' && typeof normalizePerms === 'function') {
              db.users = (db.users || []).map(u => {
                u.perms = normalizePerms(u.perms);
                return u;
              });
            }

            // Directors: make sure partners are unique by name
            if (k === 'partners') {
              db.partners = (db.partners || []).filter((p, i, arr) =>
                arr.findIndex(pp =>
                  String(pp.name || '').trim().toLowerCase() ===
                  String(p.name || '').trim().toLowerCase()
                ) === i
              );
            }

            return;
          }

          if (val && typeof val === 'object') {
            // Shallow-merge plain objects (company, settings, etc.)
            db[k] = Object.assign({}, db[k] || {}, val);
          } else {
            // Simple values (numbers / strings / booleans)
            db[k] = val;
          }
        });

        // Safety defaults
        db.company           = db.company           || {};
        db.vehicles          = db.vehicles          || [];
        db.sales             = db.sales             || [];
        db.expenses          = db.expenses          || [];
        db.showroomExpenses  = db.showroomExpenses  || [];
        db.vehicleExpenses   = db.vehicleExpenses   || [];
        db.credits           = db.credits           || [];
        db.complaints        = db.complaints        || [];
        db.investors         = db.investors         || [];
        db.partners          = db.partners          || [];
        db.todo              = db.todo              || [];
        db.purchaseInvoices  = db.purchaseInvoices  || [];
        db.audit             = db.audit             || [];
        db.deleted           = db.deleted           || {};

        // Apply deletions (if map exists)
        if (typeof applyAllDeletions === 'function') {
          applyAllDeletions();
        }

        ensureIdsEverywhere();
        dedupeVehiclesByReg();
        relinkVehicleRefsByReg();
        dedupeSalesById();
        dedupeAllExpensesAndCredits();

        saveDB();
        try { renderAlertBell(); } catch (_) {}
        if (typeof addAudit === 'function') {
          addAudit('import', 'backup', '', 'Merged JSON backup (id-merge)');
        }
        alert('Merged from backup');
        markPullUsed();
        applyPullLockUI && applyPullLockUI();
        if (typeof render === 'function') render();
      } catch (e) {
        alert('Bad JSON: ' + (e.message || e));
      }
    };
    fr.readAsText(f);
  };

  i.click();
}

// Replace-from-backup (full overwrite of local DB)
function restoreJSONReplace() {
  const i = document.createElement('input');
  i.type = 'file';
  i.accept = '.json,application/json';

  i.onchange = () => {
    const f = i.files && i.files[0];
    if (!f) return;

    const fr = new FileReader();
    fr.onload = () => {
      try {
        const incoming = JSON.parse(fr.result || '{}');
        if (!incoming || typeof incoming !== 'object') {
          throw new Error('Backup file has no data');
        }

        // Completely replace the in-memory DB with backup
        db = incoming || {};

        // Safety defaults
        db.company           = db.company           || {};
        db.vehicles          = db.vehicles          || [];
        db.sales             = db.sales             || [];
        db.expenses          = db.expenses          || [];
        db.showroomExpenses  = db.showroomExpenses  || [];
        db.vehicleExpenses   = db.vehicleExpenses   || [];
        db.credits           = db.credits           || [];
        db.complaints        = db.complaints        || [];
        db.investors         = db.investors         || [];
        db.partners          = db.partners          || [];
        db.todo              = db.todo              || [];
        db.purchaseInvoices  = db.purchaseInvoices  || [];
        db.audit             = db.audit             || [];
        db.deleted           = db.deleted           || {};

        // Normalise user permissions
        if (Array.isArray(db.users) && typeof normalizePerms === 'function') {
          db.users = db.users.map(u => {
            u.perms = normalizePerms(u.perms);
            return u;
          });
        } else {
          db.users = db.users || [];
        }

        // Apply deletions if any
        if (typeof applyAllDeletions === 'function') {
          applyAllDeletions();
        }

        ensureIdsEverywhere();
        dedupeVehiclesByReg();
        relinkVehicleRefsByReg();
        dedupeSalesById();
        dedupeAllExpensesAndCredits();

        saveDB();
        try { renderAlertBell(); } catch (_) {}
        if (typeof addAudit === 'function') {
          addAudit('import', 'backup', '', 'Replaced from JSON backup');
        }
        alert('Replaced from backup');
        markPullUsed();
        applyPullLockUI && applyPullLockUI();
        if (typeof render === 'function') render();
      } catch (e) {
        alert('Bad JSON: ' + (e.message || e));
      }
    };
    fr.readAsText(f);
  };

  i.click();
}

/* ========= Gist sync ========= */
function getGhToken(){ return localStorage.getItem(GHTOKENKEY)||''; }
function setGhToken(t){ if(t) localStorage.setItem(GHTOKENKEY,t); else localStorage.removeItem(GHTOKENKEY); }

function recordPullActivity(type = 'pull') {
    if (!db.lastPull) db.lastPull = {};
    db.lastPull = {
        timestamp: new Date().toISOString(),
        user: session ? session.username : 'unknown',
        gistId: db.company.gistId || '',
        type: type
    };
    saveDB();
}

// ========= Deletion tracking (for multi-PC sync) =========
function ensureDeletedMap() {
  db.deleted = db.deleted || {};
}

// Merge remote deleted map into local (keep latest timestamp)
function mergeDeletedMaps(localDel, remoteDel) {
  const out = localDel && typeof localDel === 'object' ? JSON.parse(JSON.stringify(localDel)) : {};
  if (remoteDel && typeof remoteDel === 'object') {
    Object.keys(remoteDel).forEach(section => {
      out[section] = out[section] || {};
      const tgt = out[section];
      const src = remoteDel[section] || {};
      Object.keys(src).forEach(id => {
        if (!tgt[id] || String(tgt[id]) < String(src[id])) {
          tgt[id] = src[id];
        }
      });
    });
  }
  return out;
}

function dedupePeopleByNamePreferLocal(mergedArr, localArr) {
  const norm = s => String(s || '').trim().toLowerCase();

  // Set of names that exist in LOCAL (so local version should win)
  const localNameSet = new Set((localArr || []).map(x => norm(x && x.name)));

  // Choose ‚Äúbest‚Äù record if we see duplicates:
  // 1) Prefer record that came from LOCAL (same name exists locally)
  // 2) Otherwise prefer one with more tx entries
  // 3) Otherwise prefer one with higher abs(balance)
  const pickBest = (a, b) => {
    const an = norm(a && a.name), bn = norm(b && b.name);
    const aLocal = localNameSet.has(an);
    const bLocal = localNameSet.has(bn);

    if (aLocal && !bLocal) return a;
    if (!aLocal && bLocal) return b;

    const atx = (a && a.tx && a.tx.length) ? a.tx.length : 0;
    const btx = (b && b.tx && b.tx.length) ? b.tx.length : 0;
    if (atx !== btx) return atx > btx ? a : b;

    const abal = Math.abs(Number(a && a.balance || 0));
    const bbal = Math.abs(Number(b && b.balance || 0));
    if (abal !== bbal) return abal > bbal ? a : b;

    return a; // stable fallback
  };

  const map = Object.create(null);
  const out = [];

  for (const item of (mergedArr || [])) {
    const key = norm(item && item.name);
    if (!key) { out.push(item); continue; }
    if (!map[key]) {
      map[key] = item;
    } else {
      map[key] = pickBest(map[key], item);
    }
  }

  // rebuild in a stable order by name (optional but helps keep dropdown stable)
  const named = Object.keys(map).sort().map(k => map[k]);
  const unnamed = out.filter(x => !x || !norm(x.name));
  return [...named, ...unnamed];
}

function dedupePeopleByNamePreferRemote(mergedArr, remoteArr) {
  const norm = s => String(s || '').trim().toLowerCase();
  const remoteNameSet = new Set((remoteArr || []).map(x => norm(x && x.name)));

  const pickBest = (a, b) => {
    const an = norm(a && a.name), bn = norm(b && b.name);
    const aRemote = remoteNameSet.has(an);
    const bRemote = remoteNameSet.has(bn);

    // Prefer record that exists in REMOTE (Gist)
    if (aRemote && !bRemote) return a;
    if (!aRemote && bRemote) return b;

    // Fallback: more tx wins
    const atx = (a && a.tx && a.tx.length) ? a.tx.length : 0;
    const btx = (b && b.tx && b.tx.length) ? b.tx.length : 0;
    if (atx !== btx) return atx > btx ? a : b;

    // Fallback: higher abs(balance)
    const abal = Math.abs(Number(a && a.balance || 0));
    const bbal = Math.abs(Number(b && b.balance || 0));
    if (abal !== bbal) return abal > bbal ? a : b;

    return a;
  };

  const map = Object.create(null);
  const out = [];

  for (const item of (mergedArr || [])) {
    const key = norm(item && item.name);
    if (!key) { out.push(item); continue; }
    if (!map[key]) map[key] = item;
    else map[key] = pickBest(map[key], item);
  }

  const named = Object.keys(map).sort().map(k => map[k]);
  const unnamed = out.filter(x => !x || !norm(x.name));
  return [...named, ...unnamed];
}

// Mark a record as deleted so other PCs know to remove it too
function markDeleted(section, id) {
  if (!id) return;
  ensureDeletedMap();
  if (!db.deleted[section]) db.deleted[section] = {};
  db.deleted[section][id] = db.deleted[section][id] || new Date().toISOString();
}

// Apply deletions to a given array (vehicles, sales, etc.)
function applyDeletions(section) {
  ensureDeletedMap();
  const map = db.deleted[section];
  if (!map) return;
  if (!Array.isArray(db[section])) return;
  db[section] = db[section].filter(item => !item || !item.id || !map[item.id]);
}

// Apply deletions to all arrays we know about
function applyAllDeletions() {
  ensureDeletedMap();
  Object.keys(db.deleted || {}).forEach(section => {
    applyDeletions(section);
  });
}

async function readGistStarcarsJSON(gistId, token = "") {
  // Safe reader that supports private gists (Authorization) and large/truncated files
  const headers = { "Accept": "application/vnd.github+json" };
  if (token) headers["Authorization"] = "token " + token;

  const r = await fetch(`https://api.github.com/gists/${gistId}`, { headers });
  const txt = await r.text();
  if (!r.ok) throw new Error(`Gist fetch failed ${r.status}: ${txt}`);

  const j = JSON.parse(txt || "{}");
  const file = j.files && (j.files['starcars.json'] || Object.values(j.files)[0]);
  if (!file) throw new Error('No starcars.json in that Gist');

  // Handle big/truncated files
  let content = file.content || '';
  if (file.truncated && file.raw_url) {
    const rr = await fetch(file.raw_url, { headers });
    if (!rr.ok) throw new Error(`Raw fetch failed ${rr.status}`);
    content = await rr.text();
  }

  return JSON.parse(content || '{}');
}

async function syncPull() {
  try {
    const gistId = (db.company.gistId || '').trim();
    if (!gistId) return alert('Enter Gist ID in Settings');

    const r = await fetch(`https://api.github.com/gists/${gistId}`);
    const txt = await r.text();
    if (!r.ok) {
      return alert('Gist fetch failed ' + r.status + ': ' + txt);
    }

    const j = JSON.parse(txt || '{}');
    const file = j.files && (j.files['starcars.json'] || Object.values(j.files)[0]);
    if (!file || !file.content) return alert('No starcars.json in that Gist');

    const incoming = await readGistStarcarsJSON(gistId);

    recordPullActivity('pull');

    // 1) Merge deleted map first so we know what to remove
    if (incoming.deleted) {
      db.deleted = mergeDeletedMaps(db.deleted, incoming.deleted);
    } else {
      ensureDeletedMap();
    }

    Object.keys(incoming).forEach(k => {
      const val = incoming[k];

      if (k === 'audit') {
        // Replace audit completely
        db.audit = Array.isArray(val) ? val.slice() : (db.audit || []);
        return;
      }

      if (k === 'deleted') {
        // already handled above
        return;
      }

      if (Array.isArray(val)) {
        // üîÅ Merge ANY array by id: vehicles, expenses, showroom, users, directors, investors, etc.
        const localArr = Array.isArray(db[k]) ? db[k] : [];
        const byId = Object.create(null);
        const noId = [];

        // Start from local
        for (const item of localArr) {
          if (item && item.id) {
            byId[item.id] = item;
          } else {
            noId.push(item);
          }
        }

        // Apply incoming: overwrite same-id items, add new ones (remote wins)
        for (const item of val) {
          if (item && item.id) {
            byId[item.id] = item;
          } else {
            noId.push(item);
          }
        }

        db[k] = [...noId, ...Object.values(byId)];

        // Apply deletions for this section
        applyDeletions(k);

        // Users: normalise permissions
        if (k === 'users' && typeof normalizePerms === 'function') {
          db.users = (db.users || []).map(u => {
            u.perms = normalizePerms(u.perms);
            return u;
          });
        }

        // FIXED: Use 'val' instead of 'remoteArr' which doesn't exist here
        if (k === 'partners')  db.partners  = dedupePeopleByNamePreferRemote(db.partners || [], val);
        if (k === 'investors') db.investors = dedupePeopleByNamePreferRemote(db.investors || [], val);

        return;
      }

      if (val && typeof val === 'object') {
        // ‚úÖ On PULL: remote (Gist) should overwrite local settings
        db[k] = Object.assign({}, db[k] || {}, val || {});
      } else {
        db[k] = val;
      }
    });

    // Normalise users again just in case
    if (typeof normalizePerms === 'function') {
      db.users = (db.users || []).map(u => {
        u.perms = normalizePerms(u.perms);
        return u;
      });
    }

    // As a safety net, apply deletions everywhere
    applyAllDeletions();

    // Ensure font sizes are numeric
    db.company = db.company || {};
    if (db.company.invoiceFontPx != null) db.company.invoiceFontPx = Number(db.company.invoiceFontPx || 12);
    if (db.company.termsFontPx  != null) db.company.termsFontPx  = Number(db.company.termsFontPx  || 10);
    ensureIdsEverywhere();
    dedupeVehiclesByReg();
    relinkVehicleRefsByReg();
    dedupeSalesById();
    dedupeAllExpensesAndCredits();
    saveDB();
    try { renderAlertBell(); } catch (_) {}
    addAudit('sync', 'pull', db.company.gistId || '', 'Pulled from Gist (arrays merged by id, deletions respected)');
    alert('Pulled & merged from Gist (arrays merged by id; deletions synced)');
    enablePushButton();
    markPullUsed();
    changeTracker.saveSnapshot();
    render();
  } catch (e) {
    alert('Pull failed: ' + e.message);
  }
}

async function readGistJSON(gistId, fileName = "starcars.json", token = ""){
  const headers = { "Accept": "application/vnd.github+json" };
  if (token) headers["Authorization"] = "token " + token;

  const r = await fetch(`https://api.github.com/gists/${gistId}`, { headers });
  const t = await r.text();
  if (!r.ok) throw new Error(`Gist fetch failed ${r.status}: ${t}`);

  const j = JSON.parse(t || "{}");
  const file = j.files && (j.files[fileName] || Object.values(j.files)[0]);
  if (!file) throw new Error(`No ${fileName} found in gist`);

  // ‚úÖ big file: file.content may be truncated
  let content = file.content || "";
  if (file.truncated && file.raw_url) {
    const rr = await fetch(file.raw_url); // raw_url is public if gist is public
    if (!rr.ok) throw new Error(`Raw gist fetch failed ${rr.status}`);
    content = await rr.text();
  }

  return JSON.parse(content || "{}");
}

async function syncPullHard() {
  try {
    const gistId = (db.company.gistId || '').trim();
    if (!gistId) return alert('Enter Gist ID in Settings');

    // ‚úÖ IMPORTANT: use the safe reader that handles big/truncated gists
    const incoming = await readGistStarcarsJSON(gistId);

    recordPullActivity('pull-hard');

    // Replace whole DB with incoming
    db = incoming || {};

    // Safety defaults
    db.company = db.company || {};
    db.vehicles = db.vehicles || [];
    db.sales = db.sales || [];
    db.vehicleExpenses = db.vehicleExpenses || [];
    db.showroomExpenses = db.showroomExpenses || [];
    db.credits = db.credits || [];
    db.complaints = db.complaints || [];
    db.investors = db.investors || [];
    db.partners = db.partners || [];
    db.todo = db.todo || [];
    db.purchaseInvoices = db.purchaseInvoices || [];
    db.audit = db.audit || [];
    db.users = db.users || [];
    db.deleted = db.deleted || {};

    db.company.autoSyncEnabled = db.company.autoSyncEnabled ?? false;
    db.company.autoSyncSeconds = db.company.autoSyncSeconds || 120;

    // Normalise permissions
    if (typeof normalizePerms === 'function') {
      db.users = (db.users || []).map(u => {
        u.perms = normalizePerms(u.perms);
        return u;
      });
    }
    
    ensureIdsEverywhere();
    dedupeVehiclesByReg();
    relinkVehicleRefsByReg();
    dedupeSalesById();
    dedupeAllExpensesAndCredits();

    if (typeof applyAllDeletions === 'function') applyAllDeletions();

    saveDB();
    try { renderAlertBell(); } catch (_) {}
    addAudit('sync', 'pull-hard', gistId, 'HARD pull from Gist (full replace, safe raw_url, dedupe)');
    alert('HARD Pull complete: local data replaced with Gist data.');
    enablePushButton();
    markPullUsed();
    changeTracker.saveSnapshot();
    render();
  } catch (e) {
    alert('Hard Pull failed: ' + e.message);
  }
}

// ========= Auto Sync (auto-pull from Gist) =========
let autoSyncTimer = null;
let autoSyncRunning = false;

function stopAutoSync(){
  if (autoSyncTimer){
    clearInterval(autoSyncTimer);
    autoSyncTimer = null;
  }
}

async function autoSyncTick(){
  if (autoSyncRunning) return; // don't overlap
  autoSyncRunning = true;
  try {
    if (!db || !db.company) return;

    const enabled = !!db.company.autoSyncEnabled;
    const gistId  = (db.company.gistId || '').trim();

    if (!enabled || !gistId) return;

    // Use normal safe pull (merge + deletions)
    await syncPull();
  } catch (e) {
    console.warn('Auto sync failed:', e);
  } finally {
    autoSyncRunning = false;
  }
}

function startAutoSyncFromSettings(){
  stopAutoSync();
  if (!db) return;
  db.company = db.company || {};

  if (!db.company.autoSyncEnabled) return;

  let sec = Number(db.company.autoSyncSeconds || 120);
  if (!sec || sec < 30) sec = 30;     // minimum 30s to avoid hammering GitHub
  if (sec > 600) sec = 600;           // max 10 mins

  autoSyncTimer = setInterval(autoSyncTick, sec * 1000);
}

// Add this function to record push activity
function recordPushActivity() {
    if (!db.lastPush) db.lastPush = {};
    db.lastPush = {
        timestamp: new Date().toISOString(),
        user: session ? session.username : 'unknown',
        gistId: db.company.gistId || ''
    };
    saveDB();
}

async function smartPush() {
  try {
    const gistId = (db.company.gistId || '').trim();
    if (!gistId) return alert('Enter Gist ID in Settings');

    const token = (getGhToken() || '').trim();
    if (!token) return alert('Enter GitHub token and Save');

    // Detect changes vs last snapshot
    const detected = changeTracker.detectAllChanges();
    let changes = detected;
    let useFullPush = false;

    if (!detected || Object.keys(detected).length === 0) {
      // Nothing detected ‚Äì offer to force a FULL push
      const ok = confirm(
        'No changes detected against the last snapshot.\n\n' +
        'Press OK to FORCE a FULL push of your current data to Gist.\n' +
        'Press Cancel to stop.'
      );
      if (!ok) return;
      useFullPush = true;
    }

    let payloadData;

    if (useFullPush) {
      // FULL PUSH: send the current local DB as starcars.json
      payloadData = db;
    } else {
      // Smart diff push ‚Äì read remote (with token), apply changes, then send back
      let remote = null;
      try {
        remote = await readGistJSON(gistId, "starcars.json", token);
      } catch (e) {
        console.warn("Remote read failed:", e);
        remote = null;
      }

      if (!remote) {
        alert(
          "Failed to fetch remote Gist content.\n\n" +
          "Try: Settings ‚Üí Pull (Normal) then Push again.\n" +
          "If still fails, do a Full Push."
        );
        return;
      }

      const updatedRemote = applyChangesToRemote(remote, changes);
      payloadData = updatedRemote;
    }

    // (2) Push to Gist ‚Äî include Accept + API version + token
    const payload = {
      files: {
        'starcars.json': {
          content: JSON.stringify(payloadData, null, 2),
        },
      },
    };

    const r = await fetch(`https://api.github.com/gists/${gistId}`, {
      method: 'PATCH',
      headers: {
        'content-type': 'application/json',
        'Accept': 'application/vnd.github+json',
        'X-GitHub-Api-Version': '2022-11-28',
        Authorization: 'token ' + token
      },
      body: JSON.stringify(payload),
    });

    const txt = await r.text();
    if (!r.ok) {
      console.error('Push failed response:', r.status, txt);
      // try to parse JSON error to show more detail
      let errMsg = `Push failed with status ${r.status}`;
      try {
        const j = JSON.parse(txt || '{}');
        if (j && j.message) errMsg += ': ' + j.message;
      } catch (_) {
        errMsg += ': ' + txt;
      }
      return alert(errMsg);
    }

    // Success: reset snapshot + change log
    changeTracker.saveSnapshot();
    changeTracker.clearChanges();

    recordPushActivity();

    if (useFullPush) {
      addAudit('sync', 'smart-push', gistId, 'Smart push FULL DB (no diff found, forced).');
      alert('Full push completed: all current data sent to Gist.');
    } else {
      addAudit(
        'sync',
        'smart-push',
        gistId,
        `Smart push completed with ${countChanges(changes)} changes.`
      );
      alert(`Smart push completed: ${countChanges(changes)} changes pushed to Gist.`);
    }

    render();
  } catch (e) {
    alert('Smart push failed: ' + e.message);
    console.error('smartPush exception', e);
  }
}

// Helper function to apply changes to remote data
function applyChangesToRemote(remote, changes) {
  const result = JSON.parse(JSON.stringify(remote)); // Deep clone
  
  Object.keys(changes).forEach(section => {
    if (section === 'company') {
      // Update company settings
      result.company = changes.company.data;
      return;
    }
    
    const sectionChanges = changes[section];
    if (!Array.isArray(sectionChanges)) return;
    
    // Ensure the section exists in remote
    if (!result[section]) {
      result[section] = [];
    }
    
    sectionChanges.forEach(change => {
      switch(change.operation) {
        case 'add':
          // Add new item (prepend to beginning)
          result[section].unshift(change.data);
          break;
          
        case 'update':
          // Update existing item
          const index = result[section].findIndex(item => item.id === change.id);
          if (index !== -1) {
            result[section][index] = change.data;
          } else {
            // If not found, add it
            result[section].unshift(change.data);
          }
          break;
          
        case 'delete':
          // Remove item
          result[section] = result[section].filter(item => item.id !== change.id);
          
          // Also add to deleted map for syncing to other PCs
          if (!result.deleted) result.deleted = {};
          if (!result.deleted[section]) result.deleted[section] = {};
          result.deleted[section][change.id] = change.data.deletedAt || new Date().toISOString();
          break;
      }
    });
    
    // Sort arrays to maintain consistency (newest first where applicable)
    if (['audit', 'sales', 'vehicles'].includes(section)) {
      result[section].sort((a, b) => {
        const dateA = a.date || a.ts || a.createdAt || '';
        const dateB = b.date || b.ts || b.createdAt || '';
        return dateB.localeCompare(dateA);
      });
    }
  });
  
  // Merge deleted maps
  if (db.deleted) {
    result.deleted = mergeDeletedMaps(result.deleted || {}, db.deleted);
  }
  
  return result;
}

// Helper to count total changes
function countChanges(changes) {
  let count = 0;
  Object.keys(changes).forEach(section => {
    if (Array.isArray(changes[section])) {
      count += changes[section].length;
    } else {
      count += 1; // For company changes
    }
  });
  return count;
}

/* ========= Navigation & render ========= */
const TABS=['Dashboard','Vehicles','Expenses','Showroom','Sales','Sold','Credit','Purchase Invoice','Customer Complaints','Directors','Investors','Reports','Alerts','To-Do','Users','Settings']; let currentTab=TABS[0];
function setTab(t){ currentTab=t; render(); }

// üîç Global search: reg / VIN / buyer / invoice / phone / complaint
function globalSearch(){
  const input = document.getElementById('global_search');
  if (!input) return;
  const raw = input.value || '';
  const q = raw.trim();
  if (!q) return;

  const up = q.toUpperCase();
  const low = q.toLowerCase();
  const phoneDigits = q.replace(/\D+/g,'');

  const vehicles   = db.vehicles   || [];
  const sales      = db.sales      || [];
  const complaints = db.complaints || [];

  let matchVehicle   = null;
  let matchSale      = null;
  let matchComplaint = null;

  // 1) Try vehicle by REG / VIN / make / model
  if (vehicles.length){
    matchVehicle = vehicles.find(v => normReg(v.reg) === normReg(up)) || null;
    if (!matchVehicle){
      matchVehicle = vehicles.find(v =>
        (v.reg   || '').toUpperCase().includes(up)   ||
        (v.vin   || '').toUpperCase().includes(up)   ||
        (v.make  || '').toLowerCase().includes(low)  ||
        (v.model || '').toLowerCase().includes(low)
      ) || null;
    }
  }

  // 2) Try sale by invoice / buyer / phone
  if (sales.length){
    matchSale = sales.find(s => {
      const inv   = (s.invNo   || '').toString().toUpperCase();
      const buyer = (s.buyer   || '').toLowerCase();
      const phone = (s.phone   || '').replace(/\D+/g,'');
      return inv === up ||
             inv.includes(up) ||
             buyer.includes(low) ||
             (phoneDigits && phone && phone.indexOf(phoneDigits) !== -1);
    }) || null;
  }

  // 3) Try complaint by customer / reg
  if (complaints.length){
    matchComplaint = complaints.find(c =>
      (c.customer || '').toLowerCase().includes(low) ||
      normReg(c.vehicle || '') === normReg(up)
    ) || null;
  }

  if (matchVehicle){
    goToVehicleSearch(matchVehicle.reg || q);
  } else if (matchSale){
    goToSaleSearch(matchSale);
  } else if (matchComplaint){
    goToComplaintSearch(matchComplaint);
  } else {
    alert('No matching vehicle, sale or complaint found for "'+q+'".');
  }
}

function goToVehicleSearch(term){
  setTab('Vehicles');
  setTimeout(function(){
    const inp = document.getElementById('veh_search');
    if (inp){
      inp.value = term;
      inp.dispatchEvent(new Event('input'));
    }
  },50);
}

function goToSaleSearch(sale){
  setTab('Sales');
  setTimeout(function(){
    const inp = document.getElementById('sales_search');
    if (inp){
      if (sale.invNo) {
        inp.value = String(sale.invNo);
      } else if (sale.buyer) {
        inp.value = sale.buyer;
      } else if (sale.vehicleId){
        const v = (db.vehicles||[]).find(x=>x.id===sale.vehicleId) || {};
        inp.value = v.reg || '';
      } else {
        inp.value = '';
      }
      inp.dispatchEvent(new Event('input'));
    }
  },50);
}

function goToComplaintSearch(comp){
  setTab('Customer Complaints');
  setTimeout(function(){
    const inp = document.getElementById('comp_search');
    if (inp){
      if (comp.vehicle)      inp.value = comp.vehicle;
      else if (comp.customer)inp.value = comp.customer;
      else                   inp.value = '';
      inp.dispatchEvent(new Event('input'));
    }
  },50);
}

function renderNav(){ const nav=document.getElementById('nav'); nav.innerHTML=''; TABS.forEach(t=>{ if(!canTab(t)) return; if(t==='Settings'&&!canSettings()) return; const b=document.createElement('button'); b.textContent=t; if(t===currentTab) b.classList.add('active'); b.onclick=()=>setTab(t); nav.appendChild(b); }); }

function ensureIdsEverywhere(){
  const sections = [
    'vehicles','sales','vehicleExpenses','showroomExpenses','credits','complaints',
    'investors','partners','todo','users','purchaseInvoices','audit'
  ];
  sections.forEach(sec=>{
    if (!Array.isArray(db[sec])) return;
    db[sec].forEach(item=>{
      if (item && !item.id) item.id = uid();
    });
  });
}

function dedupeVehiclesByReg(){
  if (!Array.isArray(db.vehicles)) return;
  const seen = new Set();
  const out = [];
  // keep newest first if createdAt exists
  const arr = db.vehicles.slice().sort((a,b)=>{
    const da = (a && (a.createdAt || a.updatedAt)) ? String(a.createdAt || a.updatedAt) : '';
    const dbb = (b && (b.createdAt || b.updatedAt)) ? String(b.createdAt || b.updatedAt) : '';
    return dbb.localeCompare(da);
  });

  for(const v of arr){
    const reg = String(v?.reg || '').toUpperCase().replace(/\s+/g,'').trim();
    if(!reg){ out.push(v); continue; }
    if(seen.has(reg)) continue;
    seen.add(reg);
    out.push(v);
  }
  db.vehicles = out;
}

function normReg(x){
  return String(x||'').toUpperCase().replace(/\s+/g,'').trim();
}

function relinkVehicleRefsByReg(){
  // Build reg -> kept vehicleId map from CURRENT db.vehicles (after dedupe)
  const regToId = Object.create(null);
  (db.vehicles || []).forEach(v=>{
    const r = normReg(v && v.reg);
    if (r && v && v.id) regToId[r] = v.id;
  });

  // Helper: if record has vehicleId, try relink by reg field (or by lookup)
  const fixList = (arrName, getRegFn) => {
    if (!Array.isArray(db[arrName])) return;
    let changed = 0;
    db[arrName].forEach(rec=>{
      const reg = normReg(getRegFn(rec));
      if (!reg) return;
      const newVid = regToId[reg];
      if (newVid && rec.vehicleId && rec.vehicleId !== newVid){
        rec.vehicleId = newVid;
        changed++;
      }
      // If vehicleId missing but reg exists, attach it
      if (newVid && !rec.vehicleId){
        rec.vehicleId = newVid;
        changed++;
      }
    });
    return changed;
  };

  // SALES: infer reg from linked vehicle OR from fields if present
  fixList('sales', (s)=>{
    // try direct from vehicleId first
    const v = (db.vehicles||[]).find(x=>x.id===s.vehicleId);
    return (v && v.reg) || s.reg || '';
  });

  // VEHICLE EXPENSES: by vehicleId -> vehicle.reg
  fixList('vehicleExpenses', (e)=>{
    const v = (db.vehicles||[]).find(x=>x.id===e.vehicleId);
    return (v && v.reg) || e.reg || '';
  });

  // CREDITS: you store reg in UI as typed; but record may have vehicleId too
  fixList('credits', (c)=> c.reg || c.vehicleReg || '');

  // COMPLAINTS (if you store reg on complaint records)
  fixList('complaints', (c)=> c.reg || c.vehicleReg || '');

  // PURCHASE INVOICES (if they reference vehicles)
  fixList('purchaseInvoices', (p)=> p.reg || p.vehicleReg || '');

  // optional: keep db.sales consistent newest-first
  if (Array.isArray(db.sales)){
    db.sales.sort((a,b)=> String(b.date||'').localeCompare(String(a.date||'')));
  }
}

function dedupeSalesById(){
  if (!Array.isArray(db.sales)) return;
  const byId = Object.create(null);
  for (const s of db.sales){
    if (!s) continue;
    const id = s.id || uid();
    s.id = id;
    byId[id] = s;
  }
  db.sales = Object.values(byId).sort((a,b)=>{
    const da = String(a.date || '');
    const dbb = String(b.date || '');
    return dbb.localeCompare(da);
  });
}

function dedupeShowroomExpenses(){
  if (!Array.isArray(db.showroomExpenses)) return;

  const seen = new Set();
  const out = [];

  const arr = db.showroomExpenses.slice().sort((a,b)=>{
    const da = String(a?.date || a?.ts || a?.createdAt || a?.updatedAt || '');
    const dbb = String(b?.date || b?.ts || b?.createdAt || b?.updatedAt || '');
    return dbb.localeCompare(da); // newest first
  });

  for (const x of arr){
    if (!x) continue;

    const key = [
      String(x.date||'').trim(),
      String(x.type||'').trim().toLowerCase(),
      String(x.method||'').trim().toLowerCase(),
      Number(x.amount||0).toFixed(2),
      String(x.note||x.desc||'').trim().toLowerCase()
    ].join('|');

    if (seen.has(key)) continue;
    seen.add(key);
    out.push(x);
  }

  db.showroomExpenses = out;
}

function dedupeVehicleExpenses(){
  if (!Array.isArray(db.vehicleExpenses)) return;

  const seen = new Set();
  const out = [];

  const arr = db.vehicleExpenses.slice().sort((a,b)=>{
    const da = String(a?.date || a?.ts || a?.createdAt || a?.updatedAt || '');
    const dbb = String(b?.date || b?.ts || b?.createdAt || b?.updatedAt || '');
    return dbb.localeCompare(da); // newest first
  });

  for (const x of arr){
    if (!x) continue;

    const key = [
      String(x.vehicleId || '').trim(),
      String(x.date||'').trim(),
      String(x.type||'').trim().toLowerCase(),
      String(x.method||'').trim().toLowerCase(),
      Number(x.amount||0).toFixed(2),
      String(x.note||'').trim().toLowerCase()
    ].join('|');

    if (seen.has(key)) continue;
    seen.add(key);
    out.push(x);
  }

  db.vehicleExpenses = out;
}

function dedupeCredits(){
  if (!Array.isArray(db.credits)) return;

  const seen = new Set();
  const out = [];

  const arr = db.credits.slice().sort((a,b)=>{
    const da = String(a?.date || a?.ts || a?.createdAt || a?.updatedAt || '');
    const dbb = String(b?.date || b?.ts || b?.createdAt || b?.updatedAt || '');
    return dbb.localeCompare(da); // newest first
  });

  for (const x of arr){
    if (!x) continue;

    const key = [
      String(x.date||'').trim(),
      String(x.customer||'').trim().toLowerCase(),
      String(x.vehicle||x.reg||'').trim().toUpperCase(),
      String(x.type||'').trim().toLowerCase(),
      String(x.method||'').trim().toLowerCase(),
      Number(x.amount||0).toFixed(2),
      String(x.reason||'').trim().toLowerCase(),
      String(x.invoiceNo||'').trim().toLowerCase()
    ].join('|');

    if (seen.has(key)) continue;
    seen.add(key);
    out.push(x);
  }

  db.credits = out;
}

function dedupeAllExpensesAndCredits(){
  dedupeShowroomExpenses();
  dedupeVehicleExpenses();
  dedupeCredits();
}

function render(){
  if(!session){ showLogin(true); return; }
  renderNav();
  const app=document.getElementById('app'); app.innerHTML=''; document.getElementById('who').textContent='Logged in: '+session.username+' ('+session.role+')';
  const views={Dashboard:viewDashboard,Vehicles:viewVehicles,Expenses:viewExpenses,Showroom:viewShowroom,Sales:viewSales,Sold:viewSold,Credit:viewCredit,["Purchase Invoice"]:viewPurchaseInvoice,["Customer Complaints"]:viewComplaints,Directors:viewDirectors,Investors:viewInvestors,Reports:viewReports,Alerts:viewAlerts,["To-Do"]:viewTodo,Users:viewUsers,Settings:viewSettings};
  const f=views[currentTab]; if(f) app.appendChild(f()); else app.textContent='No view'; refreshLogoBox();
  
  // Re-apply push button state after rendering Settings tab
  if(currentTab === 'Settings') {
    setTimeout(function() {
      if(pushEnabled) {
        enablePushButton();
      } else {
        disablePushButton();
      }
    }, 100);
  }
  applyPullLockUI();
}

/* ========= Finance helpers ========= */

function validateSaleEdit(obj){
  const reg = (obj.reg||'').toUpperCase().trim();
  if(!reg || reg.length<5 || /[^A-Z0-9]/i.test(reg)){ 
    alert('Please enter a valid REG (letters/numbers only).'); 
    return false; 
  }
  return true;
}

function calcBalances(){
  let bank=Number(db.company.openingBank||0), cash=Number(db.company.openingCash||0);
  (db.partners||[]).forEach(p=> (p.tx||[]).forEach(t=>{ if(t.method==='cash'){ if(t.type==='invest'||t.type==='profit') cash+=+t.amount||0; if(t.type==='withdraw') cash-=+t.amount||0; } else { if(t.type==='invest'||t.type==='profit') bank+=+t.amount||0; if(t.type==='withdraw') bank-=+t.amount||0; }}));
  (db.investors||[]).forEach(i=> (i.tx||[]).forEach(t=>{ if(t.method==='cash'){ if(t.type==='fund_in') cash+=+t.amount||0; if(t.type==='withdraw') cash-=+t.amount||0; } else { if(t.type==='fund_in') bank+=+t.amount||0; if(t.type==='withdraw') bank-=+t.amount||0; }}));
  (db.sales||[]).forEach(s=>{ cash+=+s.cash||0; bank+=+s.card||0; bank+=+s.bank||0; bank+=+s.finance||0; cash+=+s.deposit||0; });
  (db.vehicleExpenses||[]).forEach(e=>{ if((e.method||'bank')==='cash') cash-=+e.amount||0; else bank-=+e.amount||0; });
  (db.showroomExpenses||[]).forEach(e=>{ if((e.method||'bank')==='cash') cash-=+e.amount||0; else bank-=+e.amount||0; });
  (db.credits||[]).forEach(c=>{ if((c.method||'bank')==='cash') cash-=+c.amount||0; else bank-=+c.amount||0; });
  return {bank,cash};
}

/* ========= Global helper ========= */
function findVehicleIdByReg(reg){
  reg = (reg || '').toUpperCase().trim();
  const v = (db.vehicles || []).find(x => (x.reg || '').toUpperCase() === reg);
  return v ? v.id : null;
}

/* ========= Invoice Number Helper ========= */
function getNextInvoiceNo() {
  const sales = db.sales || [];
  if (!sales.length) return '1000'; // starting number

  let maxNum = 999;

  sales.forEach(s => {
    const raw = (s.invNo == null ? '' : String(s.invNo)).trim();
    if (!raw) return;

    // ‚úÖ Only use pure digits, and ignore silly-long numbers (e.g. 35454242)
    if (!/^\d+$/.test(raw)) return;     // skip if it has letters or symbols
    if (raw.length > 4) return;         // only count up to 4-digit invoices

    const n = parseInt(raw, 10);
    if (!isNaN(n) && n > maxNum) maxNum = n;
  });

  return String(maxNum + 1);
}

function syncSoldStatusFromSales() {
  const soldIds = new Set(
    (db.sales || [])
      .filter(s => {
        if (!s) return false;
        const st = String(s.status || 'completed').toLowerCase();
        // Only **completed** and **not refunded** sales mark the car as SOLD
        return !s.refunded && st === 'completed';
      })
      .map(s => s.vehicleId)
  );

  (db.vehicles || []).forEach(v => {
    if (!v) return;
    const currentStatus = String(v.status || '').toLowerCase();
    const shouldBeSold = soldIds.has(v.id);

    if (shouldBeSold) {
      v.status = 'sold';
    } else if (currentStatus === 'sold') {
      // If there is no qualifying sale any more, put it back For Sale
      v.status = 'for sale';
    }
  });
}

/* ========= Dashboard ========= */
function viewDashboard(){
  syncSoldStatusFromSales();
  const card=document.createElement('div'); card.className='card';
  const options=(db.vehicles||[]).map(v=>`<option value="${(v.reg||'').toUpperCase()}">`).join('');
  const dirTotal=(db.partners||[]).reduce((t,p)=>t+Number(p.balance||0),0);
  const invTotal=(db.investors||[]).reduce((t,i)=>t+Number(i.balance||0),0);
  const vehSpend=(db.vehicles||[]).reduce((t,v)=>t+Number(v.purchase||0),0);
  const vExp=(db.vehicleExpenses||[]).reduce((t,e)=>t+Number(e.amount||0),0);
  const sExp=(db.showroomExpenses||[]).reduce((t,e)=>t+Number(e.amount||0),0);
  const bal=calcBalances();
  const inStockVehicles = (db.vehicles || []).filter(v => v.status !== 'sold');
  const inStock = inStockVehicles.length;
  const inStockIds = new Set(inStockVehicles.map(v => v.id));

  const stockPurchase = inStockVehicles
  .reduce((t, v) => t + Number(v.purchase || 0), 0);

  const stockVehExpTotal = (db.vehicleExpenses || [])
  .filter(e => inStockIds.has(e.vehicleId))
  .reduce((t, e) => t + Number(e.amount || 0), 0);

  const stockValue = stockPurchase + stockVehExpTotal;

  card.innerHTML=`<h2>Dashboard</h2>
  <div class="grid4">
    <div class="card"><div class="small">Directors Invested (balance)</div><div class="stat">${fmtMoney(dirTotal)}</div></div>
    <div class="card"><div class="small">Investors Funds (balance)</div><div class="stat">${fmtMoney(invTotal)}</div></div>
    <div class="card"><div class="small">Vehicles In Stock</div><div class="stat">${inStock}</div></div>
    <div class="card"><div class="small">Estimated Bank / Cash</div><div class="stat">${fmtMoney(bal.bank)} &nbsp;|&nbsp; ${fmtMoney(bal.cash)}</div></div>
  </div>
  <div class="grid3">
    <div class="card">
    <div class="small">Current Stock Purchase (in-stock vehicles)</div>
    <div class="stat">${fmtMoney(stockPurchase)}</div>
  </div>
  <div class="card">
    <div class="small">Current Stock Vehicle Expenses</div>
    <div class="stat">${fmtMoney(stockVehExpTotal)}</div>
  </div>
  <div class="card">
    <div class="small">Current Stock Value (purchase + expenses)</div>
    <div class="stat">${fmtMoney(stockValue)}</div>
  </div>
  </div>

  <div class="row" style="margin-top:10px">
    <div class="card">
      <div class="small">MOT (Stock)</div>
      <div style="font-size:14px;margin-top:6px">
        Expired: <b id="mot_expired">0</b><br>
        ‚â§30: <b id="mot_30">0</b> &nbsp; ‚â§60: <b id="mot_60">0</b> &nbsp; ‚â§90: <b id="mot_90">0</b><br>
        No MOT saved: <b id="mot_nomot">0</b>
      </div>
      <div class="small" style="margin-top:8px;display:flex;gap:6px;flex-wrap:wrap">
        <button id="mot_btn_exp">Show Expired</button>
        <button id="mot_btn_30">Show ‚â§30</button>
        <button id="mot_btn_60">Show ‚â§60</button>
        <button id="mot_btn_90">Show ‚â§90</button>
        <button id="mot_export_csv" style="margin-left:8px;">Export CSV</button>
      </div>
      <div id="mot_list_out" style="margin-top:8px"></div>
    </div>
  </div>

  <div class="row">
    <input id="dash_reg" list="reglist" placeholder="Type REG‚Ä¶ (e.g., AB12CDE)" style="min-width:220px">
    <datalist id="reglist">${options}</datalist>
    <button id="dash_show" class="primary">Show</button>
  </div>
  <div id="dash_result" class="card" style="margin-top:10px"></div>`;

  (function(){
    const stock = (db.vehicles||[]).filter(v => (v.status||'for sale') !== 'sold');

    const b = motBucketsFromVehicles(stock);
    const set = (sel,val)=>{ const el=card.querySelector(sel); if(el) el.textContent=String(val); };

    set('#mot_expired', b.expired);
    set('#mot_30', b.d30);
    set('#mot_60', b.d60);
    set('#mot_90', b.d90);
    set('#mot_nomot', b.noMot);

    let currentList = [];

    function renderList(list, title){
      currentList = list || [];
      const out = card.querySelector('#mot_list_out');
      if(!out) return;

      const rows = currentList.slice(0,50).map(v=>{
        const exp = getMotExpiry(v);
        const dt = daysToDate(exp);
        const daysTxt = (dt===null) ? '' : (dt<0 ? `(${dt}d)` : `(+${dt}d)`);
        return `<tr>
          <td>${(v.reg||'').toUpperCase()}</td>
          <td>${v.make||''}</td>
          <td>${v.model||''}</td>
          <td>${exp||''} ${daysTxt}</td>
        </tr>`;
      }).join('');

      out.innerHTML = `
        <div class="small"><b>${title}</b> (showing up to 50)</div>
        <table class="tbl">
          <tr><th>Reg</th><th>Make</th><th>Model</th><th>MOT</th></tr>
          ${rows || '<tr><td colspan="4">No vehicles found</td></tr>'}
        </table>
      `;
    }

    const bind = (btnSel, fn)=>{
      const el = card.querySelector(btnSel);
      if(el) el.onclick = fn;
    };

    bind('#mot_btn_exp', ()=> renderList(filterByMotDays(stock, -1), 'MOT Expired'));
    bind('#mot_btn_30', ()=> renderList(filterByMotDays(stock, 30), 'MOT ‚â§ 30 days'));
    bind('#mot_btn_60', ()=> renderList(filterByMotDays(stock, 60), 'MOT ‚â§ 60 days'));
    bind('#mot_btn_90', ()=> renderList(filterByMotDays(stock, 90), 'MOT ‚â§ 90 days'));
  
    const exportBtn = card.querySelector('#mot_export_csv');
    if (exportBtn) {
      exportBtn.onclick = () => {
        // currentList is the array shown by renderList(...) in this IIFE
        const list = currentList || [];
        if (!list.length) return alert('No vehicles in the current MOT list to export.');

        const headers = [
          'REG','Make','Model','Colour','Fuel','Mileage',
          'First Registration','Purchase Date','Purchase Price',
          'Owner Type','Investor','Status','Supplier','VIN','Last MOT Date','Last MOT Expiry','Last MOT Mileage'
        ];

        const esc = v => {
          const s = (v == null) ? '' : String(v);
          return /[",\n]/.test(s) ? `"${s.replace(/"/g,'""')}"` : s;
        };

        const rows = list.map(v => [
          v.reg || '',
          v.make || '',
          v.model || '',
          v.colour || '',
          v.fuel || '',
          v.mileage || '',
          (v.firstReg ? ddmmyyyy(v.firstReg) : ''),
          (v.purchaseDate ? ddmmyyyy(v.purchaseDate) : ''),
          (v.purchase != null ? Number(v.purchase).toFixed(2) : ''),
          v.ownerType || '',
          v.investor || '',
          v.status || '',
          v.supplier || '',
          v.vin || '',
          v.lastMotDate || '',
          v.lastMotExpiry || v.motExpiry || '',
          v.lastMotMileage || ''
        ]);

        const csv = [headers.join(',')]
          .concat(rows.map(r => r.map(esc).join(',')))
          .join('\n');

        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);
        link.href = url;
        link.download = `mot_stock_${new Date().toISOString().slice(0,10)}.csv`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        setTimeout(()=>URL.revokeObjectURL(url), 10000);

        if (typeof addAudit === 'function') addAudit('export','mot','',`Exported ${list.length} vehicles from MOT list`);
      };
    }
  })();
  
  const sum=(arr,p)=>(arr||[]).reduce((t,x)=>t+Number(p?p(x):x||0),0);
  
  function showResultByReg(reg){
    reg=(reg||'').toUpperCase().trim(); 
    const v=db.vehicles.find(x=>(x.reg||'').toUpperCase()===reg);
    const out=card.querySelector('#dash_result'); 
    
    if(!v){ 
      out.innerHTML='<span class="small">No vehicle found.</span>'; 
      return; 
    }
    
    const vexp=(db.vehicleExpenses||[]).filter(e=>e.vehicleId===v.id); 
    const totalExp=sum(vexp,e=>e.amount); 
    const totalCost=Number(v.purchase||0)+totalExp;
    
    let mediaHtml='';
    if((v.media||[]).length){ 
      mediaHtml += '<div class="previewStrip">'+v.media.map(u=>`<img src="${u}" alt="media">`).join('')+'</div>'; 
    }
    if(v.video){ 
      mediaHtml += `<div class="small">YouTube: ${v.video}</div>`; 
    }
    
    // Check if this vehicle was sold and generated a part-exchange
    let saleInfo = '';
    const generatedPx = db.vehicles.find(vh => vh.originalSaleId && vh.originalSaleId === v.id);
    if (generatedPx) {
      saleInfo = `
        <tr>
          <th>Generated Part-exchange</th>
          <td>
            Vehicle was sold and customer traded in: ${generatedPx.reg}
            <br>
            <small style="color:#ff6b6b;">
              Part-ex vehicle: ${generatedPx.make || ''} ${generatedPx.model || ''}
              <br>
              Part-ex value: ${fmtMoney(generatedPx.purchase || 0)}
              <br>
              ${generatedPx.status === 'sold' ? '‚ö†Ô∏è Part-ex already sold' : '‚úÖ Part-ex in stock'}
            </small>
          </td>
        </tr>
      `;
    }
    
    let rows=vexp.map(e=>`<tr><td>${ddmmyyyy(e.date||'')}</td><td>${e.type||''}</td><td class="right">${fmtMoney(e.amount)}</td><td>${e.note||''}</td></tr>`).join('');
    if(!rows) rows='<tr><td colspan="4" class="small">No expenses yet</td></tr>';
    
    out.innerHTML=`<div class="row"><span class="badge">${v.status||'for sale'}</span>&nbsp;<b>${v.reg}</b>&nbsp;${v.make||''} ${v.model||''}</div>
      ${mediaHtml}
      <table class="table"><tbody>
      <tr><th style="width:220px">Purchase</th><td class="right">${fmtMoney(v.purchase||0)}</td></tr>
      <tr><th>Total Expenses</th><td class="right">${fmtMoney(totalExp)}</td></tr>
      <tr><th>Total Cost (incl. expenses)</th><td class="right">${fmtMoney(totalCost)}</td></tr>
      ${v.supplier === 'PART-EX' ? `<tr><th>Supplier Type</th><td>PART-EX</td></tr>` : ''}
      ${v.supplierNote ? `<tr><th>Supplier Note</th><td>${v.supplierNote}</td></tr>` : ''}
      ${saleInfo}
      </tbody></table>
      <h4>Expenses</h4><table class="table"><thead><tr><th>Date</th><th>Type</th><th class="right">Amount</th><th>Note</th></tr></thead><tbody>${rows}</tbody></table>`;
  }
  
  card.querySelector('#dash_show').onclick=()=>showResultByReg(card.querySelector('#dash_reg').value);
  card.querySelector('#dash_reg').addEventListener('change',()=>showResultByReg(card.querySelector('#dash_reg').value));
  card.querySelector('#dash_reg').addEventListener('keydown',(e)=>{ if(e.key==='Enter') showResultByReg(card.querySelector('#dash_reg').value); });
  
  return card;
}

/* ========= Vehicles ========= */
function viewVehicles(){
  if(!canTab('Vehicles')) return document.createElement('div'); const wrap=document.createElement('div'); wrap.className='card';
  wrap.innerHTML=`<h2>Vehicles</h2>
  <div class="row">
    <label>REG *<input id="v_reg" placeholder="AB12CDE"><button id="v_mot" type="button">DVSA Lookup</button></label>
    <label>Make<input id="v_make"></label>
    <label>Model<input id="v_model"></label>
    <label>Colour<input id="v_colour"></label>
    <label>Fuel<input id="v_fuel" placeholder="PETROL/DIESEL/EV"></label>
    <label>Engine Size<input id="v_engineSize" placeholder="e.g. 1998"></label>
    <label>Mileage<input id="v_mileage" type="number" placeholder="0"></label>
    <label>Purchase ¬£<input id="v_purchase" type="number" placeholder="0"></label>
    <label>Purchase Date<input id="v_purchaseDate" type="date"></label>
    <label>Date of First Reg<input id="v_firstReg" type="date"></label>
    <label>Owner Type<select id="v_ownerType"><option value="owned">owned</option><option value="investor">investor</option></select></label>
    <label>Investor
  <select id="v_investor">
    <option value="">-- Select investor (if any) --</option>
  </select>
  </label>
    <label>Supplier Invoice #<input id="v_supplier" placeholder="INV-001"></label>
    <label>VIN (optional)<input id="v_vin"></label>
    <label>MOT Expiry<input id="v_motExpiry" type="date" placeholder="Optional"></label>
    <label>Status<select id="v_status"><option value="for sale">for sale</option><option value="sold">sold</option></select></label>
  
    <div class="card" style="margin-top:10px">
  <h4 style="margin:0 0 8px 0">Sale Readiness / Prep</h4>

  <div class="row">
    <label class="small" style="display:flex;align-items:center;gap:8px;margin:0">
      <input type="checkbox" id="v_readyForSale">
      Ready for sale
    </label>

    <label class="small" style="margin:0">Stage
      <select id="v_prepStage" style="padding:4px 6px;font-size:12px;background:#0f1628;border:1px solid var(--line);color:var(--ink);border-radius:6px;">
        <option>None</option>
        <option>Prep</option>
        <option>Workshop</option>
        <option>Valet</option>
        <option>Photos</option>
        <option>Advert</option>
        <option>Ready</option>
      </select>
    </label>
  </div>

  <label class="small" style="margin-top:8px;display:block">If NOT ready, why?
    <input id="v_notReadyReason" placeholder="Reason not ready..." />
  </label>

  <label class="small" style="margin-top:8px;display:block">Next action / notes
    <textarea id="v_prepNotes" rows="2" placeholder="What needs doing..."></textarea>
  </label>
  </div>
  
  </div>
  <div class="row">
    <button id="v_add" class="primary">Add / Update</button>
  </div>

  <div class="row" style="display: flex; align-items: center; gap: 12px; margin-top: 12px;">
    <button id="veh_mot_refresh" type="button">Update MOT Expiry (Stock)</button>
    <span id="veh_mot_progress" class="small" style="margin-left:auto;"></span>
    <input id="veh_search" placeholder="Search reg/make/model/supplier">
    <label class="small" style="display: flex; align-items: center; margin: 0;">
      <input type="checkbox" id="veh_instock" checked> In stock only
    </label>
    <label class="small" style="display: flex; align-items: center; margin: 0;">
      <input type="checkbox" id="veh_soldonly"> Sold only
    </label>
    <label class="small" style="display: flex; align-items: center; margin: 0;">
      <input type="checkbox" id="veh_investoronly"> Investor stock
    </label>
    <label class="small" style="display: flex; align-items: center; margin: 0;">
      <input type="checkbox" id="veh_pxonly"> Part-ex only
    </label>
    <label class="small" style="display: flex; align-items: center; margin: 0;">
      <input type="checkbox" id="veh_notready"> Not Ready
    </label>
    <!-- NEW: MOT Expiry Filter -->
    <label class="small" style="display: flex; align-items: center; margin: 0;">
      <select id="veh_motFilter" style="padding: 4px 6px; font-size: 12px; background: #0f1628; border: 1px solid var(--line); color: var(--ink); border-radius: 6px;">
        <option value="">MOT Expiry</option>
        <option value="expired">Expired</option>
        <option value="30">Less than 30 days</option>
        <option value="60">Less than 60 days</option>
        <option value="90">Less than 90 days</option>
        <option value="valid">Valid MOT</option>
      </select>
    </label>
    <button onclick="exportVehiclesCSV()">Export CSV</button>
  </div>

  <table class="table" style="margin-top:10px"><thead><tr><th>Reg</th><th>Make</th><th>Model</th><th>Colour</th><th>Mileage</th><th>Fuel</th><th>Engine Size</th><th>First Reg</th><th>Purchase Date</th><th>Type</th><th>Investor</th><th>Purchase</th><th>VIN</th><th>MOT Expiry</th><th>Supplier #</th><th>Actions</th></tr></thead><tbody id="vehBody"></tbody></table>
  <div class="small" style="margin-top:8px">Note: DVLA proxy required in Settings. DVLA may not return Model/VIN.</div>`;
  
  // Populate investor dropdown from db.investors
  const invSel = wrap.querySelector('#v_investor');
  if (invSel) {
    invSel.innerHTML =
      '<option value="">-- Select investor (if any) --</option>' +
      (db.investors || [])
        .map(i => `<option value="${i.id}">${i.name}</option>`)
        .join('');
  }

  let editId=null; const body=wrap.querySelector('#vehBody');

  function rows(q='', mode='instock'){
  body.innerHTML='';
  q=(q||'').toLowerCase().trim();
  
  // Get filter states
  const instockOnly = wrap.querySelector('#veh_instock')?.checked;
  const soldOnly = wrap.querySelector('#veh_soldonly')?.checked;
  const investorOnly = wrap.querySelector('#veh_investoronly')?.checked;
  const pxOnly = wrap.querySelector('#veh_pxonly')?.checked;
  const notReadyOnly = wrap.querySelector('#veh_notready')?.checked;
  const motFilter = wrap.querySelector('#veh_motFilter')?.value || '';
  
  (db.vehicles||[]).forEach(v=>{
    // Apply filters...
    if (instockOnly && v.status === 'sold') return;
    if (soldOnly && v.status !== 'sold') return;
    
    // Apply investor stock filter
    if (investorOnly && v.ownerType !== 'investor') return;
    
    // Apply part-ex filter
    if (pxOnly && v.supplier !== 'PART-EX') return;

    if (notReadyOnly && (v.status === 'sold' || v.readyForSale)) return;
    
    // Apply search filter
    if (q) {
      const hay = ((v.reg || '') + ' ' + (v.make || '') + ' ' + (v.model || '') + ' ' + (v.supplier || '')).toLowerCase();
      if (!hay.includes(q)) return;
    }
    
    // Apply MOT expiry filter
    if (motFilter) {
        const motDate = v.motExpiry || v.lastMotExpiry || '';
        if (!motDate) {
        return;
        }
        const expiry = new Date(motDate);
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        expiry.setHours(0, 0, 0, 0);
        const diffMs = expiry - today;
        const diffDays = Math.ceil(diffMs / (1000 * 60 * 60 * 24));
        
        switch(motFilter) {
          case 'expired':
            if (diffDays >= 0) return; // Skip if not expired
            break;
          case '30':
            if (diffDays <= 0 || diffDays > 30) return;
            break;
          case '60':
            if (diffDays <= 0 || diffDays > 60) return;
            break;
          case '90':
            if (diffDays <= 0 || diffDays > 90) return;
            break;
          case 'valid':
            if (diffDays < 0) return; // Skip if expired
            break;
        }
      }
    
    const tr=document.createElement('tr');
    const mcount=(v.media||[]).length + ((v.video&&1)||0);
    tr.innerHTML=`<td>${v.reg||''}</td>
    <td>${v.make||''}</td>
    <td>${v.model||''}</td>
    <td>${v.colour||''}</td>
    <td>${v.mileage||''}</td>
    <td>${v.fuel||''}</td>
    <td>${v.engineSize||''}</td>
    <td>${ddmmyyyy(v.firstReg||'')}</td>
    <td>${ddmmyyyy(v.purchaseDate||'')}</td>
    <td>${v.ownerType||'owned'}</td>
    <td>${v.investor||''}</td>
    <td class="right">${fmtMoney(v.purchase||0)}</td>
    <td style="text-align:center;" title="${v.vin || ''}">${v.vin ? 'üÜî' : ''}</td>
    <td>${(() => {const motDate = v.motExpiry || v.lastMotExpiry || '';if (!motDate) return '';const expiry = new Date(motDate);const today = new Date();today.setHours(0, 0, 0, 0);expiry.setHours(0, 0, 0, 0);const diffMs = expiry - today;const diffDays = Math.ceil(diffMs / (1000 * 60 * 60 * 24));let icon = 'üìÖ';let color = '#a3b2cc';if (diffDays < 0) {icon = '‚ö†Ô∏è';color = '#ff6b6b';} else if (diffDays <= 30) {icon = '‚è≥';color = '#ffa726';} else if (diffDays <= 90) {icon = '‚úÖ';color = '#2ecc71';}return `<span title="${ddmmyyyy(motDate)}" style="cursor:help;color:${color}">${icon}${Math.abs(diffDays)}</span>`;})()}</td>
    <td>${v.supplier||''}${v.supplierNote ? '<br><small style="color:#53a8ff;">' + v.supplierNote + '</small>' : ''}</td>
    <td>${canAction('edit')?`<button data-act="edit" data-id="${v.id}">Edit</button>`:''} ${canAction('del')?`<button class="danger" data-act="del" data-id="${v.id}">Delete</button>`:''} ${v.originalSaleId?`<button data-act="viewSale" data-id="${v.originalSaleId}" title="View original sale" style="margin-left:4px;">üìã</button>`:''}</td>`;
    body.appendChild(tr);
    });
  };
  rows('', 'instock');

  function applyVehFilter(){
  const q=(wrap.querySelector('#veh_search') && wrap.querySelector('#veh_search').value) || '';
  
  // Get all checkbox states
  const chkIn=wrap.querySelector('#veh_instock'); 
  const chkSold=wrap.querySelector('#veh_soldonly');
  const chkInvestor=wrap.querySelector('#veh_investoronly');
  const chkPx=wrap.querySelector('#veh_pxonly');
  
  // Determine mode based on checked checkboxes
  let mode = 'all';
  if (chkSold && chkSold.checked) mode = 'sold';
  else if (chkIn && chkIn.checked) mode = 'instock';
  
  // Call rows with all parameters
  rows(q, mode);
  }
  
  const SRCH=wrap.querySelector('#veh_search'); 
  if(SRCH) SRCH.addEventListener('input', applyVehFilter);

  const CHK_IN=wrap.querySelector('#veh_instock'); 
  if(CHK_IN) CHK_IN.addEventListener('change', (e)=>{
  if(e.target.checked){ 
    const s=wrap.querySelector('#veh_soldonly'); 
    if(s) s.checked=false; 
    const inv=wrap.querySelector('#veh_investoronly'); 
    if(inv) inv.checked=false; 
    const px=wrap.querySelector('#veh_pxonly'); 
    if(px) px.checked=false;
    const nr = wrap.querySelector('#veh_notready'); if(nr) nr.checked = false; 
  } 
  applyVehFilter(); 
  });

  const CHK_SOLD=wrap.querySelector('#veh_soldonly'); 
  if(CHK_SOLD) CHK_SOLD.addEventListener('change', (e)=>{ 
  if(e.target.checked){ 
    const s=wrap.querySelector('#veh_instock'); 
    if(s) s.checked=false; 
    const inv=wrap.querySelector('#veh_investoronly'); 
    if(inv) inv.checked=false; 
    const px=wrap.querySelector('#veh_pxonly'); 
    if(px) px.checked=false;
    const nr = wrap.querySelector('#veh_notready'); if(nr) nr.checked = false; 
  } 
  applyVehFilter(); 
  });

  const CHK_INVESTOR=wrap.querySelector('#veh_investoronly'); 
  if(CHK_INVESTOR) CHK_INVESTOR.addEventListener('change', (e)=>{ 
  if(e.target.checked){ 
    const s=wrap.querySelector('#veh_instock'); 
    if(s) s.checked=false; 
    const sold=wrap.querySelector('#veh_soldonly'); 
    if(sold) sold.checked=false; 
    const px=wrap.querySelector('#veh_pxonly'); 
    if(px) px.checked=false;
    const nr = wrap.querySelector('#veh_notready'); if(nr) nr.checked = false; 
  } 
  applyVehFilter(); 
  });

  const CHK_PX=wrap.querySelector('#veh_pxonly'); 
  if(CHK_PX) CHK_PX.addEventListener('change', (e)=>{ 
  if(e.target.checked){ 
    const s=wrap.querySelector('#veh_instock'); 
    if(s) s.checked=false; 
    const sold=wrap.querySelector('#veh_soldonly'); 
    if(sold) sold.checked=false; 
    const inv=wrap.querySelector('#veh_investoronly'); 
    if(inv) inv.checked=false;
    const nr = wrap.querySelector('#veh_notready'); if(nr) nr.checked = false; 
  } 
  applyVehFilter(); 
  });

  const CHK_NR = wrap.querySelector('#veh_notready');
  if(CHK_NR) CHK_NR.addEventListener('change', (e) => {
    if(e.target.checked){
      // Uncheck conflicting modes
      if(wrap.querySelector('#veh_instock')) wrap.querySelector('#veh_instock').checked = false;
      if(wrap.querySelector('#veh_soldonly')) wrap.querySelector('#veh_soldonly').checked = false;
      if(wrap.querySelector('#veh_investoronly')) wrap.querySelector('#veh_investoronly').checked = false;
      if(wrap.querySelector('#veh_pxonly')) wrap.querySelector('#veh_pxonly').checked = false;
    }
    applyVehFilter();
  });

  // NEW: MOT filter change listener
  const MOT_FILTER = wrap.querySelector('#veh_motFilter');
  if(MOT_FILTER) {
    MOT_FILTER.addEventListener('change', applyVehFilter);
  }

  wrap.addEventListener('click',(ev)=>{ const b=ev.target.closest('button'); if(!b) return; const id=b.dataset.id,act=b.dataset.act;
    if(act==='edit'){ 
      if(!canAction('edit')) return alert('No permission'); 
      const v=db.vehicles.find(x=>x.id===id);
      
      ensureVehicleFields(v);

      const rdy = wrap.querySelector('#v_readyForSale');
      const stg = wrap.querySelector('#v_prepStage');
      const rsn = wrap.querySelector('#v_notReadyReason');
      const nts = wrap.querySelector('#v_prepNotes');

      if(rdy) rdy.checked = !!v.readyForSale;
      if(stg) stg.value = v.prepStage || 'None';
      if(rsn) rsn.value = v.notReadyReason || '';
      if(nts) nts.value = v.prepNotes || '';
      
      editId=id;
      
      // Populate all standard fields
      ['v_reg','v_make','v_model','v_colour','v_fuel','v_engineSize','v_mileage','v_purchase',
       'v_purchaseDate','v_firstReg','v_ownerType','v_supplier','v_status','v_vin','v_motExpiry','v_video']
      .forEach(k => {
        const el = wrap.querySelector('#' + k);
        if (!el) return;
        const key = k.replace(/^v_/,'');
        el.value = (v[key] ?? '');
      });

      // Set investor dropdown from investorId (fallback to name)
      const invSel2 = wrap.querySelector('#v_investor');
      if (invSel2) {
        let invId = v.investorId || '';
        if (!invId && v.investor) {
          const found = (db.investors || []).find(i => (i.name || '') === v.investor);
          if (found) invId = found.id;
        }
        invSel2.value = invId || '';
      }
      
      // ADDED: Create hidden fields to preserve part-ex specific data
      // Remove any existing hidden fields first
      ['v_supplierNote', 'v_originalSaleId'].forEach(field => {
        const existing = wrap.querySelector(`#${field}`);
        if (existing) existing.remove();
      });
      
      // Add hidden fields for part-ex data if they exist
      if (v.supplierNote) {
        const hiddenNote = document.createElement('input');
        hiddenNote.type = 'hidden';
        hiddenNote.id = 'v_supplierNote';
        hiddenNote.value = v.supplierNote || '';
        wrap.appendChild(hiddenNote);
      }
      
      if (v.originalSaleId) {
        const hiddenSaleId = document.createElement('input');
        hiddenSaleId.type = 'hidden';
        hiddenSaleId.id = 'v_originalSaleId';
        hiddenSaleId.value = v.originalSaleId || '';
        wrap.appendChild(hiddenSaleId);
      }
      document.getElementById('app').scrollIntoView({ behavior: 'smooth' });

    
    }else if(act==='del'){ 
    if(!canAction('del')) return alert('No permission'); 
    if(!confirm('Delete vehicle?')) return; 
    const delV=db.vehicles.find(x=>x.id===id); 

    // Mark deletion so it syncs to other PCs
    markDeleted('vehicles', id);

    db.vehicles=db.vehicles.filter(x=>x.id!==id); 
    db.vehicleExpenses=db.vehicleExpenses.filter(e=>e.vehicleId!==id); 

    saveDB(); 
    try{renderAlertBell();}catch(e){}; 
    addAudit('delete','vehicle',id,delV?delV.reg:''); 
    rows(); 
    }
    
    else if(act==='viewSale'){
      const sale = db.sales.find(x => x.id === id);
      if(sale) {
        const originalVehicle = db.vehicles.find(x => x.id === sale.vehicleId);
        const buyer = sale.buyer || 'Unknown';
        const saleDate = ddmmyyyy(sale.date);
        const price = fmtMoney(sale.salePrice);
        alert(`Part-ex Source Details:\n\nSold to: ${buyer}\nDate: ${saleDate}\nPrice: ${price}\nVehicle: ${originalVehicle?.reg || ''} ${originalVehicle?.make || ''} ${originalVehicle?.model || ''}\nInvoice #: ${sale.invNo || ''}\nPart-ex Allowance: ${fmtMoney(sale.pxAllowance || 0)}`);
      }
    }
  });

  const motBtn = wrap.querySelector('#v_mot');
  if (motBtn) {
  motBtn.onclick = async () => {

  const reg = (wrap.querySelector('#v_reg').value || '').trim().toUpperCase();
  if (!reg) return alert('Enter REG first');

  // Use DVSA proxy (not DVLA) URL from settings
  const url = db.company.dvsaProxy || '';
  if (!url) return alert('Add DVSA / MOT Proxy URL in Settings first.');

  const btn = motBtn;
  const originalText = btn.textContent;
  btn.textContent = 'Checking MOT...';
  btn.disabled = true;

  // small helper to read a field from multiple possible paths
  const pick = (obj, ...paths) => {
    for (const p of paths) {
      if (!obj) continue;
      // allow nested path arrays like ['raw','make'] or simple string 'make'
      if (Array.isArray(p)) {
        let cur = obj;
        let ok = true;
        for (const k of p) {
          if (cur && (k in cur)) cur = cur[k]; else { ok = false; break; }
        }
        if (ok && cur != null) return cur;
      } else {
        if (p in obj && obj[p] != null) return obj[p];
      }
    }
    return undefined;
  };

  try {
    const res = await fetch(url, {
      method: 'POST',
      headers: { 'content-type': 'application/json' },
      body: JSON.stringify({ reg })
    });

    const text = await res.text();
    if (!res.ok) throw new Error('DVSA error ' + res.status + ': ' + text);

    let data;
    try { data = JSON.parse(text); } catch (e) { alert("DVSA returned invalid JSON"); return; }

    // Accept several possible shapes:
    // - array of vehicle objects
    // - single vehicle object with motTests
    // - object that wraps with .data or .vehicle
    if (!Array.isArray(data)) {
      if (data && typeof data === 'object') {
        if (Array.isArray(data.data)) data = data.data;
        else if (data.vehicle) data = [data.vehicle];
        else if (data.motTests || data.registration) data = [data];
        else if (data.results && Array.isArray(data.results)) data = data.results;
      }
    }

    if (!Array.isArray(data) || data.length === 0) {
      alert(
        "MOT proxy returned wrong format or no data.\n\nGot:\n" +
        JSON.stringify(data, null, 2).slice(0, 500)
      );
      return;
    }

    const vehicle = data[0];

    // tests list may be nested differently; prefer vehicle.motTests or vehicle.tests or vehicle.testsData
    const tests = pick(vehicle, 'motTests', 'tests', ['data','motTests']) || [];
    const latest = Array.isArray(tests) && tests.length ? tests[0] : null;

    // robust field picking: top-level, raw.*, alternative names
    const makeVal = pick(vehicle, 'make', ['raw','make'], 'vehicleMake', 'manufacturer');
    const modelVal = pick(vehicle, 'model', ['raw','model'], 'product', 'vehicleModel');
    const colourVal = pick(vehicle, 'primaryColour', 'colour', ['raw','colour'], 'vehicleColour');
    const fuelVal = pick(vehicle, 'fuelType', 'fuel', ['raw','fuelType']);
    const engineVal = pick(vehicle, 'engineSize', 'engine_size', ['raw','engineSize']);
    const regReturned = pick(vehicle, 'registration', 'reg', 'registrationNumber');
    const vinVal = pick(vehicle, 'vin', ['raw','vin'], 'vehicleIdentificationNumber');

    // first reg handling (various formats)
    if (pick(vehicle, 'registrationDate', ['raw','registrationDate'], 'firstRegistration')) {
      let s = pick(vehicle, 'registrationDate', ['raw','registrationDate'], 'firstRegistration');
      let val = '';
      s = String(s || '').trim();
      if (/^\d{4}-\d{2}$/.test(s)) val = s + '-01';
      else if (/^\d{4}-\d{2}-\d{2}$/.test(s)) val = s;
      else {
        const d = new Date(s);
        if (!isNaN(d)) val = d.toISOString().slice(0,10);
      }
      if (val) {
        const firstRegInput = wrap.querySelector('#v_firstReg');
        if (firstRegInput) firstRegInput.value = val;
      }
    }

    const setField = (selector, value, force = false) => {
      if (value == null || value === '') return;
      const el = wrap.querySelector(selector);
      if (!el) return;
      // If force=true, always overwrite. Otherwise overwrite only if empty.
      if (force || !el.value || String(el.value).trim() === '') el.value = String(value);
    };

    setField('#v_make', makeVal, true);
    setField('#v_model', modelVal || pick(vehicle, 'modelName', ['raw','modelName']), true);
    setField('#v_colour', colourVal ? String(colourVal).toUpperCase() : undefined, true);
    setField('#v_fuel', fuelVal ? String(fuelVal).toUpperCase() : undefined, true);
    setField('#v_engineSize', engineVal ? String(engineVal) : undefined, true);
    setField('#v_vin', vinVal, true);

    // Last MOT details
    if (latest) {
      const newExp = latest.expiryDate || latest.expiry || '';

    // 1) Always update the MOT field on screen
    const motInput = wrap.querySelector('#v_motExpiry');
    if (motInput && newExp) {
      motInput.value = newExp;
    }

    // 2) Also store lastMot* values on found vehicle if it exists in DB
    const found = (db.vehicles || []).find(v => (v.reg || '').toUpperCase() === (regReturned || reg || '').toUpperCase());
    if (found) {
      if (latest.completedDate) found.lastMotDate = latest.completedDate || found.lastMotDate || '';
      if (newExp) {
        found.lastMotExpiry = newExp;
        // ‚úÖ always keep main motExpiry in sync with the latest MOT
        found.motExpiry = newExp;
      }
      if (latest.odometerValue || latest.odometer) {
        found.lastMotMileage = latest.odometerValue || latest.odometer || found.lastMotMileage || '';
      }
      found.updatedAt = new Date().toISOString();
      saveDB();
    }
  }

    // Build friendly message
    let msg = `Reg: ${regReturned || reg}\nMake/Model: ${makeVal || ''} ${modelVal || ''}\n\n`;
    if (latest) {
      msg += `Last MOT: ${latest.completedDate || latest.testDate || ''}\n`;
      msg += `Result: ${latest.testResult || latest.result || ''}\n`;
      msg += `Expiry: ${latest.expiryDate || latest.expiry || ''}\n`;
      msg += `Mileage: ${latest.odometerValue || latest.odometer || ''} ${latest.odometerUnit || latest.odometerUnit || ''}\n`;
    } else {
      msg += 'No MOT tests found.\n';
    }

    alert(msg);

  } catch (e) {
    alert('MOT lookup failed: ' + (e && e.message ? e.message : e));
  } finally {
    btn.textContent = originalText;
    btn.disabled = false;
  }
  };

  // ===== Bulk MOT refresh (All vehicles) =====
    function sleep(ms){ return new Promise(r=>setTimeout(r, ms)); }

    async function fetchLatestMot(reg){
      const url = db.company.dvsaProxy || '';
      if (!url) throw new Error('Add DVSA / MOT Proxy URL in Settings first.');

      const res = await fetch(url, {
        method: 'POST',
        headers: { 'content-type': 'application/json' },
        body: JSON.stringify({ reg })
      });

      const text = await res.text();
      if (!res.ok) throw new Error('DVSA error ' + res.status + ': ' + text);

      let data;
      try { data = JSON.parse(text); } catch(e){ throw new Error('DVSA returned invalid JSON'); }

      // ‚úÖ Accept both array and single-object formats
      if (!Array.isArray(data)) {
        if (data && typeof data === 'object' && data.motTests) data = [data];
        else if (Array.isArray(data.data)) data = data.data; // if your worker wraps: {data:[...]}
      }

      if (!Array.isArray(data) || !data.length) return null;

      const vehicle = data[0];
      const tests = vehicle.motTests || [];
      const latest = tests[0] || null;

      return { vehicle, latest };
    }

    const bulkBtn = wrap.querySelector('#veh_mot_refresh');
    const progEl = wrap.querySelector('#veh_mot_progress');

    if (bulkBtn) {
      bulkBtn.onclick = async () => {
        if (!confirm('Update MOT expiry for ALL vehicles? (This will take a few minutes)')) return;

        try {
          bulkBtn.disabled = true;

          const list = (db.vehicles || [])
            .filter(v => String(v.reg || '').trim())
            // default: only update in-stock vehicles (status not sold)
            .filter(v => String(v.status || '').toLowerCase() !== 'sold');

          let ok = 0, fail = 0, skipped = 0;

          for (let i = 0; i < list.length; i++) {
            const v = list[i];
            const reg = String(v.reg || '').trim().toUpperCase();

            if (progEl) progEl.textContent = `Checking ${i + 1}/${list.length}: ${reg}`;

            try {
              const out = await fetchLatestMot(reg);

              if (!out || !out.latest) { skipped++; }
              else {
                const latest = out.latest;

                v.lastMotDate = latest.completedDate || v.lastMotDate || '';
                v.lastMotExpiry = latest.expiryDate || v.lastMotExpiry || '';
                v.lastMotMileage = latest.odometerValue || v.lastMotMileage || '';

                // ‚úÖ auto-fill main motExpiry so your warnings/filters work everywhere
                v.motExpiry = latest.expiryDate || v.motExpiry || '';

                ok++;
              }
            } catch (e) {
              fail++;
            }

            // ‚úÖ throttle to avoid DVSA/proxy rate limits
            await sleep(1200);
          }

          saveDB();
          try { renderAlertBell(); } catch(e) {}

          alert(`MOT refresh complete.\n\nUpdated: ${ok}\nSkipped (no tests): ${skipped}\nFailed: ${fail}`);
        } finally {
          if (progEl) progEl.textContent = '';
          bulkBtn.disabled = false;
          // refresh the table view
          try { rows(); } catch(e) {}
        }
      };
    }
  }

  wrap.querySelector('#v_add').onclick=()=>{ if(!canAction('add')) return alert('No permission');
  const reg=(wrap.querySelector('#v_reg').value||'').toUpperCase().trim(); if(!reg){ alert('Reg is required'); return; }
  const dupe=(db.vehicles||[]).find(x=>x.reg===reg && x.id!==editId); if(dupe){ alert('Duplicate reg exists'); return; }
  const v={ 
    id:editId||uid(), 
    reg, 
    make:wrap.querySelector('#v_make').value.trim(), 
    model:wrap.querySelector('#v_model').value.trim(), 
    colour:wrap.querySelector('#v_colour').value.trim(), 
    fuel:wrap.querySelector('#v_fuel').value.trim(),
    engineSize:wrap.querySelector('#v_engineSize') ? wrap.querySelector('#v_engineSize').value.trim() : '',
    mileage:Number(wrap.querySelector('#v_mileage').value||0), 
    purchase:Number(wrap.querySelector('#v_purchase').value||0), 
    purchaseDate:wrap.querySelector('#v_purchaseDate').value,
    firstReg:wrap.querySelector('#v_firstReg').value,
    ownerType: wrap.querySelector('#v_ownerType').value,
    // investorId + investor name from dropdown
    ...(() => {
    const sel = wrap.querySelector('#v_investor');
    const invId = (sel && sel.value) || '';
    let invName = '';
    if (invId) {
    const inv = (db.investors || []).find(i => i.id === invId);
    if (inv) invName = inv.name;
    }
    return {
    investorId: invId || null,
    investor: invName // keep name for display / backwards-compat
  };

  if (typeof ensureVehicleFields === 'function') ensureVehicleFields(v);
  if (v.readyForSale) {
    v.prepStage = 'Ready';
    v.notReadyReason = '';
  }

  })(),
  supplier:wrap.querySelector('#v_supplier').value.trim(), 
  // Preserve part-ex specific fields when editing
  supplierNote: wrap.querySelector('#v_supplierNote') ? wrap.querySelector('#v_supplierNote').value : (db.vehicles.find(x=>x.id===editId)?.supplierNote || ''),
  originalSaleId: wrap.querySelector('#v_originalSaleId') ? wrap.querySelector('#v_originalSaleId').value : (db.vehicles.find(x=>x.id===editId)?.originalSaleId || null),
  vin:wrap.querySelector('#v_vin').value.trim(), 
  motExpiry: wrap.querySelector('#v_motExpiry').value || '', // ADDED THIS LINE
  status:wrap.querySelector('#v_status').value,

  readyForSale: !!wrap.querySelector('#v_readyForSale')?.checked,
  prepStage: (wrap.querySelector('#v_prepStage')?.value || 'None'),
  notReadyReason: (wrap.querySelector('#v_notReadyReason')?.value || '').trim(),
  prepNotes: (wrap.querySelector('#v_prepNotes')?.value || '').trim(),

  updatedAt: new Date().toISOString(),
  createdAt:(db.vehicles.find(x=>x.id===editId)?.createdAt)||new Date().toISOString(), 
  lastMotExpiry: (db.vehicles.find(x=>x.id===editId)?.lastMotExpiry) || '', // Preserve DVSA lookup data
  };
    if (!v.motExpiry) {
      v.lastMotExpiry = '';
      v.lastMotDate = '';
      v.lastMotMileage = '';
    }
    if(editId){ const i=db.vehicles.findIndex(x=>x.id===editId); db.vehicles[i]=v; saveDB(); try{renderAlertBell();}catch(e){}; addAudit('update','vehicle',v.id,v.reg+' '+(v.make||'')+' '+(v.model||'')); editId=null; }
    else { db.vehicles.unshift(v); saveDB(); try{renderAlertBell();}catch(e){}; addAudit('add','vehicle',v.id,v.reg+' '+(v.make||'')+' '+(v.model||'')); }
    rows(); ['v_reg','v_make','v_model','v_notReadyReason','v_prepNotes','v_colour','v_fuel','v_engineSize','v_mileage','v_purchase','v_purchaseDate','v_firstReg','v_investor','v_supplier','v_vin','v_motExpiry'].forEach(k=>document.getElementById(k).value='');
    
    document.getElementById('v_prepStage').value='None';
    
    if(document.getElementById('v_readyForSale')) document.getElementById('v_readyForSale').checked = false;

    if(document.getElementById('v_status')) document.getElementById('v_status').value = 'for sale';

    // Clean up hidden fields
    ['v_supplierNote', 'v_originalSaleId'].forEach(field => {
      const el = wrap.querySelector(`#${field}`);
      if (el) el.remove();
    });
  };
  return wrap;
}

// --- Expenses (with REG autocomplete) ---
function viewExpenses(){ if(!canTab('Expenses')) return document.createElement('div'); const wrap=document.createElement('div'); wrap.className='card';
  wrap.innerHTML=`<h2>Expenses (per vehicle)</h2>
  <div class="row">
    <label>Vehicle REG
      <datalist id="e_reg_list">
        ${(db.vehicles||[]).map(v=>`<option value="${(v.reg||'').toUpperCase()}">`).join('')}
      </datalist>
      <input id="e_vehicle" list="e_reg_list" placeholder="Type REG‚Ä¶" style="min-width:220px">
    </label>
    <input id="e_date" type="date"><input id="e_type" placeholder="Type (MOT/Repairs/Delivery/Advertising/Fuel‚Ä¶)"><select id="e_method"><option>bank</option><option>cash</option></select>
    <input id="e_amt" type="number" placeholder="Amount"><input id="e_note" placeholder="Note"><button id="e_add" class="primary">Add</button></div>
  <div class="row"><input id="e_search" placeholder="Search by reg to total (live calc)"></div>
  <div class="small" id="e_totHint"></div>
  <table class="table" style="margin-top:10px"><thead><tr><th>Reg</th><th>Date</th><th>Type</th><th>Method</th><th class="right">Amount</th><th>Note</th><th>Actions</th></tr></thead><tbody id="e_body"></tbody></table>`;
  const ebody=wrap.querySelector('#e_body'); let editId=null;
  function rows(list=db.vehicleExpenses){ ebody.innerHTML=''; list.forEach(e=>{ const v=db.vehicles.find(x=>x.id===e.vehicleId)||{}; const tr=document.createElement('tr');
    tr.innerHTML=`<td>${v.reg||''}</td><td>${ddmmyyyy(e.date)}</td><td>${e.type||''}</td><td>${e.method||'bank'}</td><td class="right">${fmtMoney(e.amount)}</td><td>${e.note||''}</td>
    <td>${canAction('edit')?`<button data-act="edit" data-id="${e.id}">Edit</button>`:''} ${canAction('del')?`<button class="danger" data-act="del" data-id="${e.id}">Delete</button>`:''}</td>`; ebody.appendChild(tr); }); }
  rows();
  wrap.querySelector('#e_add').onclick=()=>{ if(!canAction('add')) return alert('No permission');
    const regInput=(wrap.querySelector('#e_vehicle').value||'').toUpperCase().trim();
    const vid=findVehicleIdByReg(regInput);
    if(!vid){ return alert('Enter a valid REG from the suggestions');
    // ‚úÖ Block duplicate sales (manual typing protection)
    const vCheck = (db.vehicles || []).find(x => x.id === vid);
    const alreadySold = vCheck && String(vCheck.status || '').toLowerCase() === 'sold';
    const alreadyHasSale = (db.sales || []).some(sx => sx.vehicleId === vid && sx.id !== editId);

      if (!editId && (alreadySold || alreadyHasSale)) {
      return alert('This vehicle is already sold. You cannot record another sale for it.');
      }

    }
    const e={id:editId||uid(),vehicleId:vid,date:wrap.querySelector('#e_date').value,type:wrap.querySelector('#e_type').value.trim(),method:wrap.querySelector('#e_method').value,amount:Number(wrap.querySelector('#e_amt').value||0),note:wrap.querySelector('#e_note').value.trim()};
    if(editId){ db.vehicleExpenses=db.vehicleExpenses.map(x=>x.id===editId?e:x); addAudit('update','vehicleExpense',e.id,(db.vehicles.find(x=>x.id===e.vehicleId)||{}).reg+' '+e.type+' '+e.amount); editId=null; }
    else{ db.vehicleExpenses.unshift(e); addAudit('add','vehicleExpense',e.id,(db.vehicles.find(x=>x.id===e.vehicleId)||{}).reg+' '+e.type+' '+e.amount); }
    saveDB(); try{renderAlertBell();}catch(e){}; rows(); wrap.querySelector('#e_type').value=''; wrap.querySelector('#e_amt').value=''; wrap.querySelector('#e_note').value=''; hint();
  };
  wrap.addEventListener('click',(ev)=>{ const b=ev.target.closest('button'); if(!b) return; const id=b.dataset.id,act=b.dataset.act;
  if(act==='del'){ 
    if(!canAction('del')) return alert('No permission'); 
    const delE = db.vehicleExpenses.find(x=>x.id===id); 
    if(!confirm('Delete expense?')) return; 

    // track vehicle expense deletion
    markDeleted('vehicleExpenses', id);

    db.vehicleExpenses = db.vehicleExpenses.filter(x=>x.id!==id); 
    saveDB(); 
    try{renderAlertBell();}catch(e){}; 
    addAudit('delete','vehicleExpense',id,delE?delE.type+' '+delE.amount:''); 
    rows(); 
    hint();
  }
  else if(act==='edit'){ if(!canAction('edit')) return alert('No permission'); const e=db.vehicleExpenses.find(x=>x.id===id); editId=id; const v=db.vehicles.find(x=>x.id===e.vehicleId)||{}; wrap.querySelector('#e_vehicle').value=(v.reg||'').toUpperCase(); wrap.querySelector('#e_date').value=e.date; wrap.querySelector('#e_type').value=e.type||''; wrap.querySelector('#e_method').value=e.method||'bank'; wrap.querySelector('#e_amt').value=e.amount||0; wrap.querySelector('#e_note').value=e.note||''; document.getElementById('app').scrollIntoView({ behavior: 'smooth' });}
  });
  function hint(){ const bal=calcBalances(); wrap.querySelector('#e_totHint').textContent='Live balance after expenses ‚Äî Bank: '+fmtMoney(bal.bank)+' | Cash: '+fmtMoney(bal.cash); }
  hint();
  wrap.querySelector('#e_search').addEventListener('input',(e)=>{ const q=(e.target.value||'').toUpperCase().trim(); if(!q){ rows(); return; } const vids=db.vehicles.filter(v=>(v.reg||'').toUpperCase().includes(q)).map(v=>v.id);
    const filtered=(db.vehicleExpenses||[]).filter(x=>vids.includes(x.vehicleId)); rows(filtered); const tot=filtered.reduce((t,x)=>t+Number(x.amount||0),0); const tr=document.createElement('tr'); tr.innerHTML=`<td colspan="7" class="right"><b>Total for ${q}: ${fmtMoney(tot)}</b></td>`; ebody.appendChild(tr); });
  return wrap;
}

/* ========= Showroom ========= */
function viewShowroom(){ if(!canTab('Showroom')) return document.createElement('div'); const wrap=document.createElement('div'); wrap.className='card';
  wrap.innerHTML=`<h2>Showroom Expenses</h2>
<div class=\"row\"><input id=\"sx_month\" type=\"month\"><button id=\"sx_export\">Export PDF (month)</button></div>
  <div class="row"><input id="s_date" type="date"><input id="s_type" placeholder="Type (Rent/Wages/Web/Insurance‚Ä¶)"><select id="s_method"><option>bank</option><option>cash</option></select>
  <input id="s_amt" type="number" placeholder="Amount"><input id="s_note" placeholder="Note"><button id="s_add" class="primary">Add</button></div>
  <div class="small" id="s_totHint"></div>
  <table class="table" style="margin-top:10px"><thead><tr><th>Date</th><th>Type</th><th>Method</th><th class="right">Amount</th><th>Note</th><th>Actions</th></tr></thead><tbody id="s_body"></tbody></table>`;
  const body=wrap.querySelector('#s_body'); let editId=null; const sxMonth = wrap.querySelector('#sx_month'); if (sxMonth) sxMonth.value = new Date().toISOString().slice(0,7);
  
  function rows(){
    body.innerHTML='';

    const m = (wrap.querySelector('#sx_month')?.value || '').slice(0,7);
    const list = (db.showroomExpenses || [])
      .filter(e => !m || ymStr(e.date) === m)       // ‚úÖ show only selected month; if empty show all
      .sort((a,b) => (b.date||'').localeCompare(a.date||'')); // newest first

    list.forEach(e=>{
      const tr=document.createElement('tr');
      tr.innerHTML=`<td>${ddmmyyyy(e.date)}</td>
        <td>${e.type||''}${e.amount<0?' (credit)':''}</td>
        <td>${e.method||'bank'}</td>
        <td class="right">${e.amount<0?'<span class="bad">'+fmtMoney(e.amount)+'</span>':fmtMoney(e.amount)}</td>
        <td>${e.note||''}</td>
        <td>
          ${canAction('edit')?`<button data-act="edit" data-id="${e.id}">Edit</button>`:''}
          ${canAction('del')?`<button class="danger" data-act="del" data-id="${e.id}">Delete</button>`:''}
        </td>`;
      body.appendChild(tr);
    });
  }
  rows();
  wrap.querySelector('#sx_month')?.addEventListener('change', rows);
  
  // Guarded Showroom Export (single source of truth)
  (function(){
    const sxBtn = wrap.querySelector('#sx_export');
    if(!sxBtn || sxBtn._wired) return;
    sxBtn._wired = true;
    sxBtn.onclick = () => {
      const m = (wrap.querySelector('#sx_month')?.value || '').slice(0,7);
      if(!m) return alert('Pick a month');
      const exp = (db.showroomExpenses||[]).filter(e=>ymStr(e.date)===m);
      const html = '<html><head><meta charset="utf-8"><title>Showroom '+m+'</title>'
        + '<style>body{font:14px system-ui;padding:20px} .right{text-align:right} table{width:100%;border-collapse:collapse} th,td{border:1px solid #ccc;padding:6px}</style></head><body>'
        + '<h2>Showroom Expenses ‚Äî '+m+'</h2>'
        + '<table><thead><tr><th>Date</th><th>Type</th><th>Method</th><th class="right">Amount</th><th>Note</th></tr></thead><tbody>'
        + exp.map(e=>'<tr><td>'+ddmmyyyy(e.date)+'</td><td>'+(e.type||'')+'</td><td>'+(e.method||'')+'</td><td class="right">'+fmtMoney(e.amount)+'</td><td>'+(e.note||'')+'</td></tr>').join('')
        + '</tbody></table>'
        + '<p><b>Total (net):</b> '+fmtMoney(exp.reduce((t,x)=>t+Number(x.amount||0),0))+'</p>'
        + '</body></html>';
      openPrintable(html);
    };
  })();
// Guarded Showroom Export handler (single source)
  (function(){
    const sxBtn = wrap.querySelector('#sx_export');
    if(!sxBtn || sxBtn._wired) return;
    (sxBtn._wired=true); sxBtn.onclick = () => {
      const m = (wrap.querySelector('#sx_month')?.value || '').slice(0,7);
      if(!m) return alert('Pick a month');
      const exp = (db.showroomExpenses||[]).filter(e=>ymStr(e.date)===m);
      const html = '<html><head><meta charset="utf-8"><title>Showroom '+m+'</title>'
        + '<style>body{font:14px system-ui;padding:20px} .right{text-align:right} table{width:100%;border-collapse:collapse} th,td{border:1px solid #ccc;padding:6px}</style></head><body>'
        + '<h2>Showroom Expenses ‚Äî '+m+'</h2>'
        + '<table><thead><tr><th>Date</th><th>Type</th><th>Method</th><th class="right">Amount</th><th>Note</th></tr></thead><tbody>'
        + exp.map(e=>'<tr><td>'+ddmmyyyy(e.date)+'</td><td>'+(e.type||'')+'</td><td>'+(e.method||'')+'</td><td class="right">'+fmtMoney(e.amount)+'</td><td>'+(e.note||'')+'</td></tr>').join('')
        + '</tbody></table>'
        + '<p><b>Total (net):</b> '+fmtMoney(exp.reduce((t,x)=>t+Number(x.amount||0),0))+'</p>'
        + '</body></html>';
      openPrintable(html);
    };
  })();
function hint(){ const bal=calcBalances(); wrap.querySelector('#s_totHint').textContent='Live balance after showroom expenses ‚Äî Bank: '+fmtMoney(bal.bank)+' | Cash: '+fmtMoney(bal.cash); }
  hint();
  wrap.querySelector('#s_add').onclick=()=>{ if(!canAction('add')) return alert('No permission'); const e={id:editId||uid(),date:wrap.querySelector('#s_date').value,type:wrap.querySelector('#s_type').value,method:wrap.querySelector('#s_method').value,amount:Number(wrap.querySelector('#s_amt').value||0),note:wrap.querySelector('#s_note').value};
    if(editId){ db.showroomExpenses=db.showroomExpenses.map(x=>x.id===editId?e:x); addAudit('update','showroomExpense',e.id,e.type+' '+e.amount); editId=null; } else { db.showroomExpenses.unshift(e); addAudit('add','showroomExpense',e.id,e.type+' '+e.amount); }
    saveDB(); try{renderAlertBell();}catch(e){}; rows(); wrap.querySelector('#s_type').value=''; wrap.querySelector('#s_amt').value=''; wrap.querySelector('#s_note').value=''; hint();
  };
  wrap.addEventListener('click',(ev)=>{ const b=ev.target.closest('button'); if(!b) return; const id=b.dataset.id,act=b.dataset.act;
    if(act==='del'){ if(!canAction('del')) return alert('No permission'); const delS=db.showroomExpenses.find(x=>x.id===id); markDeleted('showroomExpenses', id); db.showroomExpenses=db.showroomExpenses.filter(x=>x.id!==id); saveDB(); try{renderAlertBell();}catch(e){}; addAudit('delete','showroomExpense',id,delS?delS.type+' '+delS.amount:''); rows(); hint(); }
    else if(act==='edit'){ if(!canAction('edit')) return alert('No permission'); const e=db.showroomExpenses.find(x=>x.id===id); editId=id; wrap.querySelector('#s_date').value=e.date; wrap.querySelector('#s_type').value=e.type||''; wrap.querySelector('#s_method').value=e.method||'bank'; wrap.querySelector('#s_amt').value=e.amount||0; wrap.querySelector('#s_note').value=e.note||''; document.getElementById('app').scrollIntoView({ behavior: 'smooth' });}
  });
  return wrap;
}

/* ========= Sales ========= */
function viewSales(){ 
  if(!canTab('Sales')) return document.createElement('div'); 
  const wrap=document.createElement('div');

  wrap.className='card';
  
  // ‚úÖ Only show vehicles that are NOT sold and do NOT already have a sale record
  const soldVehicleIds = new Set((db.sales || []).filter(isRealSale).map(s => s.vehicleId));
  const regOptions = (db.vehicles || [])
  .filter(v => v && String(v.status || '').toLowerCase() !== 'sold')
  .filter(v => !soldVehicleIds.has(v.id))
  .map(v => `<option value="${(v.reg || '').toUpperCase()}">`)
  .join('');

  wrap.innerHTML=`<h2>Sales</h2>
  <!-- Search and Filter Section -->
  <div class="row" style="margin-bottom: 16px; padding: 10px; background: rgba(19, 26, 43, 0.5); border-radius: 10px;">
    <div style="display: flex; gap: 12px; align-items: center; flex-wrap: wrap; width: 100%;">
      <div style="flex: 1; min-width: 200px;">
        <label class="small">Search by REG, Customer, or Invoice #</label>
        <input id="sales_search" placeholder="Type to search..." style="width: 100%;">
      </div>
      <div style="flex: 1; min-width: 200px;">
        <label class="small">Filter by Month</label>
        <input id="sales_month" type="month" style="width: 100%;">
      </div>
      <div style="min-width: 220px;">
        <label class="small">
          <input id="sales_show_pending" type="checkbox" style="margin-right: 6px;">
          Show Proforma / Cancelled / Unwound
        </label>
      </div>
      <div style="display: flex; gap: 8px; align-items: flex-end;">
        <button id="sales_clear_search" style="margin-top: 20px;">Clear Search</button>
        <button id="sales_clear_month" style="margin-top: 20px;">Show All Time</button>
        <button onclick="exportSalesCSV()" style="margin-top: 20px;">Export CSV</button>
      </div>
    </div>
  </div>

  <button id="sales_debtors">Debtors</button>
  <div id="sales_debtors_out" style="margin-top:10px;"></div>
  
  <!-- Sale Entry Form -->
  <div class="row">
    <label>Vehicle REG<datalist id="sale_reg_list">${regOptions}</datalist><input id="sale_reg" list="sale_reg_list" placeholder="Type REG to select vehicle"></label>
    <div id="sale_vehicleInfo" class="small" style="color:#9fb4ff; margin-left:6px;">
      Select a reg to see vehicle details
    </div>
    <div id="sale_costProfitInfo" class="small" style="color:#9fb4ff; margin-left:6px; margin-top:4px;"></div>
    <label>Sale Date<input id="sale_date" type="date"></label>
    <label>Customer Name<input id="sale_buyer" placeholder="Customer name"></label>
    <label>Customer Address<input id="sale_addr" placeholder="Address"></label>
    <label>Phone<input id="sale_phone" placeholder="Phone"></label>
    <label>Email<input id="sale_email" placeholder="Email"></label>
    <label>Mileage at Sale<input id="sale_mileage" type="number" placeholder="0"></label>
    <label>Date of First Reg<input id="sale_firstReg" type="date"></label>
  </div>
  <div class="row">
    <label>Sale Price ¬£<input id="sale_price" type="number" placeholder="0"></label>
    <label>Deposit ¬£<input id="sale_dep" type="number" placeholder="0"></label>
    <label>Cash ¬£<input id="sale_cash" type="number" placeholder="0"></label>
    <label>Card ¬£<input id="sale_card" type="number" placeholder="0"></label>
    <label>Bank Transfer ¬£<input id="sale_bank" type="number" placeholder="0"></label>
    <label>Finance ¬£<input id="sale_fin" type="number" placeholder="0"></label>
    <label>Finance Admin Fee ¬£<input id="sale_finFee" type="number" placeholder="0"></label>
    <label>Payout status<select id="sale_finPayout" placeholder="Status"><option value="">Unpaid</option><option value="paid">Paid</option></select></label>
    <label>Payout Date<input id="sale_finPayoutDate" type="date"></label>
    <label>Payout Amount ¬£<input id="sale_finPayoutAmount" type="number" placeholder="0"></label>
    <label>PX Allowance ¬£<input id="sale_pxAllowance" type="number" placeholder="0"></label>
    <label>Total Paid ¬£<input id="sale_totalPaid" type="number" readonly></label>
    <label>Balance Due ¬£<input id="sale_balanceDue" type="number" readonly></label>
    <label>Status<input id="sale_payStatus" readonly></label>
    <button id="auto_balance">Auto-balance</button><span id="sale_warn" class="small"></span>
  </div>
  <div class="row">
    <label>Part-ex Notes<input id="sale_partex" style="min-width:320px" placeholder="Optional notes"></label>
    <label>PX Reg<input id="sale_pxReg" placeholder="AB12CDE"></label>
    <label>PX Make<input id="sale_pxMake" placeholder="Make"></label>
    <label>PX Model<input id="sale_pxModel" placeholder="Model"></label>
    <label>Finance Company<input id="sale_finCo" placeholder="Finance company"></label>
    <label>Agreement #<input id="sale_agree" placeholder="Agreement #"></label>
    <label>Deliver To<input id="sale_deliver" placeholder="Name/address"></label>
    <label>Keys<input id="sale_keys" placeholder="e.g. 2 keys"></label>
    <label>MOT Expiry<input id="sale_mot" type="date" placeholder="e.g. 2025-11-30"></label>
    <label>Service History<input id="sale_sh" placeholder="Full / Part / None"></label>
    <label>Invoice # (optional)<input id="sale_invNo" placeholder="Leave blank for auto" maxlength="5" inputmode="numeric"></label>
    <label>Sale Type
      <select id="sale_status">
        <option value="completed" selected>Completed Sale (customer bought car)</option>
        <option value="proforma">Proforma / Finance Quote (NOT sold yet)</option>
        <option value="cancelled">Cancelled / Finance Declined</option>
        <option value="unwound">Unwound / Refunded (car returned)</option>
      </select>
    </label>
    <label>Warranty Type
      <select id="sale_warrantyType">
        <option value="">None / Not set</option>
        <option value="In-house">In-house Warranty</option>
        <option value="Third-Party">Third-Party Warranty</option>
        <option value="Manufacturer">Manufacturer</option>
      </select>
    </label>
    <label>Warranty Provider<input id="sale_warrantyProvider" placeholder="Handler / RAC / etc"></label>
    <label>Warranty Months<input id="sale_warrantyMonths" type="number" placeholder="e.g. 3"></label>
    <label>Warranty Policy #<input id="sale_warrantyPolicy" placeholder="Policy number"></label>
    
    <label>Lead Source
      <select id="sale_lead">
        <option value="">Not set</option>
        <option value="AutoTrader">AutoTrader</option>
        <option value="Website">Website</option>
        <option value="Walk-in">Walk-in</option>
        <option value="Facebook">Facebook</option>
        <option value="AA Cars">AA Cars</option>
        <option value="Gumtree">Gumtree</option>
        <option value="Referral">Referral</option>
        <option value="Other">Other</option>
      </select>
    </label>
    
    <button id="sale_add" class="primary">Record / Update</button>
  </div>

  <table class="table" style="margin-top:10px">
    <thead>
      <tr>
        <th>Date</th>
        <th>Reg</th>
        <th>Customer</th>
        <th class="right">Price</th>
        <th>Breakdown</th>
        ${canProfit()?'<th class="right">Total Cost</th><th class="right">Profit</th>':''}
        <th>Payout</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody id="sale_body"></tbody>
  </table>

  <div id="sales_summary" class="small" style="margin-top: 10px; padding: 8px; background: var(--card); border-radius: 8px;"></div>

  <!-- üîª Proforma / Cancelled / Unwound list (does NOT affect totals) -->
  <div id="proforma_box" class="small" style="margin-top:16px;padding:8px;background:rgba(5,15,35,0.8);border-radius:8px;display:none;">
    <div style="font-weight:600;margin-bottom:6px;">
      Proforma / Cancelled / Unwound deals (do NOT count in sales totals)
    </div>
    <table class="table small">
      <thead>
        <tr>
          <th>Date</th>
          <th>Reg</th>
          <th>Customer</th>
          <th>Status</th>
          <th class="right">Price</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="proforma_body"></tbody>
    </table>
  </div>
  `;
  
  let editId=null; 
  const body=wrap.querySelector('#sale_body');
    let currentFilter = {
    search: '',
    month: '',          // Empty by default instead of current month
    showPending: false  // Proforma / Cancelled / Unwound
  };
  
  // Set default month to empty (show all time)
  wrap.querySelector('#sales_month').value = currentFilter.month;
  
    function getFilteredSales() {
    let sales = (db.sales || []).filter(s => {
      if (!s) return false;
      const st = String(s.status || 'completed').toLowerCase();

      // Always show completed sales (whether refunded or not)
      if (st === 'completed') return true;

      // Only show Proforma / Cancelled / Unwound if toggle is ON
      if (currentFilter.showPending) {
        return st === 'proforma' || st === 'cancelled' || st === 'unwound';
      }

      return false;
    });

    // Apply month filter if specified
    if (currentFilter.month) {
      sales = sales.filter(s => ymStr(s.date) === currentFilter.month);
    }

    // Apply search filter if specified
    if (currentFilter.search) {
      const searchTerm = currentFilter.search.toLowerCase();
      sales = sales.filter(s => {
        const v = (db.vehicles || []).find(x => x.id === s.vehicleId) || {};
        return (
          (v.reg || '').toLowerCase().includes(searchTerm) ||
          (s.buyer || '').toLowerCase().includes(searchTerm) ||
          String(s.invNo || '').toLowerCase().includes(searchTerm) ||
          (s.phone || '').toLowerCase().includes(searchTerm) ||
          (s.email || '').toLowerCase().includes(searchTerm)
        );
      });
    }

    sales.sort((a, b) => {
      const stA = String(a.status || 'completed').toLowerCase();
      const stB = String(b.status || 'completed').toLowerCase();

      const pendA = (stA === 'proforma' || stA === 'cancelled' || stA === 'unwound');
      const pendB = (stB === 'proforma' || stB === 'cancelled' || stB === 'unwound');

      // If toggle is ON: pending group at the top
      if (currentFilter.showPending && pendA !== pendB) {
        return pendA ? -1 : 1;   // pending rows first
      }

      // Inside each group, sort by date (newest first)
      if (!a.date && !b.date) return 0;
      if (!a.date) return 1;
      if (!b.date) return -1;
      return String(b.date).localeCompare(String(a.date));
    });

    return sales;
  }

  const debtBtn = wrap.querySelector('#sales_debtors');
  if(debtBtn){
    debtBtn.onclick = ()=>{
      // backfill if older sales missing fields
      backfillSaleDebtors();

      const list = (db.sales||[])
        .filter(s => isRealSale ? isRealSale(s) : true)
        .filter(s => Number(s.balanceDue||0) > 0.01)
        .sort((a,b)=> Number(b.balanceDue||0) - Number(a.balanceDue||0));

      const total = list.reduce((t,s)=> t + Number(s.balanceDue||0), 0);

      const rows = list.map(s=>{
        const v = (db.vehicles||[]).find(x=>x.id===s.vehicleId) || {};
        return `<tr>
          <td>${s.date||''}</td>
          <td>${s.invNo||''}</td>
          <td>${v.reg||''}</td>
          <td>${s.buyer||''}</td>
          <td class="right">${fmtMoney(Number(s.salePrice||0))}</td>
          <td class="right">${fmtMoney(Number(s.totalPaid||0))}</td>
          <td class="right"><b>${fmtMoney(Number(s.balanceDue||0))}</b></td>
          <td>${s.payStatus||''}</td>
        </tr>`;
      }).join('');

      const out = wrap.querySelector('#sales_debtors_out');
      if(out){
        out.innerHTML = `
          <div><b>Total Outstanding:</b> ${fmtMoney(total)}</div>
          <table class="tbl">
            <tr><th>Date</th><th>Inv</th><th>Reg</th><th>Customer</th><th>Sale</th><th>Paid</th><th>Due</th><th>Status</th></tr>
            ${rows || '<tr><td colspan="8">No debtors üéâ</td></tr>'}
          </table>`;
      }
    };
  }

  // ===== Option 8: Live Cost/Profit preview on Sales form =====
  function updateSaleCostProfitPreview(){
    const out = wrap.querySelector('#sale_costProfitInfo');
    if(!out) return;

    const reg = wrap.querySelector('#sale_reg')?.value || '';
    const v = findVehicleByReg(reg);

    if(!v){
      out.innerHTML = '';
      return;
    }

    const cost = vehicleTotalCostByVehicleId(v.id);
    const salePrice = Number(wrap.querySelector('#sale_price')?.value || 0);
    const gross = salePrice - cost.total;

    out.innerHTML =
      `Total Cost: <b>${fmtMoney(cost.total)}</b> ` +
      `(Purchase ${fmtMoney(cost.purchase)} + Exp ${fmtMoney(cost.exp)})` +
      ` &nbsp; | &nbsp; Gross: <b>${fmtMoney(gross)}</b>`;
  }

  // Hook to REG + sale price inputs
  (function(){
    const regEl = wrap.querySelector('#sale_reg');
    const priceEl = wrap.querySelector('#sale_price');

    if(regEl) regEl.addEventListener('input', updateSaleCostProfitPreview);
    if(regEl) regEl.addEventListener('change', updateSaleCostProfitPreview);
    if(priceEl) priceEl.addEventListener('input', updateSaleCostProfitPreview);

    // Run once on Sales tab load
    updateSaleCostProfitPreview();
  })();

  function backfillSaleDebtors(){
    let changed = false;
    (db.sales||[]).forEach(s=>{
      if(!s) return;
      if(s.totalPaid!=null && s.balanceDue!=null && s.payStatus) return;

      const salePrice = Number(s.salePrice||0);
      const totalPaid = Number(s.deposit||0)+Number(s.cash||0)+Number(s.card||0)+Number(s.bank||0)+Number(s.finance||0)+Number(s.pxAllowance||0);
      const balanceDue = salePrice - totalPaid;

      let status = '';
      if(salePrice > 0){
        if(balanceDue <= 0.01) status = 'PAID';
        else if(totalPaid > 0) status = 'PART PAID';
        else status = 'DUE';
      }

      s.totalPaid = Math.round(totalPaid*100)/100;
      s.balanceDue = Math.round(balanceDue*100)/100;
      s.payStatus = status;
      changed = true;
    });
    if(changed) saveDB();
  }

  function _num(wrap, id){
    const el = wrap.querySelector(id);
    if(!el) return 0;
    const v = Number(el.value || 0);
    return isNaN(v) ? 0 : v;
  }

  // calculate payment summary from SALES form
  function calcSalePaymentSummary(wrap){
    const salePrice   = _num(wrap, '#sale_price');
    const deposit     = _num(wrap, '#sale_dep');
    const cash        = _num(wrap, '#sale_cash');
    const card        = _num(wrap, '#sale_card');
    const bank        = _num(wrap, '#sale_bank');
    const finance     = _num(wrap, '#sale_fin');
    const pxAllowance = _num(wrap, '#sale_pxAllowance');

    // pxAllowance reduces what the customer owes, so count it as paid value
    const totalPaid = deposit + cash + card + bank + finance + pxAllowance;
    const balanceDue = salePrice - totalPaid;

    let status = '';
    if(salePrice > 0){
      if(balanceDue <= 0.01) status = 'PAID';
      else if(totalPaid > 0) status = 'PART PAID';
      else status = 'DUE';
    }

    // fill fields if exist
    const tp = wrap.querySelector('#sale_totalPaid');
    const bd = wrap.querySelector('#sale_balanceDue');
    const ps = wrap.querySelector('#sale_payStatus');
    if(tp) tp.value = (Math.round(totalPaid * 100) / 100);
    if(bd) bd.value = (Math.round(balanceDue * 100) / 100);
    if(ps) ps.value = status;

    return { totalPaid, balanceDue, status };
  }

  // hook inputs (safe)
  function hookSalePaymentSummary(wrap){
    const ids = ['#sale_price','#sale_dep','#sale_cash','#sale_card','#sale_bank','#sale_fin','#sale_pxAllowance'];
    ids.forEach(sel=>{
      const el = wrap.querySelector(sel);
      if(el) el.addEventListener('input', ()=> calcSalePaymentSummary(wrap));
    });
    calcSalePaymentSummary(wrap);
  }

  hookSalePaymentSummary(wrap);

  // Add function to clear the form
  function clearSaleForm() {
    const fields = [
      '#sale_reg', '#sale_date', '#sale_buyer', '#sale_addr', '#sale_phone',
      '#sale_email', '#sale_mileage', '#sale_firstReg', '#sale_price',
      '#sale_dep', '#sale_cash', '#sale_card', '#sale_bank', '#sale_fin',
      '#sale_pxAllowance', '#sale_partex', '#sale_pxReg', '#sale_pxMake',
      '#sale_pxModel', '#sale_finCo', '#sale_agree', '#sale_deliver',
      '#sale_keys', '#sale_mot', '#sale_sh', '#sale_invNo', '#sale_warrantyType',
      '#sale_warrantyProvider', '#sale_warrantyMonths', '#sale_warrantyPolicy',
      '#sale_finFee', '#sale_finPayoutAmount', '#sale_finPayoutDate', '#sale_finPayout'
    ];
    
    fields.forEach(selector => {
      const el = wrap.querySelector(selector);
      if (el) el.value = '';
    });

    // ‚≠ê NEW: reset Lead Source dropdown
    const leadEl = wrap.querySelector('#sale_lead');
    if (leadEl) leadEl.value = '';

    // Optionally reset sale status back to "completed"
    const stField = wrap.querySelector('#sale_status');
    if (stField) stField.value = 'completed';

    // Clear warning message
    const warnEl = wrap.querySelector('#sale_warn');
    if (warnEl) warnEl.textContent = '';
  
    // üî¢ Set next invoice number so user can see it
    const invEl = wrap.querySelector('#sale_invNo');
    if (invEl) {
      invEl.value = getNextInvoiceNo();
    }

    // Reset edit ID
    editId = null;
  }
  
  function rows(){ 
    const filteredSales = getFilteredSales();
    body.innerHTML=''; 
    
    if (filteredSales.length === 0) {
      const tr = document.createElement('tr');
      tr.innerHTML = `<td colspan="${canProfit() ? 8 : 6}" class="small" style="text-align: center; padding: 20px;">
        No sales found${currentFilter.search ? ' for "' + currentFilter.search + '"' : ''}${currentFilter.month ? ' in ' + currentFilter.month : ''}
      </td>`;
      body.appendChild(tr);
    } else {
      filteredSales.forEach(s => { 
        const v = db.vehicles.find(x => x.id === s.vehicleId) || {}; 
        const vexp = (db.vehicleExpenses||[])
          .filter(e => e.vehicleId === s.vehicleId)
          .reduce((t,x) => t + Number(x.amount||0), 0);

        const totalCost = (s.vehicleTotalCostAtSale != null && s.vehicleTotalCostAtSale !== '')
          ? Number(s.vehicleTotalCostAtSale || 0)
          : (Number(v.purchase||0) + vexp);

        const profit = Number(s.salePrice||0) - totalCost; 

        const br = `¬£${Number(s.deposit||0).toFixed(2)} dep, ¬£${Number(s.cash||0).toFixed(2)} cash, ¬£${Number(s.card||0).toFixed(2)} card, ¬£${Number(s.bank||0).toFixed(2)} bank, ¬£${Number(s.finance||0).toFixed(2)} finance, PX ¬£${Number(s.pxAllowance||0).toFixed(2)}`;
        const partexVehicle = (db.vehicles||[]).find(vv => vv.originalSaleId === s.id);
        const partexInfo = partexVehicle
          ? `<br><small style="color:#53a8ff;">PX: ${partexVehicle.reg} (in stock)</small>`
          : '';
        
        const st = s.status || 'completed';
        let statusBadge = '';
        if (st && st !== 'completed') {
          const nice = (st === 'proforma')  ? 'PROFORMA'
                    : (st === 'cancelled') ? 'CANCELLED'
                    : (st === 'unwound')   ? 'UNWOUND'
                    : String(st).toUpperCase();
          const col = (st === 'proforma')  ? '#f1c40f'
                    : (st === 'cancelled') ? '#e67e22'
                    : (st === 'unwound')   ? '#e74c3c'
                    : '#999';
          statusBadge = `<br><span style="font-size:11px;color:${col};font-weight:600;">${nice}</span>`;
        }

        // Extra badge if this sale has been refunded
        if (s.refunded) {
          statusBadge += `<br><span style="font-size:11px;color:#e74c3c;font-weight:600;">REFUNDED</span>`;
        }

        const payoutPaid = !!s.financePayoutPaid;
        const payoutDate = s.financePayoutDate || '';
        const payoutAmount = Number(s.financePayoutAmount || 0);
        const payoutDisplay = payoutPaid ? `‚úÖ Paid ${ddmmyyyy(payoutDate)} ${fmtMoney(payoutAmount)}` : '‚ùå Unpaid';
        const payoutActionBtn = `<button data-act="togglePayout" data-id="${s.id}">${payoutPaid ? 'Mark unpaid' : 'Mark paid'}</button>`;
      
        // üîπ Main sale row
        const tr = document.createElement('tr'); 
        tr.innerHTML = `<td>${ddmmyyyy(s.date)}</td>
          <td>${v.reg||''}</td>
          <td>${s.buyer||''}${statusBadge}</td>
          <td class="right">${fmtMoney(s.salePrice)}</td>
          <td>${br}${partexInfo}</td>
          ${canProfit()? ('<td class="right">'+fmtMoney(totalCost)+'</td><td class="right"><b>'+fmtMoney(profit)+'</b></td>'): ''}
          <td>
            ${payoutDisplay}<br>${payoutActionBtn}</td>
            <button data-act="inv" data-id="${s.id}">Invoice</button>
            <button data-act="proforma" data-id="${s.id}">Finance Proforma</button>
            ${canAction('edit')?`<button data-act="edit" data-id="${s.id}">Edit</button>`:''}
            ${canAction('del')?` <button class="danger" data-act="del" data-id="${s.id}">Delete</button>`:''}
          </td>`; 
        body.appendChild(tr); 

        // üîª Extra rows for Refund / Credit Note linked to this sale
        const regUpper = (v.reg || '').toUpperCase();
        const relatedCredits = (db.credits || []).filter(cr => {
          if (!cr) return false;
          if (cr.type !== 'refund' && cr.type !== 'credit_note') return false;
          if (cr.saleId && cr.saleId === s.id) return true;
          if (cr.vehicle && cr.vehicle.toUpperCase() === regUpper) return true;
          return false;
        });

        // Show newest credit first under the sale
        relatedCredits.sort((a,b) => {
          if (!a.date && !b.date) return 0;
          if (!a.date) return 1;
          if (!b.date) return -1;
          return b.date.localeCompare(a.date);
        });

        relatedCredits.forEach(cr => {
          const label = cr.type === 'credit_note' ? 'Credit Note' : 'Refund';
          const trCr = document.createElement('tr');
          trCr.innerHTML = `
            <td>${ddmmyyyy(cr.date || '')}</td>
            <td>${regUpper}</td>
            <td>${cr.customer || s.buyer || ''}</td>
            <td class="right" style="color:#e74c3c;font-weight:600;">-${fmtMoney(cr.amount || 0)}</td>
            <td>
              <span style="font-size:11px;background:#e74c3c;color:#fff;padding:2px 6px;border-radius:4px;margin-right:6px;">
                ${label}
              </span>
              ${cr.reason || ''}
            </td>
            ${canProfit()?'<td class="right"></td>':''}
            <td>
              <button onclick="printCreditInvoice('${cr.id}')">Print ${label}</button>
            </td>`;
          body.appendChild(trCr);
        });
      });
    }
    
    // Update summary
    updateSummary();
    renderProformaList();
  }

  // üîµ Show Make / Model when selecting REG
  (function(){
    const regInput = wrap.querySelector('#sale_reg');
    const info = wrap.querySelector('#sale_vehicleInfo');

    function updateVehicleInfo(){
      const reg = (regInput.value || '').trim().toUpperCase();
      if(!reg){
        info.textContent = 'Select a reg to see vehicle details';
        return;
      }

      const v = (db.vehicles || []).find(x => (x.reg||'').toUpperCase() === reg);
      if(!v){
        info.textContent = 'Vehicle not found in stock';
        return;
      }

      info.textContent =
        `${v.make || ''} ${v.model || ''} | `
        + `Colour: ${v.colour || 'N/A'} | `
        + `Mileage: ${v.mileage || 0}`;
    }

    regInput.addEventListener('input', updateVehicleInfo);
    regInput.addEventListener('change', updateVehicleInfo);
  })();
  
  function updateSummary() {
    const allSales = getFilteredSales();          // includes refunded
    const realSales = allSales.filter(isRealSale); // completed + not refunded
    const totalSales = realSales.reduce((sum, s) => sum + Number(s.salePrice || 0), 0);
    const summary = wrap.querySelector('#sales_summary');
  
    let summaryText = `Showing ${realSales.length} completed sale${realSales.length !== 1 ? 's' : ''}`;
    if (currentFilter.month) {
      summaryText += ` for ${currentFilter.month}`;
    } else {
      summaryText += ` (all time)`;
    }
    if (currentFilter.search) {
      summaryText += ` matching "${currentFilter.search}"`;
    }

    const refundedCount = allSales.length - realSales.length;
    if (refundedCount > 0) {
      summaryText += ` &nbsp; | &nbsp; <span style="color:#e74c3c;">${refundedCount} refunded sale${refundedCount !== 1 ? 's' : ''} shown below (not included in totals)</span>`;
    }

    summaryText += ` &nbsp; | &nbsp; Total Sales: <b>${fmtMoney(totalSales)}</b>`;
    summary.innerHTML = summaryText;
  }

  // Build Proforma / Cancelled / Unwound list (no effect on totals)
  function getPendingSalesForList() {
    let sales = (db.sales || []).filter(s => {
      if (!s) return false;
      const st = String(s.status || '').toLowerCase();
      return st === 'proforma' || st === 'cancelled' || st === 'unwound';
    });

    // Same month filter as main list
    if (currentFilter.month) {
      sales = sales.filter(s => ymStr(s.date) === currentFilter.month);
    }

    // Same search filter as main list
    if (currentFilter.search) {
      const term = currentFilter.search.toLowerCase();
      sales = sales.filter(s => {
        const v = (db.vehicles || []).find(x => x.id === s.vehicleId) || {};
        return (
          (v.reg || '').toLowerCase().includes(term) ||
          (s.buyer || '').toLowerCase().includes(term) ||
          String(s.invNo || '').toLowerCase().includes(term) ||
          (s.phone || '').toLowerCase().includes(term) ||
          (s.email || '').toLowerCase().includes(term)
        );
      });
    }

    // Newest first
    sales.sort((a,b) => {
      if (!a.date && !b.date) return 0;
      if (!a.date) return 1;
      if (!b.date) return -1;
      return String(b.date).localeCompare(String(a.date));
    });

    return sales;
  }

  function renderProformaList() {
    const box   = wrap.querySelector('#proforma_box');
    const tbody = wrap.querySelector('#proforma_body');
    if (!box || !tbody) return;

    const sales = getPendingSalesForList();

    if (!sales.length) {
      box.style.display = 'none';
      tbody.innerHTML = '';
      return;
    }

    box.style.display = 'block';
    tbody.innerHTML = '';

    sales.forEach(s => {
      const v = (db.vehicles || []).find(x => x.id === s.vehicleId) || {};
      const st = String(s.status || '').toLowerCase();

      const nice = (st === 'proforma')  ? 'PROFORMA'
                 : (st === 'cancelled') ? 'CANCELLED'
                 : (st === 'unwound')   ? 'UNWOUND'
                 : String(st).toUpperCase();

      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${ddmmyyyy(s.date)}</td>
        <td>${v.reg || ''}</td>
        <td>${s.buyer || ''}</td>
        <td>${nice}</td>
        <td class="right">${fmtMoney(s.salePrice)}</td>
        <td>
          <button data-act="inv" data-id="${s.id}">Invoice</button>
          <button data-act="proforma" data-id="${s.id}">Finance Proforma</button>
          ${canAction('edit') ? `<button data-act="edit" data-id="${s.id}">Edit</button>` : ''}
          ${canAction('del')  ? ` <button class="danger" data-act="del" data-id="${s.id}">Delete</button>` : ''}
        </td>
      `;
      tbody.appendChild(tr);
    });
  }
  
  // Auto-fill "Date of First Reg" when entering the vehicle REG
  const vehicleRegInput = wrap.querySelector('#sale_reg');
  const firstRegInput = wrap.querySelector('#sale_firstReg');
  const saleMotInput = wrap.querySelector('#sale_mot');

    if (vehicleRegInput && firstRegInput) {
    vehicleRegInput.addEventListener('input', () => {
    const regInput = vehicleRegInput.value.trim().toUpperCase(); // Get entered REG
    const vehicle = (db.vehicles || []).find(v => (v.reg || '').toUpperCase() === regInput);
    if (vehicle && vehicle.firstReg) {
      firstRegInput.value = vehicle.firstReg; // Set the Date of First Reg field
    } else {
      firstRegInput.value = ''; // Clear if no matching vehicle found
    }

    if (saleMotInput) {
      if (vehicle && (vehicle.motExpiry || vehicle.lastMotExpiry)) {
        saleMotInput.value = vehicle.motExpiry || vehicle.lastMotExpiry || '';
      } else {
        saleMotInput.value = '';
      }
    }
  });
  }

  // Event listeners for search and filter
  wrap.querySelector('#sales_search').addEventListener('input', function(e) {
    currentFilter.search = e.target.value.trim();
    rows();
  });
  
  wrap.querySelector('#sales_month').addEventListener('change', function(e) {
    currentFilter.month = e.target.value || '';
    rows();
  });
  
  wrap.querySelector('#sales_clear_search').onclick = function() {
    wrap.querySelector('#sales_search').value = '';
    currentFilter.search = '';
    rows();
  };
  
  wrap.querySelector('#sales_clear_month').onclick = function() {
    wrap.querySelector('#sales_month').value = '';
    currentFilter.month = '';
    rows();
  };

  const pendingToggle = wrap.querySelector('#sales_show_pending');
  if (pendingToggle) {
    pendingToggle.addEventListener('change', function(e) {
      currentFilter.showPending = !!e.target.checked;
      rows();
    });
  }

  function getNums(){ return { price:Number(wrap.querySelector('#sale_price').value||0), dep:Number(wrap.querySelector('#sale_dep').value||0), cash:Number(wrap.querySelector('#sale_cash').value||0), card:Number(wrap.querySelector('#sale_card').value||0), bank:Number(wrap.querySelector('#sale_bank').value||0), fin:Number(wrap.querySelector('#sale_fin').value||0), px:Number(wrap.querySelector('#sale_pxAllowance').value||0) }; }
  function updateWarn(){ const {price,dep,cash,card,bank,fin,px}=getNums(); const sum=dep+cash+card+bank+fin+px; const w=wrap.querySelector('#sale_warn'); if(sum===price){ w.textContent='OK: payments + PX match price'; w.style.color=''; } else { const diff=price-sum; w.textContent='Remaining difference: '+fmtMoney(diff); w.style.color=diff===0?'':(diff<0?'#ffb3b3':''); } }
  ['#sale_price','#sale_dep','#sale_cash','#sale_card','#sale_bank','#sale_fin','#sale_pxAllowance'].forEach(sel=> wrap.querySelector(sel).addEventListener('input',updateWarn));
  wrap.querySelector('#auto_balance').onclick=()=>{ const {price,dep,cash,card,bank,px}=getNums(); const paid=dep+cash+card+bank+px; const fin=Math.max(0,price-paid); wrap.querySelector('#sale_fin').value=fin; updateWarn(); };

  wrap.addEventListener('click',(ev)=>{ const b=ev.target.closest('button'); if(!b)return; const s=db.sales.find(x=>x.id===b.dataset.id);
    if(b.dataset.act==='del'){ if(!canAction('del')) return alert('No permission');
    if(!confirm('Delete this sale? Vehicle will go back to stock.')) return; 
    if(s){ 
      // Also delete any associated part-ex vehicle
      const pxVehicle = (db.vehicles||[]).find(v => v.originalSaleId === s.id);
      if(pxVehicle) {
        // track PX vehicle deletion
        markDeleted('vehicles', pxVehicle.id);
        db.vehicles = db.vehicles.filter(v => v.id !== pxVehicle.id);
        db.vehicleExpenses = db.vehicleExpenses.filter(e => e.vehicleId !== pxVehicle.id);
      }

      const v = db.vehicles.find(x=>x.id===s.vehicleId); 
      if(v) v.status = 'for sale'; 

      // track sale deletion
      markDeleted('sales', s.id);
      db.sales = db.sales.filter(x=>x.id!==s.id); 

      saveDB();
      try{renderAlertBell();}catch(e){}; 
      addAudit('delete','sale',s.id,(v?v.reg:'')+' inv '+(s.invNo||'') + (pxVehicle ? ' and PX ' + pxVehicle.reg : '')); 
      rows(); 
    }
    }

    else if (b.dataset.act === 'togglePayout') {
      if (!canAction('edit')) return alert('No permission');
      const saleId = b.dataset.id;
      const s = db.sales.find(x => x.id === saleId);
      if (!s) return;
      if (s.financePayoutPaid) {
        // mark unpaid
        if (!confirm('Mark finance payout UNPAID for invoice ' + (s.invNo || '') + '?')) return;
        s.financePayoutPaid = false;
        s.financePayoutDate = '';
        s.financePayoutAmount = 0;
        addAudit('update', 'sale', s.id, 'Marked finance payout UNPAID');
      } else {
        // mark paid - ask for date and amount
        const d = prompt('Payout date (YYYY-MM-DD) or leave blank for today', new Date().toISOString().slice(0,10));
        if (d === null) return; // cancelled
        const aRaw = prompt('Payout amount (numeric)', String(Number(s.finance || 0)));
        if (aRaw === null) return;
        const a = Number(aRaw || 0);
        s.financePayoutPaid = true;
        s.financePayoutDate = d || new Date().toISOString().slice(0,10);
        s.financePayoutAmount = a;
        addAudit('update', 'sale', s.id, `Marked finance payout PAID ${s.financePayoutDate} ${fmtMoney(a)}`);
      }
      saveDB();
      try { renderAlertBell(); } catch(_) {}
      rows(); // refresh sales table
    }
  
    else if(b.dataset.act==='edit'){ 
      if(!canAction('edit')) return alert('No permission'); 
      editId = s.id; 

      const v = db.vehicles.find(x => x.id === s.vehicleId) || {};

      wrap.querySelector('#sale_reg').value = (v.reg || '').toUpperCase(); 
      wrap.querySelector('#sale_date').value = s.date || ''; 
      wrap.querySelector('#sale_buyer').value = s.buyer || ''; 
      wrap.querySelector('#sale_addr').value = s.address || '';
      wrap.querySelector('#sale_phone').value = s.phone || ''; 
      wrap.querySelector('#sale_email').value = s.email || ''; 
      wrap.querySelector('#sale_mileage').value = s.mileage || 0; 
      wrap.querySelector('#sale_firstReg').value = s.firstReg || '';
      wrap.querySelector('#sale_price').value = s.salePrice || 0; 
      wrap.querySelector('#sale_dep').value = s.deposit || 0; 
      wrap.querySelector('#sale_cash').value = s.cash || 0; 
      wrap.querySelector('#sale_card').value = s.card || 0; 
      wrap.querySelector('#sale_bank').value = s.bank || 0; 
      wrap.querySelector('#sale_fin').value = s.finance || 0;
      wrap.querySelector('#sale_finFee').value = s.financeAdminFee || 0;
      wrap.querySelector('#sale_partex').value = s.partex || ''; 
      wrap.querySelector('#sale_pxReg').value = s.pxReg || ''; 
      wrap.querySelector('#sale_pxMake').value = s.pxMake || ''; 
      wrap.querySelector('#sale_pxModel').value = s.pxModel || ''; 
      wrap.querySelector('#sale_pxAllowance').value = s.pxAllowance || 0;
      wrap.querySelector('#sale_finCo').value = s.financeCompany || ''; 
      wrap.querySelector('#sale_agree').value = s.agreement || ''; 
      wrap.querySelector('#sale_deliver').value = s.deliverTo || ''; 
      wrap.querySelector('#sale_keys').value = s.keys || ''; 
      wrap.querySelector('#sale_mot').value = s.mot || ''; 
      wrap.querySelector('#sale_sh').value = s.serviceHistory || ''; 
      wrap.querySelector('#sale_invNo').value = s.invNo || ''; 

      // Load payout fields
      if (wrap.querySelector('#sale_finPayout')) {
        wrap.querySelector('#sale_finPayout').value = s.financePayoutPaid ? 'paid' : (s.financePayoutPaid === false ? '' : (s.financePayoutPaid ? 'paid' : ''));
      }
      if (wrap.querySelector('#sale_finPayoutDate')) wrap.querySelector('#sale_finPayoutDate').value = s.financePayoutDate || '';
      if (wrap.querySelector('#sale_finPayoutAmount')) wrap.querySelector('#sale_finPayoutAmount').value = Number(s.financePayoutAmount || 0) || '';

      // ‚≠ê NEW: load Lead Source
      const leadEl = wrap.querySelector('#sale_lead');
      if (leadEl) leadEl.value = s.leadSource || '';

      const stField = wrap.querySelector('#sale_status'); 
      if (stField) stField.value = s.status || 'completed'; 

      const wt = wrap.querySelector('#sale_warrantyType'); 
      if (wt) wt.value = s.warrantyType || ''; 

      const wp = wrap.querySelector('#sale_warrantyProvider'); 
      if (wp) wp.value = s.warrantyProvider || ''; 

      const wm = wrap.querySelector('#sale_warrantyMonths'); 
      if (wm) wm.value = s.warrantyMonths || ''; 

      const wpol = wrap.querySelector('#sale_warrantyPolicy'); 
      if (wpol) wpol.value = s.warrantyPolicy || ''; 

      updateWarn();
      document.getElementById('app').scrollIntoView({ behavior: 'smooth' });
    }

    else if(b.dataset.act==='inv'){ printInvoice(s.id); } else if(b.dataset.act==='proforma'){ printFinanceProforma(s.id); }
  });

  wrap.querySelector('#sale_add').onclick = () => { 
    if (!canAction('add')) return alert('No permission'); 

    const regInput = (wrap.querySelector('#sale_reg').value || '').toUpperCase().trim(); 
    const vid = findVehicleIdByReg(regInput); 
    if (!vid) return alert('Enter a valid REG (use the suggestions).');

    // üü° Sale type: completed / proforma / cancelled
    const statusEl = wrap.querySelector('#sale_status');
    const saleStatus = statusEl ? statusEl.value : 'completed';

    const prevSale = editId ? (db.sales || []).find(x => x.id === editId) : null;
    const prevStatus = prevSale ? (prevSale.status || 'completed') : null;

    // üîí Prevent *double completed sale* on NEW sale
    if (!editId) {
      const vehicle = (db.vehicles || []).find(x => x.id === vid);
      const hasRealSale = (db.sales || []).some(sale => sale.vehicleId === vid && isRealSale(sale));

      if ((vehicle && vehicle.status === 'sold') || hasRealSale) {
        return alert('This vehicle already has a completed sale. Use EDIT on the existing sale or cancel/refund it first.');
      }
    }

    // üî¢ Invoice number: auto + unique
    let invNoValue = (wrap.querySelector('#sale_invNo').value || '').trim();

    if (!invNoValue && !editId) {
      invNoValue = getNextInvoiceNo();
    }

    if (invNoValue) {
      const existing = new Set(
        (db.sales || [])
          .filter(sale => sale.id !== (prevSale && prevSale.id))
          .map(sale => (sale.invNo == null ? '' : String(sale.invNo).trim()))
    );

    let candidate = String(invNoValue).trim();
    if (existing.has(candidate)) {
      let n = parseInt(candidate, 10);
      if (!isNaN(n)) {
        while (existing.has(String(n))) n++;
        candidate = String(n);
      } else {
        let i = 2;
        while (existing.has(candidate + '-' + i)) i++;
        candidate = candidate + '-' + i;
      }
    }
    invNoValue = candidate;
  }

  const price = Number(wrap.querySelector('#sale_price').value || 0);

  // üîß Build sale object (keeping refunded flag etc. if editing)
  const base = prevSale || {};
  const s = {
    ...base,
    id: editId || uid(), 
    vehicleId: vid, 
    date: wrap.querySelector('#sale_date').value,
    firstReg: wrap.querySelector('#sale_firstReg').value,
    buyer: wrap.querySelector('#sale_buyer').value.trim(),
    address: wrap.querySelector('#sale_addr').value.trim(),
    phone: wrap.querySelector('#sale_phone').value.trim(),
    email: wrap.querySelector('#sale_email').value.trim(),
    mileage: Number(wrap.querySelector('#sale_mileage').value || 0),
    salePrice: price,
    deposit: Number(wrap.querySelector('#sale_dep').value || 0),
    cash: Number(wrap.querySelector('#sale_cash').value || 0),
    card: Number(wrap.querySelector('#sale_card').value || 0),
    bank: Number(wrap.querySelector('#sale_bank').value || 0),
    finance: Number(wrap.querySelector('#sale_fin').value || 0),
    financeAdminFee: Number(wrap.querySelector('#sale_finFee')?.value || 0),
    financePayoutPaid: (wrap.querySelector('#sale_finPayout')?.value === 'paid'),
    financePayoutDate: (wrap.querySelector('#sale_finPayoutDate')?.value || ''),
    financePayoutAmount: Number(wrap.querySelector('#sale_finPayoutAmount')?.value || 0),
    financeAdminFeeExpenseId: base.financeAdminFeeExpenseId || '',
    partex: wrap.querySelector('#sale_partex').value.trim(),
    pxReg: (wrap.querySelector('#sale_pxReg').value || '').trim().toUpperCase(),
    pxMake: wrap.querySelector('#sale_pxMake').value.trim(),
    pxModel: wrap.querySelector('#sale_pxModel').value.trim(),
    pxAllowance: Number(wrap.querySelector('#sale_pxAllowance').value || 0),
    financeCompany: wrap.querySelector('#sale_finCo').value.trim(),
    agreement: wrap.querySelector('#sale_agree').value.trim(),
    deliverTo: wrap.querySelector('#sale_deliver').value.trim(),
    keys: wrap.querySelector('#sale_keys').value.trim(),
    mot: wrap.querySelector('#sale_mot').value.trim(),
    serviceHistory: wrap.querySelector('#sale_sh').value.trim(),
    leadSource: (wrap.querySelector('#sale_lead')?.value || '').trim(),
    invNo: invNoValue || (Date.now() + '').slice(-6),
    status: saleStatus,
    warrantyType:      (wrap.querySelector('#sale_warrantyType')?.value || ''),
    warrantyProvider:  (wrap.querySelector('#sale_warrantyProvider')?.value || '').trim(),
    warrantyMonths:    Number((wrap.querySelector('#sale_warrantyMonths')?.value || 0)),
    warrantyPolicy:    (wrap.querySelector('#sale_warrantyPolicy')?.value || '').trim()
  };

  // ‚úÖ FREEZE VEHICLE COST AT TIME OF SALE
  try {
    const v = (db.vehicles || []).find(x => x.id === s.vehicleId) || {};

    // total vehicle expenses up to that moment
    const expTotal = (db.vehicleExpenses || [])
      .filter(e => e.vehicleId === s.vehicleId)
      .reduce((t, e) => t + Number(e.amount || 0), 0);

    s.vehiclePurchaseAtSale = Number(v.purchase || 0);
    s.vehicleExpensesAtSale = Number(expTotal || 0);
    s.vehicleTotalCostAtSale = Number(s.vehiclePurchaseAtSale + s.vehicleExpensesAtSale);
  } catch (e) {}

  // store paid/due/status in the sale record
  const _sum = calcSalePaymentSummary(wrap);
  s.totalPaid  = Math.round(_sum.totalPaid * 100) / 100;
  s.balanceDue = Math.round(_sum.balanceDue * 100) / 100;
  s.payStatus  = _sum.status;

  // ‚úÖ Finance admin fee -> store as a vehicle expense so profit is correct
  (function applyFinanceAdminFeeExpense(){
    const fee = Number(s.financeAdminFee || 0);
    if (!s.vehicleId) return;

    // If fee is 0, remove previously linked expense (if any)
    if (fee <= 0) {
      if (s.financeAdminFeeExpenseId) {
        // track deletion if you‚Äôre using multi-PC delete sync
        if (typeof markDeleted === 'function') markDeleted('vehicleExpenses', s.financeAdminFeeExpenseId);

        db.vehicleExpenses = (db.vehicleExpenses || []).filter(e => e.id !== s.financeAdminFeeExpenseId);
        s.financeAdminFeeExpenseId = '';
      }
      return;
    }

    // Create or update the linked expense
    let exp = (db.vehicleExpenses || []).find(e => e.id === s.financeAdminFeeExpenseId);
    if (!exp) {
      exp = {
        id: uid(),
        vehicleId: s.vehicleId,
        date: s.date || new Date().toISOString().slice(0,10),
        type: 'Finance admin fee',
        method: 'bank',
        amount: fee,
        note: `Finance company: ${s.financeCompany || ''} ‚Ä¢ Inv: ${s.invNo || ''}`
      };
      (db.vehicleExpenses = db.vehicleExpenses || []).unshift(exp);
      s.financeAdminFeeExpenseId = exp.id;
    } else {
      exp.vehicleId = s.vehicleId;
      exp.date = s.date || exp.date;
      exp.type = 'Finance admin fee';
      exp.method = exp.method || 'bank';
      exp.amount = fee;
      exp.note = `Finance company: ${s.financeCompany || ''} ‚Ä¢ Inv: ${s.invNo || ''}`;
    }
  })();

  // Auto-set warranty expiry based on sale date + months (for quick reference)
  (function(){
    try{
      const months = Number(s.warrantyMonths || 0);
      if (s.date && months > 0){
        const d = new Date(s.date);
        d.setMonth(d.getMonth() + months);
        s.warrantyExpiry = d.toISOString().slice(0,10);
      } else {
        s.warrantyExpiry = s.warrantyExpiry || '';
      }
    } catch(e){}
  })();

  // Mark refunded flag for unwound deals
  if (saleStatus === 'unwound') {
    s.refunded = true;
  }
  
  const sumBreak = s.deposit + s.cash + s.card + s.bank + s.finance + s.pxAllowance;
  if (sumBreak !== s.salePrice) {
    if (!confirm('Payments + PX do not equal sale price. Continue?')) return;
  }

  // üß† Helper to create PX vehicle (only for completed sales)
  function ensurePartExVehicle(sale, vStat){
    if (!sale.pxReg || !(sale.pxAllowance > 0)) return;
    const existingPx = (db.vehicles || []).find(v => v.originalSaleId === sale.id);
    if (existingPx) return; // already created before

    const px = {
      id: uid(),
      reg: sale.pxReg,
      make: sale.pxMake,
      model: sale.pxModel,
      colour: '',
      fuel: '',
      mileage: 0,
      purchase: sale.pxAllowance,
      ownerType: 'owned',
      investor: '',
      supplier: 'PART-EX',
      supplierNote: `PX from sale ${sale.invNo} (${vStat?.reg || 'Unknown'})`,
      originalSaleId: sale.id,
      vin: '',
      status: 'for sale',
      createdAt: new Date().toISOString(),
      media: [],
      video: ''
    };
    db.vehicles.unshift(px);
    addAudit('add', 'vehicle', px.id, 'PX ' + px.reg + ' ' + px.make + ' ' + px.model + ' from sale ' + sale.invNo + ' (' + (vStat?.reg || 'Unknown') + ')');
  }

  if (editId) { 
    // üîÑ Update existing sale
    db.sales = (db.sales || []).map(x => x.id === s.id ? s : x); 
    addAudit('update', 'sale', s.id, (db.vehicles.find(x => x.id === s.vehicleId) || {}).reg + ' inv ' + s.invNo); 

    const vM = db.vehicles.find(x => x.id === s.vehicleId); 
    if (vM) vM.mileage = s.mileage || vM.mileage; 

    // Status transitions:
    if (prevStatus !== 'completed' && saleStatus === 'completed') {
      // became a real sale now ‚Üí mark sold + PX if needed
      if (vM) vM.status = 'sold';
      ensurePartExVehicle(s, vM);
    } else if (prevStatus === 'completed' && saleStatus !== 'completed') {
      // was completed, now proforma/cancelled ‚Üí put back to stock + remove PX
      if (vM) vM.status = 'for sale';
      const pxVehicle = (db.vehicles || []).find(v => v.originalSaleId === s.id);
      if (pxVehicle) {
        db.vehicles = db.vehicles.filter(v => v.id !== pxVehicle.id);
        db.vehicleExpenses = (db.vehicleExpenses || []).filter(e => e.vehicleId !== pxVehicle.id);
      }
    }

    editId = null;
  } else { 
    // üÜï New sale
    db.sales.unshift(s); 
    addAudit('add', 'sale', s.id, (db.vehicles.find(x => x.id === s.vehicleId) || {}).reg + ' inv ' + s.invNo); 
    
    const vStat = db.vehicles.find(x => x.id === vid); 
    if (vStat) { 
      if (saleStatus === 'completed') {
        vStat.status = 'sold';       // only completed = sold
      }
      vStat.mileage = s.mileage || vStat.mileage; 
    }

    if (saleStatus === 'completed' && vStat) {
      ensurePartExVehicle(s, vStat);
    }
  }
  
  saveDB(); 
  try{renderAlertBell();}catch(e){}; 
  rows(); 
  clearSaleForm();
};
  
  // Initial render
  clearSaleForm();
  rows();
  return wrap;
}

/* ========= Sold (new) ========= */
function viewSold(){
  if(!canTab('Sold')) return document.createElement('div'); 
  const wrap=document.createElement('div'); 
  wrap.className='card';
  
  wrap.innerHTML=`<h2>Sold</h2>
  <div class="row" style="margin-bottom: 16px; padding: 10px; background: rgba(19, 26, 43, 0.5); border-radius: 10px;">
    <div style="display: flex; gap: 12px; align-items: center; flex-wrap: wrap; width: 100%;">
      <div style="flex: 1; min-width: 200px;">
        <label class="small">Search by REG, Customer, or Phone</label>
        <input id="sold_search" placeholder="Type to search..." style="width: 100%;">
      </div>
      <div style="flex: 1; min-width: 200px;">
        <label class="small">Filter by Month</label>
        <input id="sold_month" type="month" style="width: 100%;">
      </div>
      <div style="display: flex; gap: 8px; align-items: flex-end;">
        <button id="sold_clear_search" style="margin-top: 20px;">Clear Search</button>
        <button id="sold_clear_month" style="margin-top: 20px;">Show All Time</button>
        <button id="sold_export" style="margin-top: 20px;">Export CSV</button>
      </div>
    </div>
  </div>
  <table class="table" style="margin-top:10px"><thead><tr>
    <th>Date</th><th>Reg</th><th>Make</th><th>Model</th><th>Customer</th><th>Address</th><th>Postcode</th><th>Phone</th><th>Email</th><th class="right">Price</th>
  </tr></thead><tbody id="sold_body"></tbody></table>
  <div id="sold_summary" class="small" style="margin-top: 10px; padding: 8px; background: var(--card); border-radius: 8px;"></div>`;
  
  const body=wrap.querySelector('#sold_body');
  const summary=wrap.querySelector('#sold_summary');
  
  // Filter state
  let currentFilter = {
    search: '',
    month: '' // Empty by default instead of current month
  };
  
  // Set default month to empty (show all time)
  wrap.querySelector('#sold_month').value = currentFilter.month;
  
  function postcodeFrom(addr){ 
    const m=(addr||'').match(/([A-Z]{1,2}\d{1,2}[A-Z]?)\s*\d[A-Z]{2}/i); 
    return m?m[0].toUpperCase():''; 
  }
  
  function getFilteredSales() {
    let sales = (db.sales || []).filter(isRealSale);
    
    // Apply month filter if specified
    if (currentFilter.month) {
      sales = sales.filter(s => ymStr(s.date) === currentFilter.month);
    }
    
    // Apply search filter if specified
    if (currentFilter.search) {
      const searchTerm = currentFilter.search.toLowerCase();
      sales = sales.filter(s => {
        const v = db.vehicles.find(x => x.id === s.vehicleId) || {};
        return (
          (v.reg || '').toLowerCase().includes(searchTerm) ||
          (s.buyer || '').toLowerCase().includes(searchTerm) ||
          (s.phone || '').toLowerCase().includes(searchTerm)
        );
      });
    }
    
    // Sort by date (newest first)
    sales.sort((a, b) => {
      if (!a.date && !b.date) return 0;
      if (!a.date) return 1;
      if (!b.date) return -1;
      return b.date.localeCompare(a.date);
    });
    
    return sales;
  }
  
  function renderSoldRows(){
    const filteredSales = getFilteredSales();
    body.innerHTML=''; 
    
    if (filteredSales.length === 0) {
      const tr = document.createElement('tr');
      tr.innerHTML = `<td colspan="10" class="small" style="text-align: center; padding: 20px;">No sold vehicles found${currentFilter.search ? ' for "' + currentFilter.search + '"' : ''}${currentFilter.month ? ' in ' + currentFilter.month : ''}</td>`;
      body.appendChild(tr);
    } else {
      filteredSales.forEach(s=>{
        const v=db.vehicles.find(x=>x.id===s.vehicleId)||{};
        const tr=document.createElement('tr'); 
        tr.innerHTML=`<td>${ddmmyyyy(s.date)}</td>
                     <td>${v.reg||''}</td>
                     <td>${v.make||''}</td>
                     <td>${v.model||''}</td>
                     <td>${s.buyer||''}</td>
                     <td>${s.address || ''}</td>
                     <td>${postcodeFrom(s.address)}</td>
                     <td>${s.phone||''}</td>
                     <td>${s.email||''}</td>
                     <td class="right">${fmtMoney(s.salePrice||0)}</td>`; 
        body.appendChild(tr);
      });
    }
    
    // Update summary
    updateSummary();
  }
  
  function updateSummary() {
    const filteredSales = getFilteredSales();
    const totalSales = filteredSales.reduce((sum, s) => sum + Number(s.salePrice || 0), 0);
    
    let summaryText = `Showing ${filteredSales.length} sold vehicle${filteredSales.length !== 1 ? 's' : ''}`;
    if (currentFilter.month) {
      summaryText += ` for ${currentFilter.month}`;
    } else {
      summaryText += ` (all time)`;
    }
    if (currentFilter.search) {
      summaryText += ` matching "${currentFilter.search}"`;
    }
    summaryText += ` | Total Sales: ${fmtMoney(totalSales)}`;
    
    summary.textContent = summaryText;
  }
  
  // Event listeners for search and filter
  wrap.querySelector('#sold_search').addEventListener('input', function(e) {
    currentFilter.search = e.target.value.trim();
    renderSoldRows();
  });
  
  wrap.querySelector('#sold_month').addEventListener('change', function(e) {
    currentFilter.month = e.target.value || '';
    renderSoldRows();
  });
  
  wrap.querySelector('#sold_clear_search').onclick = function() {
    wrap.querySelector('#sold_search').value = '';
    currentFilter.search = '';
    renderSoldRows();
  };
  
  wrap.querySelector('#sold_clear_month').onclick = function() {
    wrap.querySelector('#sold_month').value = '';
    currentFilter.month = '';
    renderSoldRows();
  };
  
  // Export CSV functionality (unchanged)
  wrap.querySelector('#sold_export').onclick=()=>{ 
    const rowsCSV=[["Date","Reg","Make","Model","Customer","Postcode","Phone","Email","Price"]]; 
    getFilteredSales().forEach(s=>{ 
      const v=db.vehicles.find(x=>x.id===s.vehicleId)||{}; 
      rowsCSV.push([
        ddmmyyyy(s.date),
        v.reg||'',
        v.make||'',
        v.model||'',
        s.buyer||'',
        (s.address||'').split(',').slice(-1)[0]||'',
        s.phone||'',
        s.email||'',
        Number(s.salePrice||0)
      ]); 
    }); 
    
    const csv=rowsCSV.map(r=>r.map(v=>'"'+String(v).replace(/"/g,'""')+'"').join(',')).join('\n'); 
    const a=document.createElement('a'); 
    a.href=URL.createObjectURL(new Blob([csv],{type:'text/csv'})); 
    a.download='sold_export_' + new Date().toISOString().slice(0,10) + '.csv'; 
    a.click(); 
    
    addAudit('export', 'sold', '', `Exported ${getFilteredSales().length} sold vehicles to CSV`);
  };
  
  // Initial render
  renderSoldRows();
  return wrap;
}

/* ========= Credit ========= */
function viewCredit(){
  if(!canTab('Credit')) return document.createElement('div'); 
  const wrap=document.createElement('div'); 
  wrap.className='card';

  wrap.innerHTML=`<h2>Credit Notes & Refunds</h2>
  <div class="row">
    <input id="cr_date" type="date">
    <input id="cr_customer" placeholder="Customer Name">
    <datalist id="cr_reg_list">
      ${(db.vehicles||[]).filter(v => String(v.status||'').toLowerCase() === 'sold').map(v => `<option value="${(v.reg||'').toUpperCase()}">`).join('')}
    </datalist>
    <input id="cr_vehicle" list="cr_reg_list" placeholder="Vehicle REG (select sold reg)">
    <select id="cr_type">
      <option value="refund">Refund (Return)</option>
      <option value="credit_note">Credit Note</option>
    </select>
    <select id="cr_method"><option value="bank">Bank</option><option value="cash">Cash</option></select>
    <input id="cr_amount" type="number" placeholder="Refund Paid ¬£">
    <input id="cr_reason" placeholder="Reason for credit/refund">
    <input id="cr_invoiceNo" placeholder="Invoice No (auto)">
    <button id="cr_add" class="primary">Add/Update Credit</button>
  </div>

  <div class="row" style="margin-top:6px;">
    <textarea id="cr_terms" placeholder="Extra terms / conditions for this credit note or refund (will print on the credit note)" style="width:100%;min-height:60px;"></textarea>
  </div>

  <div class="row" style="margin:10px 0 12px;">
    <div class="small" id="cr_saleHint" style="opacity:.85"></div>
  </div>

  <div class="row" style="margin-bottom:12px;">
    <input id="cr_search" placeholder="Search by customer, vehicle, invoice" style="min-width:320px">
    <button id="cr_clear_search">Clear</button>
  </div>

  <div class="row" id="cr_vehicleDetailsSection">
    <label>Make<input id="cr_make" placeholder="Vehicle Make"></label>
    <label>Model<input id="cr_model" placeholder="Vehicle Model"></label>
    <label>VIN<input id="cr_vin" placeholder="Vehicle VIN"></label>
    <label>Return Mileage<input id="cr_mileage" type="number" placeholder="Mileage on return"></label>
    <label>Colour<input id="cr_colour" placeholder="Vehicle Colour"></label>
    <label>Fuel<input id="cr_fuel" placeholder="Fuel Type"></label>
  </div>

  <table class="table" style="margin-top:10px">
    <thead>
      <tr>
        <th>Date</th>
        <th>Customer</th>
        <th>Vehicle</th>
        <th>Type</th>
        <th>Method</th>
        <th class="right">Refund Paid</th>
        <th>Reason</th>
        <th>Invoice No</th>
        <th>Returned To Stock</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody id="cr_body"></tbody>
  </table>`;

  const body = wrap.querySelector('#cr_body');
  let editId = null;

  // This holds the SOLD sale we auto-found from REG
  let linkedSale = null;
  let linkedVehicle = null;

  // Default date = today
  wrap.querySelector('#cr_date').value = new Date().toISOString().slice(0,10);

  function money(n){ return fmtMoney(Number(n||0)); }

  function findLatestSaleByReg(reg){
    reg = (reg||'').trim().toUpperCase();
    if(!reg) return null;

    // Find vehicle by reg (even if sold)
    const v = (db.vehicles||[]).find(x => (x.reg||'').toUpperCase() === reg);
    if(!v) return null;

    // Find latest sale for that vehicleId
    const sales = (db.sales||[]).filter(s => s.vehicleId === v.id);
    if(!sales.length) return null;

    sales.sort((a,b)=> String(b.date||'').localeCompare(String(a.date||'')));
    return { sale: sales[0], vehicle: v };
  }

  function setSaleHint(){
    const hint = wrap.querySelector('#cr_saleHint');
    if(!linkedSale || !linkedVehicle){
      hint.textContent = 'Tip: Type a REG that was sold and it will auto-load the sold invoice + price + buyer.';
      return;
    }
    hint.textContent =
      `Linked SOLD: ${linkedVehicle.reg} | Inv ${linkedSale.invNo||''} | Sold ${money(linkedSale.salePrice)} | Sold mileage ${linkedSale.mileage||0} | Buyer: ${linkedSale.buyer||''}`;
  }

  function loadFromReg(){
    const reg = (wrap.querySelector('#cr_vehicle').value||'').trim().toUpperCase();
    linkedSale = null; 
    linkedVehicle = null;

    // Clear auto fields first
    wrap.querySelector('#cr_invoiceNo').value = '';
    // Customer stays if user typed it, but we will overwrite if we find a sale.

    if(!reg){
      setSaleHint();
      return;
    }

    const res = findLatestSaleByReg(reg);
    if(!res){
      setSaleHint();
      return;
    }

    linkedSale = res.sale;
    linkedVehicle = res.vehicle;

    // Auto-fill from sale + vehicle
    wrap.querySelector('#cr_customer').value = linkedSale.buyer || wrap.querySelector('#cr_customer').value || '';
    wrap.querySelector('#cr_invoiceNo').value = linkedSale.invNo || '';
    wrap.querySelector('#cr_make').value = linkedVehicle.make || '';
    wrap.querySelector('#cr_model').value = linkedVehicle.model || '';
    wrap.querySelector('#cr_vin').value = linkedVehicle.vin || '';
    wrap.querySelector('#cr_colour').value = linkedVehicle.colour || '';
    wrap.querySelector('#cr_fuel').value = linkedVehicle.fuel || '';
    // Put sold mileage as default return mileage (user can change)
    wrap.querySelector('#cr_mileage').value = Number(linkedSale.mileage||linkedVehicle.mileage||0);

    setSaleHint();
  }

  // Auto-load when REG changes
  wrap.querySelector('#cr_vehicle').addEventListener('input', () => {
    // Avoid re-running on every keystroke if you want: keep as-is for now
    loadFromReg();
  });

  function renderCredits(){
    const searchTerm = (wrap.querySelector('#cr_search')?.value || '').toLowerCase().trim();
    body.innerHTML = '';

    const filtered = (db.credits || []).filter(cr => {
      return !searchTerm ||
        (cr.customer||'').toLowerCase().includes(searchTerm) ||
        (cr.vehicle||'').toLowerCase().includes(searchTerm) ||
        (cr.invoiceNo||'').toLowerCase().includes(searchTerm);
    });

    filtered.forEach(cr => {
      const inStock = !!(cr.vehicle && (db.vehicles||[]).some(v => (v.reg||'') === cr.vehicle && v.status === 'for sale'));
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${ddmmyyyy(cr.date)}</td>
        <td>${cr.customer||''}</td>
        <td>${cr.vehicle||''}</td>
        <td>${cr.type||''}</td>
        <td>${cr.method||'bank'}</td>
        <td class="right">${fmtMoney(cr.amount)}</td>
        <td>${cr.reason||''}</td>
        <td>${cr.invoiceNo||''}</td>
        <td>${cr.type==='refund' && inStock ? '‚úÖ' : ''}</td>
        <td>
          <button data-act="print" data-id="${cr.id}">Print</button>
          <button data-act="edit" data-id="${cr.id}">Edit</button>
          <button class="danger" data-act="del" data-id="${cr.id}">Delete</button>
        </td>`;
      body.appendChild(tr);
    });
  }

  wrap.querySelector('#cr_search').addEventListener('input', renderCredits);
  wrap.querySelector('#cr_clear_search').addEventListener('click', () => {
    wrap.querySelector('#cr_search').value = '';
    renderCredits();
  });

  function clearForm(){
    wrap.querySelector('#cr_customer').value = '';
    wrap.querySelector('#cr_vehicle').value = '';
    wrap.querySelector('#cr_amount').value = '';
    wrap.querySelector('#cr_reason').value = '';
    wrap.querySelector('#cr_invoiceNo').value = '';
    wrap.querySelector('#cr_make').value = '';
    wrap.querySelector('#cr_model').value = '';
    wrap.querySelector('#cr_vin').value = '';
    wrap.querySelector('#cr_mileage').value = '';
    wrap.querySelector('#cr_colour').value = '';
    wrap.querySelector('#cr_fuel').value = '';
    if (wrap.querySelector('#cr_terms')) wrap.querySelector('#cr_terms').value = '';
    linkedSale = null;
    linkedVehicle = null;
    setSaleHint();
  }

  // MAIN: Add / Update credit
  wrap.querySelector('#cr_add').onclick = () => {
    if (!canAction('add')) return alert('No permission');

    const reg = (wrap.querySelector('#cr_vehicle').value || '').trim().toUpperCase();
    const type = wrap.querySelector('#cr_type').value;

    // Ensure we refresh linkage (in case user pasted reg)
    loadFromReg();

    const refundPaid = Number(wrap.querySelector('#cr_amount').value || 0);

    const cr = {
      id: editId || uid(),
      date: wrap.querySelector('#cr_date').value,
      customer: wrap.querySelector('#cr_customer').value.trim(),
      vehicle: reg,
      type: type,
      method: wrap.querySelector('#cr_method').value,
      amount: refundPaid,
      reason: wrap.querySelector('#cr_reason').value.trim(),
      invoiceNo: wrap.querySelector('#cr_invoiceNo').value.trim(),
      make: wrap.querySelector('#cr_make').value.trim(),
      model: wrap.querySelector('#cr_model').value.trim(),
      vin: wrap.querySelector('#cr_vin').value.trim(),
      mileage: Number(wrap.querySelector('#cr_mileage').value || 0),
      colour: wrap.querySelector('#cr_colour').value.trim(),
      fuel: wrap.querySelector('#cr_fuel').value.trim(),
      terms: (wrap.querySelector('#cr_terms')?.value || '').trim(),
      saleId: linkedSale ? linkedSale.id : null,
      soldPrice: linkedSale ? Number(linkedSale.salePrice||0) : 0,
      soldInvNo: linkedSale ? (linkedSale.invNo||'') : '',
      soldMileage: linkedSale ? Number(linkedSale.mileage||0) : 0,
      returnMileage: Number(wrap.querySelector('#cr_mileage').value || 0),

      // NEW: expense link id (so we don't create duplicates)
      costAdjustExpenseId: (editId ? (db.credits||[]).find(x=>x.id===editId)?.costAdjustExpenseId : null) || null
    };

    if(!cr.date || !cr.customer || !cr.type || (!cr.amount && cr.type==='refund')){
      return alert('Date + Customer + Refund Paid are required.');
    }

    // If REFUND: return to stock + add negative expense to reduce cost
    if(type === 'refund' && reg){
      const v = (db.vehicles||[]).find(x => (x.reg||'').toUpperCase() === reg);
      if(v){
        // Return to stock
        v.status = 'for sale';
        if(cr.returnMileage) v.mileage = cr.returnMileage;

        // If we have a linked sale price, calculate "kept amount"
        const soldPrice = cr.soldPrice || 0;
        const kept = soldPrice - refundPaid; // e.g. 8399 - 8099 = 300

        // Only apply adjustment if we actually know sold price and kept > 0
        if(soldPrice > 0 && kept !== 0){
          db.vehicleExpenses = db.vehicleExpenses || [];
          let ex = cr.costAdjustExpenseId ? (db.vehicleExpenses||[]).find(e=>e.id===cr.costAdjustExpenseId) : null;

          const expObj = {
            id: ex ? ex.id : uid(),
            vehicleId: v.id,
            date: cr.date,
            type: 'Credit/Return Adjustment',
            method: cr.method || 'bank',
            amount: -Number(kept), // negative reduces total cost
            note: `Refund to ${cr.customer} (${(v.reg||'').toUpperCase()}): sold ${fmtMoney(soldPrice)}, refund ${fmtMoney(refundPaid)}, kept ${fmtMoney(kept)}. Inv ${cr.invoiceNo||cr.soldInvNo||''}`
          };

          if(ex){
            db.vehicleExpenses = db.vehicleExpenses.map(e => e.id===ex.id ? expObj : e);
          }else{
            db.vehicleExpenses.unshift(expObj);
          }
          cr.costAdjustExpenseId = expObj.id;
        }
      }
    }

    // Mark the original sale as refunded so it does not appear in sales/sold/reports
    if (type === 'refund' && linkedSale && linkedSale.id) {
      const sale = (db.sales||[]).find(s => s.id === linkedSale.id);
      if (sale) {
        sale.refunded = true;
        saveDB();
      }
    }

    if(editId){
      db.credits = (db.credits||[]).map(x => x.id===editId ? cr : x);
      addAudit('update','credit',cr.id,`${cr.type} for ${cr.customer} - ${fmtMoney(cr.amount)}`);
      editId = null;
    }else{
      db.credits = db.credits || [];
      db.credits.unshift(cr);
      addAudit('add','credit',cr.id,`${cr.type} for ${cr.customer} - ${fmtMoney(cr.amount)}`);
    }

    saveDB();
    try{renderAlertBell();}catch(e){}
    renderCredits();
    clearForm();
  };

  wrap.addEventListener('click',(ev)=>{
    const b=ev.target.closest('button');
    if(!b) return;

    const id  = b.dataset.id;
    const act = b.dataset.act;

    if (act === 'print') {
      // üñ® Print Credit Note / Refund Receipt
      printCreditInvoice(id);
      return;
    }

    if (act === 'del') {
      if (!canAction('del')) return alert('No permission');
      if (!confirm('Delete this credit/refund?')) return;

      const delCr = (db.credits||[]).find(x=>x.id===id);

      // Also delete linked adjustment expense (if any)
      if (delCr && delCr.costAdjustExpenseId) {
        // track vehicle expense deletion
        markDeleted('vehicleExpenses', delCr.costAdjustExpenseId);
        db.vehicleExpenses = (db.vehicleExpenses||[]).filter(e => e.id !== delCr.costAdjustExpenseId);
      }

      // track credit deletion
      markDeleted('credits', id);
      db.credits = (db.credits||[]).filter(x=>x.id!==id);

      saveDB();
      try{ renderAlertBell(); }catch(e){}
      addAudit('delete','credit',id,delCr ? `${delCr.type} for ${delCr.customer}` : '');
      renderCredits();
    }

    if (act === 'edit') {
      if (!canAction('edit')) return alert('No permission');
      const cr = (db.credits||[]).find(x=>x.id===id);
      if (!cr) return;

      editId = id;

      wrap.querySelector('#cr_date').value      = cr.date || '';
      wrap.querySelector('#cr_customer').value  = cr.customer || '';
      wrap.querySelector('#cr_vehicle').value   = cr.vehicle || '';
      wrap.querySelector('#cr_type').value      = cr.type || 'refund';
      wrap.querySelector('#cr_method').value    = cr.method || 'bank';
      wrap.querySelector('#cr_amount').value    = Number(cr.amount||0);
      wrap.querySelector('#cr_reason').value    = cr.reason || '';
      wrap.querySelector('#cr_invoiceNo').value = cr.invoiceNo || '';
      wrap.querySelector('#cr_make').value    = cr.make || '';
      wrap.querySelector('#cr_model').value   = cr.model || '';
      wrap.querySelector('#cr_vin').value     = cr.vin || '';
      wrap.querySelector('#cr_mileage').value = Number(cr.returnMileage||cr.mileage||0);
      wrap.querySelector('#cr_colour').value  = cr.colour || '';
      wrap.querySelector('#cr_fuel').value    = cr.fuel || '';
      if (wrap.querySelector('#cr_terms')) wrap.querySelector('#cr_terms').value = cr.terms || '';

      // Reload linkage hint
      loadFromReg();

      document.getElementById('app').scrollIntoView({ behavior: 'smooth' });
    }
  });

  setSaleHint();
  renderCredits();
  return wrap;
}

function hasPX(s){
  return !!(
    (s && String(s.pxReg||'').trim()) ||
    (s && String(s.pxMake||'').trim()) ||
    (s && String(s.pxModel||'').trim()) ||
    (s && String(s.pxMileage||s.pxMilage||'').trim())
  );
}

/* ========= Credit Invoice Printing ========= */
function printCreditInvoice(creditId){
  const cr = db.credits.find(x => x.id === creditId);
  if (!cr) return;

  const co = db.company || {};
  const fontPx  = Number(co.invoiceFontPx || 12);
  const termsPx = Number(co.termsFontPx || 10);

  const title = cr.type === 'credit_note' ? 'CREDIT NOTE' : 'REFUND RECEIPT';
  const refNo = 'CR' + (cr.id || '').slice(-6).toUpperCase();

  const logo = (co.logo||'').trim()
    ? `<img src="${co.logo}" style="max-width:${Number(co.logoMaxW||140)}px;max-height:${Number(co.logoMaxH||80)}px;object-fit:contain">`
    : '';

  const headerHTML = `<div class="h"><div>${logo}</div>
    <div style="text-align:right"><h2 style="margin:0">${title}</h2><div>Ref #: ${refNo}</div><div>Date: ${ddmmyyyy(cr.date||'')}</div></div></div>
    <div style="margin-top:6px"><b>${co.name||'Star Cars London Ltd'}</b><br>${co.address||''}<br>P: ${co.phone||''} ${co.email||''}<br>COMPANY #: ${co.companyNumber||''} ‚Ä¢ VAT #: ${co.vatNumber||''} ‚Ä¢ FCA #: ${co.fcaNumber||''}</div>`;

  const html = `<!doctype html><html><head><meta charset="utf-8"><title>${title}</title>
  <style>
    @page{size:A4;margin:10mm 10mm}
    body{font-family:Arial;color:#111;font-size:${fontPx}px}
    .h{display:flex;justify-content:space-between;align-items:flex-start;border-bottom:2px solid #000;padding-bottom:6px;margin-bottom:6px}
    table{width:100%;border-collapse:collapse}
    th,td{border:1px solid #000;padding:6px 8px;font-size:${fontPx}px;vertical-align:top}
    th{background:#f5f5f5;text-align:left}
    .terms{font-size:${Math.max(8,termsPx)}px;line-height:1.35}
    .terms{ page-break-inside: avoid; break-inside: avoid; }
    .tight td{padding:4px 6px}
    .negative{color:#d00;font-weight:bold}
    .no-print{margin:8px 0}
    @media print{.no-print{display:none !important}}
  </style></head><body>
  <button class="no-print" onclick="window.print()" style="margin:8px 0">Print / Save as PDF</button>
  ${headerHTML}
  <table class="tight">
    <tr><th>Customer</th><td>${cr.customer||''}</td></tr>
    ${cr.vehicle
      ? `<tr><th>Vehicle</th><td>${cr.vehicle}</td></tr>`
      : ''
    }
    ${
      (cr.invoiceNo || cr.soldInvNo)
        ? `<tr><th>Original Invoice #</th><td>${cr.invoiceNo || cr.soldInvNo}</td></tr>`
        : ''
    }
    <tr><th>Type</th><td>${cr.type === 'credit_note' ? 'Credit Note' : 'Refund'}</td></tr>
    <tr><th>Payment Method</th><td>${cr.method === 'cash' ? 'Cash' : 'Bank Transfer'}</td></tr>
    <tr><th>Reason</th><td>${cr.reason||''}</td></tr>
  </table>
  <h3>Amount</h3>
  <table class="tight">
    <tr><th>Total ${cr.type === 'credit_note' ? 'Credit' : 'Refund'}</th><td class="right negative">${fmtMoney(cr.amount)}</td></tr>
  </table>
  <p class="terms">
    <b>Terms:</b><br>
    ${
      (cr.terms || '').trim()
        ? (cr.terms || '').trim()
        : (
            cr.type === 'credit_note'
              ? 'This credit note may be used against future purchases with ' + (co.name || 'Star Cars London Ltd') + '. Valid for 12 months from date of issue.'
              : 'This refund has been processed as indicated above. Please allow 3-5 working days for bank transfers to clear.'
          )
    }
  </p>
  <p>Customer signature: _______________________ &nbsp;&nbsp; Authorised by: _______________________</p>
  <p style="margin-top:20px;font-size:${Math.max(10,fontPx-2)}px;color:#666">
    Issued by: ${co.name || 'Star Cars London Ltd'} ‚Ä¢ ${ddmmyyyy(cr.date)} ‚Ä¢ Ref: ${refNo}
  </p>
  </body></html>`;

  openPrintable(html);
}

/* ========= Purchase Invoice ========= */
function viewPurchaseInvoice(){
  if(!canTab('Purchase Invoice')) return document.createElement('div'); 
  const wrap=document.createElement('div'); wrap.className='card';
  wrap.innerHTML=`<h2>Purchase Invoices (Buy from Customers)</h2>
  <div class="row">
    <input id="pi_date" type="date">
    <input id="pi_supplier" placeholder="Seller Name">
    <input id="pi_reg" placeholder="Vehicle REG *" style="min-width:120px">
    <input id="pi_make" placeholder="Make">
    <input id="pi_model" placeholder="Model">
    <input id="pi_vin" placeholder="VIN (optional)">
    <input id="pi_mileage" type="number" placeholder="Mileage">
    <input id="pi_amount" type="number" placeholder="Purchase Amount ¬£">
    <select id="pi_method"><option value="bank">Bank</option><option value="cash">Cash</option></select>
    <input id="pi_invoiceNo" placeholder="Invoice #">
    <button id="pi_add" class="primary">Add Purchase</button>
  </div>
  <div class="row">
    <label style="min-width:320px;flex:1">Notes<textarea id="pi_notes" placeholder="Additional notes"></textarea></label>
  </div>
  <div class="row" style="margin-bottom:12px">
    <input id="pi_search" placeholder="Search by seller, reg, invoice" style="min-width:320px">
    <button id="pi_clear_search">Clear</button>
  </div>
  <table class="table" style="margin-top:10px">
    <thead>
      <tr>
        <th>Date</th>
        <th>Seller</th>
        <th>Reg</th>
        <th>Make</th>
        <th>Model</th>
        <th>Mileage</th>
        <th class="right">Amount</th>
        <th>Method</th>
        <th>Invoice #</th>
        <th>In Stock</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody id="pi_body"></tbody>
  </table>`;
  
  const body=wrap.querySelector('#pi_body');
  let editId=null;
  
  function renderPurchases(filter = '') {
  body.innerHTML = '';
  
  // Filter purchase invoices based on the search term
  const filtered = (db.purchaseInvoices || []).filter(pi => {
    return !filter || 
           (pi.supplier || '').toLowerCase().includes(filter) || 
           (pi.reg || '').toLowerCase().includes(filter) || 
           (pi.invoiceNo || '').toLowerCase().includes(filter);
  });

  filtered.forEach(pi => {
    // Check if vehicle is in stock
    const inStock = (db.vehicles || []).some(v => v.reg === pi.reg && v.status === 'for sale');

    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${ddmmyyyy(pi.date)}</td>
      <td>${pi.supplier || ''}</td>
      <td>${pi.reg || ''}</td>
      <td>${pi.make || ''}</td>
      <td>${pi.model || ''}</td>
      <td>${pi.mileage || ''}</td>
      <td class="right">${fmtMoney(pi.amount)}</td>
      <td>${pi.method || 'bank'}</td>
      <td>${pi.invoiceNo || ''}</td>
      <td>${inStock ? '‚úÖ' : ''}</td>
      <td>
        <button data-act="print" data-id="${pi.id}">Print Invoice</button>
        ${canAction('edit') ? `<button data-act="edit" data-id="${pi.id}">Edit</button>` : ''}
        ${canAction('del') ? `<button class="danger" data-act="del" data-id="${pi.id}">Delete</button>` : ''}
        ${!inStock ? `<button data-act="addToStock" data-id="${pi.id}">Add to Stock</button>` : ''}
      </td>`;
    body.appendChild(tr);
  });
}

  wrap.querySelector('#pi_search').addEventListener('input', function () {
    const searchTerm = this.value.toLowerCase().trim();
    renderPurchases(searchTerm);
  });

  wrap.querySelector('#pi_clear_search').onclick = function () {
    wrap.querySelector('#pi_search').value = '';
    renderPurchases();
  };
  
  wrap.querySelector('#pi_add').onclick=()=>{
    if(!canAction('add')) return alert('No permission');
    
    const pi={
      id: editId||uid(),
      date: wrap.querySelector('#pi_date').value,
      supplier: wrap.querySelector('#pi_supplier').value.trim(),
      reg: wrap.querySelector('#pi_reg').value.trim().toUpperCase(),
      make: wrap.querySelector('#pi_make').value.trim(),
      model: wrap.querySelector('#pi_model').value.trim(),
      vin: wrap.querySelector('#pi_vin').value.trim(),
      mileage: Number(wrap.querySelector('#pi_mileage').value||0),
      amount: Number(wrap.querySelector('#pi_amount').value||0),
      method: wrap.querySelector('#pi_method').value,
      invoiceNo: wrap.querySelector('#pi_invoiceNo').value.trim(),
      notes: wrap.querySelector('#pi_notes').value.trim()
    };
    
    if(!pi.date || !pi.supplier || !pi.reg || !pi.amount) {
      return alert('Date, Seller, REG and Amount are required');
    }
    
    // Check for duplicate REG in purchase invoices (excluding current edit)
    const dupe = (db.purchaseInvoices||[]).find(x => x.reg === pi.reg && x.id !== editId);
    if(dupe) return alert('Duplicate REG in purchase invoices');
    
    if(editId){
      db.purchaseInvoices = db.purchaseInvoices.map(x => x.id === editId ? pi : x);
      addAudit('update','purchaseInvoice',pi.id,`Purchase from ${pi.supplier} - ${pi.reg} - ${fmtMoney(pi.amount)}`);
      editId = null;
    } else {
      db.purchaseInvoices = db.purchaseInvoices || [];
      db.purchaseInvoices.unshift(pi);
      addAudit('add','purchaseInvoice',pi.id,`Purchase from ${pi.supplier} - ${pi.reg} - ${fmtMoney(pi.amount)}`);
    }
    
    saveDB(); 
    try{renderAlertBell();}catch(e){}
    renderPurchases();
    
    // Clear form
    wrap.querySelector('#pi_supplier').value = '';
    wrap.querySelector('#pi_reg').value = '';
    wrap.querySelector('#pi_make').value = '';
    wrap.querySelector('#pi_model').value = '';
    wrap.querySelector('#pi_vin').value = '';
    wrap.querySelector('#pi_mileage').value = '';
    wrap.querySelector('#pi_amount').value = '';
    wrap.querySelector('#pi_invoiceNo').value = '';
    wrap.querySelector('#pi_notes').value = '';
  };
  
  wrap.addEventListener('click',(ev)=>{
    const b=ev.target.closest('button'); 
    if(!b) return; 
    const id=b.dataset.id, act=b.dataset.act;
    
    if(act==='del'){
    if(!canAction('del')) return alert('No permission');
    if(!confirm('Delete this purchase invoice?')) return;
    const delPi=db.purchaseInvoices.find(x=>x.id===id);

    // mark deletion for sync
    markDeleted('purchaseInvoices', id);

    db.purchaseInvoices=db.purchaseInvoices.filter(x=>x.id!==id);
    saveDB(); 
    try{renderAlertBell();}catch(e){}
    addAudit('delete','purchaseInvoice',id,delPi?`Purchase from ${delPi.supplier} - ${delPi.reg}`:'');
    renderPurchases();
  }

    else if(act==='edit'){
      if(!canAction('edit')) return alert('No permission');
      const pi=db.purchaseInvoices.find(x=>x.id===id);
      editId=id;
      wrap.querySelector('#pi_date').value=pi.date;
      wrap.querySelector('#pi_supplier').value=pi.supplier||'';
      wrap.querySelector('#pi_reg').value=pi.reg||'';
      wrap.querySelector('#pi_make').value=pi.make||'';
      wrap.querySelector('#pi_model').value=pi.model||'';
      wrap.querySelector('#pi_vin').value=pi.vin||'';
      wrap.querySelector('#pi_mileage').value=pi.mileage||0;
      wrap.querySelector('#pi_amount').value=pi.amount||0;
      wrap.querySelector('#pi_method').value=pi.method||'bank';
      wrap.querySelector('#pi_invoiceNo').value=pi.invoiceNo||'';
      wrap.querySelector('#pi_notes').value=pi.notes||'';
      document.getElementById('app').scrollIntoView({ behavior: 'smooth' });
    }
    else if(act==='print'){
      printPurchaseInvoice(id);
    }
    else if(act==='addToStock'){
      const pi=db.purchaseInvoices.find(x=>x.id===id);
      if(!pi) return;
      
      // Check if vehicle already exists in stock
      const existingVehicle = (db.vehicles||[]).find(v => v.reg === pi.reg);
      if(existingVehicle) {
        return alert(`Vehicle ${pi.reg} already exists in stock`);
      }
      
      // Add to vehicles
      const vehicle = {
        id: uid(),
        reg: pi.reg,
        make: pi.make,
        model: pi.model,
        colour: '',
        fuel: '',
        mileage: pi.mileage,
        purchase: pi.amount,
        ownerType: 'owned',
        investor: '',
        supplier: pi.supplier,
        vin: pi.vin,
        status: 'for sale',
        createdAt: pi.date || new Date().toISOString(),
        media: [],
        video: ''
      };
      
      db.vehicles.unshift(vehicle);
      saveDB();
      try{renderAlertBell();}catch(e){}
      addAudit('add','vehicle',vehicle.id,`Added to stock from purchase invoice - ${vehicle.reg}`);
      alert(`Vehicle ${pi.reg} added to stock`);
      renderPurchases();
    }
  });
  
  renderPurchases();
  return wrap;
}

/* ========= Purchase Invoice Printing ========= */
function printPurchaseInvoice(purchaseId){
  const pi = db.purchaseInvoices.find(x => x.id === purchaseId);
  if (!pi) return;

  const co = db.company || {};
  const fontPx  = Number(co.invoiceFontPx || 12);
  const termsPx = Number(co.termsFontPx || 10);

  const refNo = 'PI' + (pi.id || '').slice(-6).toUpperCase();

  const logo = (co.logo||'').trim()
    ? `<img src="${co.logo}" style="max-width:${Number(co.logoMaxW||140)}px;max-height:${Number(co.logoMaxH||80)}px;object-fit:contain">`
    : '';

  const headerHTML = `<div class="h"><div>${logo}</div>
    <div style="text-align:right"><h2 style="margin:0">PURCHASE INVOICE</h2><div>Ref #: ${refNo}</div><div>Date: ${ddmmyyyy(pi.date||'')}</div></div></div>
    <div style="margin-top:6px"><b>${co.name||'Star Cars London Ltd'}</b><br>${co.address||''}<br>P: ${co.phone||''} ${co.email||''}<br>COMPANY #: ${co.companyNumber||''} ‚Ä¢ VAT #: ${co.vatNumber||''} ‚Ä¢ FCA #: ${co.fcaNumber||''}</div>`;

  const html = `<!doctype html><html><head><meta charset="utf-8"><title>Purchase Invoice</title>
  <style>
    @page{size:A4;margin:10mm 10mm}
    body{font-family:Arial;color:#111;font-size:${fontPx}px}
    .h{display:flex;justify-content:space-between;align-items:flex-start;border-bottom:2px solid #000;padding-bottom:6px;margin-bottom:6px}
    table{width:100%;border-collapse:collapse}
    th,td{border:1px solid #000;padding:6px 8px;font-size:${fontPx}px;vertical-align:top}
    th{background:#f5f5f5;text-align:left}
    .terms{font-size:${Math.max(8,termsPx)}px;line-height:1.35}
    .terms{ page-break-inside: avoid; break-inside: avoid; }
    .tight td{padding:4px 6px}
    .no-print{margin:8px 0}
    @media print{.no-print{display:none !important}}
  </style></head><body>
  <button class="no-print" onclick="window.print()" style="margin:8px 0">Print / Save as PDF</button>
  ${headerHTML}
  <table class="tight">
    <tr><th>Seller</th><td>${pi.supplier||''}</td></tr>
    <tr><th>Invoice Number</th><td>${pi.invoiceNo||refNo}</td></tr>
    <tr><th>Payment Method</th><td>${pi.method === 'cash' ? 'Cash' : 'Bank Transfer'}</td></tr>
  </table>

  <h3>Vehicle Details</h3>
  <table class="tight">
    <tr><th>Registration</th><td><b>${pi.reg||''}</b></td></tr>
    <tr><th>Make</th><td>${pi.make||''}</td></tr>
    <tr><th>Model</th><td>${pi.model||''}</td></tr>
    <tr><th>VIN</th><td>${pi.vin||''}</td></tr>
    <tr><th>Mileage</th><td>${pi.mileage||''}</td></tr>
  </table>

  <h3>Purchase Details</h3>
  <table class="tight">
    <tr><th>Purchase Amount</th><td class="right">${fmtMoney(pi.amount)}</td></tr>
  </table>

  <div class="terms">
    <b>Purchase Terms:</b><br>
    Vehicle purchased as seen. Payment made as indicated above. All relevant documentation and keys exchanged at time of purchase.
    ${pi.notes ? `<br><br><b>Additional Notes:</b><br>${pi.notes}` : ''}
  </div>

  <p>Seller signature: _______________________ &nbsp;&nbsp; Buyer signature: _______________________</p>

  <p style="margin-top:20px;font-size:${Math.max(10,fontPx-2)}px;color:#666">
    Issued by: ${co.name || 'Star Cars London Ltd'} ‚Ä¢ ${ddmmyyyy(pi.date)} ‚Ä¢ Ref: ${refNo}
  </p>
  </body></html>`;

  openPrintable(html);
}

/* ========= Directors ========= */
function viewDirectors(){ if(!canTab('Directors')) return document.createElement('div'); const wrap=document.createElement('div'); wrap.className='card';
  wrap.innerHTML=`<h2>Directors</h2><div class="row"><select id="d_sel">${(db.partners||[]).map((p,i)=>`<option value="${i}">${p.name}</option>`).join('')}</select><input id="d_rename" placeholder="Rename selected"><button id="d_renbtn">Rename</button></div><div id="d_box" class="card"></div>`;
  // Ensure Delete button exists next to Rename
  (function(){
    const row = wrap.querySelector('.row');
    const ren = wrap.querySelector('#d_renbtn');
    if(ren && !wrap.querySelector('#d_delbtn')){
      const btn=document.createElement('button');
      btn.id='d_delbtn'; btn.className='danger'; btn.textContent='Delete';
      ren.parentNode.insertBefore(btn, ren.nextSibling);
    }
  })();
  const sel=()=>wrap.querySelector('#d_sel');
  
  // Delete selected director
  var __del=wrap.querySelector('#d_delbtn'); 
  if(__del) __del.onclick=()=>{
    const i=Number(sel().value||0); 
    const p=(db.partners||[])[i]; 
    if(!p) return;
    if(!confirm('Delete director \"'+(p.name||'')+'\"? This will remove their record.')) return;

    // track director deletion
    markDeleted('partners', p.id);

    (db.partners||[]).splice(i,1);
    saveDB(); 
    try{renderAlertBell();}catch(e){}; 
    addAudit('delete','director',p.id,(p.name||'')); 
    setTab('Directors');
  };

  function renderBox(){ const i=Number(sel().value||0); const p=db.partners[i]; if(!p){ wrap.querySelector('#d_box').innerHTML=''; return; }
    const tx=(p.tx||[]).map(t=>`<tr><td>${ddmmyyyy(t.date||'')}</td><td>${t.type}</td><td>${t.method||'bank'}</td><td class="right">${fmtMoney(t.amount)}</td><td>${t.note||''}</td><td>${canAction('edit')?`<button data-act="edit" data-id="${t.id}">Edit</button>`:''} ${canAction('del')?`<button class="danger" data-act="del" data-id="${t.id}">Delete</button>`:''}</td></tr>`).join('')||'<tr><td colspan="6" class="small">No transactions</td></tr>';
    wrap.querySelector('#d_box').innerHTML=`<div class="row"><input id="d_date" type="date"><select id="d_type"><option value="invest">invest</option><option value="withdraw">withdraw</option><option value="profit">profit</option></select><select id="d_method"><option>bank</option><option>cash</option></select><input id="d_amt" type="number" placeholder="Amount"><input id="d_note" placeholder="Note"><button id="d_add" class="primary">Add / Update</button></div>
    <div class="row small"><b>Balance:</b> ${fmtMoney(p.balance||0)}</div><table class="table" style="margin-top:10px"><thead><tr><th>Date</th><th>Type</th><th>Method</th><th class="right">Amount</th><th>Note</th><th>Actions</th></tr></thead><tbody id="d_body">${tx}</tbody></table>`;
    let editTxId=null; wrap.querySelector('#d_add').onclick=()=>{ if(!canAction('add')) return alert('No permission'); const t={id:editTxId||uid(),date:wrap.querySelector('#d_date').value,type:wrap.querySelector('#d_type').value,method:wrap.querySelector('#d_method').value,amount:Number(wrap.querySelector('#d_amt').value||0),note:wrap.querySelector('#d_note').value.trim()};
      if(editTxId){ p.tx=p.tx.map(x=>x.id===editTxId?t:x); addAudit('update','directorTx',t.id,(p?.name||'')+' '+t.type+' '+t.amount); editTxId=null; } else { p.tx=p.tx||[]; p.tx.unshift(t); addAudit('add','directorTx',t.id,(p?.name||'')+' '+t.type+' '+t.amount); }
      p.balance=(p.tx||[]).reduce((bal,x)=> bal+((x.type==='invest'||x.type==='profit')?+x.amount:-x.amount),0); saveDB(); try{renderAlertBell();}catch(e){}; renderBox(); };
    wrap.querySelector('#d_body').addEventListener('click',(ev)=>{ const b=ev.target.closest('button'); if(!b) return; const id=b.dataset.id,act=b.dataset.act; const t=(p.tx||[]).find(x=>x.id===id);
      if(act==='edit'){ if(!canAction('edit')) return alert('No permission'); editTxId=t.id; wrap.querySelector('#d_date').value=t.date; wrap.querySelector('#d_type').value=t.type; wrap.querySelector('#d_method').value=t.method||'bank'; wrap.querySelector('#d_amt').value=t.amount||0; wrap.querySelector('#d_note').value=t.note||''; document.getElementById('app').scrollIntoView({ behavior: 'smooth' });}
      else if(act==='del'){ if(!canAction('del')) return alert('No permission'); if(!confirm('Delete transaction?'))return; p.tx=p.tx.filter(x=>x.id!==id); p.balance=(p.tx||[]).reduce((bal,x)=> bal+((x.type==='invest'||x.type==='profit')?+x.amount:-x.amount),0); saveDB(); try{renderAlertBell();}catch(e){}; addAudit('delete','directorTx',id,(p?.name||'')); renderBox(); } });
  }
  wrap.querySelector('#d_sel').onchange=renderBox; renderBox();
  wrap.querySelector('#d_renbtn').onclick=()=>{ if(!canAction('edit')) return alert('No permission'); const i=Number(sel().value||0); const p=db.partners[i]; if(!p) return; const nm=wrap.querySelector('#d_rename').value.trim(); if(!nm) return; p.name=nm; saveDB(); try{renderAlertBell();}catch(e){}; addAudit('update','director','rename',nm); setTab('Directors'); };
  return wrap;
}

/* ========= Investors ========= */
function viewInvestors(){ if(!canTab('Investors')) return document.createElement('div'); const wrap=document.createElement('div'); wrap.className='card';
  wrap.innerHTML=`<h2>Investors</h2><div class="row"><input id="i_name" placeholder="Investor name"><button id="i_addInv" class="primary">Add investor</button><span class="small">Track funds in/out & balance; tag investor on vehicle.</span></div>
  <div class="row"><select id="i_sel"><option value="">Select investor‚Ä¶</option>${(db.investors||[]).map(i=>`<option value="${i.id}">${i.name}</option>`).join('')}</select></div><div id="i_box" class="card"></div>`;
  
  function exportInvestorStatement(invId){
  const inv = (db.investors || []).find(i => i.id === invId);
  if(!inv){
    alert('Investor not found.');
    return;
  }
  const tx = (inv.tx || []).slice().sort((a,b)=> new Date(a.date||0) - new Date(b.date||0));
  
  let running = 0;
  const rows = tx.map(t=>{
    const amt = Number(t.amount || 0);
    if(t.type === 'fund_in') running += amt;
    else if(t.type === 'withdraw') running -= amt;
    else running += amt;
    return {
      date: ddmmyyyy(t.date),
      type: t.type || '',
      method: t.method || '',
      amount: fmtMoney(amt),
      note: t.note || '',
      balance: fmtMoney(running)
    };
  });
  
  const headers = ['Date','Type','Method','Amount','Note','Running Balance'];
  const lines = [];
  lines.push(headers.join(','));
  rows.forEach(r=>{
    const vals = [r.date,r.type,r.method,r.amount,r.note,r.balance].map(cell=>{
      const s = String(cell == null ? '' : cell);
      if(s.includes(',') || s.includes('"') || s.includes('\n')){
        return '"' + s.replace(/"/g,'""') + '"';
      }
      return s;
    });
    lines.push(vals.join(','));
  });
  
  const csv = lines.join('\n');
  const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  const safeName = (inv.name || 'investor').replace(/[^a-z0-9]+/gi,'_');
  a.href = url;
  a.download = 'investor_statement_' + safeName + '_' + new Date().toISOString().slice(0,10) + '.csv';
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  setTimeout(()=>URL.revokeObjectURL(url), 10000);
  
  if(typeof addAudit === 'function'){
    addAudit('export','investor',inv.id,'Export statement ' + inv.name);
  }
  }


  // Hard-wire Delete button next to "Add investor"
  (function(){
    const addBtn = wrap.querySelector('#i_addInv');
    if(addBtn && !wrap.querySelector('#i_delbtn')){
      const del = document.createElement('button');
      del.id='i_delbtn'; del.className='danger'; del.textContent='Delete';
      addBtn.parentNode.insertBefore(del, addBtn.nextSibling);
    }
  })();
  
  wrap.querySelector('#i_addInv').onclick=()=>{ 
    if(!canAction('add')) return alert('No permission'); 
    const name=wrap.querySelector('#i_name').value.trim(); 
    if(!name) return alert('Enter name'); 
    const inv={id:uid(),name,balance:0,tx:[]}; 
    (db.investors=db.investors||[]).unshift(inv); 
    saveDB(); 
    try{renderAlertBell();}catch(e){}; 
    addAudit('add','investor',inv.id,name); 
    setTab('Investors'); 
  };
  
  // Investor deletion - single clean implementation
  (function(){
    const delBtn = wrap.querySelector('#i_delbtn');
    if(!delBtn || delBtn._wired) return;
    delBtn._wired = true;
    delBtn.onclick = () => {
      if(!canAction('del')) return alert('No permission to delete investors');
      
      const sel = wrap.querySelector('#i_sel');
      const id = (sel && sel.value) || '';
      if(!id) return alert('Select an investor to delete');
      
      const inv = (db.investors||[]).find(x => x.id === id);
      if(!inv) return alert('Investor not found');
      
      // Check for linked vehicles
      const linked = (db.vehicles || []).filter(v => {
        const byId   = v.investorId && v.investorId === inv.id;
        const byName = (v.investor || '') === inv.name;
        return byId || byName;
      });

      if (linked.length > 0) {
        const others = (db.investors || []).filter(x => x !== inv);
        let choice = 'dealer';

        if (others.length > 0) {
          const names = others.map(o => o.name).join(', ');
          const ans = prompt(
            'Investor "' + inv.name + '" has ' + linked.length + ' vehicle(s).\n' +
            'Type a new investor name to reassign (' + names + '), or leave blank for DEALER:',
            ''
          );
          if (ans && ans.trim()) {
            choice = ans.trim();
          }
        }

        // Reassign vehicles
        linked.forEach(v => {
          if (choice === 'dealer') {
            v.ownerType = 'owned';
            v.investor = '';
            v.investorId = null;
          } else {
            const newInv = (db.investors || []).find(x => x.name === choice);
            v.ownerType = 'investor';
            v.investor = choice;
            v.investorId = newInv ? newInv.id : null;
          }
        });
      }

    const soldIds = new Set((db.sales || []).map(s => s.vehicleId));
    const live = linked.filter(v => !soldIds.has(v.id));

    assigned = live.reduce((t, v) => {
      const vx = (db.vehicleExpenses || [])
        .filter(e => e.vehicleId === v.id)
        .reduce((u, e) => u + Number(e.amount || 0), 0);
      return t + Number(v.purchase || 0) + vx;
    }, 0);
    unassigned = Number(inv.balance || 0) - assigned;
      
      if(linked.length > 0){
        const others = (db.investors||[]).filter(x => x !== inv);
        let choice = 'dealer';
        
        if(others.length > 0){
          const names = others.map(o => o.name).join(', ');
          const ans = prompt(
            'Investor \"' + inv.name + '\" has ' + linked.length + ' vehicle(s).\n' +
            'Type a new investor name to reassign (' + names + '), or leave blank for DEALER:',
            ''
          );
          if(ans && others.some(o => o.name === ans)) {
            choice = ans;
          } else {
            choice = 'dealer';
          }
        }
        
        // Reassign vehicles
        linked.forEach(v => {
          if(choice === 'dealer'){
            v.ownerType = 'owned';
            v.investor = '';
          } else {
            v.ownerType = 'investor';
            v.investor = choice;
          }
        });
      }
      
      if(!confirm('Delete investor \"' + (inv.name||'') + '\"?')) return;
      
      // track investor deletion
      markDeleted('investors', id);

      db.investors = (db.investors || []).filter(x => x.id !== id);
      saveDB(); 
      try{renderAlertBell();}catch(e){}
      addAudit('delete','investor',inv.id,(inv.name||''));
      setTab('Investors'); // Refresh the view
    };
  })();

  function renderDetails(id){ 
    let assigned = 0, unassigned = 0;
    const inv=(db.investors||[]).find(x=>x.id===id); 
    if(!inv){ wrap.querySelector('#i_box').innerHTML=''; return; }
    
    let ins=0,outs=0; 
    (inv.tx||[]).forEach(x=>{ 
      if(x.type==='fund_in') ins+=+x.amount||0; 
      if(x.type==='withdraw') outs+=+x.amount||0; 
    }); 
    inv.balance=ins-outs;
    
    const linked=(db.vehicles||[]).filter(v=> v.ownerType==='investor' && (v.investor||'')===inv.name);
    const soldIds=new Set((db.sales||[]).map(s=>s.vehicleId));
    const live=linked.filter(v=>!soldIds.has(v.id));
    assigned = live.reduce((t,v)=>{ 
      const vx=(db.vehicleExpenses||[]).filter(e=>e.vehicleId===v.id).reduce((u,e)=>u+Number(e.amount||0),0); 
      return t + Number(v.purchase||0) + vx; 
    },0);
    unassigned = Number(inv.balance||0) - assigned;

    const txRows=(inv.tx||[]).map(t=>`<tr><td>${ddmmyyyy(t.date||'')}</td><td>${t.type}</td><td>${t.method||'bank'}</td><td class="right">${fmtMoney(t.amount)}</td><td>${t.note||''}</td><td>${canAction('edit')?`<button data-act="edit" data-id="${t.id}">Edit</button>`:''} ${canAction('del')?`<button class="danger" data-act="del" data-id="${t.id}">Delete</button>`:''}</td></tr>`).join('')||'<tr><td colspan="6" class="small">No transactions</td></tr>';
    
    wrap.querySelector('#i_box').innerHTML=`<div class="row"><input id="i_date" type="date"><select id="i_type"><option value="fund_in">fund_in</option><option value="withdraw">withdraw</option></select><select id="i_method"><option>bank</option><option>cash</option></select><input id="i_amt" type="number" placeholder="Amount"><input id="i_note" placeholder="Note"><button id="i_tx" class="primary">Add / Update</button></div>
    <div class="row small">
      <b>Balance:</b> ${fmtMoney(inv.balance||0)}
      <button id="i_stmt_csv" style="margin-left:8px;">Export Statement (CSV)</button>
    </div>
    <div class=\"row small\"><b>Assigned to vehicles (unsold):</b> ${fmtMoney(assigned)} &nbsp; <b>Unassigned:</b> ${fmtMoney(unassigned)}</div><table class="table" style="margin-top:10px"><thead><tr><th>Date</th><th>Type</th><th>Method</th><th class="right">Amount</th><th>Note</th><th>Actions</th></tr></thead><tbody id="i_body">${txRows}</tbody></table>`;
    
    let editTxId=null; 
    wrap.querySelector('#i_tx').onclick=()=>{ 
      if(!canAction('add')) return alert('No permission'); 
      const t={id:editTxId||uid(),date:wrap.querySelector('#i_date').value,type:wrap.querySelector('#i_type').value,method:wrap.querySelector('#i_method').value,amount:Number(wrap.querySelector('#i_amt').value||0),note:wrap.querySelector('#i_note').value.trim()};
      if(editTxId){ 
        inv.tx=inv.tx.map(x=>x.id===editTxId?t:x); 
        addAudit('update','investorTx',t.id,inv.name+' '+t.type+' '+t.amount); 
      } else { 
        inv.tx=inv.tx||[]; 
        inv.tx.unshift(t); 
        addAudit('add','investorTx',t.id,inv.name+' '+t.type+' '+t.amount); 
      }
      let ins=0,outs=0; 
      (inv.tx||[]).forEach(x=>{ 
        if(x.type==='fund_in') ins+=+x.amount||0; 
        if(x.type==='withdraw') outs+=+x.amount||0; 
      }); 
      inv.balance=ins-outs; 
      saveDB(); 
      try{renderAlertBell();}catch(e){}; 
      editTxId=null; 
      wrap.querySelector('#i_amt').value=''; 
      wrap.querySelector('#i_note').value=''; 
      renderDetails(id);
    };

    const stmtBtn = wrap.querySelector('#i_stmt_csv');
    if (stmtBtn) {
      stmtBtn.onclick = () => {
        exportInvestorStatement(inv.id);
      };
    }
    
    wrap.querySelector('#i_body').addEventListener('click',(ev)=>{ 
      const b=ev.target.closest('button'); 
      if(!b) return; 
      const t=(inv.tx||[]).find(x=>x.id===b.dataset.id);
      if(b.dataset.act==='edit'){ 
        if(!canAction('edit')) return alert('No permission'); 
        editTxId=t.id; 
        wrap.querySelector('#i_date').value=t.date; 
        wrap.querySelector('#i_type').value=t.type; 
        wrap.querySelector('#i_method').value=t.method||'bank'; 
        wrap.querySelector('#i_amt').value=t.amount||0; 
        wrap.querySelector('#i_note').value=t.note||'';
        document.getElementById('app').scrollIntoView({ behavior: 'smooth' }); 
      }
      else if(b.dataset.act==='del'){ 
        if(!canAction('del')) return alert('No permission'); 
        if(!confirm('Delete?')) return; 
        inv.tx=inv.tx.filter(x=>x.id!==t.id); 
        let ins=0,outs=0; 
        (inv.tx||[]).forEach(x=>{ 
          if(x.type==='fund_in') ins+=+x.amount||0; 
          if(x.type==='withdraw') outs+=+x.amount||0; 
        }); 
        inv.balance=ins-outs; 
        saveDB(); 
        try{renderAlertBell();}catch(e){}; 
        addAudit('delete','investorTx',t.id,inv.name); 
        renderDetails(id); 
      }
    });
  }
  
  wrap.querySelector('#i_sel').onchange=(e)=>renderDetails(e.target.value); 
  return wrap;
}

/* ========= Invoice / Proforma printing ========= */
function price(n){ return '¬£'+Number(n||0).toFixed(2); }
function invoiceHeaderHTML(title, refNo, date){
  const co=db.company||{};
  const logo = (co.logo||'').trim()
    ? `<img src="${co.logo}" style="max-width:${Number(co.logoMaxW||140)}px;max-height:${Number(co.logoMaxH||80)}px;object-fit:contain">`
    : '';
  const now = new Date();
  const timeStr = now.toLocaleTimeString('en-GB',{hour:'2-digit',minute:'2-digit'});
  return `<div class="h"><div>${logo}</div>
    <div style="text-align:right"><h2 style="margin:0">${title}</h2><div>Invoice #: ${refNo||''}</div><div>Date: ${ddmmyyyy(date||'')}</div><div>Time: ${timeStr}</div></div></div>
    <div style="margin-top:6px"><b>${co.name||'Star Cars London Ltd'}</b><br>${co.address||''}<br>P: ${co.phone||''} ${co.email||''}<br>COMPANY #: ${co.companyNumber||''} ‚Ä¢ VAT #: ${co.vatNumber||''} ‚Ä¢ FCA #: ${co.fcaNumber||''}</div>`;
}

function printInvoice(saleId){
  const s = db.sales.find(x => x.id === saleId);
  if (!s) return;

  const v  = db.vehicles.find(x => x.id === s.vehicleId) || {};
  const co = db.company || {};
  const fontPx  = Number(co.invoiceFontPx || 12);
  const termsPx = Number(co.termsFontPx || 10);

  const html = `<!doctype html><html><head><meta charset="utf-8"><title>Invoice</title>
  <style>
    @page{size:A4;margin:10mm 10mm}
    body{font-family:Arial;color:#111;font-size:${fontPx}px}
    .h{display:flex;justify-content:space-between;align-items:flex-start;border-bottom:2px solid #000;padding-bottom:6px;margin-bottom:6px}
    .title{font-size:26px;font-weight:800;letter-spacing:.5px}
    .right{text-align:right}
    .co{margin-top:6px}
    table{width:100%;border-collapse:collapse}
    th,td{border:1px solid #000;padding:8px 10px;font-size:${fontPx}px;vertical-align:top}
    th{background:#fff;text-align:left;font-weight:700}
    .tight td,.tight th{padding:6px 8px}
    .no-border{border:none !important}
    .terms{font-size:${Math.max(8,termsPx)}px;line-height:1.35;white-space:normal}
    .terms{ page-break-inside: avoid; break-inside: avoid; }
    .no-print{margin:8px 0}
    @media print{.no-print{display:none !important}}

    /* Bottom layout like your PDF */
    .sigRow{margin:18px 0 10px}

  .sigLine{
  display:inline-block;
  width:180px;              /* ‚¨Ö shorter line */
  border-bottom:1px solid #000;
  height:14px;
  vertical-align:baseline;
  }

  .sigFlex{
  display:flex;
  gap:12px;
  align-items:center;
  white-space:nowrap;       /* ‚¨Ö forces single line */
  margin-bottom:18px;
  }

    .pxBox{width:62%}
    .payBox{width:38%}
    .pxInner{width:100%;border-collapse:collapse}
    .pxInner th,.pxInner td{border:1px solid #000;padding:10px;font-size:${fontPx}px}
    .pxTitle{font-family:Georgia,"Times New Roman",serif;font-size:28px;text-align:center;font-weight:500}
    .payTbl{width:100%;border-collapse:collapse}
    .payTbl th,.payTbl td{border:1px solid #000;padding:8px 10px;font-size:${fontPx}px}
    .payTbl th{width:70%;font-weight:700}
    .payTbl td{text-align:right}
  </style></head><body>

  <button class="no-print" onclick="window.print()" style="margin:8px 0">Print / Save as PDF</button>

  ${invoiceHeaderHTML('SALES INVOICE', s.invNo, s.date)}

  <!-- Invoice To / Deliver To -->
  <table class="tight">
    <tr>
      <th style="width:30%">Invoice To:</th>
      <td>${s.buyer||''}<br>${s.address||''}<br>${s.phone||''} ${s.email||''}</td>
    </tr>
    ${s.deliverTo && s.deliverTo.trim() ? `
    <tr>
      <th>Deliver To:</th>
      <td>${s.deliverTo||''}</td>
    </tr>
    ` : ``}
  </table>

  <!-- Vehicle block -->
  <table class="tight" style="margin-top:0">
    <tr>
      <th style="width:26%">Vehicle</th>
      <td>
        <b>${v.make||''} ${v.model||''}</b><br>
        Colour: ${v.colour||''}<br>
        REG: <b>${v.reg||''}</b> &nbsp; VIN: ${v.vin||''}<br>
        Mileage: ${(s.mileage||v.mileage||'')} &nbsp; First Reg: ${ddmmyyyy(s.firstReg||'')}
      </td>
    </tr>
    <tr>
      <th>Keys / MOT / History</th>
      <td>
        Keys: ${s.keys||'N/A'} &nbsp;&nbsp;
        MOT Exp: ${s.mot||'N/A'} &nbsp;&nbsp;
        Service History: ${s.serviceHistory||'N/A'}
      </td>
    </tr>
  </table>

  <!-- Terms -->
  <div style="margin-top:10px">
    <div style="font-weight:700;margin-bottom:4px">Terms:</div>
    <div class="terms">${String(co.terms||'').replace(/\n/g,'<br>')}</div>
  </div>

  <!-- Signatures -->
  <div class="sigRow">
  <div class="sigFlex">
    <span><b>Customer Date:</b></span>
    <span class="sigLine"></span>
    <span><b>Customer Signature:</b></span>
    <span class="sigLine"></span>
  </div>

  <div class="sigFlex">
    <span><b>Dealer Date:</b></span>
    <span class="sigLine"></span>
    <span><b>Dealer Signature:</b></span>
    <span class="sigLine"></span>
  </div>

  ${hasPX(s) ? `
  <div class="bottomWrap">
  <table class="bottomTbl" style="width:100%;border-collapse:collapse">
    <tr>
      <td class="pxBox" style="padding-right:14px;border:none">
        <table class="pxInner">
          <tr><th class="pxTitle" colspan="2"><b>PART EX</b></th></tr>
          <tr>
            <td style="width:50%"><b>MAKE:</b><br>${s.pxMake || '‚Äî'}</td>
            <td style="width:50%"><b>MODEL:</b><br>${s.pxModel || '‚Äî'}</td>
          </tr>
          <tr>
            <td><b>REG:</b><br>${s.pxReg || '‚Äî'}</td>
            <td><b>MILEAGE:</b><br>${s.pxMileage || s.pxMilage || '‚Äî'}</td>
          </tr>
          <tr>
            <td colspan="2" style="height:40px"></td>
          </tr>
        </table>
      </td>

      <td class="payBox" style="border:none">
        <table class="payTbl">
          <tr><th>Cash Price</th><td>${price(s.salePrice)}</td></tr>
          <tr><th>Deposit</th><td>${price(s.deposit)}</td></tr>
          <tr><th>Cash</th><td>${price(s.cash)}</td></tr>
          <tr><th>Card</th><td>${price(s.card)}</td></tr>
          <tr><th>Bank</th><td>${price(s.bank)}</td></tr>
          <tr><th>Finance</th><td>${price(s.finance)}</td></tr>
          <tr><th>Part-ex Allowance</th><td>${price(s.pxAllowance)}</td></tr>
          <tr><th>Total Paid</th><td>${price((+s.deposit||0)+(+s.cash||0)+(+s.card||0)+(+s.bank||0)+(+s.finance||0)+(+s.pxAllowance||0))}</td></tr>
        </table>
      </td>
    </tr>
  </table>
  </div>
  ` : `
  <div class="bottomWrap">
  <table style="width:100%;border-collapse:collapse">
    <tr>
      <td style="border:none">
        <table class="payTbl" style="width:50%;margin-left:auto">
          <tr><th>Cash Price</th><td>${price(s.salePrice)}</td></tr>
          <tr><th>Deposit</th><td>${price(s.deposit)}</td></tr>
          <tr><th>Cash</th><td>${price(s.cash)}</td></tr>
          <tr><th>Card</th><td>${price(s.card)}</td></tr>
          <tr><th>Bank Transfer</th><td>${price(s.bank)}</td></tr>
          <tr><th>Finance</th><td>${price(s.finance)}</td></tr>
          <tr><th>Total Paid</th><td>${price((+s.deposit||0)+(+s.cash||0)+(+s.card||0)+(+s.bank||0)+(+s.finance||0))}</td></tr>
        </table>
      </td>
    </tr>
  </table>
  </div>
  `}

  </body></html>`;

  openPrintable(html);
}

function printFinanceProforma(saleId){
  const s = db.sales.find(x => x.id === saleId);
  if (!s) return;

  const v  = db.vehicles.find(x => x.id === s.vehicleId) || {};
  const co = db.company || {};
  const fontPx  = Number(co.invoiceFontPx || 12);
  const termsPx = Number(co.termsFontPx || 10);

  const logo = (co.logo||'').trim()
    ? `<img src="${co.logo}" style="max-width:${Number(co.logoMaxW||140)}px;max-height:${Number(co.logoMaxH||80)}px;object-fit:contain">`
    : '';
  const now    = new Date();
  const timeStr = now.toLocaleTimeString('en-GB',{hour:'2-digit',minute:'2-digit'});

  const headerHTML = `<div class="h">
    <div>${logo}</div>
    <div class="right">
      <div class="title">PROFORMA INVOICE ‚Äî FINANCE</div>
      <div>Invoice #: ${s.invNo||''}</div>
      <div>Date: ${ddmmyyyy(s.date||'')}</div>
      <div>Time: ${timeStr}</div>
    </div>
  </div>
  <div class="co">
    <b>${co.name||'Star Cars London Ltd'}</b><br>
    ${co.address||''}<br>
    P: ${co.phone||''} ${co.email||''}<br>
    COMPANY #: ${co.companyNumber||''} ‚Ä¢ VAT #: ${co.vatNumber||''} ‚Ä¢ FCA #: ${co.fcaNumber||''}
  </div>`;

  const financeTerms = (co.financeTerms || co.terms || '');

  const html = `<!doctype html><html><head><meta charset="utf-8"><title>Finance Proforma</title>
  <style>
    @page{size:A4;margin:10mm 10mm}
    body{font-family:Arial;color:#111;font-size:${fontPx}px}
    .h{display:flex;justify-content:space-between;align-items:flex-start;border-bottom:2px solid #000;padding-bottom:6px;margin-bottom:6px}
    .title{font-size:18px;font-weight:800;letter-spacing:.5px}
    .right{text-align:right}
    .co{margin-top:6px}
    table{width:100%;border-collapse:collapse}
    th,td{border:1px solid #000;padding:8px 10px;font-size:${fontPx}px;vertical-align:top}
    th{background:#fff;text-align:left;font-weight:700}
    .tight td,.tight th{padding:6px 8px}
    .terms{font-size:${Math.max(8,termsPx)}px;line-height:1.35;white-space:normal}
    .terms{ page-break-inside: avoid; break-inside: avoid; }
    .print-btn-proforma{margin:8px 0}
    @media print{.print-btn-proforma{display:none !important}}

    /* Bottom layout like your PDF */
    .sigRow{margin:18px 0 10px}

    .sigLine{
    display:inline-block;
    width:180px;              /* ‚¨Ö shorter line */
    border-bottom:1px solid #000;
    height:14px;
    vertical-align:baseline;
    }

    .sigFlex{
    display:flex;
    gap:12px;
    align-items:center;
    white-space:nowrap;       /* ‚¨Ö forces single line */
    margin-bottom:18px;
    }

    .pxBox{width:62%}
    .payBox{width:38%}
    .pxInner{width:100%;border-collapse:collapse}
    .pxInner th,.pxInner td{border:1px solid #000;padding:10px;font-size:${fontPx}px}
    .pxTitle{font-family:Georgia,"Times New Roman",serif;font-size:28px;text-align:center;font-weight:500}
    .payTbl{width:100%;border-collapse:collapse}
    .payTbl th,.payTbl td{border:1px solid #000;padding:8px 10px;font-size:${fontPx}px}
    .payTbl th{width:70%;font-weight:700}
    .payTbl td{text-align:right}
    </style></head><body>

  <button class="print-btn-proforma" onclick="window.print()" style="margin:8px 0">Print / Save as PDF</button>

  ${headerHTML}

  <!-- Invoice To / Deliver To -->
  <table class="tight">
    <tr>
      <th style="width:30%">Invoice To:</th>
      <td>${s.buyer||''}<br>${s.address||''}<br>${s.phone||''} ${s.email||''}</td></td>
    </tr>
    ${s.deliverTo && s.deliverTo.trim() ? `
    <tr>
      <th>Deliver To:</th>
      <td>${s.deliverTo||''}</td>
    </tr>
    ` : ``}
  </table>

  <!-- Vehicle block -->
  <table class="tight" style="margin-top:0">
    <tr>
      <th style="width:26%">Vehicle</th>
      <td>
        <b>${v.make||''} ${v.model||''}</b><br>
        Colour: ${v.colour||''}<br>
        REG: <b>${v.reg||''}</b> &nbsp; VIN: ${v.vin||''}<br>
        Mileage: ${(s.mileage||v.mileage||'')} &nbsp; First Reg: ${ddmmyyyy(s.firstReg||'')}
      </td>
    </tr>
    <tr>
      <th>Keys / MOT / History</th>
      <td>
        Keys: ${s.keys||'N/A'} &nbsp;&nbsp;
        MOT Exp: ${s.mot||'N/A'} &nbsp;&nbsp;
        Service History: ${s.serviceHistory||'N/A'}
      </td>
    </tr>
  </table>

  <!-- Terms -->
  <div style="margin-top:10px">
    <div style="font-weight:700;margin-bottom:4px">Terms:</div>
    <div class="terms">${String(financeTerms).replace(/\n/g,'<br>')}</div>
  </div>

  <!-- Signatures -->
  <div class="sigRow">
  <div class="sigFlex">
    <span><b>Customer Date:</b></span>
    <span class="sigLine"></span>
    <span><b>Customer Signature:</b></span>
    <span class="sigLine"></span>
  </div>

  <div class="sigFlex">
    <span><b>Dealer Date:</b></span>
    <span class="sigLine"></span>
    <span><b>Dealer Signature:</b></span>
    <span class="sigLine"></span>
  </div>

  ${hasPX(s) ? `
  <div class="bottomWrap">
  <table class="bottomTbl" style="width:100%;border-collapse:collapse">
    <tr>
      <td class="pxBox" style="padding-right:14px;border:none">
        <table class="pxInner">
          <tr><th class="pxTitle" colspan="2"><b>PART EX</b></th></tr>
          <tr>
            <td style="width:50%"><b>MAKE:</b><br>${s.pxMake || '‚Äî'}</td>
            <td style="width:50%"><b>MODEL:</b><br>${s.pxModel || '‚Äî'}</td>
          </tr>
          <tr>
            <td><b>REG:</b><br>${s.pxReg || '‚Äî'}</td>
            <td><b>MILEAGE:</b><br>${s.pxMileage || s.pxMilage || '‚Äî'}</td>
          </tr>
          <tr>
            <td colspan="2" style="height:40px"></td>
          </tr>
        </table>
      </td>

      <td class="payBox" style="border:none">
        <table class="payTbl">
          <tr><th>Cash Price</th><td>${price(s.salePrice)}</td></tr>
          <tr><th>Deposit</th><td>${price(s.deposit)}</td></tr>
          <tr><th>Cash</th><td>${price(s.cash)}</td></tr>
          <tr><th>Card</th><td>${price(s.card)}</td></tr>
          <tr><th>Bank</th><td>${price(s.bank)}</td></tr>
          <tr><th>Finance</th><td>${price(s.finance)}</td></tr>
          <tr><th>Part-ex Allowance</th><td>${price(s.pxAllowance)}</td></tr>
          <tr><th>Total Paid</th><td>${price((+s.deposit||0)+(+s.cash||0)+(+s.card||0)+(+s.bank||0)+(+s.finance||0)+(+s.pxAllowance||0))}</td></tr>
        </table>
      </td>
    </tr>
  </table>
  </div>
  ` : `
  <div class="bottomWrap">
  <table style="width:100%;border-collapse:collapse">
    <tr>
      <td style="border:none">
        <table class="payTbl" style="width:50%;margin-left:auto">
          <tr><th>Cash Price</th><td>${price(s.salePrice)}</td></tr>
          <tr><th>Deposit</th><td>${price(s.deposit)}</td></tr>
          <tr><th>Cash</th><td>${price(s.cash)}</td></tr>
          <tr><th>Card</th><td>${price(s.card)}</td></tr>
          <tr><th>Bank Transfer</th><td>${price(s.bank)}</td></tr>
          <tr><th>Finance</th><td>${price(s.finance)}</td></tr>
          <tr><th>Total Paid</th><td>${price((+s.deposit||0)+(+s.cash||0)+(+s.card||0)+(+s.bank||0)+(+s.finance||0))}</td></tr>
        </table>
      </td>
    </tr>
  </table>
  </div>
  `}

  </body></html>`;

  openPrintable(html);
}

function ensureVehicleFields(v){
  if(!v) return v;
  if(typeof v.readyForSale !== 'boolean') v.readyForSale = false;
  if(typeof v.prepStage !== 'string') v.prepStage = 'None';
  if(typeof v.notReadyReason !== 'string') v.notReadyReason = '';
  if(typeof v.prepNotes !== 'string') v.prepNotes = '';
  return v;
}

function isRealSale(s) {
  if (!s) return false;
  if (s.refunded) return false;
  const st = s.status || 'completed'; // old sales have no status ‚Üí completed
  return st === 'completed';
}

/* ========= Reports (inc. Month Close) ========= */
function viewReports(){
  if(!canTab('Reports')) return document.createElement('div'); const wrap=document.createElement('div'); wrap.className='card';
  wrap.innerHTML=`<h2>Reports</h2>
  <div class="card"><h3>Audit Log</h3><div class="row"><input id="r_from" type="date"><input id="r_to" type="date"><select id="r_user"><option value="">All users</option>${(db.users||[]).map(u=>'<option>'+u.username+'</option>').join('')}</select>
  <select id="r_entity"><option value="">All entities</option><option>vehicle</option><option>sale</option><option>vehicleExpense</option><option>showroomExpense</option><option>directorTx</option><option>investorTx</option><option>todo</option></select>
  <button id="r_run">Run</button><button id="r_export">Export CSV</button></div><div id="r_out" class="small"></div>
  <details id="r_fold"><summary>Show audit entries (<span id="r_count">0</span>)</summary><div id="r_tblwrap"><table class="table" style="margin-top:8px"><thead><tr><th>When</th><th>User</th><th>Action</th><th>Entity</th><th>Details</th></tr></thead><tbody id="r_body"></tbody></table></div></details></div>

  <div class="card"><h3>Monthly Summary</h3><div class="row"><input id="rm_month" type="month" value="${new Date().toISOString().slice(0,7)}"><label class="small"><input type="checkbox" id="rm_cover"> Pretend showroom expenses covered by monthly profit</label><button id="rm_go">Calculate</button><button id="rm_export_xlsx">Export Excel (Month + Sold cars)</button></div><div id="rm_box"></div></div>

  <div class="card"><h3>Month Close (Directors & Investors)</h3>
    <div class="row"><input id="mc_month" type="month" value="${new Date().toISOString().slice(0,7)}"> <button id="mc_prev">Preview</button><button id="mc_post" class="primary">Post</button><button id="mc_export">Export PDF</button><span id="mc_warn" class="small" style="margin-left:8px;color:#ffb3b3"></span></div><div id="mc_box" class="small"></div>
  </div>
  
  <button id="rep_fin_unpaid">Finance Unpaid</button>
  <div id="rep_fin_unpaid_out"></div>

  <div class="card">
    <details>
      <summary><h3 style="display:inline; cursor:pointer;">Sales Insights (Accounts)</h3></summary>
      <div class="row" style="margin-top:10px">
        <input id="si_month" type="month" value="${new Date().toISOString().slice(0,7)}"> </label>
        <button id="si_run" class="primary">Run</button>
        <button id="si_export_csv">Export CSV</button>
    </div>

    <div class="grid2" style="margin-top:10px">
    <div class="card">
      <h4 style="margin:0 0 8px 0">Top Make / Model</h4>
      <div id="si_top_mm" class="small"></div>
      <div id="si_tbl_mm"></div>
    </div>

    <div class="card">
      <h4 style="margin:0 0 8px 0">Price Range Sold</h4>
      <div id="si_top_price" class="small"></div>
      <div id="si_tbl_price"></div>
    </div>

    <div class="card">
      <h4 style="margin:0 0 8px 0">Customer Areas (Postcode Outward)</h4>
      <div id="si_top_area" class="small"></div>
      <div id="si_tbl_area"></div>
    </div>

    <div class="card">
      <h4 style="margin:0 0 8px 0">Stock List ‚ÄúAs At‚Äù Month End</h4>
      <div class="row">
        <button id="si_stock_run">Build Stock List</button>
        <button id="si_stock_export_csv">Export Stock CSV</button>
      </div>
      <div id="si_stock_sum" class="small" style="margin-top:8px"></div>
      <div id="si_tbl_stock" style="margin-top:8px"></div>
    </div>
    </div>

    <div id="si_debug" class="small" style="margin-top:10px"></div>
    </details>
  </div>

  <div class="card">
    <details>
      <summary><h3 style="display:inline; cursor:pointer;">Finance Sales (Accounts)</h3></summary>
      <div class="row" style="margin-top:10px">
        <input id="rf_month" type="month" value="${new Date().toISOString().slice(0,7)}"> </label>
        <button id="rf_run" class="primary">Run</button>
        <button id="rf_export">Export CSV</button>
    </div>

    <div id="rf_summary" class="small" style="margin-top:10px"></div>

    <details open style="margin-top:10px">
      <summary>Show finance company breakdown</summary>
      <div id="rf_out" style="margin-top:10px"></div>
    </details>

    <details style="margin-top:10px">
      <summary>Show salesperson breakdown (from Audit Log)</summary>
      <div id="rf_by_user" style="margin-top:10px"></div>
    </details>
  </div>

  <div class="card" style="margin-top:12px">
    <details id="fr_fold">
      <summary style="cursor:pointer; font-weight:bold; font-size:1.17em;">Finance Sales Breakdown</summary>
      <div style="margin-top:12px">
        <div class="row" style="justify-content:space-between">
          <div class="row">
            <input id="fr_month" type="month" value="${new Date().toISOString().slice(0,7)}">
            <button id="fr_run" class="primary">Run</button>
            <button id="fr_export">Export CSV</button>
          </div>
        </div>
        <div id="fr_sum" class="small" style="margin-top:10px"></div>
        <div id="fr_out" style="margin-top:10px"></div>
      </div>
    </details>
  </div>

  <div class="card" style="margin-top:12px">
    <details id="nr_fold">
      <summary style="cursor:pointer; font-weight:bold; font-size:1.17em;">Cars Not Ready (In Stock)</summary>
      <div class="row" style="justify-content:space-between;align-items:flex-end">
        <div>
          <div class="small">Shows vehicles still in stock that are NOT ready for sale, with reason + stage</div>
        </div>
        <div class="row">
          <select id="nr_stage" style="padding:4px 6px;font-size:12px;background:#0f1628;border:1px solid var(--line);color:var(--ink);border-radius:6px;">
            <option value="">All stages</option>
            <option>None</option><option>Prep</option><option>Workshop</option><option>Valet</option><option>Photos</option><option>Advert</option><option>Ready</option>
          </select>
          <input id="nr_q" placeholder="Search reg/make/model/reason..." />
          <button id="nr_run" class="primary">Run</button>
          <button id="nr_export">Export CSV</button>
        </div>
      </div>
      <div id="nr_sum" class="small" style="margin-top:10px"></div>
      <div id="nr_tbl" style="margin-top:10px"></div>
    </details>
  </div>
  `;
  
  /* Audit Log */
  const body=wrap.querySelector('#r_body'); const out=wrap.querySelector('#r_out');
  function run(){ const f=wrap.querySelector('#r_from').value; const t=wrap.querySelector('#r_to').value; const user=wrap.querySelector('#r_user').value; const ent=wrap.querySelector('#r_entity').value;
    let rows=(db.audit||[]).slice(); if(f) rows=rows.filter(a=>a.ts>=f); if(t) rows=rows.filter(a=>a.ts<=t+'T23:59:59'); if(user) rows=rows.filter(a=>a.user===user); if(ent) rows=rows.filter(a=>a.entity===ent);
    body.innerHTML=''; rows.forEach(a=>{ const d=new Date(a.ts); body.insertAdjacentHTML('beforeend','<tr><td>'+ddmmyyyy(d.toISOString().slice(0,10))+'</td><td>'+(a.user||'')+'</td><td>'+a.action+'</td><td>'+a.entity+'</td><td>'+(a.details||'')+'</td></tr>'); }); out.textContent=rows.length+' entr'+(rows.length===1?'y':'ies'); }
  wrap.querySelector('#r_run').onclick=run; run();
  wrap.querySelector('#r_export').onclick=()=>{ const rows=[["When","User","Action","Entity","Details"]].concat((db.audit||[]).map(a=>[a.ts,a.user,a.action,a.entity,(a.details||'')])); const csv=rows.map(r=>r.map(v=>'"'+String(v).replace(/"/g,'""')+'"').join(',')).join('\n'); const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([csv],{type:'text/csv'})); a.download='audit.csv'; a.click(); };

  /* Monthly Summary - UPDATED to use purchaseDate instead of createdAt */
  wrap.querySelector('#rm_go').onclick=()=>{ 
    const k=(wrap.querySelector('#rm_month').value||'').slice(0,7); 
    let purchases=0,vehExp=0,showExp=0,sales=0,buyCount=0,sellCount=0;
    
    // Count vehicles purchased in this month - using purchaseDate or dateAdded field
    (db.vehicles||[]).forEach(v=>{ 
      // Try purchaseDate first, then dateAdded, then createdAt as fallback
      const purchaseDate = v.purchaseDate || v.dateAdded || v.createdAt || '';
      if(purchaseDate.slice(0,7)===k){ 
        purchases+=Number(v.purchase||0); 
        buyCount++; 
      }
    });
    
    (db.vehicleExpenses||[]).forEach(e=>{ if((e.date||'').slice(0,7)===k) vehExp+=Number(e.amount||0); });
    (db.showroomExpenses||[]).forEach(e=>{ if((e.date||'').slice(0,7)===k) showExp+=Number(e.amount||0); });
    
    // Count vehicles sold in this month
    (db.sales||[]).forEach(s=>{ 
      if ((s.date||'').slice(0,7)===k && isRealSale(s)) { 
        sales+=Number(s.salePrice||0); 
        sellCount++; 
      }
    });

    /* ========= Finance Sales (Accounts) ========= */
    function getSaleCreatedUser(saleId){
      // Uses Audit Log to guess who created the sale (works even if sale object has no user field)
      const a = (db.audit || []).find(x => x.entity === 'sale' && x.entityId === saleId && x.action === 'add');
      return (a && a.user) ? a.user : '';
    }

    function buildFinanceAccounts(monthKey){
      const sales = (db.sales || []).filter(s =>
        isRealSale(s) &&
        (s.date || '').slice(0,7) === monthKey &&
        (
          Number(s.finance || 0) > 0 ||
          String(s.financeCompany || '').trim() !== '' ||
          Number(s.financeAdminFee || 0) > 0 ||
          Number(s.financePayoutAmount || 0) > 0
        )
      );

      // Group by finance company
      const byCo = {};
      sales.forEach(s => {
        const co = (String(s.financeCompany || '').trim() || 'UNKNOWN').toUpperCase();
        if(!byCo[co]) byCo[co] = { company: co, deals: 0, financeAmt: 0, payoutPaid: 0, adminFee: 0 };

        byCo[co].deals += 1;
        byCo[co].financeAmt += Number(s.finance || 0);
        byCo[co].adminFee += Number(s.financeAdminFee || 0);

        // Only count payout if marked paid, otherwise it‚Äôs not ‚Äúreceived‚Äù
        if (s.financePayoutPaid) byCo[co].payoutPaid += Number(s.financePayoutAmount || 0);
      });

      // Group by salesperson (from audit)
      const byUser = {};
      sales.forEach(s => {
        const u = (getSaleCreatedUser(s.id) || 'UNKNOWN');
        if(!byUser[u]) byUser[u] = { user: u, deals: 0, financeAmt: 0, payoutPaid: 0, adminFee: 0 };
        byUser[u].deals += 1;
        byUser[u].financeAmt += Number(s.finance || 0);
        byUser[u].adminFee += Number(s.financeAdminFee || 0);
        if (s.financePayoutPaid) byUser[u].payoutPaid += Number(s.financePayoutAmount || 0);
      });

      const companies = Object.values(byCo).sort((a,b) => b.deals - a.deals);
      const users = Object.values(byUser).sort((a,b) => b.deals - a.deals);

      const totals = companies.reduce((acc,r) => {
        acc.deals += r.deals;
        acc.financeAmt += r.financeAmt;
        acc.payoutPaid += r.payoutPaid;
        acc.adminFee += r.adminFee;
        return acc;
      }, {deals:0, financeAmt:0, payoutPaid:0, adminFee:0});

      // Render summary
      const summaryEl = wrap.querySelector('#rf_summary');
      if(summaryEl){
        summaryEl.innerHTML =
          `<b>${monthKey}</b> ‚Ä¢ Deals: <b>${totals.deals}</b> ‚Ä¢ Finance: <b>${fmtMoney(totals.financeAmt)}</b> ‚Ä¢ Payout received: <b>${fmtMoney(totals.payoutPaid)}</b> ‚Ä¢ Admin fees: <b>${fmtMoney(totals.adminFee)}</b>`;
      }

      // Render company table
      const out = wrap.querySelector('#rf_out');
      if(out){
        out.innerHTML = `
          <table class="table">
            <thead>
              <tr>
                <th>Finance Company</th>
                <th class="right">Deals</th>
                <th class="right">Finance Amount</th>
                <th class="right">Payout Received (Paid)</th>
                <th class="right">Admin Fees</th>
              </tr>
            </thead>
            <tbody>
              ${companies.map(r => `
                <tr>
                  <td>${r.company}</td>
                  <td class="right">${r.deals}</td>
                  <td class="right">${fmtMoney(r.financeAmt)}</td>
                  <td class="right">${fmtMoney(r.payoutPaid)}</td>
                  <td class="right">${fmtMoney(r.adminFee)}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        `;
      }

      // Render user table
      const outU = wrap.querySelector('#rf_by_user');
      if(outU){
        outU.innerHTML = `
          <table class="table">
            <thead>
              <tr>
                <th>Salesperson (from Audit)</th>
                <th class="right">Deals</th>
                <th class="right">Finance Amount</th>
                <th class="right">Payout Received (Paid)</th>
                <th class="right">Admin Fees</th>
              </tr>
            </thead>
            <tbody>
              ${users.map(r => `
                <tr>
                  <td>${r.user}</td>
                  <td class="right">${r.deals}</td>
                  <td class="right">${fmtMoney(r.financeAmt)}</td>
                  <td class="right">${fmtMoney(r.payoutPaid)}</td>
                  <td class="right">${fmtMoney(r.adminFee)}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        `;
      }

      return { monthKey, companies, users, totals };
    }

    // Hook buttons
    const rfRunBtn = wrap.querySelector('#rf_run');
    const rfExportBtn = wrap.querySelector('#rf_export');

    if(rfRunBtn){
      rfRunBtn.onclick = () => {
        const m = (wrap.querySelector('#rf_month').value || '').slice(0,7);
        if(!m) return alert('Please select a month');
        buildFinanceAccounts(m);
      };
    }

    if(rfExportBtn){
      rfExportBtn.onclick = () => {
        const m = (wrap.querySelector('#rf_month').value || '').slice(0,7);
        if(!m) return alert('Please select a month');
        const res = buildFinanceAccounts(m);

        const rows = [
          ["Month","Finance Company","Deals","Finance Amount","Payout Received (Paid)","Admin Fees"]
        ].concat(res.companies.map(r => [
          res.monthKey, r.company, r.deals, r.financeAmt, r.payoutPaid, r.adminFee
        ]));

        const csv = rows.map(r => r.map(v => `"${String(v ?? '').replace(/"/g,'""')}"`).join(',')).join('\n');
        const a = document.createElement('a');
        a.href = URL.createObjectURL(new Blob([csv], {type:'text/csv'}));
        a.download = `finance_accounts_${res.monthKey}.csv`;
        a.click();
      };
    }

    const cover = wrap.querySelector('#rm_cover').checked; 
    const showExpShown = cover ? 0 : showExp; 

    // ‚úÖ Net Profit/Loss (Month Close method)
    const c = calcMonthClose(k);
    const netMonthClose = Number(c.remainder || 0);
    
    const box=wrap.querySelector('#rm_box'); 
    box.innerHTML='<table class="table"><tbody>'
      +'<tr><th>Sold (count)</th><td class="right">'+sellCount+'</td></tr>'
      +'<tr><th>Purchased (count)</th><td class="right">'+buyCount+'</td></tr>'
      +'<tr><th>Total Sales</th><td class="right">'+fmtMoney(sales)+'</td></tr>'
      +'<tr><th>Total Vehicle Purchases (purchased this month)</th><td class="right">'+fmtMoney(purchases)+'</td></tr>'
      +'<tr><th>Vehicle Expenses (this month)</th><td class="right">'+fmtMoney(vehExp)+'</td></tr>'
      +'<tr><th>Showroom Expenses '+(cover?'(covered by profit, shown as ¬£0)':'')+'</th><td class="right">'+fmtMoney(showExpShown)+'</td></tr>'
      +'<tr><th>Net Profit/Loss (Month Close method)</th><td class="right"><b>'+fmtMoney(netMonthClose)+'</b></td></tr>'
      +'</tbody></table>';
  };

  function norm(s){ return String(s||'').trim(); }
  function monthKey(d){ return String(d||'').slice(0,7); }

  function financeSalesRowsForMonth(k){
    return (db.sales || []).filter(s => {
      if (!isRealSale(s)) return false;             // your existing helper
      if (monthKey(s.date) !== k) return false;
      const finCo = norm(s.financeCompany);
      const finAmt = Number(s.finance || 0);
      // consider it a "finance sale" if financeCompany filled OR finance amount > 0
      return finCo !== '' || finAmt > 0;
    });
  }

  function buildFinanceReport(){
    const k = (wrap.querySelector('#fr_month')?.value || '').slice(0,7);
    const out = wrap.querySelector('#fr_out');
    const sum = wrap.querySelector('#fr_sum');
    if(!k || !out || !sum) return;

    const sales = financeSalesRowsForMonth(k);

    // group by finance company
    const groups = {};
    let grandCount=0, grandFinance=0, grandPayout=0, grandAdmin=0;

    sales.forEach(s => {
      const co = norm(s.financeCompany) || '(No company entered)';
      if(!groups[co]) groups[co] = { count:0, finance:0, payout:0, admin:0, byUser:{} };

      const g = groups[co];
      const finance = Number(s.finance || 0);
      const payout  = Number(s.financePayoutAmount || 0);
      const admin   = Number(s.financeAdminFee || 0);

      g.count += 1;
      g.finance += finance;
      g.payout  += payout;
      g.admin   += admin;

      // "who" (best-effort: user/createdBy/audit)
      const who = norm(s.user || s.createdBy || s.username) || 'Unknown';
      if(!g.byUser[who]) g.byUser[who] = {count:0, finance:0, payout:0, admin:0};
      g.byUser[who].count += 1;
      g.byUser[who].finance += finance;
      g.byUser[who].payout  += payout;
      g.byUser[who].admin   += admin;

      grandCount += 1;
      grandFinance += finance;
      grandPayout  += payout;
      grandAdmin   += admin;
    });

    // render
    const companies = Object.keys(groups).sort((a,b)=> groups[b].count - groups[a].count);

    sum.innerHTML =
      `Month: <b>${k}</b> ‚Ä¢ Finance sales: <b>${grandCount}</b> ‚Ä¢ Finance total: <b>${fmtMoney(grandFinance)}</b> ‚Ä¢ Payout received: <b>${fmtMoney(grandPayout)}</b> ‚Ä¢ Admin fees: <b>${fmtMoney(grandAdmin)}</b>`;

    if(companies.length === 0){
      out.innerHTML = `<div class="small">No finance sales found for this month.</div>`;
      return;
    }

    out.innerHTML = companies.map(co => {
      const g = groups[co];
      const userRows = Object.keys(g.byUser).sort((a,b)=>g.byUser[b].count - g.byUser[a].count).map(u=>{
        const r = g.byUser[u];
        return `<tr>
          <td>${u}</td>
          <td class="right">${r.count}</td>
          <td class="right">${fmtMoney(r.finance)}</td>
          <td class="right">${fmtMoney(r.payout)}</td>
          <td class="right">${fmtMoney(r.admin)}</td>
        </tr>`;
      }).join('');

      return `
        <details class="card" style="margin-top:10px">
          <summary>
            <b>${co}</b> ‚Äî Deals: ${g.count} ‚Ä¢ Finance: ${fmtMoney(g.finance)} ‚Ä¢ Payout: ${fmtMoney(g.payout)} ‚Ä¢ Admin: ${fmtMoney(g.admin)}
          </summary>
          <div style="margin-top:10px">
            <table class="table">
              <thead>
                <tr><th>Who</th><th class="right">Deals</th><th class="right">Finance</th><th class="right">Payout</th><th class="right">Admin Fees</th></tr>
              </thead>
              <tbody>${userRows}</tbody>
            </table>
          </div>
        </details>
      `;
    }).join('');
  }

  wrap.querySelector('#fr_run').onclick = buildFinanceReport;

  wrap.querySelector('#fr_export').onclick = () => {
    const k = (wrap.querySelector('#fr_month')?.value || '').slice(0,7);
    const sales = financeSalesRowsForMonth(k);

    const rows = [
      ["Month","Invoice","Reg","Customer","FinanceCompany","Who","FinanceAmount","PayoutAmount","AdminFee"]
    ].concat(sales.map(s=>[
      k,
      s.invNo || '',
      (db.vehicles||[]).find(v=>v.id===s.vehicleId)?.reg || '',
      s.buyer || '',
      s.financeCompany || '',
      (s.user || s.createdBy || s.username || ''),
      Number(s.finance || 0),
      Number(s.financePayoutAmount || 0),
      Number(s.financeAdminFee || 0)
    ]));

    const csv = rows.map(r=>r.map(v=>`"${String(v).replace(/"/g,'""')}"`).join(',')).join('\n');
    const a=document.createElement('a');
    a.href=URL.createObjectURL(new Blob([csv],{type:'text/csv'}));
    a.download=`finance_sales_${k}.csv`;
    a.click();
  };

  // auto-run once
  buildFinanceReport();

  // ================= Cars Not Ready (In Stock) REPORT =================
  (function(){
    const runBtn = wrap.querySelector('#nr_run');
    if(!runBtn) return;

    const qEl = wrap.querySelector('#nr_q');
    const stageEl = wrap.querySelector('#nr_stage');
    const sumEl = wrap.querySelector('#nr_sum');
    const tblEl = wrap.querySelector('#nr_tbl');
    const expBtn = wrap.querySelector('#nr_export');

    function isInStockNow(v){
      // Stock if NOT sold in completed sales AND status not 'sold'
      const soldBySales = (db.sales||[]).some(s => isRealSale(s) && s.vehicleId === v.id);
      const soldByStatus = String(v.status||'').toLowerCase() === 'sold';
      return !soldBySales && !soldByStatus;
    }

    function table(rows){
      const head = `<thead><tr>
        <th>Reg</th><th>Make</th><th>Model</th><th>Stage</th><th>Reason</th><th>Next action</th>
      </tr></thead>`;
      const body = rows.length ? rows.map(r=>`
        <tr>
          <td><b>${r.reg}</b></td>
          <td>${r.make}</td>
          <td>${r.model}</td>
          <td><span class="badge">${r.stage}</span></td>
          <td>${r.reason}</td>
          <td>${r.next}</td>
        </tr>`).join('')
        : `<tr><td colspan="6">No not-ready vehicles found ‚úÖ</td></tr>`;
      return `<table class="table">${head}<tbody>${body}</tbody></table>`;
    }

    function run(){
      const q = (qEl.value||'').trim().toLowerCase();
      const st = (stageEl.value||'').trim();

      const rows = (db.vehicles||[])
        .map(ensureVehicleFields)
        .filter(v => isInStockNow(v))
        .filter(v => !v.readyForSale)
        .filter(v => !st || (v.prepStage||'') === st)
        .filter(v=>{
          if(!q) return true;
          const hay = `${v.reg||''} ${v.make||''} ${v.model||''} ${v.prepStage||''} ${v.notReadyReason||''} ${v.prepNotes||''}`.toLowerCase();
          return hay.includes(q);
        })
        .map(v=>({
          reg: v.reg||'',
          make: v.make||'',
          model: v.model||'',
          stage: v.prepStage||'Prep',
          reason: v.notReadyReason||'Not specified',
          next: v.prepNotes||''
        }));

      sumEl.innerHTML = `Not ready in stock: <b>${rows.length}</b>`;
      tblEl.innerHTML = table(rows);
      wrap.__nr_rows = rows;
    }

    runBtn.onclick = run;
    if(qEl) qEl.oninput = ()=>{ clearTimeout(wrap.__nr_t); wrap.__nr_t=setTimeout(run,200); };
    if(stageEl) stageEl.onchange = run;

    if(expBtn) expBtn.onclick = ()=>{
      const rows = wrap.__nr_rows || [];
      if(!rows.length) return alert('Run the report first.');
      const headers = ['reg','make','model','stage','reason','next'];
      const csv = [headers.join(',')].concat(
        rows.map(r => headers.map(h=>{
          const s = (r[h]==null?'':String(r[h]));
          return /[",\n]/.test(s) ? `"${s.replace(/"/g,'""')}"` : s;
        }).join(','))
      ).join('\n');

      const a = document.createElement('a');
      a.href = URL.createObjectURL(new Blob([csv], {type:'text/csv'}));
      a.download = 'cars_not_ready.csv';
      a.click();
    };

    setTimeout(run, 50);
  })();

  (function(){
  // Helpers
  const num = v => Number(v || 0);

  function getMonthRange(ym){
    const start = ym + "-01";
    const end = lastDayOfMonth(ym);          // you already have this
    return { start, end };
  }

  function safeUpper(s){ return String(s||'').trim().toUpperCase(); }

  function getPurchaseDate(v){
    // matches your Monthly Summary logic
    return (v && (v.purchaseDate || v.dateAdded || v.createdAt || '')) || '';
  }

  function getOutwardPostcode(address){
    // tries to find a UK postcode in the address string and returns outward code (e.g. "E4", "IG8", "EN9")
    const s = safeUpper(address);
    if(!s) return '';
    // basic UK postcode pattern: outward + inward
    const m = s.match(/([A-Z]{1,2}\d{1,2}[A-Z]?)\s*\d[A-Z]{2}\b/);
    return m ? m[1] : '';
  }

  function bucketPrice(p){
    p = num(p);
    if(p < 3000) return "¬£0‚Äì¬£2,999";
    if(p < 5000) return "¬£3,000‚Äì¬£4,999";
    if(p < 7000) return "¬£5,000‚Äì¬£6,999";
    if(p < 10000) return "¬£7,000‚Äì¬£9,999";
    if(p < 15000) return "¬£10,000‚Äì¬£14,999";
    if(p < 20000) return "¬£15,000‚Äì¬£19,999";
    return "¬£20,000+";
  }

  function topN(mapObj, n=10){
    return Object.entries(mapObj)
      .sort((a,b)=> (b[1]||0) - (a[1]||0))
      .slice(0,n);
  }

  function renderSimpleTable(headers, rows){
    return `
      <table class="table">
        <thead><tr>${headers.map(h=>`<th>${h}</th>`).join('')}</tr></thead>
        <tbody>
          ${rows.length ? rows.map(r=>`<tr>${r.map(c=>`<td>${c}</td>`).join('')}</tr>`).join('') :
            `<tr><td colspan="${headers.length}">No data</td></tr>`}
        </tbody>
      </table>
    `;
  }

  // Core: get REAL sales in month (uses your isRealSale)
  function getSalesInMonth(ym){
    return (db.sales||[]).filter(s => (s.date||'').slice(0,7)===ym && isRealSale(s));
  }

  // Build insights rows (also used for CSV export)
  function buildInsights(ym){
    const sales = getSalesInMonth(ym);

    // counts
    const makeCount = {};
    const modelCount = {};
    const makeModelCount = {}; // "MAKE||MODEL"
    const priceBandCount = {};
    const areaCount = {};

    const rowsForCsv = [];

    for(const s of sales){
      const v = (db.vehicles||[]).find(x=>x.id===s.vehicleId) || {};
      const make = (v.make || '').trim() || 'Unknown';
      const model = (v.model || '').trim() || 'Unknown';
      const mmKey = make + "||" + model;

      makeCount[make] = (makeCount[make]||0) + 1;
      modelCount[model] = (modelCount[model]||0) + 1;
      makeModelCount[mmKey] = (makeModelCount[mmKey]||0) + 1;

      const band = bucketPrice(s.salePrice);
      priceBandCount[band] = (priceBandCount[band]||0) + 1;

      const outward = getOutwardPostcode(s.address || '');
      if(outward) areaCount[outward] = (areaCount[outward]||0) + 1;

      rowsForCsv.push({
        month: ym,
        date: s.date || '',
        invNo: s.invNo || '',
        reg: v.reg || '',
        make, model,
        salePrice: num(s.salePrice).toFixed(2),
        priceBand: band,
        outwardPostcode: outward,
        customer: s.customer || ''
      });
    }

    // Find top single items
    const topMake = topN(makeCount, 1)[0];
    const topModel = topN(modelCount, 1)[0];
    const topBand = topN(priceBandCount, 1)[0];
    const topArea = topN(areaCount, 1)[0];

    // Make/Model table (top 10 combos)
    const mmRows = topN(makeModelCount, 10).map(([k,qty])=>{
      const [mk,md] = k.split('||');
      return [mk, md, qty];
    });

    // Price bands table (all, sorted by count)
    const priceRows = Object.entries(priceBandCount)
      .sort((a,b)=>(b[1]||0)-(a[1]||0))
      .map(([band,qty])=>[band, qty]);

    // Area table (top 10)
    const areaRows = topN(areaCount, 10).map(([pc,qty])=>[pc, qty]);

    return {
      salesCount: sales.length,
      topMake, topModel, topBand, topArea,
      mmRows, priceRows, areaRows,
      csvRows: rowsForCsv
    };
  }

  // Stock ‚Äúas at‚Äù month end (accounting)
  function buildStockAsAt(ym){
    const { end } = getMonthRange(ym);

    // sales up to month end (real sales only)
    const soldIdsUpToEnd = new Set(
      (db.sales||[])
        .filter(s => isRealSale(s))
        .filter(s => (s.date||'') && (s.date <= end))
        .map(s => s.vehicleId)
        .filter(Boolean)
    );

    // vehicles purchased on/before end, and not sold by end
    const stockVehicles = (db.vehicles||[])
      .filter(v=>{
        const pd = getPurchaseDate(v).slice(0,10);
        if(!pd) return false;
        return pd <= end && !soldIdsUpToEnd.has(v.id);
      });

    // expenses up to month end per vehicle
    const expByVeh = {};
    for(const e of (db.vehicleExpenses||[])){
      const d = (e.date||'').slice(0,10);
      if(!d || d > end) continue;
      const vid = e.vehicleId;
      if(!vid) continue;
      expByVeh[vid] = (expByVeh[vid]||0) + num(e.amount);
    }

    const rows = stockVehicles.map(v=>{
      const purchase = num(v.purchase);
      const exp = num(expByVeh[v.id]);
      const total = purchase + exp;
      return {
        reg: v.reg || '',
        make: v.make || '',
        model: v.model || '',
        purchaseDate: (getPurchaseDate(v)||'').slice(0,10),
        purchase: purchase.toFixed(2),
        expensesToEnd: exp.toFixed(2),
        stockValue: total.toFixed(2)
      };
    }).sort((a,b)=> (a.make+a.model+a.reg).localeCompare(b.make+b.model+b.reg));

    const totalStockValue = rows.reduce((t,r)=>t + num(r.stockValue), 0);

    return { end, rows, totalStockValue };
  }

  // ---------- Wire it to your Reports UI (IDs from the HTML block) ----------
  const monthEl = wrap.querySelector('#si_month');
  const runBtn = wrap.querySelector('#si_run');
  const exportBtn = wrap.querySelector('#si_export_csv');

  const topMm = wrap.querySelector('#si_top_mm');
  const tblMm = wrap.querySelector('#si_tbl_mm');

  const topPrice = wrap.querySelector('#si_top_price');
  const tblPrice = wrap.querySelector('#si_tbl_price');

  const topArea = wrap.querySelector('#si_top_area');
  const tblArea = wrap.querySelector('#si_tbl_area');

  const stockRunBtn = wrap.querySelector('#si_stock_run');
  const stockExportBtn = wrap.querySelector('#si_stock_export_csv');
  const stockSum = wrap.querySelector('#si_stock_sum');
  const tblStock = wrap.querySelector('#si_tbl_stock');

  const debug = wrap.querySelector('#si_debug');

  function runInsights(){
    const ym = (monthEl.value || '').slice(0,7);
    if(!ym) return alert('Pick a month');

    const r = buildInsights(ym);

    topMm.innerHTML =
      `Sales count: <b>${r.salesCount}</b><br>` +
      `Top Make: <b>${r.topMake ? r.topMake[0] : '‚Äî'}</b> (${r.topMake ? r.topMake[1] : 0})<br>` +
      `Top Model: <b>${r.topModel ? r.topModel[0] : '‚Äî'}</b> (${r.topModel ? r.topModel[1] : 0})`;

    tblMm.innerHTML = renderSimpleTable(
      ['Make','Model','Qty'],
      r.mmRows
    );

    topPrice.innerHTML =
      `Most common price band: <b>${r.topBand ? r.topBand[0] : '‚Äî'}</b> (${r.topBand ? r.topBand[1] : 0})`;

    tblPrice.innerHTML = renderSimpleTable(
      ['Price band','Qty'],
      r.priceRows
    );

    topArea.innerHTML =
      `Top outward postcode: <b>${r.topArea ? r.topArea[0] : '‚Äî'}</b> (${r.topArea ? r.topArea[1] : 0})`;

    tblArea.innerHTML = renderSimpleTable(
      ['Outward postcode','Qty'],
      r.areaRows
    );

    // keep latest CSV rows for export
    wrap.__si_last_csv_rows = r.csvRows;

    debug.textContent = r.salesCount ? '' : 'No sales found in this month (only REAL/Completed sales are counted).';
  }

  runBtn.onclick = runInsights;

  exportBtn.onclick = ()=>{
    const rows = wrap.__si_last_csv_rows || [];
    if(!rows.length) return alert('Run the report first (no rows to export).');

    const headers = ['month','date','invNo','reg','make','model','salePrice','priceBand','outwardPostcode','customer'];
    const csv = [headers.join(',')].concat(
      rows.map(r => headers.map(h=>{
        const s = (r[h]==null?'':String(r[h]));
        return /[",\n]/.test(s) ? `"${s.replace(/"/g,'""')}"` : s;
      }).join(','))
    ).join('\n');

    const a = document.createElement('a');
    a.href = URL.createObjectURL(new Blob([csv], {type:'text/csv'}));
    a.download = 'sales_insights_' + (monthEl.value||'') + '.csv';
    a.click();
  };

  // Stock buttons
  stockRunBtn.onclick = ()=>{
    const ym = (monthEl.value || '').slice(0,7);
    if(!ym) return alert('Pick a month');

    const r = buildStockAsAt(ym);

    stockSum.innerHTML =
      `As at <b>${r.end}</b> ‚Äî Vehicles in stock: <b>${r.rows.length}</b> ‚Äî Total stock value: <b>${fmtMoney(r.totalStockValue)}</b>`;

    tblStock.innerHTML = renderSimpleTable(
      ['Reg','Make','Model','Purchase date','Purchase ¬£','Expenses to end ¬£','Stock value ¬£'],
      r.rows.map(x=>[
        x.reg, x.make, x.model,
        x.purchaseDate,
        fmtMoney(x.purchase),
        fmtMoney(x.expensesToEnd),
        fmtMoney(x.stockValue)
      ])
    );

    wrap.__si_last_stock_rows = r.rows;
    wrap.__si_last_stock_end = r.end;
  };

  stockExportBtn.onclick = ()=>{
    const rows = wrap.__si_last_stock_rows || [];
    if(!rows.length) return alert('Build Stock List first (no rows to export).');

    const end = wrap.__si_last_stock_end || '';
    const headers = ['reg','make','model','purchaseDate','purchase','expensesToEnd','stockValue'];

    const csv = [headers.join(',')].concat(
      rows.map(r => headers.map(h=>{
        const s = (r[h]==null?'':String(r[h]));
        return /[",\n]/.test(s) ? `"${s.replace(/"/g,'""')}"` : s;
      }).join(','))
    ).join('\n');

    const a = document.createElement('a');
    a.href = URL.createObjectURL(new Blob([csv], {type:'text/csv'}));
    a.download = 'stock_as_at_' + end + '.csv';
    a.click();
  };

  // auto-run once so it shows something
  setTimeout(runInsights, 50);
  })();

  wrap.querySelector('#rep_fin_unpaid').onclick = ()=>{
    const rows = (db.sales||[])
      .filter(s => Number(s.finance||0) > 0)
      .filter(s => !s.financePayoutDate)   // unpaid
      .map(s=>{
        const v = (db.vehicles||[]).find(x=>x.id===s.vehicleId) || {};
        const fee = Number(s.financeAdminFee||0);
        const net = Number(s.financeNet||0) || Math.max(0, Number(s.finance||0)-fee);
        return `
          <tr>
            <td>${s.date||''}</td>
            <td>${s.invNo||''}</td>
            <td>${v.reg||''}</td>
            <td>${s.financeCompany||''}</td>
            <td class="right">${fmtMoney(Number(s.finance||0))}</td>
            <td class="right">${fmtMoney(fee)}</td>
            <td class="right"><b>${fmtMoney(net)}</b></td>
            <td>${s.customer||''}</td>
          </tr>`;
      }).join('');

    wrap.querySelector('#rep_fin_unpaid_out').innerHTML = `
      <table class="tbl">
        <tr><th>Date</th><th>Inv</th><th>Reg</th><th>Company</th><th>Finance</th><th>Fee</th><th>Net</th><th>Customer</th></tr>
        ${rows || '<tr><td colspan="8">No unpaid finance payouts üéâ</td></tr>'}
      </table>`;
  };

  wrap.querySelector('#rm_export_xlsx').onclick = ()=>{
    const k = (wrap.querySelector('#rm_month').value || '').slice(0,7);
    if(!k) return alert('Pick a month');

    if(!window.XLSX) return alert('Excel library not loaded. Add the SheetJS <script> in <head>.');

    const c = calcMonthClose(k);

    // ---------- Sheet 1: Month Close Summary ----------
    const summaryRows = [
      ['Month', k],
      ['Sold cars count', c.items.length],
      ['Gross profit on sold vehicles', c.totalGross],
      ['Mgmt flat (¬£175) total', c.totalFlat],
      ['Mgmt 20% total', c.totalPct],
      ['Investor 30% total', c.totalInvestor],
      ['Post-sale expenses total', c.postExpTotal],
      ['Remainder before showroom', c.remainderBeforeShowroom],
      ['Showroom expenses (net) this month', c.showroomMonthTotal],
      ['NET Profit/Loss (Month Close remainder)', c.remainder],
      ['Directors share each', (c.directorEach ?? c.directorHalf)]
    ];

    const wsSummary = XLSX.utils.aoa_to_sheet(summaryRows);

    // ---------- Sheet 2: Sold Cars (with Total Cost) ----------
    const soldHeader = [
      'Sale Date','Inv No','Reg','Make','Model','Owner Type','Investor',
      'Sale Price','Purchase','Vehicle Expenses','Total Cost','Gross',
      'Mgmt Flat','Mgmt 20%','Investor 30%','Remainder After Investor'
    ];

    const soldRows = c.items.map(x=>{
      const v = x.v || {};
      const s = x.s || {};
      const purchase = Number(v.purchase || 0);

      // Recalculate expenses total same way Month Close does:
      const vexpTotal = (db.vehicleExpenses||[])
        .filter(e=>e.vehicleId===s.vehicleId)
        .reduce((t,e)=>t + Number(e.amount||0), 0);

      const totalCost = (s.vehicleTotalCostAtSale != null)
        ? Number(s.vehicleTotalCostAtSale || 0)
        : (Number(v.purchase||0) + vexpTotal);

      const gross = Number(s.salePrice||0) - totalCost;

      return [
        s.date || '',
        s.invNo || '',
        v.reg || '',
        v.make || '',
        v.model || '',
        v.ownerType || '',
        x.investorName || '',
        Number(s.salePrice||0),
        purchase,
        vexpTotal,
        totalCost,
        gross,
        Number(x.mgmtFlat||0),
        Number(x.mgmtPct||0),
        Number(x.investorShare||0),
        Number(x.afterInvestor||0)
      ];
    });

    const wsSold = XLSX.utils.aoa_to_sheet([soldHeader, ...soldRows]);

    // ---------- Sheet 3 (optional): Post-sale expenses ----------
    const postHeader = ['Expense Date','Type','Amount','Vehicle Reg','Note'];
    const postRows = (c.postExp||[]).map(pe=>[
      pe.date||'',
      pe.type||'',
      Number(pe.amount||0),
      pe.reg||'',
      pe.note||''
    ]);
    const wsPost = XLSX.utils.aoa_to_sheet([postHeader, ...postRows]);

    // ---------- Sheet 4: Cashflow Summary (old Monthly Summary style) ----------
    const monthStart = k + '-01';
    const monthEnd = (function(){
      const [yy,mm]=k.split('-').map(Number);
      const d=new Date(yy, mm, 0); // last day of month
      return d.toISOString().slice(0,10);
    })();

    const inMonth = d => (d||'') >= monthStart && (d||'') <= monthEnd;

    // totals (cashflow style)
    const salesCash = (db.sales||[])
      .filter(s=> inMonth(s.date))
      .reduce((t,s)=> t + Number(s.salePrice||0), 0);

    const purchasesCash = (db.vehicles||[])
      .filter(v=> inMonth(v.purchaseDate))
      .reduce((t,v)=> t + Number(v.purchase||0), 0);

    const vehExpCash = (db.vehicleExpenses||[])
      .filter(e=> inMonth(e.date))
      .reduce((t,e)=> t + Number(e.amount||0), 0);

    // showroom expenses (net of credit notes) - same method your summary uses
    const showExpCash = ((db.showroomExpenses||[])
      .filter(e=> inMonth(e.date))
      .reduce((t,e)=> t + Number(e.amount||0), 0))
      - ((db.showroomExpenseCredits||[])
        .filter(c=> inMonth(c.date))
        .reduce((t,c)=> t + Number(c.amount||0), 0));

    const netCashflow = salesCash - purchasesCash - vehExpCash - showExpCash;

    // month close (posting) profit
    const netMonthClose = Number(c.remainder || 0);

    const cashflowRows = [
      ['Month', k],
      ['Sales total (invoice values)', salesCash],
      ['Purchases total (cars bought this month)', purchasesCash],
      ['Vehicle expenses total (dated this month)', vehExpCash],
      ['Showroom expenses net (dated this month)', showExpCash],
      ['NET (Cashflow method)', netCashflow],
      [''],
      ['NET (Month Close / Posting method)', netMonthClose],
      ['Note', 'Cashflow includes stock purchases not yet sold. Month Close matches the posting screen.']
    ];

    const wsCash = XLSX.utils.aoa_to_sheet(cashflowRows);

    // ---------- Sheet 5: Transactions ‚Äì This Month ----------
    const txHeader = ['Date','Type','Category','Reg','Inv No','Counterparty','Method','Amount','Note','ID'];

    const txRows = [];

    // SALES (money in)
    (db.sales||[])
      .filter(s=> inMonth(s.date))
      .forEach(s=>{
        const v = (db.vehicles||[]).find(x=>x.id===s.vehicleId) || {};
        txRows.push([
          s.date || '',
          'IN',
          'Sale',
          v.reg || '',
          s.invNo || '',
          s.customer || '',
          (s.finance>0 ? 'finance' : (s.method || '')),
          Number(s.salePrice||0),
          (s.financeCompany ? ('Finance: ' + s.financeCompany) : ''),
          s.id || ''
        ]);
      });

    // PURCHASES (money out)
    (db.vehicles||[])
      .filter(v=> inMonth(v.purchaseDate))
      .forEach(v=>{
        txRows.push([
          v.purchaseDate || '',
          'OUT',
          'Purchase',
          v.reg || '',
          v.purchaseInv || '',
          v.supplier || '',
          v.purchaseMethod || '',
          Number(v.purchase||0),
          v.purchaseNote || '',
          v.id || ''
        ]);
      });

    // VEHICLE EXPENSES (money out)
    (db.vehicleExpenses||[])
      .filter(e=> inMonth(e.date))
      .forEach(e=>{
        const v = (db.vehicles||[]).find(x=>x.id===e.vehicleId) || {};
        txRows.push([
          e.date || '',
          'OUT',
          'Vehicle Expense',
          v.reg || '',
          '',
          e.supplier || '',
          e.method || '',
          Number(e.amount||0),
          e.note || e.type || '',
          e.id || ''
        ]);
      });

    // SHOWROOM EXPENSES (money out)
    (db.showroomExpenses||[])
      .filter(e=> inMonth(e.date))
      .forEach(e=>{
        txRows.push([
          e.date || '',
          'OUT',
          'Showroom Expense',
          '',
          e.invNo || '',
          e.supplier || '',
          e.method || '',
          Number(e.amount||0),
          e.note || e.type || '',
          e.id || ''
        ]);
      });

    // SHOWROOM EXPENSE CREDITS (money in / negative expense)
    (db.showroomExpenseCredits||[])
      .filter(cn=> inMonth(cn.date))
      .forEach(cn=>{
        txRows.push([
          cn.date || '',
          'IN',
          'Showroom Credit Note',
          '',
          cn.invNo || '',
          cn.supplier || '',
          cn.method || '',
          -Math.abs(Number(cn.amount||0)),   // negative
          cn.note || cn.type || '',
          cn.id || ''
        ]);
      });

    // Sort by date (then by category)
    txRows.sort((a,b)=> (a[0]||'').localeCompare(b[0]||'') || (a[2]||'').localeCompare(b[2]||''));

    const wsTx = XLSX.utils.aoa_to_sheet([txHeader, ...txRows]);

    // Build workbook
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, wsSummary, 'Month Close Summary');
    XLSX.utils.book_append_sheet(wb, wsSold, 'Sold Cars (Total Cost)');
    XLSX.utils.book_append_sheet(wb, wsPost, 'Post-Sale Expenses');
    XLSX.utils.book_append_sheet(wb, wsCash, 'Cashflow Summary');
    XLSX.utils.book_append_sheet(wb, wsTx, 'Transactions - This Month');

    // Download
    XLSX.writeFile(wb, `StarCars_Report_${k}.xlsx`);
  };

  /* Month Close */
  function calcMonthClose(k){
    const showroomMonthTotal = (db.showroomExpenses||[]).filter(e=>ymStr(e.date)===k).reduce((t,e)=>t+Number(e.amount||0),0);
    const sold=(db.sales||[]).filter(s=>ymStr(s.date)===k && isRealSale(s));
    const items=sold.map(s=>{
      const v=db.vehicles.find(x=>x.id===s.vehicleId)||{};
      const vexp=(db.vehicleExpenses||[]).filter(e=>e.vehicleId===s.vehicleId).reduce((t,x)=>t+Number(x.amount||0),0);
      const gross = Number(s.salePrice || 0) - Number(v.purchase || 0) - vexp;
      const isInvestor = (v.ownerType === 'investor' && v.investor);

      // Mgmt fees only if car made a profit
      const mgmtFlat = (isInvestor && gross > 0) ? 175 : 0;
      const mgmtBase = Math.max(0, gross - mgmtFlat);
      const mgmtPct  = (isInvestor && gross > 0) ? (0.20 * mgmtBase) : 0;

      let investorShare = 0;
      let afterInvestor = gross;

      if (isInvestor && gross > 0) {
        // Step 1: subtract ¬£175 (mgmtFlat) and 20% of remaining (mgmtPct)
        const baseAfterFees = Math.max(0, gross - mgmtFlat - mgmtPct);

        // Step 2: investor gets 30% of the remaining
        investorShare = 0.30 * baseAfterFees;

        // Step 3: remainder from this car for directors pot (before showroom / post-expenses)
        afterInvestor = Math.max(0, baseAfterFees - investorShare);
      } else {
        // Dealer-owned car: all gross goes to directors pot (before showroom / post-expenses)
        afterInvestor = gross;
      }

      return { s, v, gross, mgmtFlat, mgmtPct, investorShare, afterInvestor, isInvestor, investorName: v.investor || '' };
    });

    const totalGross=items.reduce((t,x)=>t+x.gross,0);
    const totalFlat=items.reduce((t,x)=>t+x.mgmtFlat,0);
    const totalPct=items.reduce((t,x)=>t+x.mgmtPct,0);
    const totalInvestor=items.reduce((t,x)=>t+x.investorShare,0);

    // Post-sale expenses this month for vehicles sold earlier
    const postExp = (db.vehicleExpenses||[]).filter(e=>ymStr(e.date)===k).map(e=>{
      const v=db.vehicles.find(x=>x.id===e.vehicleId);
      if(!v) return null;
      const s = (db.sales||[]).find(s0=>s0.vehicleId===e.vehicleId && isRealSale(s0));
      if(!s) return null;
      if(ymStr(s.date) >= k) return null;
      return { e, v, amount: Number(e.amount||0) };
    }).filter(Boolean);
    const postExpTotal = postExp.reduce((t,x)=>t + x.amount, 0);

    const remainderBeforeShowroom = items.reduce((t,x)=>t+x.afterInvestor,0) - postExpTotal;
    const remainder = remainderBeforeShowroom - showroomMonthTotal;

    // ‚úÖ count directors properly (unique non-empty names)
    const norm = s => String(s||'').trim().toLowerCase();
    const directorsUnique = (db.partners||[])
      .filter(p => norm(p && p.name))
      .filter((p,i,arr)=> arr.findIndex(x => norm(x.name) === norm(p.name)) === i);

    const directorCount = Math.max(1, directorsUnique.length);
    const directorEach = remainder / directorCount;

    return {
      items,totalGross,totalFlat,totalPct,totalInvestor,
      remainder,directorEach,directorCount,
      postExp,postExpTotal,showroomMonthTotal,remainderBeforeShowroom
    }
  };

    function purgeMonthClose(k){
    const marker='MonthClose '+k;
    // Remove prior director profit entries for this month
    (db.partners||[]).forEach(p=>{ p.tx=(p.tx||[]).filter(t=>!(t.type==='profit' && (t.note||'').includes(marker))); p.balance=(p.tx||[]).reduce((bal,x)=> bal+((x.type==='invest'||x.type==='profit')?+x.amount:-x.amount),0); });
    // Remove prior investor postings for this month
    (db.investors||[]).forEach(inv=>{ inv.tx=(inv.tx||[]).filter(t=>!(t.type==='fund_in' && (t.note||'').includes(marker))); inv.balance=(inv.tx||[]).reduce((bal,x)=> bal+((x.type==='fund_in')?+x.amount:-x.amount),0); });
    // Remove showroom mgmt entries dated in that month
    db.showroomExpenses=(db.showroomExpenses||[]).filter(e=>{
      const ym = (e.date||'').slice(0,7);
      if(ym!==k) return true;
      const t=String(e.type||'');
      return !(t.includes('Mgmt flat ¬£175') || t.includes('Mgmt 20%'));
    });
    }
    function alreadyPosted(k){
    // Heuristic: if both directors have a 'profit' tx on k month with same note marker, block.
    const marker='MonthClose '+k;
    const both=(db.partners||[]).filter(p=>(p.tx||[]).some(t=>t.type==='profit' && (t.note||'').includes(marker))).length>=2;
    return both;
  }
  function previewClose(){
    const k=(wrap.querySelector('#mc_month').value||'').slice(0,7);
    const c=calcMonthClose(k);
    const box=wrap.querySelector('#mc_box');
    box.innerHTML = '<b>Month:</b> '+k+'<br>'
      + 'Gross profit on sold vehicles: '+fmtMoney(c.totalGross)+'<br>'
      + 'Showroom mgmt (flat ¬£175 each investor car): '+fmtMoney(c.totalFlat)+'<br>'
      + 'Showroom mgmt (20% each investor car): '+fmtMoney(c.totalPct)+'<br>'
      + 'Investor 30% total: '+fmtMoney(c.totalInvestor)+'<br>'
      + 'Showroom expenses this month (net): ' + fmtMoney(c.showroomMonthTotal) + '<br>'
      + 'Post-sale expenses (this month on earlier sales): '+fmtMoney(c.postExpTotal)+'<br>'
      + '<b>Remainder for directors:</b> ' + fmtMoney(c.remainder) + ' ‚áí ' + fmtMoney(c.directorEach) + ' each (Directors: ' + c.directorCount + ')<br><br>'
      + '<div class="card small" style="margin:8px 0;padding:8px">'
      + '<b>Breakdown</b><br>'
      + '<table class="table"><tbody>'
      + '<tr><td>Gross profit on sold vehicles</td><td class="right">'+fmtMoney(c.totalGross)+'</td></tr>'
      + '<tr><td>Mgmt flat (¬£175) ‚Äî investor cars</td><td class="right">'+fmtMoney(c.totalFlat)+'</td></tr>'
      + '<tr><td>Mgmt 20% ‚Äî investor cars</td><td class="right">'+fmtMoney(c.totalPct)+'</td></tr>'
      + '<tr><td>Investor 30% total</td><td class="right">'+fmtMoney(c.totalInvestor)+'</td></tr>'
      + '<tr><td>Post-sale expenses (this month on earlier sales)</td><td class="right">'+fmtMoney(c.postExpTotal)+'</td></tr>'
      + '<tr><td><b>Remainder before showroom</b></td><td class="right"><b>'+fmtMoney(c.remainderBeforeShowroom)+'</b></td></tr>'
      + '<tr><td>Showroom expenses this month (net)</td><td class="right">'+fmtMoney(c.showroomMonthTotal)+'</td></tr>'
      + '<tr><td><b>Remainder after showroom</b></td><td class="right"><b>'+fmtMoney(c.remainder)+'</b></td></tr>'
      + '<tr><td><b>Directors share (each)</b></td><td class="right"><b>'+fmtMoney(c.directorHalf)+'</b></td></tr>'
      + '</tbody></table>'
      + '</div>'
      + '<table class="table"><thead><tr><th>Date</th><th>Reg</th><th>Investor</th><th>Gross</th><th>¬£175</th><th>20%</th><th>Investor 30%</th><th>Remainder</th></tr></thead><tbody>'
      + c.items.map(x=>`<tr><td>${ddmmyyyy(x.s.date)}</td><td>${x.v.reg||''}</td><td>${x.investorName}</td><td class="right">${fmtMoney(x.gross)}</td><td class="right">${fmtMoney(x.mgmtFlat)}</td><td class="right">${fmtMoney(x.mgmtPct)}</td><td class="right">${fmtMoney(x.investorShare)}</td><td class="right">${fmtMoney(x.afterInvestor)}</td></tr>`).join('')
      + '</tbody></table>'
      + (c.postExp.length ? ('<br><div class="small"><b>Post-sale expenses this month:</b><ul>'
          + c.postExp.map(pe=>`<li>${ddmmyyyy(pe.e.date)} ‚Äî ${pe.v.reg||''} ‚Äî ${pe.e.type||''}: ${fmtMoney(pe.amount)}</li>`).join('')
          + '</ul></div>') : '');
    const warn=wrap.querySelector('#mc_warn'); warn.textContent = alreadyPosted(k) ? ('Already posted for '+k+' ‚Äî new posting will replace the previous one.') : '';}
  function postClose(){
    const k=(wrap.querySelector('#mc_month').value||'').slice(0,7); if(!k) return alert('Pick a month');
    if(alreadyPosted(k)) { if(!confirm('This month was already posted. Recalculate and re-post?')) return; purgeMonthClose(k); }
    const c=calcMonthClose(k);

    // 1) Post mgmt fees to Showroom Expenses (175 + 20% for PROFITABLE investor cars only)
    c.items.forEach(x=>{
      if(x.isInvestor && x.gross > 0){  // Only if car made profit
        db.showroomExpenses.unshift({id:mcId(k, 'showroom_flat175', x.v.reg, '', ''),date:lastDayOfMonth(k),type:'Mgmt flat ¬£175',method:'bank',amount:-175,note:(x.v.reg||'')});
        const pct=+(x.mgmtPct||0);
        if(pct>0) db.showroomExpenses.unshift({id:mcId(k, 'showroom_20pct', x.v.reg, '', ''),date:lastDayOfMonth(k),type:'Mgmt 20% (investor car)',method:'bank',amount:-pct,note:(x.v.reg||'')});
      }
    });

    // 2) Post investor 30% total aggregated by investor (only for profitable cars)
    const byInvestor={};
    c.items.forEach(x=>{
      if(x.isInvestor && x.investorShare>0 && x.gross > 0){  // Only if car made profit
        byInvestor[x.investorName]=(byInvestor[x.investorName]||0)+x.investorShare;
      }
    });
    Object.keys(byInvestor).forEach(name=>{
      let inv=(db.investors||[]).find(i=>i.name===name);
      if(!inv){ inv={id:uid(),name,balance:0,tx:[]}; (db.investors=db.investors||[]).push(inv); }
      const amt=byInvestor[name];
      inv.tx.unshift({id:mcId(k, 'investor_30pct', inv.id, '', ''),date:lastDayOfMonth(k),type:'fund_in',method:'bank',amount:amt,note:'MonthClose '+k});
      inv.balance+=(+amt||0);
    });

    // 3) Directors single entry each (split by number of directors)
    const marker='MonthClose '+k;

    const norm = s => String(s||'').trim().toLowerCase();
    const directorsUnique = (db.partners||[])
      .filter(p => norm(p && p.name))
      .filter((p,i,arr)=> arr.findIndex(x => norm(x.name) === norm(p.name)) === i);

    directorsUnique.forEach(p=>{
      const amt = c.directorEach;
      p.tx = p.tx || [];
      p.tx.unshift({
        id: mcId(k, 'director_profit', p.id, '', ''),
        date: lastDayOfMonth(k),
        type: 'profit',
        method: 'bank',
        amount: amt,
        note: marker
      });
      p.balance = (p.tx||[]).reduce((bal,x)=> bal + ((x.type==='invest'||x.type==='profit')? +x.amount : -x.amount), 0);
    });
    
    saveDB(); try{renderAlertBell();}catch(e){}; addAudit('monthClose','reports','monthClose',marker); alert('Month close posted.');
    previewClose();
  }

  wrap.querySelector('#mc_prev').onclick=previewClose;
  wrap.querySelector('#mc_post').onclick=postClose;

  
  wrap.querySelector('#mc_export').onclick=()=>{
    const k=(wrap.querySelector('#mc_month').value||'').slice(0,7); if(!k) return alert('Pick a month');
    const c=calcMonthClose(k);
    const html = '<html><head><meta charset=\"utf-8\"><title>Month Close '+k+'</title>'+
      '<style>body{font:14px system-ui;padding:20px} .right{text-align:right} table{width:100%;border-collapse:collapse} th,td{border:1px solid #ccc;padding:6px}</style></head><body>'+
      '<h2>Month Close '+k+'</h2>'+
      '<p><b>Gross:</b> '+fmtMoney(c.totalGross)+'<br>'+
      'Mgmt flat (¬£175): '+fmtMoney(c.totalFlat)+'<br>'+
      'Mgmt 20%: '+fmtMoney(c.totalPct)+'<br>'+
      'Investor 30% total: '+fmtMoney(c.totalInvestor)+'<br>'+
      'Post-sale expenses: '+fmtMoney(c.postExpTotal)+'<br>'+
      '<b>Remainder before showroom:</b> '+fmtMoney(c.remainderBeforeShowroom)+'<br>'+
      'Showroom (net): '+fmtMoney(c.showroomMonthTotal)+'<br>'+
      '<b>Remainder after showroom:</b> '+fmtMoney(c.remainder)+'<br>'+
      '<b>Directors share (each):</b> '+fmtMoney(c.directorHalf)+'</p>'+
      '<table><thead><tr><th>Date</th><th>Reg</th><th>Investor</th><th class=\"right\">Gross</th><th class=\"right\">¬£175</th><th class=\"right\">20%</th><th class=\"right\">Inv 30%</th><th class=\"right\">Remainder</th></tr></thead><tbody>'+
      c.items.map(x=>'<tr><td>'+ddmmyyyy(x.s.date)+'</td><td>'+(x.v.reg||'')+'</td><td>'+(x.investorName||'')+'</td><td class=\"right\">'+fmtMoney(x.gross)+'</td><td class=\"right\">'+fmtMoney(x.mgmtFlat)+'</td><td class=\"right\">'+fmtMoney(x.mgmtPct)+'</td><td class=\"right\">'+fmtMoney(x.investorShare)+'</td><td class=\"right\">'+fmtMoney(x.afterInvestor)+'</td></tr>').join('')+
      '</tbody></table>'+
      '</body></html>';
    openPrintable(html);
  };
return wrap;
}

function viewAlerts(){
  if(!canTab('Alerts')) return document.createElement('div');
  const wrap = document.createElement('div');
  wrap.className = 'card';
  
  const today = new Date();
  today.setHours(0,0,0,0);
  
  const complaints = (db.complaints || []).slice();
  const urgent = complaints.filter(c => 
    (c.severity === 'urgent' || c.status === 'escalated')
  );
  const overdueFollow = complaints.filter(c => {
    if(!c.followup) return false;
    const st = (c.status || '').toLowerCase();
    if(st === 'resolved' || st === 'closed') return false;
    try{
      const d = new Date(c.followup);
      d.setHours(0,0,0,0);
      return d < today;
    }catch(e){ return false; }
  });
  
  const vehicles = (db.vehicles || []).slice();
  const motAlerts = [];
  vehicles.forEach(v => {
    if (String(v.status || '').toLowerCase() === 'sold') return;
    const motDate = v.lastMotExpiry || v.motExpiry || '';
    if(!motDate) return;
    try{
      const e = new Date(motDate);
      e.setHours(0,0,0,0);
      const diffDays = Math.ceil((e - today)/(1000*60*60*24));
      if(diffDays < 0){
        motAlerts.push({type:'Expired', diff:diffDays, v});
      } else if(diffDays <= 30){
        motAlerts.push({type:'Due <30 days', diff:diffDays, v});
      }
    }catch(e){}
  });
  motAlerts.sort((a,b)=>a.diff-b.diff);
  
  const todos = (db.todo || []).filter(t => !t.done);
  todos.sort((a,b)=> new Date(a.date || 0) - new Date(b.date || 0));
  
  let html = `<h2>Alerts & Tasks</h2>`;
  
  html += `<div class="row small" style="margin-bottom:10px">
    <span><b>Urgent complaints:</b> ${urgent.length}</span>
    <span style="margin-left:15px;"><b>Overdue follow-ups:</b> ${overdueFollow.length}</span>
    <span style="margin-left:15px;"><b>MOT alerts (expired / &lt;30 days):</b> ${motAlerts.length}</span>
    <span style="margin-left:15px;"><b>Open To-Do tasks:</b> ${todos.length}</span>
  </div>`;
  
  // Urgent complaints
  html += `<div class="card" style="margin-top:10px;">
    <h3>Urgent / Escalated Complaints</h3>`;
  if(!urgent.length){
    html += `<div class="small">No urgent complaints üéâ</div>`;
  } else {
    html += `<table class="table"><thead>
      <tr><th>Date</th><th>Customer</th><th>Vehicle</th><th>Type</th><th>Severity</th><th>Status</th><th>Follow-up</th><th>Handler</th></tr>
    </thead><tbody>`;
    urgent.sort((a,b)=>new Date(b.date||0)-new Date(a.date||0)).forEach(c=>{
      html += `<tr>
        <td>${ddmmyyyy(c.date)}</td>
        <td>${c.customer||''}</td>
        <td>${c.vehicle||''}</td>
        <td>${c.type||''}</td>
        <td>${c.severity||''}</td>
        <td>${c.status||''}</td>
        <td>${ddmmyyyy(c.followup)}</td>
        <td>${c.handler || c.assigned || ''}</td>
      </tr>`;
    });
    html += `</tbody></table>`;
  }
  html += `</div>`;
  
  // Overdue follow-ups
  html += `<div class="card" style="margin-top:10px;">
    <h3>Overdue Complaint Follow-ups</h3>`;
  if(!overdueFollow.length){
    html += `<div class="small">No overdue complaint follow-ups.</div>`;
  } else {
    html += `<table class="table"><thead>
      <tr><th>Follow-up Date</th><th>Customer</th><th>Vehicle</th><th>Type</th><th>Status</th><th>Handler</th></tr>
    </thead><tbody>`;
    overdueFollow.sort((a,b)=>new Date(a.followup||0)-new Date(b.followup||0)).forEach(c=>{
      html += `<tr>
        <td>${ddmmyyyy(c.followup)}</td>
        <td>${c.customer||''}</td>
        <td>${c.vehicle||''}</td>
        <td>${c.type||''}</td>
        <td>${c.status||''}</td>
        <td>${c.handler || c.assigned || ''}</td>
      </tr>`;
    });
    html += `</tbody></table>`;
  }
  html += `</div>`;
  
  // MOT alerts
  html += `<div class="card" style="margin-top:10px;">
    <h3>MOT Alerts (Expired / next 30 days)</h3>`;
  if(!motAlerts.length){
    html += `<div class="small">No MOT alerts.</div>`;
  } else {
    html += `<table class="table"><thead>
      <tr><th>REG</th><th>Vehicle</th><th>MOT Expiry</th><th>Alert</th><th>Days</th><th>Status</th></tr>
    </thead><tbody>`;
    motAlerts.forEach(row=>{
      const v = row.v;
      html += `<tr>
        <td>${(v.reg||'').toUpperCase()}</td>
        <td>${(v.make||'')+' '+(v.model||'')}</td>
        <td>${ddmmyyyy(v.lastMotExpiry || v.motExpiry)}</td>
        <td>${row.type}</td>
        <td class="right">${row.diff}</td>
        <td>${v.status||''}</td>
      </tr>`;
    });
    html += `</tbody></table>`;
  }
  html += `</div>`;
  
  // To-Do
  html += `<div class="card" style="margin-top:10px;">
    <h3>Open To-Do Tasks</h3>`;
  if(!todos.length){
    html += `<div class="small">No open tasks.</div>`;
  } else {
    html += `<table class="table"><thead>
      <tr><th>Date</th><th>Text</th><th>Assigned</th></tr>
    </thead><tbody>`;
    todos.forEach(t=>{
      html += `<tr>
        <td>${ddmmyyyy(t.date)}</td>
        <td>${t.text||''}</td>
        <td>${t.assignedTo||''}</td>
      </tr>`;
    });
    html += `</tbody></table>`;
  }
  html += `</div>`;
  
  wrap.innerHTML = html;
  return wrap;
}

/* ========= To-Do ========= */
function viewTodo(){ if(!canTab('To-Do')) return document.createElement('div'); const wrap=document.createElement('div'); wrap.className='card';
  wrap.innerHTML=`<h2>To-Do</h2><div class="row"><input id="t_date" type="date"><input id="t_text" placeholder="Task"><select id="t_user"><option value="">‚Äî assign ‚Äî</option>${(db.users||[]).map(u=>`<option>${u.username}</option>`).join('')}</select><select id="t_entity"><option value="">entity‚Ä¶</option><option>vehicle</option><option>sale</option><option>investor</option><option>director</option></select><input id="t_eid" placeholder="Entity id/reg"><button id="t_add" class="primary">Add</button></div>
  <table class="table" style="margin-top:10px"><thead><tr><th>Date</th><th>Task</th><th>Assigned</th><th>Entity</th><th>Done</th><th>Actions</th></tr></thead><tbody id="t_body"></tbody></table>`;
  const body=wrap.querySelector('#t_body'); function rows(){ body.innerHTML=''; (db.todo||[]).forEach(t=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${ddmmyyyy(t.date||'')}</td><td>${t.text||''}</td><td>${t.assignedTo||''}</td><td>${t.entity||''} ${t.entityId||''}</td><td><input type="checkbox" ${t.done?'checked':''} data-act="toggle" data-id="${t.id}"></td><td>${canAction('del')?`<button class="danger" data-act="del" data-id="${t.id}">Delete</button>`:''}</td>`; body.appendChild(tr); }); }
  rows();
  wrap.querySelector('#t_add').onclick=()=>{ if(!canAction('add')) return alert('No permission'); const t={id:uid(),date:document.getElementById('t_date').value,text:document.getElementById('t_text').value.trim(),assignedTo:document.getElementById('t_user').value,entity:document.getElementById('t_entity').value,entityId:document.getElementById('t_eid').value.trim(),done:false}; if(!t.text) return alert('Task text required'); (db.todo=db.todo||[]).unshift(t); saveDB(); try{renderAlertBell();}catch(e){}; addAudit('add','todo',t.id,t.text); rows(); document.getElementById('t_text').value=''; };
  wrap.addEventListener('change',(ev)=>{ const cb=ev.target.closest('input[type=checkbox][data-act=toggle]'); if(!cb) return; const t=(db.todo||[]).find(x=>x.id===cb.dataset.id); if(!t) return; t.done=cb.checked; saveDB(); try{renderAlertBell();}catch(e){}; addAudit('update','todo',t.id,t.text+' done='+t.done); });
  wrap.addEventListener('click',(ev)=>{ 
  const b=ev.target.closest('button'); 
  if(!b) return; 
    if(b.dataset.act==='del'){ 
      if(!canAction('del')) return alert('No permission'); 

      const id = b.dataset.id;
      // track todo deletion
      markDeleted('todo', id);
    
      db.todo = db.todo.filter(x=>x.id!==id); 
      saveDB(); 
      try{renderAlertBell();}catch(e){}; 
      addAudit('delete','todo',id,''); 
      rows(); 
    } 
  });
  return wrap;
}

/* ========= Customer Complaints ========= */
function viewComplaints(){
  if(!canTab('Customer Complaints')) return document.createElement('div'); 
  const wrap=document.createElement('div'); 
  wrap.className='card';
  
  wrap.innerHTML=`<h2>Customer Complaints</h2>
  <div class="row">
    <input id="comp_date" type="date">
    <input id="comp_customer" placeholder="Customer Name *" style="min-width:180px">
    
    <datalist id="comp_reg_list">
      ${(db.vehicles||[]).map(v => {
        const reg = (v.reg||'').toUpperCase();
        const m = v.make||'';
        const mo = v.model||'';
        return `<option value="${reg}">${reg} ‚Äî ${m} ${mo}</option>`;
      }).join('')}
    </datalist>
    <input id="comp_vehicle" list="comp_reg_list" placeholder="Vehicle REG" style="min-width:180px">
    
    <input id="comp_type" placeholder="Complaint Type" style="min-width:180px">
    <select id="comp_severity">
      <option value="low">Low</option>
      <option value="medium" selected>Medium</option>
      <option value="high">High</option>
      <option value="urgent">Urgent</option>
    </select>
  </div>

  <div class="row small" id="comp_saleHint" style="margin-top:4px;margin-bottom:8px;color:var(--mut)"></div>

  <div class="row">
    <textarea id="comp_details" placeholder="Complaint details *" style="flex:1;min-height:80px"></textarea>
  </div>
  <div class="row">
    <textarea id="comp_resolution" placeholder="Resolution taken / plan" style="flex:1;min-height:80px"></textarea>
  </div>

  <!-- LOG FIELDS -->
  <div class="row" style="flex-wrap:wrap;gap:8px">
    <input id="comp_mileageNow" type="number" placeholder="Mileage now" style="max-width:150px">
    <button id="comp_autofill" type="button">Auto-fill from sale</button>
    <input id="comp_mechBook" type="date" placeholder="Booked with mechanic">
    <input id="comp_mechName" placeholder="Mechanic / Garage name">
    <input id="comp_delivered" type="date" placeholder="Delivered to mechanic">
    <input id="comp_work" placeholder="Work carried out / fault found" style="flex:1;min-width:200px">
  </div>

  <div class="row" style="flex-wrap:wrap;gap:8px;margin-top:6px">
    <input id="comp_collected" type="date" placeholder="Customer collected">
    <input id="comp_collectedMileage" type="number" placeholder="Mileage at collection" style="max-width:170px">
    <input id="comp_handler" placeholder="Staff dealing with complaint">
  </div>

  <div class="row" style="margin-top:10px">
    <select id="comp_status">
      <option value="new">New</option>
      <option value="investigating">Investigating</option>
      <option value="resolved">Resolved</option>
      <option value="closed">Closed</option>
      <option value="escalated">Escalated</option>
    </select>
    <input id="comp_assigned" placeholder="Assigned to (optional)">
    <input id="comp_followup" type="date" placeholder="Follow-up date">
    <input id="comp_cost" type="number" placeholder="Cost ¬£ (if any)">
    <button id="comp_add" class="primary">Add / Update</button>
  </div>
  
  <div class="row" style="margin-top:16px;margin-bottom:8px">
    <input id="comp_search" placeholder="Search customer/reg/details." style="flex:1">
    <select id="comp_filter_status">
      <option value="">All Status</option>
      <option value="new">New</option>
      <option value="investigating">Investigating</option>
      <option value="resolved">Resolved</option>
      <option value="closed">Closed</option>
      <option value="escalated">Escalated</option>
    </select>
    <select id="comp_filter_severity">
      <option value="">All Severity</option>
      <option value="low">Low</option>
      <option value="medium">Medium</option>
      <option value="high">High</option>
      <option value="urgent">Urgent</option>
    </select>
    <button id="comp_clear">Clear Filters</button>
    <button id="comp_export">Export CSV</button>
    <button id="comp_print">Print</button>
  </div>
  
  <table class="table" style="margin-top:10px">
    <thead>
      <tr>
        <th>Date</th>
        <th>Customer / Summary</th>
        <th>Vehicle</th>
        <th>Type</th>
        <th>Severity</th>
        <th>Status</th>
        <th>Assigned</th>
        <th>Follow-up</th>
        <th>Cost</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody id="comp_body"></tbody>
  </table>`;

  // ===== Helpers =====
  db.complaints = db.complaints || [];
  const body = wrap.querySelector('#comp_body');
  let editId = null;

  function findSaleByReg(reg){
    reg = (reg||'').toUpperCase().trim();
    if(!reg) return null;
    const v = (db.vehicles||[]).find(x => (x.reg||'').toUpperCase() === reg) || null;
    if(!v) return null;
    const sale = (db.sales||[]).find(s => s.vehicleId === v.id && isRealSale(s)) || null;
    return { vehicle: v, sale };
  }

  function buildSaleHint(reg, comp){
    const hintEl = wrap.querySelector('#comp_saleHint');
    const found = findSaleByReg(reg);
    if(!found || !found.sale){
      hintEl.textContent = reg ? `No sale found for ${reg} (may be unsold / purchase only).` : '';
      return;
    }
    const v = found.vehicle;
    const s = found.sale;
    const buyer = s.buyer || (comp && comp.customer) || '';
    const soldDate = s.date ? ddmmyyyy(s.date) : '';
    const soldMileage = Number(s.mileage || 0);
    const compMileage = Number((comp && comp.mileageNow) || wrap.querySelector('#comp_mileageNow').value || 0) || 0;

    let daysSinceSale = '';
    if (s.date) {
      const dSale = new Date(s.date);
      const dComp = comp && comp.date ? new Date(comp.date) : new Date();
      const diff = Math.round((dComp - dSale) / (1000*60*60*24));
      daysSinceSale = isNaN(diff) ? '' : `${diff} days`;
    }

    // Optional warranty: prefer sale-specific months, then Settings default
    let warrantyText = '';
    const saleMonths   = Number(s.warrantyMonths || 0);
    const configMonths = Number((db.company || {}).defaultWarrantyMonths || 0);
    const wMonths      = saleMonths || configMonths;

    if (s.date && wMonths > 0){
      const d = new Date(s.date);
      d.setMonth(d.getMonth() + wMonths);
      const iso   = d.toISOString().slice(0,10);
      const prov  = s.warrantyProvider || '';
      const label = prov ? `${prov} warranty` : 'Warranty';
      warrantyText = `${label} approx until ${ddmmyyyy(iso)} (${wMonths} months)`;
    }

    let bits = [];
    if (soldDate) bits.push(`Sold: ${soldDate}${daysSinceSale ? ' ('+daysSinceSale+' before complaint)' : ''}`);
    if (soldMileage) bits.push(`Mileage at sale: ${soldMileage.toLocaleString()} miles`);
    if (compMileage) {
      const diffMiles = soldMileage ? (compMileage - soldMileage) : null;
      bits.push(`Mileage now: ${compMileage.toLocaleString()} miles` + (diffMiles!=null ? ` (${diffMiles.toLocaleString()} since sale)` : ''));
    }
    if (warrantyText) bits.push(warrantyText);

    const line = `Logging for: ${buyer || 'Unknown'} ‚Äî ${(v.reg||'').toUpperCase()} (${v.make||''} ${v.model||''})`;
    hintEl.innerHTML = line + (bits.length ? `<br><span style="color:var(--mut);font-size:12px">${bits.join(' ‚Ä¢ ')}</span>` : '');
  }

    function openComplaintEvidence(comp){
    const reg = (comp.vehicle || '').toUpperCase();
    const found = findSaleByReg(reg) || {};
    const v = found.vehicle || {};
    const s = found.sale || null;
    
    const expenses = (db.vehicleExpenses || []).filter(e => v.id && e.vehicleId === v.id);
    expenses.sort((a,b)=> new Date(a.date||0) - new Date(b.date||0));
    const expRows = expenses.map(e => {
      return `<tr>
        <td>${ddmmyyyy(e.date)}</td>
        <td>${e.type || ''}</td>
        <td>${e.note || ''}</td>
        <td class="right">${fmtMoney(e.amount || 0)}</td>
      </tr>`;
    }).join('');
    const expTotal = expenses.reduce((t,e)=>t + Number(e.amount||0),0);
    
    const saleDate   = s && s.date ? ddmmyyyy(s.date) : '';
    const saleMiles  = s && s.mileage ? s.mileage.toLocaleString() : '';
    const compMiles  = comp.mileageNow || comp.collectedMileage || '';
    
    let milesLine = '';
    if (saleMiles || compMiles){
      let diff = '';
      if (saleMiles && compMiles){
        const m1 = Number(String(s.mileage||0).replace(/[^0-9]/g,'')) || 0;
        const m2 = Number(String(compMiles).replace(/[^0-9]/g,'')) || 0;
        const d  = m2 - m1;
        if(!isNaN(d) && d>=0) diff = ` (approx +${d.toLocaleString()} miles since sale)`;
      }
      milesLine =
        `${saleMiles ? 'Mileage at sale: '+saleMiles : ''}` +
        `${saleMiles && compMiles ? ' ‚Üí ' : ''}` +
        `${compMiles ? 'Mileage at complaint: '+compMiles : ''}` +
        `${diff}`;
    }
    
    let warrantyText = '';
    if (s && s.warrantyMonths){
      const months = Number(s.warrantyMonths||0);
      if(s.date && months>0){
        const d = new Date(s.date);
        d.setMonth(d.getMonth()+months);
        const iso = d.toISOString().slice(0,10);
        const prov = s.warrantyProvider || '';
        const label = prov ? prov+' warranty' : 'Warranty';
        warrantyText = `${label} approx until ${ddmmyyyy(iso)} (${months} months)`;
      }
    } else {
      const cfgMonths = Number((db.company || {}).defaultWarrantyMonths || 0);
      if(s && s.date && cfgMonths>0){
        const d = new Date(s.date);
        d.setMonth(d.getMonth()+cfgMonths);
        const iso = d.toISOString().slice(0,10);
        warrantyText = `Warranty approx until ${ddmmyyyy(iso)} (${cfgMonths} months)`;
      }
    }
    
    const nowStr = new Date().toLocaleString();
    
    let html = `<!doctype html><html><head><meta charset="utf-8">
      <title>Complaint Evidence Pack</title>
      <style>
        body{font-family:Arial,Helvetica,sans-serif;font-size:12px;color:#222;margin:16px;}
        h1,h2,h3{margin:4px 0;}
        table{border-collapse:collapse;width:100%;margin-bottom:10px;}
        th,td{border:1px solid #ccc;padding:4px 6px;font-size:12px;vertical-align:top;}
        th{background:#f4f4f4;text-align:left;}
        .right{text-align:right;}
        .small{font-size:11px;color:#666;}
        .section{margin-top:10px;margin-bottom:4px;}
      </style>
    </head><body>`;
    
    html += `<h1>Complaint Evidence Pack</h1>
      <div class="small">Generated: ${nowStr}</div>
      <div class="small">Complaint ID: ${comp.id || ''}</div>`;
    
    // 1. Complaint summary
    html += `<div class="section"><h2>1. Complaint Summary</h2>
      <table>
        <tr><th>Date received</th><td>${ddmmyyyy(comp.date)}</td></tr>
        <tr><th>Customer</th><td>${comp.customer || ''}</td></tr>
        <tr><th>Vehicle</th><td>${reg} ${(v.make||'') ? ' ‚Äî '+(v.make||'')+' '+(v.model||'') : ''}</td></tr>
        <tr><th>Type</th><td>${comp.type || ''}</td></tr>
        <tr><th>Severity</th><td>${comp.severity || ''}</td></tr>
        <tr><th>Status</th><td>${comp.status || ''}</td></tr>
        <tr><th>Assigned handler</th><td>${comp.handler || comp.assigned || ''}</td></tr>
        <tr><th>Follow-up date</th><td>${ddmmyyyy(comp.followup)}</td></tr>
        <tr><th>Complaint details</th><td>${(comp.details || '').replace(/\n/g,'<br>')}</td></tr>
        <tr><th>Resolution / notes</th><td>${(comp.resolution || '').replace(/\n/g,'<br>')}</td></tr>
      </table>
    </div>`;
    
    // 2. Vehicle & sale details
    html += `<div class="section"><h2>2. Vehicle & Sale Details</h2>
      <table>
        <tr><th>REG</th><td>${reg}</td></tr>
        <tr><th>Make / Model</th><td>${(v.make||'')+' '+(v.model||'')}</td></tr>
        <tr><th>VIN</th><td>${v.vin || ''}</td></tr>
        <tr><th>First registration</th><td>${ddmmyyyy(v.firstReg)}</td></tr>
        <tr><th>MOT expiry (last known)</th><td>${ddmmyyyy(v.lastMotExpiry || v.motExpiry)}</td></tr>
        <tr><th>Status in stock system</th><td>${v.status || ''}</td></tr>
        <tr><th>Sale date</th><td>${saleDate}</td></tr>
        <tr><th>Sale price</th><td>${s ? fmtMoney(s.salePrice || 0) : ''}</td></tr>
        <tr><th>Invoice #</th><td>${s ? (s.invNo || '') : ''}</td></tr>
        <tr><th>Finance company</th><td>${s ? (s.financeCompany || '') : ''}</td></tr>
        <tr><th>Mileage at sale / now</th><td>${milesLine || ''}</td></tr>
        <tr><th>Warranty</th><td>${warrantyText || 'Not recorded'}</td></tr>
      </table>
    </div>`;
    
    // 3. Workshop / repairs from complaint log
    html += `<div class="section"><h2>3. Workshop / Repair Details (Complaint Log)</h2>
      <table>
        <tr><th>Fault reported</th><td>${comp.problem || comp.type || ''}</td></tr>
        <tr><th>Booked with mechanic</th><td>${comp.mechanicBooked || ''}</td></tr>
        <tr><th>Garage / mechanic name</th><td>${comp.mechanicName || ''}</td></tr>
        <tr><th>Vehicle delivered to mechanic</th><td>${comp.deliveredDate || ''}</td></tr>
        <tr><th>Work done</th><td>${(comp.workDone || '').replace(/\n/g,'<br>')}</td></tr>
        <tr><th>Customer collected on</th><td>${comp.collectedDate || ''}</td></tr>
        <tr><th>Mileage at collection</th><td>${comp.collectedMileage || ''}</td></tr>
        <tr><th>Internal handler</th><td>${comp.handler || comp.assigned || ''}</td></tr>
        <tr><th>Company cost / goodwill</th><td>${comp.cost ? fmtMoney(comp.cost) : ''}</td></tr>
      </table>
    </div>`;
    
    // 4. Linked vehicle expenses
    html += `<div class="section"><h2>4. Linked Vehicle Expenses / Repairs</h2>`;
    if(!expenses.length){
      html += `<div class="small">No vehicle expenses recorded for this vehicle.</div>`;
    } else {
      html += `<table>
        <thead><tr><th>Date</th><th>Type</th><th>Note</th><th class="right">Amount</th></tr></thead>
        <tbody>${expRows}</tbody>
        <tfoot><tr><th colspan="3" class="right">Total</th><th class="right">${fmtMoney(expTotal)}</th></tr></tfoot>
      </table>`;
    }
    html += `</div>`;
    
    html += `</body></html>`;
    openPrintable(html);
    }

    function openComplaintEvidence(comp){
    const reg = (comp.vehicle || '').toUpperCase();
    const found = findSaleByReg(reg) || {};
    const v = found.vehicle || {};
    const s = found.sale || null;
    
    const expenses = (db.vehicleExpenses || []).filter(e => v.id && e.vehicleId === v.id);
    expenses.sort((a,b)=> new Date(a.date||0) - new Date(b.date||0));
    const expRows = expenses.map(e => {
      return `<tr>
        <td>${ddmmyyyy(e.date)}</td>
        <td>${e.type || ''}</td>
        <td>${e.note || ''}</td>
        <td class="right">${fmtMoney(e.amount || 0)}</td>
      </tr>`;
    }).join('');
    const expTotal = expenses.reduce((t,e)=>t + Number(e.amount||0),0);
    
    const saleDate   = s && s.date ? ddmmyyyy(s.date) : '';
    const saleMiles  = s && s.mileage ? s.mileage.toLocaleString() : '';
    const compMiles  = comp.mileageNow || comp.collectedMileage || '';
    
    let milesLine = '';
    if (saleMiles || compMiles){
      let diff = '';
      if (saleMiles && compMiles){
        const m1 = Number(String(s.mileage||0).replace(/[^0-9]/g,'')) || 0;
        const m2 = Number(String(compMiles).replace(/[^0-9]/g,'')) || 0;
        const d  = m2 - m1;
        if(!isNaN(d) && d>=0) diff = ` (approx +${d.toLocaleString()} miles since sale)`;
      }
      milesLine =
        `${saleMiles ? 'Mileage at sale: '+saleMiles : ''}` +
        `${saleMiles && compMiles ? ' ‚Üí ' : ''}` +
        `${compMiles ? 'Mileage at complaint: '+compMiles : ''}` +
        `${diff}`;
    }
    
    let warrantyText = '';
    if (s && s.warrantyMonths){
      const months = Number(s.warrantyMonths||0);
      if(s.date && months>0){
        const d = new Date(s.date);
        d.setMonth(d.getMonth()+months);
        const iso = d.toISOString().slice(0,10);
        const prov = s.warrantyProvider || '';
        const label = prov ? prov+' warranty' : 'Warranty';
        warrantyText = `${label} approx until ${ddmmyyyy(iso)} (${months} months)`;
      }
    } else {
      const cfgMonths = Number((db.company || {}).defaultWarrantyMonths || 0);
      if(s && s.date && cfgMonths>0){
        const d = new Date(s.date);
        d.setMonth(d.getMonth()+cfgMonths);
        const iso = d.toISOString().slice(0,10);
        warrantyText = `Warranty approx until ${ddmmyyyy(iso)} (${cfgMonths} months)`;
      }
    }
    
    const nowStr = new Date().toLocaleString();
    
    let html = `<!doctype html><html><head><meta charset="utf-8">
      <title>Complaint Evidence Pack</title>
      <style>
        body{font-family:Arial,Helvetica,sans-serif;font-size:12px;color:#222;margin:16px;}
        h1,h2,h3{margin:4px 0;}
        table{border-collapse:collapse;width:100%;margin-bottom:10px;}
        th,td{border:1px solid #ccc;padding:4px 6px;font-size:12px;vertical-align:top;}
        th{background:#f4f4f4;text-align:left;}
        .right{text-align:right;}
        .small{font-size:11px;color:#666;}
        .section{margin-top:10px;margin-bottom:4px;}
      </style>
    </head><body>`;
    
    html += `<h1>Complaint Evidence Pack</h1>
      <div class="small">Generated: ${nowStr}</div>
      <div class="small">Complaint ID: ${comp.id || ''}</div>`;
    
    // 1. Complaint summary
    html += `<div class="section"><h2>1. Complaint Summary</h2>
      <table>
        <tr><th>Date received</th><td>${ddmmyyyy(comp.date)}</td></tr>
        <tr><th>Customer</th><td>${comp.customer || ''}</td></tr>
        <tr><th>Vehicle</th><td>${reg} ${(v.make||'') ? ' ‚Äî '+(v.make||'')+' '+(v.model||'') : ''}</td></tr>
        <tr><th>Type</th><td>${comp.type || ''}</td></tr>
        <tr><th>Severity</th><td>${comp.severity || ''}</td></tr>
        <tr><th>Status</th><td>${comp.status || ''}</td></tr>
        <tr><th>Assigned handler</th><td>${comp.handler || comp.assigned || ''}</td></tr>
        <tr><th>Follow-up date</th><td>${ddmmyyyy(comp.followup)}</td></tr>
        <tr><th>Complaint details</th><td>${(comp.details || '').replace(/\n/g,'<br>')}</td></tr>
        <tr><th>Resolution / notes</th><td>${(comp.resolution || '').replace(/\n/g,'<br>')}</td></tr>
      </table>
    </div>`;
    
    // 2. Vehicle & sale details
    html += `<div class="section"><h2>2. Vehicle & Sale Details</h2>
      <table>
        <tr><th>REG</th><td>${reg}</td></tr>
        <tr><th>Make / Model</th><td>${(v.make||'')+' '+(v.model||'')}</td></tr>
        <tr><th>VIN</th><td>${v.vin || ''}</td></tr>
        <tr><th>First registration</th><td>${ddmmyyyy(v.firstReg)}</td></tr>
        <tr><th>MOT expiry (last known)</th><td>${ddmmyyyy(v.lastMotExpiry || v.motExpiry)}</td></tr>
        <tr><th>Status in stock system</th><td>${v.status || ''}</td></tr>
        <tr><th>Sale date</th><td>${saleDate}</td></tr>
        <tr><th>Sale price</th><td>${s ? fmtMoney(s.salePrice || 0) : ''}</td></tr>
        <tr><th>Invoice #</th><td>${s ? (s.invNo || '') : ''}</td></tr>
        <tr><th>Finance company</th><td>${s ? (s.financeCompany || '') : ''}</td></tr>
        <tr><th>Mileage at sale / now</th><td>${milesLine || ''}</td></tr>
        <tr><th>Warranty</th><td>${warrantyText || 'Not recorded'}</td></tr>
      </table>
    </div>`;
    
    // 3. Workshop / repairs from complaint log
    html += `<div class="section"><h2>3. Workshop / Repair Details (Complaint Log)</h2>
      <table>
        <tr><th>Fault reported</th><td>${comp.problem || comp.type || ''}</td></tr>
        <tr><th>Booked with mechanic</th><td>${comp.mechanicBooked || ''}</td></tr>
        <tr><th>Garage / mechanic name</th><td>${comp.mechanicName || ''}</td></tr>
        <tr><th>Vehicle delivered to mechanic</th><td>${comp.deliveredDate || ''}</td></tr>
        <tr><th>Work done</th><td>${(comp.workDone || '').replace(/\n/g,'<br>')}</td></tr>
        <tr><th>Customer collected on</th><td>${comp.collectedDate || ''}</td></tr>
        <tr><th>Mileage at collection</th><td>${comp.collectedMileage || ''}</td></tr>
        <tr><th>Internal handler</th><td>${comp.handler || comp.assigned || ''}</td></tr>
        <tr><th>Company cost / goodwill</th><td>${comp.cost ? fmtMoney(comp.cost) : ''}</td></tr>
      </table>
    </div>`;
    
    // 4. Linked vehicle expenses
    html += `<div class="section"><h2>4. Linked Vehicle Expenses / Repairs</h2>`;
    if(!expenses.length){
      html += `<div class="small">No vehicle expenses recorded for this vehicle.</div>`;
    } else {
      html += `<table>
        <thead><tr><th>Date</th><th>Type</th><th>Note</th><th class="right">Amount</th></tr></thead>
        <tbody>${expRows}</tbody>
        <tfoot><tr><th colspan="3" class="right">Total</th><th class="right">${fmtMoney(expTotal)}</th></tr></tfoot>
      </table>`;
    }
    html += `</div>`;
    
    html += `</body></html>`;
    openPrintable(html);
  }

  function renderComplaints(filter = {}) {
    body.innerHTML = '';
    
    let complaints = db.complaints || [];
    
    // Filters
    if (filter.search) {
      const searchTerm = filter.search.toLowerCase();
      complaints = complaints.filter(c => 
        (c.customer || '').toLowerCase().includes(searchTerm) ||
        (c.vehicle || '').toLowerCase().includes(searchTerm) ||
        (c.details || '').toLowerCase().includes(searchTerm) ||
        (c.resolution || '').toLowerCase().includes(searchTerm)
      );
    }
    if (filter.status) {
      complaints = complaints.filter(c => c.status === filter.status);
    }
    if (filter.severity) {
      complaints = complaints.filter(c => c.severity === filter.severity);
    }
    
    // Sort by date (newest first)
    complaints.sort((a, b) => new Date(b.date || 0) - new Date(a.date || 0));
    
    if (complaints.length === 0) {
      const tr = document.createElement('tr');
      tr.innerHTML = `<td colspan="10" class="small" style="text-align: center; padding: 20px;">No complaints found${filter.search ? ' for "' + filter.search + '"' : ''}</td>`;
      body.appendChild(tr);
      return;
    }
    
    complaints.forEach(c => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${ddmmyyyy(c.date)}</td>
        <td>${c.customer || ''}<br><small style="color:var(--mut)">${(c.details || '').substring(0, 50)}${(c.details || '').length > 50 ? '...' : ''}</small></td>
        <td>${c.vehicle || ''}</td>
        <td>${c.type || ''}</td>
        <td>${c.severity || ''}</td>
        <td>${c.status || ''}</td>
        <td>${c.assigned || ''}</td>
        <td>${ddmmyyyy(c.followup)}</td>
        <td class="right">${c.cost ? fmtMoney(c.cost) : ''}</td>
        <td>
          <button data-act="view" data-id="${c.id}" title="View Details">View</button>
          <button data-act="pack" data-id="${c.id}" title="Export evidence pack">Evidence</button>
          ${canAction('edit') ? `<button data-act="edit" data-id="${c.id}">Edit</button>` : ''}
          ${canAction('del') ? `<button class="danger" data-act="del" data-id="${c.id}">Delete</button>` : ''}
        </td>
      `;
      body.appendChild(tr);
    });
  }

  // Initial table
  renderComplaints();

  // Add/Update complaint
  wrap.querySelector('#comp_add').onclick = () => {
    if(!canAction('add')) return alert('No permission');
    
    const compReg = (wrap.querySelector('#comp_vehicle').value || '').toUpperCase().trim();
    const current = editId ? (db.complaints||[]).find(x => x.id === editId) : null;

    const baseDate = wrap.querySelector('#comp_date').value || (current && current.date) || new Date().toISOString().split('T')[0];
    const mechRaw = wrap.querySelector('#comp_mechBook').value || '';
    const delRaw  = wrap.querySelector('#comp_delivered').value || '';
    const colRaw  = wrap.querySelector('#comp_collected').value || '';

    const comp = {
      id: editId || uid(),
      date: baseDate,
      customer: wrap.querySelector('#comp_customer').value.trim(),
      vehicle: compReg,
      type: wrap.querySelector('#comp_type').value,
      severity: wrap.querySelector('#comp_severity').value,
      details: wrap.querySelector('#comp_details').value.trim(),
      resolution: wrap.querySelector('#comp_resolution').value.trim(),
      status: wrap.querySelector('#comp_status').value,
      assigned: wrap.querySelector('#comp_assigned').value.trim(),
      followup: wrap.querySelector('#comp_followup').value,
      cost: Number(wrap.querySelector('#comp_cost').value || 0),

      // LOG FIELDS
      mileageNow: Number(wrap.querySelector('#comp_mileageNow').value || 0),
      mechanicBooked: mechRaw ? mechRaw.substring(0,10) : '',
      mechanicName: wrap.querySelector('#comp_mechName').value.trim(),
      deliveredDate: delRaw ? delRaw.substring(0,10) : '',
      workDone: wrap.querySelector('#comp_work').value.trim(),
      collectedDate: colRaw ? colRaw.substring(0,10) : '',
      collectedMileage: Number(wrap.querySelector('#comp_collectedMileage').value || 0),
      handler: wrap.querySelector('#comp_handler').value.trim(),

      createdAt: editId && current ? current.createdAt : new Date().toISOString(),
      updatedAt: new Date().toISOString()
    };

    // Snapshot sale info when adding (optional but useful)
    const found = findSaleByReg(compReg);
    if (found && found.sale){
      comp.saleId = found.sale.id;
      comp.saleDate = found.sale.date || '';
      comp.saleMileage = Number(found.sale.mileage || 0);
      comp.salePrice = Number(found.sale.salePrice || 0);
      comp.saleInvNo = found.sale.invNo || '';
    }

    if(!comp.customer || !comp.details) {
      return alert('Customer name and complaint details are required');
    }

    if(editId) {
      db.complaints = db.complaints.map(x => x.id === editId ? comp : x);
      addAudit('update', 'complaint', comp.id, `${comp.customer} - ${comp.type} - ${comp.status}`);
      editId = null;
    } else {
      db.complaints.unshift(comp);
      addAudit('add', 'complaint', comp.id, `${comp.customer} - ${comp.type} - ${comp.severity}`);

      // Auto notification: create TODO when urgent/escalated
      if (comp.severity === 'urgent' || comp.status === 'escalated') {
        db.todo = db.todo || [];
        const task = {
          id: uid(),
          date: comp.date,
          text: `URGENT complaint: ${comp.customer} / ${comp.vehicle} ‚Äî ${comp.type}`,
          assignedTo: comp.assigned || '',
          entity: 'complaint',
          entityId: comp.id,
          done: false
        };
        db.todo.unshift(task);
        addAudit('add', 'todo', task.id, task.text);
      }
    }
    
    saveDB();
    try{renderAlertBell();}catch(e){}
    renderComplaints();

    // Clear form
    wrap.querySelector('#comp_customer').value = '';
    wrap.querySelector('#comp_vehicle').value = '';
    wrap.querySelector('#comp_type').value = '';
    wrap.querySelector('#comp_details').value = '';
    wrap.querySelector('#comp_resolution').value = '';
    wrap.querySelector('#comp_assigned').value = '';
    wrap.querySelector('#comp_followup').value = '';
    wrap.querySelector('#comp_cost').value = '';
    wrap.querySelector('#comp_mileageNow').value = '';
    wrap.querySelector('#comp_mechBook').value = '';
    wrap.querySelector('#comp_mechName').value = '';
    wrap.querySelector('#comp_delivered').value = '';
    wrap.querySelector('#comp_work').value = '';
    wrap.querySelector('#comp_collected').value = '';
    wrap.querySelector('#comp_collectedMileage').value = '';
    wrap.querySelector('#comp_handler').value = '';
    wrap.querySelector('#comp_saleHint').textContent = '';
  };

  // Search / filter / clear
  wrap.querySelector('#comp_search').addEventListener('input', () => {
    renderComplaints({
      search: wrap.querySelector('#comp_search').value,
      status: wrap.querySelector('#comp_filter_status').value,
      severity: wrap.querySelector('#comp_filter_severity').value
    });
  });
  wrap.querySelector('#comp_filter_status').addEventListener('change', () => {
    renderComplaints({
      search: wrap.querySelector('#comp_search').value,
      status: wrap.querySelector('#comp_filter_status').value,
      severity: wrap.querySelector('#comp_filter_severity').value
    });
  });
  wrap.querySelector('#comp_filter_severity').addEventListener('change', () => {
    renderComplaints({
      search: wrap.querySelector('#comp_search').value,
      status: wrap.querySelector('#comp_filter_status').value,
      severity: wrap.querySelector('#comp_filter_severity').value
    });
  });
  wrap.querySelector('#comp_clear').onclick = () => {
    wrap.querySelector('#comp_search').value = '';
    wrap.querySelector('#comp_filter_status').value = '';
    wrap.querySelector('#comp_filter_severity').value = '';
    renderComplaints();
  };

  // Auto-fill from sale
  wrap.querySelector('#comp_autofill').onclick = () => {
    const reg = (wrap.querySelector('#comp_vehicle').value || '').toUpperCase().trim();
    if (!reg) return alert('Enter vehicle REG first.');
    const found = findSaleByReg(reg);
    if (!found || !found.sale) {
      alert('No sale found for this REG.');
      return;
    }
    const s = found.sale;
    if (!wrap.querySelector('#comp_customer').value.trim()) {
      wrap.querySelector('#comp_customer').value = s.buyer || '';
    }
    // Put the mileage at sale as a starting point (you can then overwrite with current mileage)
    if (!wrap.querySelector('#comp_mileageNow').value) {
      wrap.querySelector('#comp_mileageNow').value = s.mileage || 0;
    }
    buildSaleHint(reg, {
      date: wrap.querySelector('#comp_date').value || new Date().toISOString().slice(0,10),
      mileageNow: Number(wrap.querySelector('#comp_mileageNow').value || 0)
    });
  };

  // Update hint when REG changes
  wrap.querySelector('#comp_vehicle').addEventListener('change', () => {
    const reg = (wrap.querySelector('#comp_vehicle').value || '').toUpperCase().trim();
    if (!reg) {
      wrap.querySelector('#comp_saleHint').textContent = '';
      return;
    }
    buildSaleHint(reg, {
      date: wrap.querySelector('#comp_date').value || new Date().toISOString().slice(0,10),
      mileageNow: Number(wrap.querySelector('#comp_mileageNow').value || 0)
    });
  });

  // Export CSV
  wrap.querySelector('#comp_export').onclick = () => {
    const rows = (db.complaints||[]).map(c => ([
      c.date || '',
      c.customer || '',
      c.vehicle || '',
      c.type || '',
      c.severity || '',
      c.status || '',
      c.assigned || '',
      c.followup || '',
      c.cost || 0,
      c.mileageNow || '',
      c.mechanicBooked || '',
      c.mechanicName || '',
      c.deliveredDate || '',
      c.workDone || '',
      c.collectedDate || '',
      c.collectedMileage || '',
      c.handler || '',
      c.saleDate || '',
      c.saleMileage || '',
      c.salePrice || '',
      c.saleInvNo || ''
    ]));

    const header = [
      'Complaint Date','Customer','Vehicle REG','Type','Severity','Status','Assigned',
      'Follow-up','Cost','Mileage Now','Mechanic Booked','Mechanic Name',
      'Delivered Date','Work Done','Collected Date','Collected Mileage',
      'Handled By','Sale Date','Sale Mileage','Sale Price','Sale Invoice'
    ];

    const csv = [header].concat(rows)
      .map(r => r.map(v => `"${String(v).replace(/"/g,'""')}"`).join(','))
      .join('\n');

    const a = document.createElement('a');
    a.href = URL.createObjectURL(new Blob([csv],{type:'text/csv'}));
    a.download = 'complaints_'+new Date().toISOString().slice(0,10)+'.csv';
    a.click();
  };

  // Print summary
  wrap.querySelector('#comp_print').onclick = () => {
    const list = db.complaints || [];
    if (!list.length) {
      alert('No complaints to print.');
      return;
    }
    let html = `<!doctype html><html><head><meta charset="utf-8"><title>Customer Complaints</title>
    <style>
      body{font-family:Arial;font-size:11px;color:#111}
      table{width:100%;border-collapse:collapse}
      th,td{border:1px solid #000;padding:4px 6px;vertical-align:top}
      th{background:#f0f0f0}
      h2{margin:0 0 10px 0}
      .small{font-size:10px;color:#666}
      .no-print{margin:8px 0}
      @media print{.no-print{display:none}}
    </style>
    </head><body>
    <button class="no-print" onclick="window.print()">Print / Save PDF</button>
    <h2>Customer Complaints Log</h2>
    <table><thead><tr>
      <th>Date</th><th>Customer</th><th>Vehicle</th><th>Summary</th><th>Status</th>
      <th>Severity</th><th>Handler</th><th>Log (mileage/mechanic)</th>
    </tr></thead><tbody>`;

    list.sort((a,b)=>new Date(b.date||0)-new Date(a.date||0)).forEach(c => {
      const reg = (c.vehicle||'').toUpperCase();
      const found = findSaleByReg(reg);
      const v = found && found.vehicle ? found.vehicle : {};
      const s = found && found.sale ? found.sale : null;

      const soldBit = s && s.date ? `Sold ${ddmmyyyy(s.date)}${s.mileage ? ' @ ' + s.mileage + ' miles' : ''}` : '';
      const mileageBit = (c.mileageNow || c.collectedMileage) ? 
        `Mileage now: ${c.mileageNow||''} ‚Ä¢ At collection: ${c.collectedMileage||''}` : '';
      const mechBit = (c.mechanicName || c.workDone) ? 
        `${c.mechanicName||''} ‚Äî ${c.workDone||''}` : '';
      
      html += `<tr>
        <td>${ddmmyyyy(c.date)}</td>
        <td>${c.customer||''}</td>
        <td>${reg}<br><span class="small">${v.make||''} ${v.model||''}</span></td>
        <td>${(c.details||'').replace(/\n/g,'<br>')}</td>
        <td>${c.status||''}</td>
        <td>${c.severity||''}</td>
        <td>${c.handler || c.assigned || ''}</td>
        <td class="small">
          ${soldBit ? soldBit + '<br>' : ''}
          ${mileageBit ? mileageBit + '<br>' : ''}
          ${c.mechanicBooked ? 'Booked: '+c.mechanicBooked+'<br>' : ''}
          ${c.deliveredDate ? 'Delivered: '+c.deliveredDate+'<br>' : ''}
          ${c.collectedDate ? 'Collected: '+c.collectedDate+'<br>' : ''}
          ${mechBit}
        </td>
      </tr>`;
    });

    html += '</tbody></table></body></html>';
    openPrintable(html);
  };

  // Row buttons (view/edit/delete)
  wrap.addEventListener('click', (ev) => {
    const b = ev.target.closest('button');
    if(!b || !b.dataset.act) return;
    const id = b.dataset.id;
    const act = b.dataset.act;
    const comp = (db.complaints||[]).find(x => x.id === id);
    if(!comp) return;
    
    if(act === 'view') {
      const reg = (comp.vehicle||'').toUpperCase();
      const found = findSaleByReg(reg);
      const v = found && found.vehicle ? found.vehicle : {};
      const s = found && found.sale ? found.sale : null;

      let headerRow = '';
      if (s && v) {
        const buyer = s.buyer || comp.customer || '';
        const soldDate = s.date ? ddmmyyyy(s.date) : '';
        const soldMileage = Number(s.mileage || 0);

        const compMileage = Number(comp.mileageNow || comp.collectedMileage || 0) || 0;
        let daysSinceSale = '';
        if (s.date) {
          const dSale = new Date(s.date);
          const dComp = comp.date ? new Date(comp.date) : new Date();
          const diff = Math.round((dComp - dSale) / (1000*60*60*24));
          daysSinceSale = isNaN(diff) ? '' : `${diff} days`;
        }
        const diffMiles = (compMileage && soldMileage) ? (compMileage - soldMileage) : null;

        // warranty from settings
        let warrantyText = '';
        const wMonths = Number((db.company||{}).defaultWarrantyMonths || 0);
        if (s.date && wMonths > 0) {
          const d = new Date(s.date);
          d.setMonth(d.getMonth()+wMonths);
          const iso = d.toISOString().slice(0,10);
          warrantyText = `‚Ä¢ Warranty approx until ${ddmmyyyy(iso)} (${wMonths} months)`;
        }

        let bits = [];
        if (soldDate) bits.push(`Sold: ${soldDate}${daysSinceSale ? ' ('+daysSinceSale+' before complaint)' : ''}`);
        if (soldMileage) bits.push(`Mileage at sale: ${soldMileage.toLocaleString()} miles`);
        if (compMileage) bits.push(`Mileage now: ${compMileage.toLocaleString()} miles` + (diffMiles!=null ? ` (${diffMiles.toLocaleString()} since sale)` : ''));
        if (warrantyText) bits.push(warrantyText);

        const headerLine = `Logging for: ${buyer || 'Unknown'} ‚Äî ${reg} (${v.make||''} ${v.model||''})`;
        headerRow = `<tr><td colspan="2" style="padding:8px 4px;background:#0f1628;color:#cbd4ff;font-size:12px;border-bottom:1px solid var(--line);">
            ${headerLine}<br>
            <span style="color:#cbd4ffb3;font-size:11px">${bits.join(' ‚Ä¢ ')}</span>
          </td></tr>`;
      }

      const html = `
        <div style="padding:10px;max-width:700px">
          <h3>Complaint Details</h3>
          <table style="width:100%;border-collapse:collapse">
            ${headerRow}
            <tr><th style="text-align:left;padding:6px 4px;width:130px">Date:</th><td style="padding:6px 4px">${ddmmyyyy(comp.date)}</td></tr>
            <tr><th style="text-align:left;padding:6px 4px">Customer:</th><td style="padding:6px 4px">${comp.customer}</td></tr>
            <tr><th style="text-align:left;padding:6px 4px">Vehicle:</th><td style="padding:6px 4px">${(comp.vehicle||'')}${v.make||v.model ? ' ‚Äî ' + (v.make||'') + ' ' + (v.model||'') : ''}</td></tr>
            <tr><th style="text-align:left;padding:6px 4px">Type:</th><td style="padding:6px 4px">${comp.type || ''}</td></tr>
            <tr><th style="text-align:left;padding:6px 4px">Severity:</th><td style="padding:6px 4px">${comp.severity || ''}</td></tr>
            <tr><th style="text-align:left;padding:6px 4px">Status:</th><td style="padding:6px 4px">${comp.status || ''}</td></tr>
            <tr><th style="text-align:left;padding:6px 4px">Assigned:</th><td style="padding:6px 4px">${comp.assigned || 'Not assigned'}</td></tr>
            <tr><th style="text-align:left;padding:6px 4px">Follow-up:</th><td style="padding:6px 4px">${ddmmyyyy(comp.followup) || 'Not set'}</td></tr>
            <tr><th style="text-align:left;padding:6px 4px">Cost:</th><td style="padding:6px 4px">${comp.cost ? fmtMoney(comp.cost) : 'None'}</td></tr>

            <tr><th style="text-align:left;padding:6px 4px">Mileage now:</th><td style="padding:6px 4px">${comp.mileageNow || ''}</td></tr>
            <tr><th style="text-align:left;padding:6px 4px">Booked with mechanic:</th><td style="padding:6px 4px">${ddmmyyyy(comp.mechanicBooked) || ''}</td></tr>
            <tr><th style="text-align:left;padding:6px 4px">Mechanic / Garage:</th><td style="padding:6px 4px">${comp.mechanicName || ''}</td></tr>
            <tr><th style="text-align:left;padding:6px 4px">Delivered to mechanic:</th><td style="padding:6px 4px">${ddmmyyyy(comp.deliveredDate) || ''}</td></tr>
            <tr><th style="text-align:left;padding:6px 4px">Work carried out:</th><td style="padding:6px 4px">${(comp.workDone || '').replace(/\n/g,'<br>')}</td></tr>
            <tr><th style="text-align:left;padding:6px 4px">Customer collected:</th><td style="padding:6px 4px">${ddmmyyyy(comp.collectedDate) || ''}</td></tr>
            <tr><th style="text-align:left;padding:6px 4px">Mileage at collection:</th><td style="padding:6px 4px">${comp.collectedMileage || ''}</td></tr>
            <tr><th style="text-align:left;padding:6px 4px">Handled by:</th><td style="padding:6px 4px">${comp.handler || comp.assigned || ''}</td></tr>

            <tr><th style="text-align:left;padding:6px 4px;vertical-align:top">Details:</th><td style="padding:6px 4px">${(comp.details || '').replace(/\n/g, '<br>')}</td></tr>
            <tr><th style="text-align:left;padding:6px 4px;vertical-align:top">Resolution:</th><td style="padding:6px 4px">${(comp.resolution || '').replace(/\n/g, '<br>') || 'None recorded'}</td></tr>
          </table>
        </div>`;
      alert(html);
    }

    else if(act === 'pack') {
      openComplaintEvidence(comp);
    }

    else if(act === 'edit') {
      if(!canAction('edit')) return alert('No permission');
      editId = comp.id;

      wrap.querySelector('#comp_date').value = comp.date || '';
      wrap.querySelector('#comp_customer').value = comp.customer || '';
      wrap.querySelector('#comp_vehicle').value = comp.vehicle || '';
      wrap.querySelector('#comp_type').value = comp.type || '';
      wrap.querySelector('#comp_severity').value = comp.severity || 'medium';
      wrap.querySelector('#comp_details').value = comp.details || '';
      wrap.querySelector('#comp_resolution').value = comp.resolution || '';
      wrap.querySelector('#comp_status').value = comp.status || 'new';
      wrap.querySelector('#comp_assigned').value = comp.assigned || '';
      wrap.querySelector('#comp_followup').value = comp.followup || '';
      wrap.querySelector('#comp_cost').value = comp.cost || '';

      wrap.querySelector('#comp_mileageNow').value = comp.mileageNow || '';
      wrap.querySelector('#comp_mechBook').value = (comp.mechanicBooked || '').substring(0,10);
      wrap.querySelector('#comp_mechName').value = comp.mechanicName || '';
      wrap.querySelector('#comp_delivered').value = (comp.deliveredDate || '').substring(0,10);
      wrap.querySelector('#comp_work').value = comp.workDone || '';
      wrap.querySelector('#comp_collected').value = (comp.collectedDate || '').substring(0,10);
      wrap.querySelector('#comp_collectedMileage').value = comp.collectedMileage || '';
      wrap.querySelector('#comp_handler').value = comp.handler || '';

      buildSaleHint(comp.vehicle, comp);
      document.getElementById('app').scrollIntoView({ behavior: 'smooth' });
    }
    else if(act === 'del') {
      if(!canAction('del')) return alert('No permission');
      if(!confirm('Delete this complaint?')) return;

      // track complaint deletion
      markDeleted('complaints', id);
      db.complaints = (db.complaints||[]).filter(x => x.id !== id);

      saveDB();
      try{renderAlertBell();}catch(e){}
      addAudit('delete', 'complaint', id, comp.customer || '');
      renderComplaints();
    }
  });

  return wrap;
}

/* ========= Users ========= */
function viewUsers(){ if(!canTab('Users')) return document.createElement('div'); const wrap=document.createElement('div'); wrap.className='card'; const tabs=DEFAULT_TABS;
  function renderTable(){ wrap.innerHTML=`<h2>Users</h2>
<div class="row"><button id="u_reset_admin" class="danger">Reset admin password</button></div>
<div class="row"><input id="u_name" placeholder="username"><input id="u_pass" placeholder="password"><select id="u_role"><option value="user">user</option><option value="admin">admin</option></select><button id="u_add" class="primary">Add user</button></div>
  <table class="table" style="margin-top:10px"><thead><tr><th>User</th><th>Role</th><th>Permissions</th><th>Actions</th></tr></thead><tbody id="u_body"></tbody></table>`;
    
  /* users dedupe */
  (function(){
    const seen=new Set(); const out=[];
    (db.users||[]).forEach(u=>{ const key=(u.username||u.name||'')+'|'+(u.role||''); if(!seen.has(key)){ seen.add(key); out.push(u); }});
    if(out.length !== (db.users||[]).length){ db.users=out; saveDB(); }
  })();
    const body=wrap.querySelector('#u_body'); (db.users||[]).forEach(u=>{ const p=normalizePerms(u.perms);
      const tabChecks=tabs.map(t=>`<label class="small" style="display:inline-block;min-width:110px"><input data-user="${u.id}" data-k="tab" data-tab="${t}" type="checkbox" ${p.tabs[t]?'checked':''}> ${t}</label>`).join(' ');
      const actionChecks=['view','add','edit','del'].map(a=>`<label class="small"><input data-user="${u.id}" data-k="act" data-act="${a}" type="checkbox" ${p.actions[a]?'checked':''}> ${a}</label>`).join(' ');
      const extraChecks=`<label class="small"><input data-user="${u.id}" data-k="profit" type="checkbox" ${p.profit?'checked':''}> can see profit</label> <label class="small"><input data-user="${u.id}" data-k="settings" type="checkbox" ${p.settings?'checked':''}> can edit settings</label>`;
      const tr=document.createElement('tr'); tr.innerHTML=`<td>${u.username}</td><td>${u.role}</td><td>${tabChecks}<div style="margin-top:6px">${actionChecks} &nbsp; ${extraChecks}</div></td>
      <td><button data-act="chpass" data-id="${u.id}">Change Password</button> <button data-act="reset" data-id="${u.id}">Reset pass to '1234'</button> <button class="danger" data-act="del" data-id="${u.id}">Delete</button></td>`; body.appendChild(tr); });
    wrap.addEventListener('change',(ev)=>{ const el=ev.target; if(!el.dataset||!el.dataset.user) return; const u=(db.users||[]).find(x=>x.id===el.dataset.user); if(!u) return; u.perms=normalizePerms(u.perms);
      if(el.dataset.k==='tab'){ u.perms.tabs[el.dataset.tab]=el.checked; } if(el.dataset.k==='act'){ u.perms.actions[el.dataset.act]=el.checked; } if(el.dataset.k==='profit'){ u.perms.profit=el.checked; } if(el.dataset.k==='settings'){ u.perms.settings=el.checked; } saveDB(); try{renderAlertBell();}catch(e){}; if(u.username===session.username) render(); });
    wrap.addEventListener('click',(ev)=>{ const b=ev.target.closest('button'); if(!b) return; const u=(db.users||[]).find(x=>x.id===b.dataset.id);
      if(b.dataset.act==='chpass'){ const p1=prompt("New password for '"+u.username+"':"); if(p1===null) return; if(!p1.trim()) return alert('Password cannot be empty'); const p2=prompt('Confirm new password:'); if(p2===null) return; if(p1!==p2) return alert('Passwords do not match'); u.password=p1; saveDB(); try{renderAlertBell();}catch(e){}; addAudit('update','userPass',u.id,'Admin changed for '+u.username); alert('Password updated for '+u.username); return; }
      if(b.dataset.act==='reset'){ u.password='1234'; saveDB(); try{renderAlertBell();}catch(e){}; addAudit('update','user',u.id,u.username+' reset'); alert("Password reset to '1234'"); return; }
      
      if(b.dataset.act==='del'){ 
        if(u.username==='admin') return alert('Cannot delete admin'); 

        // track user deletion
        markDeleted('users', u.id);

        db.users = db.users.filter(x=>x.id!==u.id); 
        saveDB(); 
        try{renderAlertBell();}catch(e){}; 
        addAudit('delete','user',u.id,u.username); 
        renderTable(); 
        return; 
      }
    });
    wrap.querySelector('#u_add').onclick=()=>{ const name=wrap.querySelector('#u_name').value.trim(); if(!name) return alert('Username required'); const u={id:uid(),username:name,password:(wrap.querySelector('#u_pass').value||'1234'),role:wrap.querySelector('#u_role').value,perms:defaultPerms()}; (db.users=db.users||[]).push(u); saveDB(); try{renderAlertBell();}catch(e){}; addAudit('add','user',u.id,u.username); renderTable(); };
  }
  renderTable(); return wrap;
}

/* ========= Settings ========= */
function viewSettings(){ 
  // Check if user has permission to access settings at all
  if(!canTab('Settings') || !canSettings()){ 
    const w=document.createElement('div'); 
    w.className='card'; 
    w.innerHTML='<div class="small">No permission to edit settings. Ask admin.</div>'; 
    return w; 
  } 
  
  const wrap=document.createElement('div'); 
  wrap.className='card'; 
  const tokenCurrent=getGhToken();
  const currentUserObj = currentUser();
  const isAdmin = currentUserObj && currentUserObj.role === 'admin';
  
  // Format last push timestamp for display
  let lastPushInfo = '';
  if (db.lastPush && db.lastPush.timestamp) {
    const pushDate = new Date(db.lastPush.timestamp);
    const formattedDate = pushDate.toLocaleDateString('en-GB', {
        day: '2-digit',
        month: '2-digit',
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit'
    });
    lastPushInfo = `<div class="small" style="margin-top: 8px; padding: 8px; background: rgba(19, 26, 43, 0.7); border-radius: 8px;">
        <strong>Last Push to Gist:</strong><br>
        üìÖ ${formattedDate}<br>
        üë§ By: ${db.lastPush.user || 'unknown'}<br>
        üîó Gist ID: ${db.lastPush.gistId || 'not specified'}
    </div>`;
  } else {
    lastPushInfo = `<div class="small" style="margin-top: 8px; padding: 8px; background: rgba(19, 26, 43, 0.7); border-radius: 8px;">
        <em>No push history recorded yet.</em>
    </div>`;
  }

  wrap.innerHTML=`<h2>Settings</h2><div class="grid2">
  <div class="card" ${!isAdmin ? 'style="display:none"' : ''}><h3>Company</h3>
    <div class="row"><input id="c_name" placeholder="Company name" value="${db.company.name||''}"></div>
    <div class="row"><input id="c_addr" placeholder="Address" value="${db.company.address||''}" style="min-width:420px"></div>
    <div class="row"><input id="c_phone" placeholder="Phone" value="${db.company.phone||''}"><input id="c_email" placeholder="Email" value="${db.company.email||''}"></div>
    <div class="row"><input id="c_vat" placeholder="VAT Number" value="${db.company.vatNumber||''}"><input id="c_co" placeholder="Company Number" value="${db.company.companyNumber||''}"><input id="c_fca" placeholder="FCA Number" value="${db.company.fcaNumber||''}"></div>
    <div class="row"><input id="c_logo" placeholder="Logo URL (optional)" value="${db.company.logo||''}"></div>
    <div class="row"><label>Upload Logo<input id="c_logoUpload" type="file" accept="image/*"></label><span class="small">Stored locally as data-URL</span></div>
    <div class="row"><label class="small">Opening Bank ¬£ <input id="c_bank" type="number" value="${db.company.openingBank||0}"></label><label class="small">Opening Cash ¬£ <input id="c_cash" type="number" value="${db.company.openingCash||0}"></label></div>
    <div class="row"><textarea id="c_terms" placeholder="Terms & Conditions">${db.company.terms||''}</textarea></div>
    <div class="row"><textarea id="c_finTerms" placeholder="Finance-specific Terms (optional) ‚Äî used on the Finance Proforma only if filled.">${db.company.financeTerms||''}</textarea></div>
    <div class="row">
      <label class="small">Invoice Font Size px <input id="c_invFont" type="number" min="9" max="18" value="${db.company.invoiceFontPx||12}"></label>
      <label class="small">Terms Font Size px <input id="c_termsFont" type="number" min="8" max="14" value="${db.company.termsFontPx||10}"></label>
      <label class="small">Logo Max-W px <input id="c_logoW" type="number" min="80" max="300" value="${db.company.logoMaxW||140}"></label>
      <label class="small">Logo Max-H px <input id="c_logoH" type="number" min="50" max="200" value="${db.company.logoMaxH||80}"></label>
    </div>
    <button id="c_save" class="primary">Save</button>
  </div>
  <div class="card"><h3>Integrations</h3>
    <div class="row"><input id="c_dvlaProxy" placeholder="DVLA Proxy URL" value="${db.company.dvlaProxy||''}" style="min-width:420px"></div>
    <div class="row"><input id="c_dvlaKey" placeholder="DVLA API Key (optional)" value="${db.company.dvlaKey||''}"></div>
    <div class="row"><input id="c_dvsaProxy" placeholder="DVSA Proxy URL" value="${db.company.dvsaProxy||''}" style="min-width:420px"></div>
    <div class="row"><input id="c_dvsaKey" placeholder="DVSA API Key (optional)" value="${db.company.dvsaKey||''}"></div>
    <div class="row"><input id="c_testReg" placeholder="Test REG (e.g. KR21UYL)" style="min-width:220px"><button id="c_dvlaTest">DVLA Test</button></div><hr style="width:100%;border:0;border-top:1px solid var(--line)">
    <div class="row"><input id="c_gistId" placeholder="GitHub Gist ID (where starcars.json lives)" value="${db.company.gistId||''}" style="min-width:420px"></div>
    <div class="row"><input id="c_ghToken" placeholder="GitHub Token (gist scope)" value="${tokenCurrent||''}" type="password" style="min-width:420px"></div>
    <div class="row"><button id="c_isave" class="primary">Save Integrations</button><button id="c_pull">Pull (Gist ‚Üí App)</button><button id="syncPullHard">Pull (REPLACE ALL from Gist)</button><button id="c_push" ${pushEnabled ? '' : 'disabled'}>Push (App ‚Üí Gist)</button></div>
    ${lastPushInfo}
    <div class="small">Token is stored only in your browser (LocalStorage), not inside backups.</div>
  </div></div>`;

  // After wrap.innerHTML is set, add Auto Sync controls into the Integrations card
  const cards = wrap.querySelectorAll('.card');
  const integrationsCard = cards[1]; // 0 = Company, 1 = Integrations (in your layout)

  if (integrationsCard) {
    const row = document.createElement('div');
    row.className = 'row';
    row.innerHTML = `
      <label class="small">
        <input id="c_autoSync" type="checkbox" ${db.company.autoSyncEnabled ? 'checked' : ''}>
        Auto Sync (auto pull from Gist)
        &nbsp;every&nbsp;
        <input id="c_autoSyncSec" type="number" min="30" max="600"
               value="${db.company.autoSyncSeconds || 120}"
               style="width:80px">
        seconds
      </label>
    `;
    integrationsCard.appendChild(row);
  }
  
  // Only show save button for company settings if user is admin
  if (isAdmin) {
    wrap.querySelector('#c_save').onclick=()=>{
        db.company.name=document.getElementById('c_name').value;
        db.company.address=document.getElementById('c_addr').value;
        db.company.phone=document.getElementById('c_phone').value;
        db.company.email=document.getElementById('c_email').value;
        db.company.vatNumber=document.getElementById('c_vat').value;
        db.company.companyNumber=document.getElementById('c_co').value;
        db.company.fcaNumber = document.getElementById('c_fca').value;
        db.company.logo=document.getElementById('c_logo').value;
        db.company.openingBank=Number(document.getElementById('c_bank').value||0);
        db.company.openingCash=Number(document.getElementById('c_cash').value||0);
        db.company.terms=document.getElementById('c_terms').value;
        db.company.financeTerms=document.getElementById('c_finTerms').value;
        db.company.invoiceFontPx=Number(document.getElementById('c_invFont').value||12);
        db.company.termsFontPx=Number(document.getElementById('c_termsFont').value||10);
        db.company.logoMaxW=Number(document.getElementById('c_logoW').value||140);
        db.company.logoMaxH=Number(document.getElementById('c_logoH').value||80);
        db.company.dvlaProxy=document.getElementById('c_dvlaProxy').value||'';
        db.company.dvsaProxy=document.getElementById('c_dvsaProxy').value||'';
        db.company.dvlaKey=document.getElementById('c_dvlaKey').value||'';
        db.company.dvsaKey=document.getElementById('c_dvsaKey').value||'';
        
        saveDB();
        try{renderAlertBell();}catch(e){}
        addAudit('update','company','company','Updated company profile');
        refreshLogoBox();
        alert('Saved');
    };
    } else {
    // Hide company save button for non-admin users with settings permission
    const saveBtn = wrap.querySelector('#c_save');
    if (saveBtn) saveBtn.style.display = 'none';
  }
  
  // Integration settings are available for all users with settings permission
  wrap.querySelector('#c_isave').onclick=()=>{ 
    db.company.dvlaProxy = document.getElementById('c_dvlaProxy').value; 
    db.company.dvlaKey   = document.getElementById('c_dvlaKey').value;
    db.company.dvsaProxy = document.getElementById('c_dvsaProxy').value; 
    db.company.dvsaKey   = document.getElementById('c_dvsaKey').value; 
    db.company.gistId    = document.getElementById('c_gistId').value.trim(); 
    setGhToken(document.getElementById('c_ghToken').value.trim()); 

    // Read auto-sync controls if present
    const chk = document.getElementById('c_autoSync');
    const sec = document.getElementById('c_autoSyncSec');
    if (chk && sec) {
    db.company.autoSyncEnabled = chk.checked;
    db.company.autoSyncSeconds = Number(sec.value || 120);
  }

  saveDB(); 
  try { renderAlertBell(); } catch(e) {} 
  addAudit('update','integrations','integrations','Updated DVLA, Gist & Auto Sync'); 

  // Restart auto sync with new settings
  if (typeof startAutoSyncFromSettings === 'function') {
    startAutoSyncFromSettings();
  }

  alert('Saved integrations'); 
  };

  
  wrap.querySelector('#c_pull').onclick=()=>syncPull();
  wrap.querySelector('#c_push').onclick=()=>smartPush();

  const hardBtn = wrap.querySelector('#syncPullHard');
if (hardBtn) {
  hardBtn.onclick = () => {
    if (confirm('This will REPLACE ALL local data with the Gist version. Unsynced changes on this PC will be LOST. Are you sure?')) {
      syncPullHard();
    }
  };
}
  
  // Fixed DVLA Test function - available for all users with settings permission
  wrap.querySelector('#c_dvlaTest').onclick = async () => { 
    const url = (document.getElementById('c_dvlaProxy').value || '').trim(); 
    const key = (document.getElementById('c_dvlaKey').value || '').trim(); 
    const reg = (document.getElementById('c_testReg').value || '').trim().toUpperCase(); 
    
    if (!url) return alert('Enter Proxy URL');
    if (!reg) return alert('Enter a test REG');
    
    const btn = wrap.querySelector('#c_dvlaTest');
    const originalText = btn.textContent;
    btn.textContent = 'Testing...';
    btn.disabled = true;
    
    try { 
      const response = await fetch(url, {
        method: 'POST',
        headers: {'content-type': 'application/json'},
        body: JSON.stringify({reg: reg, apiKey: key})
      }); 
      
      const result = await response.text();
      
      if (!response.ok) {
        alert('DVLA Test Failed: ' + response.status + ' - ' + result);
      } else {
        try {
          const data = JSON.parse(result);
          alert('DVLA Test Successful!\n\nResponse: ' + JSON.stringify(data, null, 2).substring(0, 500));
        } catch (e) {
          alert('DVLA Test Successful!\n\nResponse: ' + result.substring(0, 500));
        }
      }
    } catch (e) { 
      alert('DVLA Test Failed: ' + e.message); 
    } finally {
      btn.textContent = originalText;
      btn.disabled = false;
    }
  };
  
  // Logo upload to data-URL - only for admin users
  if (isAdmin) {
    wrap.querySelector('#c_logoUpload').addEventListener('change', (e)=>{
      const f=e.target.files&&e.target.files[0]; if(!f) return;
      const r=new FileReader(); r.onload=()=>{ db.company.logo=r.result; document.getElementById('c_logo').value=r.result; saveDB(); try{renderAlertBell();}catch(e){}; addAudit('update','company','logo','Uploaded logo'); refreshLogoBox(); alert('Logo updated.'); };
      r.readAsDataURL(f);
    });
  } else {
    // Hide logo upload for non-admin users
    const logoUpload = wrap.querySelector('#c_logoUpload');
    if (logoUpload) {
      logoUpload.parentNode.parentNode.style.display = 'none';
    }
  }
  
  return wrap;
}

/* ================================
   GLOBAL BLOCK SAVE WITHOUT DATE
   ================================ */

(function blockSaveWithoutDate(){

  document.addEventListener('click', function(e){

    // SALE
    if(e.target && e.target.id === 'sale_add'){
      const d = document.getElementById('sale_date');
      if(d && !d.value){
        alert('Please select Sale Date');
        e.stopImmediatePropagation();
        e.preventDefault();
        return false;
      }
    }

    // PURCHASE
    if(e.target && e.target.id === 'pi_add'){
      const d = document.getElementById('pi_date');
      if(d && !d.value){
        alert('Please select Purchase Date');
        e.stopImmediatePropagation();
        e.preventDefault();
        return false;
      }
    }

    // CREDIT / REFUND
    if(e.target && e.target.id === 'cr_add'){
      const d = document.getElementById('cr_date');
      if(d && !d.value){
        alert('Please select Credit / Refund Date');
        e.stopImmediatePropagation();
        e.preventDefault();
        return false;
      }
    }

  }, true);

})();

/* ===============================
   AUTO DATE + MANDATORY DATE
   =============================== */

function applyAutoTodayAndMandatoryDate(){
  const today = new Date().toISOString().slice(0,10);

  // Helper to wire multiple date fields
  function wireDate(inputId, buttonId, message){
    const d = document.getElementById(inputId);
    if (d && !d.value) d.value = today;

    const btn = document.getElementById(buttonId);
    if (btn && !btn.dataset.checked){
      btn.dataset.checked = "1";
      btn.addEventListener('click', e=>{
        const d2 = document.getElementById(inputId);
        if (d2 && !d2.value){
          alert(message);
          e.stopImmediatePropagation();
          e.preventDefault();
          return false;
        }
      }, true);
    }
  }

  // Sale
  wireDate('sale_date', 'sale_add', 'Please select Sale Date');

  // Purchase
  wireDate('pi_date', 'pi_add', 'Please select Purchase Date');

  // Credit / Refund
  wireDate('cr_date', 'cr_add', 'Please select Credit / Refund Date');

  // üîπ Expenses
  wireDate('e_date', 'e_add', 'Please select Expense Date');

  // üîπ Showroom
  wireDate('s_date', 's_add', 'Please select Showroom Date');

  // üîπ Customer Complaint
  wireDate('comp_date', 'comp_add', 'Please select Complaint Date');
}

// Run repeatedly because forms are dynamic
setInterval(applyAutoTodayAndMandatoryDate, 500);

startAutoSyncFromSettings();
render();
</script>
</body>
</html>