<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Star Cars ‚Äî v48 Upgraded</title>
<style>
:root{
  --bg1:#0b1020;--bg2:#0e1a36;--card:#131a2b;--ink:#e9eef7;--mut:#a3b2cc;
  --pri:#53a8ff;--ok:#2ecc71;--bad:#ff6b6b;--line:#26324a
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;font:14px/1.45 system-ui,Segoe UI,Roboto,Arial;color:var(--ink);
  background:radial-gradient(1200px 800px at 10% -10%,#1a2e5f 0%,rgba(26,46,95,0) 60%),
             radial-gradient(900px 700px at 120% 0%,#0a5ea1 0%,rgba(10,94,161,0) 60%),
             linear-gradient(160deg,var(--bg1),var(--bg2))
}
a{color:var(--pri)}
header{
  display:flex;gap:12px;align-items:center;justify-content:space-between;
  padding:12px 14px;border-bottom:1px solid var(--line);
  background:rgba(10,16,30,.7);backdrop-filter:blur(6px);position:sticky;top:0;z-index:5
}
#logoBox{width:40px;height:40px;border-radius:12px;background:linear-gradient(135deg,#53a8ff,#7a5cff);display:grid;place-items:center;font-weight:900;overflow:hidden}
#logoBox img{width:100%;height:100%;object-fit:contain}
.hdr-actions button{margin-left:6px}
nav{
  display:flex;flex-wrap:wrap;gap:6px;padding:10px 14px;border-bottom:1px solid var(--line);
  background:rgba(10,16,30,.55);backdrop-filter:blur(6px);position:sticky;top:64px;z-index:4
}
nav button{background:#17233a;border:1px solid var(--line);color:var(--ink);padding:8px 10px;border-radius:10px;cursor:pointer}
nav button.active{background:var(--pri);border-color:transparent;color:#001029;font-weight:700}
main{padding:16px;max-width:1200px;margin:auto}
.card{background:rgba(19,26,43,.92);border:1px solid var(--line);border-radius:14px;padding:14px;margin-bottom:14px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
.row{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
.grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.grid3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
.grid4{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
input,select,textarea{background:#0f1628;border:1px solid var(--line);color:var(--ink);padding:8px;border-radius:10px;min-width:120px}
label{display:flex;flex-direction:column;gap:6px;font-size:12px;color:var(--mut)}
textarea{min-height:88px;width:100%}
small,.small{color:var(--mut);font-size:12px}
button{background:#182845;border:1px solid var(--line);color:var(--ink);padding:8px 10px;border-radius:10px;cursor:pointer}
button.primary{background:var(--pri);border-color:#2b7be0;color:#031226}
button.danger{background:#321722;border-color:#5a2a3d;color:#ffc9c9}
.table{width:100%;border-collapse:collapse}
.table th,.table td{border:1px solid var(--line);padding:6px 8px}
.table th{background:#0c1526;text-align:left}
.right{text-align:right}
.badge{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid var(--line);background:#0f1a2d}
footer{padding:30px 0;color:#8ea3c6;text-align:center}
#loginOverlay{position:fixed;inset:0;display:none;place-items:center;background:rgba(3,6,12,.7);z-index:10}
.loginCard{width:360px;max-width:90vw}
kbd{background:#0b1230;border:1px solid #22325e;border-radius:6px;padding:1px 6px}
.stat{font-size:28px;font-weight:800}
.previewStrip{display:flex;gap:6px;flex-wrap:wrap;margin-top:6px}
.previewStrip img{width:56px;height:56px;object-fit:cover;border-radius:8px;border:1px solid var(--line)}

button:disabled {
  opacity: 0.5;
  cursor: not-allowed;
  background: #0a1420 !important;
  border-color: #1a2438 !important;
  color: #6b7a99 !important;
}

button.primary:disabled {
  background: #1a4a7a !important;
  border-color: #1a4a7a !important;
  color: #6b7a99 !important;
}

</style>

</head><script>
(function(){
  if (window.__starcars_bootstrap__) return;
  window.__starcars_bootstrap__ = true;

  // Safe CSV helper (fixed regex + quotes escaping)
  function toCSV(rows, headers){
    const esc = v => {
      const s = (v == null) ? '' : String(v);
      return /[",\n]/.test(s) ? `"${s.replace(/"/g,'""')}"` : s;
    };
    const head = headers || ((rows && rows[0]) ? Object.keys(rows[0]) : []);
    const lines = [head.join(",")];
    for (const r of (rows || [])) lines.push(head.map(h => esc(r && r[h])).join(","));
    return lines.join("\n");
  }

  // Full JSON backup (includes audit + user passwords)
  window.backupJSON = function(){
    try{
      const data = JSON.stringify(window.db || {}, null, 2);
      const a = document.createElement("a");
      a.href = URL.createObjectURL(new Blob([data], {type:"application/json"}));
      a.download = "starcars_backup_" + new Date().toISOString().slice(0,19).replace(/[:T]/g,"-") + ".json";
      a.click();
      if (typeof window.addAudit === "function") window.addAudit("export","backup","","Full JSON backup");
    }catch(e){ alert("Backup failed: " + (e.message||e)); }
  };

// Merge-from-backup with id-based merge for ALL arrays
window.restoreJSONMerge = function () {
  const i = document.createElement('input');
  i.type = 'file';
  i.accept = '.json,application/json';

  i.onchange = () => {
    const f = i.files && i.files[0];
    if (!f) return;

    const fr = new FileReader();
    fr.onload = () => {
      try {
        const incoming = JSON.parse(fr.result || '{}');
        const db = (window.db = window.db || {});

        for (const k of Object.keys(incoming)) {
          const val = incoming[k];

          if (k === 'audit') {
            // Replace audit log
            db.audit = Array.isArray(val) ? val.slice() : (db.audit || []);
            continue;
          }

          if (Array.isArray(val)) {
            // üîÅ Same id-merge logic as Gist pull ‚Äì works for:
            // vehicles, vehicleExpenses, showroomExpenses, sales, credits,
            // partners (directors), investors, users, todo, etc.
            const localArr = Array.isArray(db[k]) ? db[k] : [];
            const byId = Object.create(null);
            const noId = [];

            for (const item of localArr) {
              if (item && item.id) {
                byId[item.id] = item;
              } else {
                noId.push(item);
              }
            }

            for (const item of val) {
              if (item && item.id) {
                byId[item.id] = item; // backup wins
              } else {
                noId.push(item);
              }
            }

            db[k] = [...noId, ...Object.values(byId)];

            // Fix users & directors special rules
            if (k === 'users' && typeof window.normalizePerms === 'function') {
              db.users = (db.users || []).map(u => {
                u.perms = window.normalizePerms(u.perms);
                return u;
              });
            }

            if (k === 'partners') {
              db.partners = (db.partners || []).filter((p, i, arr) =>
                arr.findIndex(pp =>
                  String(pp.name || '').trim().toLowerCase() ===
                  String(p.name || '').trim().toLowerCase()
                ) === i
              );
            }

            continue;
          }

          if (val && typeof val === 'object') {
            db[k] = Object.assign({}, db[k] || {}, val);
          } else {
            db[k] = val;
          }
        }

        if (typeof window.saveDB === 'function') window.saveDB();
        try {
          if (typeof window.renderAlertBell === 'function') window.renderAlertBell();
        } catch (_) {}
        if (typeof window.addAudit === 'function') {
          window.addAudit('import', 'backup', '', 'Merged JSON backup (id-merge)');
        }
        alert('Merged from backup');
        markPullUsed();
        applyPullLockUI && applyPullLockUI();
        if (typeof window.render === 'function') window.render();
      } catch (e) {
        alert('Bad JSON: ' + (e.message || e));
      }
    };
    fr.readAsText(f);
  };

  i.click();
};

  // Replace-from-backup
  window.restoreJSONReplace = function(){
    const i = document.createElement("input"); i.type = "file"; i.accept = ".json,application/json";
    i.onchange = () => {
      const f = i.files && i.files[0]; if(!f) return;
      const fr = new FileReader();
      fr.onload = () => {
        try{
          const incoming = JSON.parse(fr.result || "{}");
          window.db = (incoming && typeof incoming === "object") ? incoming : {};
          window.db.audit = window.db.audit || [];
          if (Array.isArray(window.db.users) && typeof window.normalizePerms === "function"){
            window.db.users = window.db.users.map(u => { u.perms = window.normalizePerms(u.perms); return u; });
          }
          window.saveDB && window.saveDB();
          try{ window.renderAlertBell && window.renderAlertBell(); }catch(_){}
          if (typeof window.addAudit === "function") window.addAudit("import","backup","","Replaced from JSON backup");
          alert("Replaced from backup");
          markPullUsed();
          applyPullLockUI && applyPullLockUI();
          window.render && window.render();
        }catch(e){ alert("Bad JSON: " + (e.message||e)); }
      };
      fr.readAsText(f);
    };
    i.click();
  };

  // Export everything as a single CSV (sectioned)
  window.exportAllCSV = function(){
    const db = window.db || {};
    const parts = [];
    parts.push("=== Vehicles ===");         parts.push(toCSV(db.vehicles||[]));
    parts.push(""); parts.push("=== Sales ==="); parts.push(toCSV(db.sales||[]));
    parts.push(""); parts.push("=== ShowroomExpenses ==="); parts.push(toCSV(db.showroomExpenses||[]));
    parts.push(""); parts.push("=== Investors ==="); parts.push(toCSV(db.investors||[]));
    parts.push(""); parts.push("=== Audit ==="); parts.push(toCSV(db.audit||[]));
    const a = document.createElement("a");
    a.href = URL.createObjectURL(new Blob([parts.join("\n")], {type:"text/csv"}));
    a.download = "starcars_export_all_" + new Date().toISOString().slice(0,19).replace(/[:T]/g,"-") + ".csv";
    a.click();
    if (typeof window.addAudit === "function") window.addAudit("export","csv","","Export all CSV (sections)");
  };
})();
</script>

<body>
<header>
  <div style="display:flex;gap:10px;align-items:center">
    <div id="logoBox">SC</div>
    <div>
      <div style="font-weight:900">Star Cars London Ltd</div>
      <div class="small">Dealer Backoffice </div>
    </div>
  </div>
  <div class="hdr-actions">
    <span id="who" class="small"></span>
    <button onclick="switchUser()">Switch User</button>
    <button onclick="changeMyPass()">Change Password</button>
    <button onclick="logout()">Logout</button>
    <button onclick="backupJSON()">Backup</button>
    <button onclick="restoreJSONMerge()">Restore (merge)</button>
    <button onclick="restoreJSONReplace()">Restore (replace)</button>
    <button onclick="exportAllCSV()">Export CSVs</button>
  </div>
</header>
<nav id="nav"></nav>
<main id="app"></main>
<footer>¬© Star Cars London Ltd</footer>

<div id="loginOverlay">
  <div class="card loginCard">
    <h2>Login</h2>
    <div class="row">
      <input id="li_user" placeholder="username">
      <input id="li_pass" placeholder="password" type="password">
      <button class="primary" onclick="doLogin()">Login</button>
    </div>
  </div>
</div>

<script>
/* ========= Core utils ========= */
const DBKEY='starcars_db_v48u'; const GHTOKENKEY='starcars_github_token';
function loadDB(){ try{ return JSON.parse(localStorage.getItem(DBKEY)||'{}'); }catch(e){ return {}; } }
function saveDB(){
  try {
    // Normal save
    localStorage.setItem(DBKEY, JSON.stringify(db));
  } catch (e) {
    console.error('saveDB quota error:', e);

    // If localStorage is full, try to free the old snapshot key first
    try {
      localStorage.removeItem('starcars_last_snapshot');
    } catch (_) {}

    try {
      // Make a slim copy of DB for storage
      const slim = JSON.parse(JSON.stringify(db || {}));

      // Trim very large audit log to keep newest 1000 entries
      if (Array.isArray(slim.audit) && slim.audit.length > 1000) {
        slim.audit = slim.audit.slice(0, 1000);
      }

      // (Optional) you can also trim deleted map if it gets huge
      if (slim.deleted && typeof slim.deleted === 'object') {
        Object.keys(slim.deleted).forEach(section => {
          const entries = Object.entries(slim.deleted[section] || {});
          if (entries.length > 1000) {
            // keep latest 1000 deletions
            entries.sort((a,b)=>String(b[1]).localeCompare(String(a[1])));
            const trimmed = entries.slice(0,1000);
            const newMap = {};
            trimmed.forEach(([id, ts]) => newMap[id] = ts);
            slim.deleted[section] = newMap;
          }
        });
      }

      localStorage.setItem(DBKEY, JSON.stringify(slim));
      alert('Local storage was nearly full.\nOld history was trimmed but your main data was saved.');
    } catch (e2) {
      alert('Save failed due to browser storage limit:\n' + (e2.message || e2));
    }
  }
}
function uid(){ return Math.random().toString(36).slice(2)+Date.now().toString(36); }
function fmtMoney(n){ n=Number(n||0); const s=n<0?'-':''; n=Math.abs(n); return s+'¬£'+n.toFixed(2); }
function ddmmyyyy(d){
  if(!d) return '';
  const t=(d||'').split('T')[0]||d;
  const a=t.split('-'); // yyyy-mm-dd
  return a.length===3 ? (a[2]+'-'+a[1]+'-'+a[0]) : d; // dd-mm-yyyy
}
function ymStr(d){ return (d||'').slice(0,7); } // yyyy-mm

function lastDayOfMonth(ym) {
  // ym = "YYYY-MM"
  const [y, m] = ym.split('-').map(Number);
  // Day 0 of next month = last day of current month
  const d = new Date(y, m, 0);
  return d.toISOString().slice(0, 10); // YYYY-MM-DD
}

function mcId(ym, type, a, b, c) {
  // stable, deterministic IDs for MonthClose postings
  const safe = (x) => String(x || '').trim().toLowerCase().replace(/[^a-z0-9]+/g,'_').slice(0,60);
  return `mc_${safe(ym)}_${safe(type)}_${safe(a)}_${safe(b)}_${safe(c)}`;
}


function openPrintable(html){
  try{
    const blob=new Blob([html],{type:'text/html'});
    const url=URL.createObjectURL(blob);
    const w=window.open(url,'_blank','noopener');
    if(w){ setTimeout(()=>URL.revokeObjectURL(url),10000); return true; }
  }catch(e){}
  const iframe=document.createElement('iframe');
  iframe.style.position='fixed';iframe.style.right='0';iframe.style.bottom='0';iframe.style.width='0';iframe.style.height='0';iframe.style.border='0';
  document.body.appendChild(iframe);
  iframe.addEventListener('load',()=>{ try{ iframe.contentWindow.focus(); setTimeout(()=>iframe.contentWindow.print(),50);}catch(e){} });
  iframe.srcdoc=html; return false;
}

// Export Vehicles as CSV
function exportVehiclesCSV() {
    const vehicles = db.vehicles || [];
    
    // Apply the same filters as the current view
    const searchTerm = (document.getElementById('veh_search')?.value || '').toLowerCase().trim();
    const instockOnly = document.getElementById('veh_instock')?.checked;
    const soldOnly = document.getElementById('veh_soldonly')?.checked;
    const investorOnly = document.getElementById('veh_investoronly')?.checked;
    const pxOnly = document.getElementById('veh_pxonly')?.checked;
    
    let filteredVehicles = vehicles.filter(v => {
        // Apply stock status filters
        if (instockOnly && v.status === 'sold') return false;
        if (soldOnly && v.status !== 'sold') return false;
        
        // Apply investor stock filter
        if (investorOnly && v.ownerType !== 'investor') return false;
        
        // Apply part-ex filter
        if (pxOnly && v.supplier !== 'PART-EX') return false;
        
        // Apply search filter
        if (searchTerm) {
            const hay = ((v.reg || '') + ' ' + (v.make || '') + ' ' + (v.model || '')).toLowerCase();
            if (!hay.includes(searchTerm)) return false;
        }
        
        return true;
    });
    
    // Define headers
    const headers = [
        'REG', 'Make', 'Model', 'Colour', 'Fuel', 'Mileage', 
        'First Registration', 'Purchase Date', 'Purchase Price', 
        'Owner Type', 'Investor', 'Status', 'Supplier', 'Supplier Note',
        'VIN', 'Created At', 'Last MOT Date', 'Last MOT Expiry', 'Last MOT Mileage'
    ];
    
    // Create CSV rows
    const rows = filteredVehicles.map(v => [
        v.reg || '',
        v.make || '',
        v.model || '',
        v.colour || '',
        v.fuel || '',
        v.mileage || 0,
        ddmmyyyy(v.firstReg || ''),
        ddmmyyyy(v.purchaseDate || ''),
        Number(v.purchase || 0).toFixed(2),
        v.ownerType || 'owned',
        v.investor || '',
        v.status || '',
        v.supplier || '',
        v.supplierNote || '',
        v.vin || '',
        v.createdAt || '',
        v.lastMotDate || '',
        v.lastMotExpiry || '',
        v.lastMotMileage || ''
    ]);
    
    // Create CSV content
    const csvContent = [
        headers.join(','),
        ...rows.map(row => row.map(cell => 
            typeof cell === 'string' && (cell.includes(',') || cell.includes('"') || cell.includes('\n')) 
                ? `"${cell.replace(/"/g, '""')}"` 
                : cell
        ).join(','))
    ].join('\n');
    
    // Create and trigger download
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);
    link.setAttribute('href', url);
    link.setAttribute('download', `vehicles_export_${new Date().toISOString().slice(0, 10)}.csv`);
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    addAudit('export', 'vehicles', '', `Exported ${filteredVehicles.length} vehicles to CSV`);
}

// Export Sales as CSV
function exportSalesCSV() {
    // Get all sales or filtered sales based on your current view
    const sales = db.sales || [];
    
    // Define headers
    const headers = [
        'Date', 'Invoice #', 'Vehicle REG', 'Make', 'Model', 'Colour',
        'Customer Name', 'Customer Address', 'Phone', 'Email',
        'Sale Price', 'Deposit', 'Cash', 'Card', 'Bank Transfer', 'Finance',
        'PX Allowance', 'PX REG', 'PX Make', 'PX Model', 'Finance Company',
        'Agreement #', 'Deliver To', 'Keys', 'MOT Expiry', 'Service History',
        'Mileage at Sale', 'First Registration'
    ];
    
    // Create CSV rows
    const rows = sales.map(s => {
        const v = db.vehicles.find(x => x.id === s.vehicleId) || {};
        return [
            ddmmyyyy(s.date),
            s.invNo || '',
            v.reg || '',
            v.make || '',
            v.model || '',
            v.colour || '',
            s.buyer || '',
            s.address || '',
            s.phone || '',
            s.email || '',
            Number(s.salePrice || 0).toFixed(2),
            Number(s.deposit || 0).toFixed(2),
            Number(s.cash || 0).toFixed(2),
            Number(s.card || 0).toFixed(2),
            Number(s.bank || 0).toFixed(2),
            Number(s.finance || 0).toFixed(2),
            Number(s.pxAllowance || 0).toFixed(2),
            s.pxReg || '',
            s.pxMake || '',
            s.pxModel || '',
            s.financeCompany || '',
            s.agreement || '',
            s.deliverTo || '',
            s.keys || '',
            s.mot || '',
            s.serviceHistory || '',
            s.mileage || '',
            ddmmyyyy(s.firstReg || '')
        ];
    });
    
    // Create CSV content
    const csvContent = [
        headers.join(','),
        ...rows.map(row => row.map(cell => 
            typeof cell === 'string' && (cell.includes(',') || cell.includes('"') || cell.includes('\n')) 
                ? `"${cell.replace(/"/g, '""')}"` 
                : cell
        ).join(','))
    ].join('\n');
    
    // Create and trigger download
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);
    link.setAttribute('href', url);
    link.setAttribute('download', `sales_export_${new Date().toISOString().slice(0, 10)}.csv`);
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    // Log the export in audit trail
    if (typeof addAudit === 'function') {
        addAudit('export', 'sales', '', `Exported ${sales.length} sales to CSV`);
    }
}

// DVLA Response Validation Helper
function validateDVLAResponse(data) {
  if (!data || typeof data !== 'object') {
    return { isValid: false, error: 'Invalid response format' };
  }
  
  // Check if we have at least some vehicle data
  const hasData = data.make || data.colour || data.fuel || data.vin || 
                 (data.raw && (data.raw.make || data.raw.colour || data.raw.fuelType));
  
  return { 
    isValid: !!hasData, 
    fieldsFound: {
      make: !!data.make,
      model: !!data.model,
      colour: !!data.colour,
      fuel: !!data.fuel,
      vin: !!data.vin
    }
  };
}

/* ========= DB init ========= */
let db=loadDB();
window.db = db;
db.deleted = db.deleted || {};
if (!db.lastPush) db.lastPush = {};
let pushEnabled = false;
const DEFAULT_TABS=['Dashboard','Vehicles','Expenses','Showroom','Sales','Sold','Credit','Purchase Invoice','Customer Complaints','Directors','Investors','Reports','To-Do','Users','Settings'];

// Add to the core utils section
let changeTracker = {
  lastSnapshot: null,
  changes: {},
  init: function() {
    // Start with no persisted snapshot to save space in localStorage
    this.lastSnapshot = null;
    this.changes = {};

    // Clean up old big snapshot key from previous versions (one-time)
    try {
      localStorage.removeItem('starcars_last_snapshot');
    } catch(e) {
      console.warn('Could not remove old snapshot key:', e);
    }
  },
  
  saveSnapshot: function() {
    // Keep snapshot only in memory (not in localStorage) to avoid quota issues
    this.lastSnapshot = JSON.parse(JSON.stringify(window.db || {}));
  },
  
  trackChange: function(section, id, operation, data) {
    // Track a change (add, update, delete)
    if (!this.changes[section]) {
      this.changes[section] = [];
    }
    
    this.changes[section].push({
      id: id,
      operation: operation,
      data: data,
      timestamp: new Date().toISOString(),
      user: session ? session.username : 'unknown'
    });
  },
  
  getChanges: function() {
    return this.changes;
  },
  
  clearChanges: function() {
    this.changes = {};
  },
  
  // Compare current state with last snapshot to find all changes
  detectAllChanges: function() {
    if (!this.lastSnapshot) {
      return null; // No baseline to compare against
    }
    
    const current = window.db || {};
    const previous = this.lastSnapshot;
    const changes = {};
    
    // Track array changes
    const sections = ['vehicles', 'sales', 'vehicleExpenses', 'showroomExpenses', 
                     'credits', 'purchaseInvoices', 'complaints', 'investors', 
                     'partners', 'todo', 'users', 'audit'];
    
    sections.forEach(section => {
      const currentArr = current[section] || [];
      const previousArr = previous[section] || [];
      
      // Create maps for easy comparison
      const currentMap = new Map(currentArr.map(item => [item.id, item]));
      const previousMap = new Map(previousArr.map(item => [item.id, item]));
      
      const sectionChanges = [];
      
      // Find new items
      currentArr.forEach(item => {
        if (!previousMap.has(item.id)) {
          sectionChanges.push({
            id: item.id,
            operation: 'add',
            data: item
          });
        }
      });
      
      // Find modified items
      currentArr.forEach(item => {
        if (previousMap.has(item.id)) {
          const prevItem = previousMap.get(item.id);
          if (JSON.stringify(item) !== JSON.stringify(prevItem)) {
            sectionChanges.push({
              id: item.id,
              operation: 'update',
              data: item
            });
          }
        }
      });
      
      // Find deleted items (only if we're tracking deletions)
      if (db.deleted && db.deleted[section]) {
        Object.keys(db.deleted[section] || {}).forEach(id => {
          if (previousMap.has(id) && !currentMap.has(id)) {
            sectionChanges.push({
              id: id,
              operation: 'delete',
              data: { id: id, deletedAt: db.deleted[section][id] }
            });
          }
        });
      }
      
      if (sectionChanges.length > 0) {
        changes[section] = sectionChanges;
      }
    });
    
    // Track object changes (company settings)
    if (JSON.stringify(current.company || {}) !== JSON.stringify(previous.company || {})) {
      changes.company = {
        operation: 'update',
        data: current.company || {}
      };
    }
    
    return changes;
  }
};

// Initialize change tracker
changeTracker.init();

// Save initial snapshot if none exists
if (!changeTracker.lastSnapshot) {
  changeTracker.saveSnapshot();
}

function defaultPerms(){ const tabs={}; DEFAULT_TABS.forEach(t=>tabs[t]=true); return {tabs,actions:{view:true,add:true,edit:true,del:true},profit:true,settings:true}; }
function normalizePerms(perms){
  const base=defaultPerms(); const p=Object.assign({},base,perms||{});
  p.tabs=Object.assign({},base.tabs,(perms&&perms.tabs)||{});
  p.actions=Object.assign({},base.actions,(perms&&perms.actions)||{});
  if(typeof p.profit!=='boolean') p.profit=!!(perms&&perms.profit);
  if(typeof p.settings!=='boolean') p.settings=!!(perms&&perms.settings);
  DEFAULT_TABS.forEach(t=>{ if(typeof p.tabs[t]!=='boolean') p.tabs[t]=true; });
  return p;
}

db.users=db.users||[
  {id:'u1',username:'admin',password:'admin',role:'admin',perms:defaultPerms()},
  {id:'u2',username:'staff',password:'1234',role:'user',perms:(()=>{const p=defaultPerms();p.profit=false;p.settings=false;p.tabs['Directors']=false;p.tabs['Investors']=false;p.tabs['Users']=false;p.tabs['Settings']=false;return p;})()}
];
db.users=(db.users||[]).map(u=>{u.perms=normalizePerms(u.perms);return u;});
db.company=db.company||{
  name:'Star Cars London Ltd',address:'Park Farm, Sewardstone Road, London E4 7RG',phone:'',email:'',
  vatNumber:'',companyNumber:'',terms:'All vehicles supplied under CRA 2015. See full T&Cs.',
  logo:'',dvlaProxy:'',dvlaKey:'',dvsaKey:'',dvsaProxy:'',gistId:'',
  openingBank:0,openingCash:0,
  invoiceFontPx:12, logoMaxW:140, logoMaxH:80
};
db.vehicles=db.vehicles||[]; db.vehicleExpenses=db.vehicleExpenses||[]; db.showroomExpenses=db.showroomExpenses||[]; db.sales=db.sales||[]; db.credits=db.credits||[]; db.complaints = db.complaints || [];
db.partners=db.partners||[{id:'p1',name:'Director A',balance:0,tx:[]},{id:'p2',name:'Director B',balance:0,tx:[]}];
// Ensure partners are unique by name (fix duplicate directors from backup)
db.partners = (db.partners||[]).filter((p,i,arr)=> arr.findIndex(q=>String(q.name||'').trim().toLowerCase()===String(p.name||'').trim().toLowerCase())===i);

db.investors=db.investors||[]; db.audit=db.audit||[]; db.todo=db.todo||[];
db.purchaseInvoices = db.purchaseInvoices || []; // Add purchase invoices array

/* ========= Session / Header / Logo ========= */
let session=JSON.parse(sessionStorage.getItem('starcars_sess')||'null'); if(!session){ showLogin(true); }
function showLogin(show){ document.getElementById('loginOverlay').style.display=show?'grid':'none'; }

function checkPullStatusOnLogin(){
  // If you already use lastPulledAt logic, keep it consistent
  try{
    const t = Number(sessionStorage.getItem('starcars_last_pulled_at') || 0);
    if(!t){
      // lock push until first pull
      if (typeof disablePushButton === "function") disablePushButton();
    } else {
      if (typeof enablePushButton === "function") enablePushButton();
    }
  }catch(e){
    // never block login if something goes wrong
    console.warn("checkPullStatusOnLogin error:", e);
  }
}

function doLogin(){
  const u=document.getElementById('li_user').value.trim(); const p=document.getElementById('li_pass').value;
  const user=(db.users||[]).find(x=>x.username===u&&x.password===p);
  if(!user){alert('Wrong login');return;}
  if ((db.company && db.company.requireGist === true) && !db.company.gistBootstrapped) {
    alert('Please go to Settings ‚Üí Integrations and Pull Users from your Gist first.');
    return;
  }
  if (user.role==='admin' && (db.company && db.company.disableAdminLogin === true)) {
    alert('Admin login is disabled on this build.');
    return;
  }
  session={username:user.username,role:user.role}; sessionStorage.setItem('starcars_sess',JSON.stringify(session));
  showLogin(false); initHeader(); render(); checkPullStatusOnLogin();
  
  // Disable push button on login
  disablePushButton();
}

function logout(){sessionStorage.removeItem('starcars_sess'); sessionStorage.removeItem('starcars_pull_used'); session=null; showLogin(true); initHeader();}
function switchUser(){ logout(); }
function initHeader(){ const el=document.getElementById('who'); el.textContent=session?('Logged in: '+session.username+' ('+session.role+')'):'Not logged in'; refreshLogoBox(); }

function disablePushButton() {
  pushEnabled = false;
  sessionStorage.setItem('starcars_push_enabled', 'false');
  
  // Disable push button in settings
  const pushBtn = document.querySelector('#c_push');
  if (pushBtn) {
    pushBtn.disabled = true;
    pushBtn.style.opacity = '0.5';
    pushBtn.style.cursor = 'not-allowed';
  }
}

function enablePushButton() {
  pushEnabled = true;
  sessionStorage.setItem('starcars_push_enabled', 'true');
  
  // Enable push button in settings
  const pushBtn = document.querySelector('#c_push');
  if (pushBtn) {
    pushBtn.disabled = false;
    pushBtn.style.opacity = '1';
    pushBtn.style.cursor = 'pointer';
  }
}

function isPullUsed(){
  return sessionStorage.getItem('starcars_pull_used') === 'true';
}

function markPullUsed() {
  sessionStorage.setItem('starcars_pull_used', 'true');
}

function applyPullLockUI(){
  // If pull is done, unlock everything
  if (isPullUsed()){
    document.querySelectorAll('[data-pull-lock="1"]').forEach(el=>{
      el.disabled = false;
      el.removeAttribute('data-pull-lock');
      el.removeAttribute('title');
    });
    const note = document.getElementById('pullLockNote');
    if (note) note.remove();
    return;
  }

  // Not pulled yet -> lock app inputs/buttons (but NOT header/nav)
  const app = document.getElementById('app');
  if (!app) return;

  // Show a note at the top of the current tab
  if (!document.getElementById('pullLockNote')){
    const note = document.createElement('div');
    note.id = 'pullLockNote';
    note.className = 'card';
    note.style.borderColor = '#ff6b6b';
    note.innerHTML = `
      <div style="font-weight:800">‚ö†Ô∏è Editing locked</div>
      <div class="small" style="margin-top:4px">
        You must use <b>Pull</b> first on this device to avoid overwriting other PCs.
        Go to <b>Settings ‚Üí Pull (Gist ‚Üí App)</b>.
      </div>
      <div class="row" style="margin-top:10px">
        <button class="primary" id="goSettingsPull">Go to Settings</button>
      </div>
    `;
    app.prepend(note);
    note.querySelector('#goSettingsPull').onclick = () => setTab('Settings');
  }

  // Allowlist (things we still want enabled inside Settings)
  const allowIds = new Set([
    'c_pull',        // Pull (Normal)
    'syncPullHard',  // Pull (Hard)
    'c_isave',       // Save Integrations
    'c_gistId', 'c_ghToken',
    'c_autoSync', 'c_autoSyncSec'
  ]);

  // Disable everything editable inside #app except allowlist
  app.querySelectorAll('button, input, select, textarea').forEach(el=>{
    if (allowIds.has(el.id)) return;

    // If element is inside Settings tab, still lock it unless allowlisted
    el.disabled = true;
    el.setAttribute('data-pull-lock', '1');
    el.title = 'Locked until you Pull from Gist';
  });
}

function refreshLogoBox(){ const lb=document.getElementById('logoBox'); const logo=(db.company.logo||'').trim(); if(logo){ lb.innerHTML='<img alt="logo" src="'+logo+'">'; } else { lb.textContent='SC'; } }
initHeader();

function changeMyPass(){
  if(!session){ return alert('Not logged in'); }
  const u = (db.users||[]).find(x=>x.username===session.username);
  if(!u){ return alert('User not found'); }
  const p1 = prompt('Enter new password for '+u.username+':'); if(p1===null) return;
  if(!p1.trim()){ return alert('Password cannot be empty'); }
  const p2 = prompt('Confirm new password:'); if(p2===null) return;
  if(p1!==p2){ return alert('Passwords do not match'); }
  u.password = p1; saveDB(); try{renderAlertBell();}catch(e){}; addAudit('update','userPass',u.id,'Self-change for '+u.username); alert('Password updated.');
}
function currentUser(){ return (db.users||[]).find(x=>session&&x.username===session.username); }
function canTab(tab){ const u=currentUser(); return !!(u&&u.perms&&u.perms.tabs&&u.perms.tabs[tab]); }
function canProfit(){ const u=currentUser(); return !!(u&&u.perms&&u.perms.profit); }
function canSettings(){ const u=currentUser(); return !!(u&&u.perms&&u.perms.settings); }
function canAction(act){ const u=currentUser(); return !!(u&&u.perms&&u.perms.actions&&u.perms.actions[act]); }

function addAudit(action, entity, entityId, details){ 
  try{ 
    db.audit.unshift({
      id:uid(),
      ts:new Date().toISOString(),
      user:session?session.username:'(anon)',
      action,
      entity,
      entityId,
      details:details||''
    }); 
    
    if(db.audit.length>5000) db.audit.length=5000; 
    
    // Track the change
    changeTracker.trackChange(entity, entityId, action, details);
    
    saveDB(); 
    try{renderAlertBell();}catch(e){}; 
  }catch(e){}
}

/* ========= Backup / Restore / CSV ========= */
function backupJSON(){
  try{
    const data = JSON.stringify(db, null, 2); // full DB including db.audit and user passwords
    const blob = new Blob([data], {type:'application/json'});
    const a=document.createElement('a');
    a.href=URL.createObjectURL(blob);
    a.download='starcars_backup_'+(new Date()).toISOString().slice(0,19).replace(/[:T]/g,'-')+'.json';
    a.click();
    addAudit && addAudit('export','backup','','Full JSON backup');
  }catch(e){ alert('Backup failed: '+(e.message||e)); }

}

// Merge-from-backup with id-based merge for ALL arrays
function restoreJSONMerge() {
  const i = document.createElement('input');
  i.type = 'file';
  i.accept = '.json,application/json';

  i.onchange = () => {
    const f = i.files && i.files[0];
    if (!f) return;

    const fr = new FileReader();
    fr.onload = () => {
      try {
        const incoming = JSON.parse(fr.result || '{}');
        if (!incoming || typeof incoming !== 'object') {
          throw new Error('Backup file has no data');
        }

        // Make sure db exists
        db = db || {};

        // If backup contains deleted map, merge it first
        if (incoming.deleted && typeof mergeDeletedMaps === 'function') {
          db.deleted = mergeDeletedMaps(db.deleted, incoming.deleted);
        } else {
          db.deleted = db.deleted || {};
        }

        Object.keys(incoming).forEach(k => {
          const val = incoming[k];

          if (k === 'audit') {
            // Replace audit log with backup audit
            db.audit = Array.isArray(val) ? val.slice() : (db.audit || []);
            return;
          }

          if (k === 'deleted') {
            // Already merged above
            return;
          }

          if (Array.isArray(val)) {
            // üîÅ Merge ANY array by id: vehicles, sales, expenses, showroomExpenses,
            // vehicleExpenses, investors, credits, complaints, todo, users, partners, etc.
            const localArr = Array.isArray(db[k]) ? db[k] : [];
            const byId = Object.create(null);
            const noId = [];

            // Start from local (current browser) data
            for (const item of localArr) {
              if (item && item.id) {
                byId[item.id] = item;
              } else {
                noId.push(item);
              }
            }

            // Apply incoming backup: overwrite same-id items, add new ones
            for (const item of val) {
              if (item && item.id) {
                byId[item.id] = item; // backup wins on conflicts
              } else {
                noId.push(item);
              }
            }

            db[k] = [...noId, ...Object.values(byId)];

            // Users: normalise permissions
            if (k === 'users' && typeof normalizePerms === 'function') {
              db.users = (db.users || []).map(u => {
                u.perms = normalizePerms(u.perms);
                return u;
              });
            }

            // Directors: make sure partners are unique by name
            if (k === 'partners') {
              db.partners = (db.partners || []).filter((p, i, arr) =>
                arr.findIndex(pp =>
                  String(pp.name || '').trim().toLowerCase() ===
                  String(p.name || '').trim().toLowerCase()
                ) === i
              );
            }

            return;
          }

          if (val && typeof val === 'object') {
            // Shallow-merge plain objects (company, settings, etc.)
            db[k] = Object.assign({}, db[k] || {}, val);
          } else {
            // Simple values (numbers / strings / booleans)
            db[k] = val;
          }
        });

        // Safety defaults
        db.company           = db.company           || {};
        db.vehicles          = db.vehicles          || [];
        db.sales             = db.sales             || [];
        db.expenses          = db.expenses          || [];
        db.showroomExpenses  = db.showroomExpenses  || [];
        db.vehicleExpenses   = db.vehicleExpenses   || [];
        db.credits           = db.credits           || [];
        db.complaints        = db.complaints        || [];
        db.investors         = db.investors         || [];
        db.partners          = db.partners          || [];
        db.todo              = db.todo              || [];
        db.purchaseInvoices  = db.purchaseInvoices  || [];
        db.audit             = db.audit             || [];
        db.deleted           = db.deleted           || {};

        // Apply deletions (if map exists)
        if (typeof applyAllDeletions === 'function') {
          applyAllDeletions();
        }

        ensureIdsEverywhere();
        dedupeVehiclesByReg();
        relinkVehicleRefsByReg();
        dedupeSalesById();
        dedupeAllExpensesAndCredits();

        saveDB();
        try { renderAlertBell(); } catch (_) {}
        if (typeof addAudit === 'function') {
          addAudit('import', 'backup', '', 'Merged JSON backup (id-merge)');
        }
        alert('Merged from backup');
        markPullUsed();
        applyPullLockUI && applyPullLockUI();
        if (typeof render === 'function') render();
      } catch (e) {
        alert('Bad JSON: ' + (e.message || e));
      }
    };
    fr.readAsText(f);
  };

  i.click();
}

// Replace-from-backup (full overwrite of local DB)
function restoreJSONReplace() {
  const i = document.createElement('input');
  i.type = 'file';
  i.accept = '.json,application/json';

  i.onchange = () => {
    const f = i.files && i.files[0];
    if (!f) return;

    const fr = new FileReader();
    fr.onload = () => {
      try {
        const incoming = JSON.parse(fr.result || '{}');
        if (!incoming || typeof incoming !== 'object') {
          throw new Error('Backup file has no data');
        }

        // Completely replace the in-memory DB with backup
        db = incoming || {};

        // Safety defaults
        db.company           = db.company           || {};
        db.vehicles          = db.vehicles          || [];
        db.sales             = db.sales             || [];
        db.expenses          = db.expenses          || [];
        db.showroomExpenses  = db.showroomExpenses  || [];
        db.vehicleExpenses   = db.vehicleExpenses   || [];
        db.credits           = db.credits           || [];
        db.complaints        = db.complaints        || [];
        db.investors         = db.investors         || [];
        db.partners          = db.partners          || [];
        db.todo              = db.todo              || [];
        db.purchaseInvoices  = db.purchaseInvoices  || [];
        db.audit             = db.audit             || [];
        db.deleted           = db.deleted           || {};

        // Normalise user permissions
        if (Array.isArray(db.users) && typeof normalizePerms === 'function') {
          db.users = db.users.map(u => {
            u.perms = normalizePerms(u.perms);
            return u;
          });
        } else {
          db.users = db.users || [];
        }

        // Apply deletions if any
        if (typeof applyAllDeletions === 'function') {
          applyAllDeletions();
        }

        ensureIdsEverywhere();
        dedupeVehiclesByReg();
        relinkVehicleRefsByReg();
        dedupeSalesById();
        dedupeAllExpensesAndCredits();

        saveDB();
        try { renderAlertBell(); } catch (_) {}
        if (typeof addAudit === 'function') {
          addAudit('import', 'backup', '', 'Replaced from JSON backup');
        }
        alert('Replaced from backup');
        markPullUsed();
        applyPullLockUI && applyPullLockUI();
        if (typeof render === 'function') render();
      } catch (e) {
        alert('Bad JSON: ' + (e.message || e));
      }
    };
    fr.readAsText(f);
  };

  i.click();
}

/* ========= Gist sync ========= */
function getGhToken(){ return localStorage.getItem(GHTOKENKEY)||''; }
function setGhToken(t){ if(t) localStorage.setItem(GHTOKENKEY,t); else localStorage.removeItem(GHTOKENKEY); }

function recordPullActivity(type = 'pull') {
    if (!db.lastPull) db.lastPull = {};
    db.lastPull = {
        timestamp: new Date().toISOString(),
        user: session ? session.username : 'unknown',
        gistId: db.company.gistId || '',
        type: type
    };
    saveDB();
}

// ========= Deletion tracking (for multi-PC sync) =========
function ensureDeletedMap() {
  db.deleted = db.deleted || {};
}

// Merge remote deleted map into local (keep latest timestamp)
function mergeDeletedMaps(localDel, remoteDel) {
  const out = localDel && typeof localDel === 'object' ? JSON.parse(JSON.stringify(localDel)) : {};
  if (remoteDel && typeof remoteDel === 'object') {
    Object.keys(remoteDel).forEach(section => {
      out[section] = out[section] || {};
      const tgt = out[section];
      const src = remoteDel[section] || {};
      Object.keys(src).forEach(id => {
        if (!tgt[id] || String(tgt[id]) < String(src[id])) {
          tgt[id] = src[id];
        }
      });
    });
  }
  return out;
}

function dedupePeopleByNamePreferLocal(mergedArr, localArr) {
  const norm = s => String(s || '').trim().toLowerCase();

  // Set of names that exist in LOCAL (so local version should win)
  const localNameSet = new Set((localArr || []).map(x => norm(x && x.name)));

  // Choose ‚Äúbest‚Äù record if we see duplicates:
  // 1) Prefer record that came from LOCAL (same name exists locally)
  // 2) Otherwise prefer one with more tx entries
  // 3) Otherwise prefer one with higher abs(balance)
  const pickBest = (a, b) => {
    const an = norm(a && a.name), bn = norm(b && b.name);
    const aLocal = localNameSet.has(an);
    const bLocal = localNameSet.has(bn);

    if (aLocal && !bLocal) return a;
    if (!aLocal && bLocal) return b;

    const atx = (a && a.tx && a.tx.length) ? a.tx.length : 0;
    const btx = (b && b.tx && b.tx.length) ? b.tx.length : 0;
    if (atx !== btx) return atx > btx ? a : b;

    const abal = Math.abs(Number(a && a.balance || 0));
    const bbal = Math.abs(Number(b && b.balance || 0));
    if (abal !== bbal) return abal > bbal ? a : b;

    return a; // stable fallback
  };

  const map = Object.create(null);
  const out = [];

  for (const item of (mergedArr || [])) {
    const key = norm(item && item.name);
    if (!key) { out.push(item); continue; }
    if (!map[key]) {
      map[key] = item;
    } else {
      map[key] = pickBest(map[key], item);
    }
  }

  // rebuild in a stable order by name (optional but helps keep dropdown stable)
  const named = Object.keys(map).sort().map(k => map[k]);
  const unnamed = out.filter(x => !x || !norm(x.name));
  return [...named, ...unnamed];
}

function dedupePeopleByNamePreferRemote(mergedArr, remoteArr) {
  const norm = s => String(s || '').trim().toLowerCase();
  const remoteNameSet = new Set((remoteArr || []).map(x => norm(x && x.name)));

  const pickBest = (a, b) => {
    const an = norm(a && a.name), bn = norm(b && b.name);
    const aRemote = remoteNameSet.has(an);
    const bRemote = remoteNameSet.has(bn);

    // Prefer record that exists in REMOTE (Gist)
    if (aRemote && !bRemote) return a;
    if (!aRemote && bRemote) return b;

    // Fallback: more tx wins
    const atx = (a && a.tx && a.tx.length) ? a.tx.length : 0;
    const btx = (b && b.tx && b.tx.length) ? b.tx.length : 0;
    if (atx !== btx) return atx > btx ? a : b;

    // Fallback: higher abs(balance)
    const abal = Math.abs(Number(a && a.balance || 0));
    const bbal = Math.abs(Number(b && b.balance || 0));
    if (abal !== bbal) return abal > bbal ? a : b;

    return a;
  };

  const map = Object.create(null);
  const out = [];

  for (const item of (mergedArr || [])) {
    const key = norm(item && item.name);
    if (!key) { out.push(item); continue; }
    if (!map[key]) map[key] = item;
    else map[key] = pickBest(map[key], item);
  }

  const named = Object.keys(map).sort().map(k => map[k]);
  const unnamed = out.filter(x => !x || !norm(x.name));
  return [...named, ...unnamed];
}

// Mark a record as deleted so other PCs know to remove it too
function markDeleted(section, id) {
  if (!id) return;
  ensureDeletedMap();
  if (!db.deleted[section]) db.deleted[section] = {};
  db.deleted[section][id] = db.deleted[section][id] || new Date().toISOString();
}

// Apply deletions to a given array (vehicles, sales, etc.)
function applyDeletions(section) {
  ensureDeletedMap();
  const map = db.deleted[section];
  if (!map) return;
  if (!Array.isArray(db[section])) return;
  db[section] = db[section].filter(item => !item || !item.id || !map[item.id]);
}

// Apply deletions to all arrays we know about
function applyAllDeletions() {
  ensureDeletedMap();
  Object.keys(db.deleted || {}).forEach(section => {
    applyDeletions(section);
  });
}

async function readGistStarcarsJSON(gistId, token = "") {
  // Safe reader that supports private gists (Authorization) and large/truncated files
  const headers = { "Accept": "application/vnd.github+json" };
  if (token) headers["Authorization"] = "token " + token;

  const r = await fetch(`https://api.github.com/gists/${gistId}`, { headers });
  const txt = await r.text();
  if (!r.ok) throw new Error(`Gist fetch failed ${r.status}: ${txt}`);

  const j = JSON.parse(txt || "{}");
  const file = j.files && (j.files['starcars.json'] || Object.values(j.files)[0]);
  if (!file) throw new Error('No starcars.json in that Gist');

  // Handle big/truncated files
  let content = file.content || '';
  if (file.truncated && file.raw_url) {
    const rr = await fetch(file.raw_url, { headers });
    if (!rr.ok) throw new Error(`Raw fetch failed ${rr.status}`);
    content = await rr.text();
  }

  return JSON.parse(content || '{}');
}

async function syncPull() {
  try {
    const gistId = (db.company.gistId || '').trim();
    if (!gistId) return alert('Enter Gist ID in Settings');

    const r = await fetch(`https://api.github.com/gists/${gistId}`);
    const txt = await r.text();
    if (!r.ok) {
      return alert('Gist fetch failed ' + r.status + ': ' + txt);
    }

    const j = JSON.parse(txt || '{}');
    const file = j.files && (j.files['starcars.json'] || Object.values(j.files)[0]);
    if (!file || !file.content) return alert('No starcars.json in that Gist');

    const incoming = await readGistStarcarsJSON(gistId);

    recordPullActivity('pull');

    // 1) Merge deleted map first so we know what to remove
    if (incoming.deleted) {
      db.deleted = mergeDeletedMaps(db.deleted, incoming.deleted);
    } else {
      ensureDeletedMap();
    }

    Object.keys(incoming).forEach(k => {
      const val = incoming[k];

      if (k === 'audit') {
        // Replace audit completely
        db.audit = Array.isArray(val) ? val.slice() : (db.audit || []);
        return;
      }

      if (k === 'deleted') {
        // already handled above
        return;
      }

      if (Array.isArray(val)) {
        // üîÅ Merge ANY array by id: vehicles, expenses, showroom, users, directors, investors, etc.
        const localArr = Array.isArray(db[k]) ? db[k] : [];
        const byId = Object.create(null);
        const noId = [];

        // Start from local
        for (const item of localArr) {
          if (item && item.id) {
            byId[item.id] = item;
          } else {
            noId.push(item);
          }
        }

        // Apply incoming: overwrite same-id items, add new ones (remote wins)
        for (const item of val) {
          if (item && item.id) {
            byId[item.id] = item;
          } else {
            noId.push(item);
          }
        }

        db[k] = [...noId, ...Object.values(byId)];

        // Apply deletions for this section
        applyDeletions(k);

        // Users: normalise permissions
        if (k === 'users' && typeof normalizePerms === 'function') {
          db.users = (db.users || []).map(u => {
            u.perms = normalizePerms(u.perms);
            return u;
          });
        }

        // FIXED: Use 'val' instead of 'remoteArr' which doesn't exist here
        if (k === 'partners')  db.partners  = dedupePeopleByNamePreferRemote(db.partners || [], val);
        if (k === 'investors') db.investors = dedupePeopleByNamePreferRemote(db.investors || [], val);

        return;
      }

      if (val && typeof val === 'object') {
        // ‚úÖ On PULL: remote (Gist) should overwrite local settings
        db[k] = Object.assign({}, db[k] || {}, val || {});
      } else {
        db[k] = val;
      }
    });

    // Normalise users again just in case
    if (typeof normalizePerms === 'function') {
      db.users = (db.users || []).map(u => {
        u.perms = normalizePerms(u.perms);
        return u;
      });
    }

    // As a safety net, apply deletions everywhere
    applyAllDeletions();

    // Ensure font sizes are numeric
    db.company = db.company || {};
    if (db.company.invoiceFontPx != null) db.company.invoiceFontPx = Number(db.company.invoiceFontPx || 12);
    if (db.company.termsFontPx  != null) db.company.termsFontPx  = Number(db.company.termsFontPx  || 10);
    ensureIdsEverywhere();
    dedupeVehiclesByReg();
    relinkVehicleRefsByReg();
    dedupeSalesById();
    dedupeAllExpensesAndCredits();
    saveDB();
    try { renderAlertBell(); } catch (_) {}
    addAudit('sync', 'pull', db.company.gistId || '', 'Pulled from Gist (arrays merged by id, deletions respected)');
    alert('Pulled & merged from Gist (arrays merged by id; deletions synced)');
    enablePushButton();
    markPullUsed();
    changeTracker.saveSnapshot();
    render();
  } catch (e) {
    alert('Pull failed: ' + e.message);
  }
}

async function readGistJSON(gistId, fileName = "starcars.json", token = ""){
  const headers = { "Accept": "application/vnd.github+json" };
  if (token) headers["Authorization"] = "token " + token;

  const r = await fetch(`https://api.github.com/gists/${gistId}`, { headers });
  const t = await r.text();
  if (!r.ok) throw new Error(`Gist fetch failed ${r.status}: ${t}`);

  const j = JSON.parse(t || "{}");
  const file = j.files && (j.files[fileName] || Object.values(j.files)[0]);
  if (!file) throw new Error(`No ${fileName} found in gist`);

  // ‚úÖ big file: file.content may be truncated
  let content = file.content || "";
  if (file.truncated && file.raw_url) {
    const rr = await fetch(file.raw_url); // raw_url is public if gist is public
    if (!rr.ok) throw new Error(`Raw gist fetch failed ${rr.status}`);
    content = await rr.text();
  }

  return JSON.parse(content || "{}");
}

async function syncPullHard() {
  try {
    const gistId = (db.company.gistId || '').trim();
    if (!gistId) return alert('Enter Gist ID in Settings');

    // ‚úÖ IMPORTANT: use the safe reader that handles big/truncated gists
    const incoming = await readGistStarcarsJSON(gistId);

    recordPullActivity('pull-hard');

    // Replace whole DB with incoming
    db = incoming || {};

    // Safety defaults
    db.company = db.company || {};
    db.vehicles = db.vehicles || [];
    db.sales = db.sales || [];
    db.vehicleExpenses = db.vehicleExpenses || [];
    db.showroomExpenses = db.showroomExpenses || [];
    db.credits = db.credits || [];
    db.complaints = db.complaints || [];
    db.investors = db.investors || [];
    db.partners = db.partners || [];
    db.todo = db.todo || [];
    db.purchaseInvoices = db.purchaseInvoices || [];
    db.audit = db.audit || [];
    db.users = db.users || [];
    db.deleted = db.deleted || {};

    db.company.autoSyncEnabled = db.company.autoSyncEnabled ?? false;
    db.company.autoSyncSeconds = db.company.autoSyncSeconds || 120;

    // Normalise permissions
    if (typeof normalizePerms === 'function') {
      db.users = (db.users || []).map(u => {
        u.perms = normalizePerms(u.perms);
        return u;
      });
    }
    
    ensureIdsEverywhere();
    dedupeVehiclesByReg();
    relinkVehicleRefsByReg();
    dedupeSalesById();
    dedupeAllExpensesAndCredits();

    if (typeof applyAllDeletions === 'function') applyAllDeletions();

    saveDB();
    try { renderAlertBell(); } catch (_) {}
    addAudit('sync', 'pull-hard', gistId, 'HARD pull from Gist (full replace, safe raw_url, dedupe)');
    alert('HARD Pull complete: local data replaced with Gist data.');
    enablePushButton();
    markPullUsed();
    changeTracker.saveSnapshot();
    render();
  } catch (e) {
    alert('Hard Pull failed: ' + e.message);
  }
}

// ========= Auto Sync (auto-pull from Gist) =========
let autoSyncTimer = null;
let autoSyncRunning = false;

function stopAutoSync(){
  if (autoSyncTimer){
    clearInterval(autoSyncTimer);
    autoSyncTimer = null;
  }
}

async function autoSyncTick(){
  if (autoSyncRunning) return; // don't overlap
  autoSyncRunning = true;
  try {
    if (!db || !db.company) return;

    const enabled = !!db.company.autoSyncEnabled;
    const gistId  = (db.company.gistId || '').trim();

    if (!enabled || !gistId) return;

    // Use normal safe pull (merge + deletions)
    await syncPull();
  } catch (e) {
    console.warn('Auto sync failed:', e);
  } finally {
    autoSyncRunning = false;
  }
}

function startAutoSyncFromSettings(){
  stopAutoSync();
  if (!db) return;
  db.company = db.company || {};

  if (!db.company.autoSyncEnabled) return;

  let sec = Number(db.company.autoSyncSeconds || 120);
  if (!sec || sec < 30) sec = 30;     // minimum 30s to avoid hammering GitHub
  if (sec > 600) sec = 600;           // max 10 mins

  autoSyncTimer = setInterval(autoSyncTick, sec * 1000);
}

// Add this function to record push activity
function recordPushActivity() {
    if (!db.lastPush) db.lastPush = {};
    db.lastPush = {
        timestamp: new Date().toISOString(),
        user: session ? session.username : 'unknown',
        gistId: db.company.gistId || ''
    };
    saveDB();
}

async function smartPush() {
  try {
    const gistId = (db.company.gistId || '').trim();
    if (!gistId) return alert('Enter Gist ID in Settings');

    const token = (getGhToken() || '').trim();
    if (!token) return alert('Enter GitHub token and Save');

    // Detect changes vs last snapshot
    const detected = changeTracker.detectAllChanges();
    let changes = detected;
    let useFullPush = false;

    if (!detected || Object.keys(detected).length === 0) {
      // Nothing detected ‚Äì offer to force a FULL push
      const ok = confirm(
        'No changes detected against the last snapshot.\n\n' +
        'Press OK to FORCE a FULL push of your current data to Gist.\n' +
        'Press Cancel to stop.'
      );
      if (!ok) return;
      useFullPush = true;
    }

    let payloadData;

    if (useFullPush) {
      // FULL PUSH: send the current local DB as starcars.json
      payloadData = db;
    } else {
      // Smart diff push ‚Äì read remote (with token), apply changes, then send back
      let remote = null;
      try {
        remote = await readGistJSON(gistId, "starcars.json", token);
      } catch (e) {
        console.warn("Remote read failed:", e);
        remote = null;
      }

      if (!remote) {
        alert(
          "Failed to fetch remote Gist content.\n\n" +
          "Try: Settings ‚Üí Pull (Normal) then Push again.\n" +
          "If still fails, do a Full Push."
        );
        return;
      }

      const updatedRemote = applyChangesToRemote(remote, changes);
      payloadData = updatedRemote;
    }

    // (2) Push to Gist ‚Äî include Accept + API version + token
    const payload = {
      files: {
        'starcars.json': {
          content: JSON.stringify(payloadData, null, 2),
        },
      },
    };

    const r = await fetch(`https://api.github.com/gists/${gistId}`, {
      method: 'PATCH',
      headers: {
        'content-type': 'application/json',
        'Accept': 'application/vnd.github+json',
        'X-GitHub-Api-Version': '2022-11-28',
        Authorization: 'token ' + token
      },
      body: JSON.stringify(payload),
    });

    const txt = await r.text();
    if (!r.ok) {
      console.error('Push failed response:', r.status, txt);
      // try to parse JSON error to show more detail
      let errMsg = `Push failed with status ${r.status}`;
      try {
        const j = JSON.parse(txt || '{}');
        if (j && j.message) errMsg += ': ' + j.message;
      } catch (_) {
        errMsg += ': ' + txt;
      }
      return alert(errMsg);
    }

    // Success: reset snapshot + change log
    changeTracker.saveSnapshot();
    changeTracker.clearChanges();

    recordPushActivity();

    if (useFullPush) {
      addAudit('sync', 'smart-push', gistId, 'Smart push FULL DB (no diff found, forced).');
      alert('Full push completed: all current data sent to Gist.');
    } else {
      addAudit(
        'sync',
        'smart-push',
        gistId,
        `Smart push completed with ${countChanges(changes)} changes.`
      );
      alert(`Smart push completed: ${countChanges(changes)} changes pushed to Gist.`);
    }

    render();
  } catch (e) {
    alert('Smart push failed: ' + e.message);
    console.error('smartPush exception', e);
  }
}

// Helper function to apply changes to remote data
function applyChangesToRemote(remote, changes) {
  const result = JSON.parse(JSON.stringify(remote)); // Deep clone
  
  Object.keys(changes).forEach(section => {
    if (section === 'company') {
      // Update company settings
      result.company = changes.company.data;
      return;
    }
    
    const sectionChanges = changes[section];
    if (!Array.isArray(sectionChanges)) return;
    
    // Ensure the section exists in remote
    if (!result[section]) {
      result[section] = [];
    }
    
    sectionChanges.forEach(change => {
      switch(change.operation) {
        case 'add':
          // Add new item (prepend to beginning)
          result[section].unshift(change.data);
          break;
          
        case 'update':
          // Update existing item
          const index = result[section].findIndex(item => item.id === change.id);
          if (index !== -1) {
            result[section][index] = change.data;
          } else {
            // If not found, add it
            result[section].unshift(change.data);
          }
          break;
          
        case 'delete':
          // Remove item
          result[section] = result[section].filter(item => item.id !== change.id);
          
          // Also add to deleted map for syncing to other PCs
          if (!result.deleted) result.deleted = {};
          if (!result.deleted[section]) result.deleted[section] = {};
          result.deleted[section][change.id] = change.data.deletedAt || new Date().toISOString();
          break;
      }
    });
    
    // Sort arrays to maintain consistency (newest first where applicable)
    if (['audit', 'sales', 'vehicles'].includes(section)) {
      result[section].sort((a, b) => {
        const dateA = a.date || a.ts || a.createdAt || '';
        const dateB = b.date || b.ts || b.createdAt || '';
        return dateB.localeCompare(dateA);
      });
    }
  });
  
  // Merge deleted maps
  if (db.deleted) {
    result.deleted = mergeDeletedMaps(result.deleted || {}, db.deleted);
  }
  
  return result;
}

// Helper to count total changes
function countChanges(changes) {
  let count = 0;
  Object.keys(changes).forEach(section => {
    if (Array.isArray(changes[section])) {
      count += changes[section].length;
    } else {
      count += 1; // For company changes
    }
  });
  return count;
}

/* ========= Navigation & render ========= */
const TABS=['Dashboard','Vehicles','Expenses','Showroom','Sales','Sold','Credit','Purchase Invoice','Customer Complaints','Directors','Investors','Reports','To-Do','Users','Settings']; let currentTab=TABS[0];
function setTab(t){ currentTab=t; render(); }
function renderNav(){ const nav=document.getElementById('nav'); nav.innerHTML=''; TABS.forEach(t=>{ if(!canTab(t)) return; if(t==='Settings'&&!canSettings()) return; const b=document.createElement('button'); b.textContent=t; if(t===currentTab) b.classList.add('active'); b.onclick=()=>setTab(t); nav.appendChild(b); }); }

function ensureIdsEverywhere(){
  const sections = [
    'vehicles','sales','vehicleExpenses','showroomExpenses','credits','complaints',
    'investors','partners','todo','users','purchaseInvoices','audit'
  ];
  sections.forEach(sec=>{
    if (!Array.isArray(db[sec])) return;
    db[sec].forEach(item=>{
      if (item && !item.id) item.id = uid();
    });
  });
}

function dedupeVehiclesByReg(){
  if (!Array.isArray(db.vehicles)) return;
  const seen = new Set();
  const out = [];
  // keep newest first if createdAt exists
  const arr = db.vehicles.slice().sort((a,b)=>{
    const da = (a && (a.createdAt || a.updatedAt)) ? String(a.createdAt || a.updatedAt) : '';
    const dbb = (b && (b.createdAt || b.updatedAt)) ? String(b.createdAt || b.updatedAt) : '';
    return dbb.localeCompare(da);
  });

  for(const v of arr){
    const reg = String(v?.reg || '').toUpperCase().replace(/\s+/g,'').trim();
    if(!reg){ out.push(v); continue; }
    if(seen.has(reg)) continue;
    seen.add(reg);
    out.push(v);
  }
  db.vehicles = out;
}

function normReg(x){
  return String(x||'').toUpperCase().replace(/\s+/g,'').trim();
}

function relinkVehicleRefsByReg(){
  // Build reg -> kept vehicleId map from CURRENT db.vehicles (after dedupe)
  const regToId = Object.create(null);
  (db.vehicles || []).forEach(v=>{
    const r = normReg(v && v.reg);
    if (r && v && v.id) regToId[r] = v.id;
  });

  // Helper: if record has vehicleId, try relink by reg field (or by lookup)
  const fixList = (arrName, getRegFn) => {
    if (!Array.isArray(db[arrName])) return;
    let changed = 0;
    db[arrName].forEach(rec=>{
      const reg = normReg(getRegFn(rec));
      if (!reg) return;
      const newVid = regToId[reg];
      if (newVid && rec.vehicleId && rec.vehicleId !== newVid){
        rec.vehicleId = newVid;
        changed++;
      }
      // If vehicleId missing but reg exists, attach it
      if (newVid && !rec.vehicleId){
        rec.vehicleId = newVid;
        changed++;
      }
    });
    return changed;
  };

  // SALES: infer reg from linked vehicle OR from fields if present
  fixList('sales', (s)=>{
    // try direct from vehicleId first
    const v = (db.vehicles||[]).find(x=>x.id===s.vehicleId);
    return (v && v.reg) || s.reg || '';
  });

  // VEHICLE EXPENSES: by vehicleId -> vehicle.reg
  fixList('vehicleExpenses', (e)=>{
    const v = (db.vehicles||[]).find(x=>x.id===e.vehicleId);
    return (v && v.reg) || e.reg || '';
  });

  // CREDITS: you store reg in UI as typed; but record may have vehicleId too
  fixList('credits', (c)=> c.reg || c.vehicleReg || '');

  // COMPLAINTS (if you store reg on complaint records)
  fixList('complaints', (c)=> c.reg || c.vehicleReg || '');

  // PURCHASE INVOICES (if they reference vehicles)
  fixList('purchaseInvoices', (p)=> p.reg || p.vehicleReg || '');

  // optional: keep db.sales consistent newest-first
  if (Array.isArray(db.sales)){
    db.sales.sort((a,b)=> String(b.date||'').localeCompare(String(a.date||'')));
  }
}

function dedupeSalesById(){
  if (!Array.isArray(db.sales)) return;
  const byId = Object.create(null);
  for (const s of db.sales){
    if (!s) continue;
    const id = s.id || uid();
    s.id = id;
    byId[id] = s;
  }
  db.sales = Object.values(byId).sort((a,b)=>{
    const da = String(a.date || '');
    const dbb = String(b.date || '');
    return dbb.localeCompare(da);
  });
}

function dedupeShowroomExpenses(){
  if (!Array.isArray(db.showroomExpenses)) return;

  const seen = new Set();
  const out = [];

  const arr = db.showroomExpenses.slice().sort((a,b)=>{
    const da = String(a?.date || a?.ts || a?.createdAt || a?.updatedAt || '');
    const dbb = String(b?.date || b?.ts || b?.createdAt || b?.updatedAt || '');
    return dbb.localeCompare(da); // newest first
  });

  for (const x of arr){
    if (!x) continue;

    const key = [
      String(x.date||'').trim(),
      String(x.type||'').trim().toLowerCase(),
      String(x.method||'').trim().toLowerCase(),
      Number(x.amount||0).toFixed(2),
      String(x.note||x.desc||'').trim().toLowerCase()
    ].join('|');

    if (seen.has(key)) continue;
    seen.add(key);
    out.push(x);
  }

  db.showroomExpenses = out;
}

function dedupeVehicleExpenses(){
  if (!Array.isArray(db.vehicleExpenses)) return;

  const seen = new Set();
  const out = [];

  const arr = db.vehicleExpenses.slice().sort((a,b)=>{
    const da = String(a?.date || a?.ts || a?.createdAt || a?.updatedAt || '');
    const dbb = String(b?.date || b?.ts || b?.createdAt || b?.updatedAt || '');
    return dbb.localeCompare(da); // newest first
  });

  for (const x of arr){
    if (!x) continue;

    const key = [
      String(x.vehicleId || '').trim(),
      String(x.date||'').trim(),
      String(x.type||'').trim().toLowerCase(),
      String(x.method||'').trim().toLowerCase(),
      Number(x.amount||0).toFixed(2),
      String(x.note||'').trim().toLowerCase()
    ].join('|');

    if (seen.has(key)) continue;
    seen.add(key);
    out.push(x);
  }

  db.vehicleExpenses = out;
}

function dedupeCredits(){
  if (!Array.isArray(db.credits)) return;

  const seen = new Set();
  const out = [];

  const arr = db.credits.slice().sort((a,b)=>{
    const da = String(a?.date || a?.ts || a?.createdAt || a?.updatedAt || '');
    const dbb = String(b?.date || b?.ts || b?.createdAt || b?.updatedAt || '');
    return dbb.localeCompare(da); // newest first
  });

  for (const x of arr){
    if (!x) continue;

    const key = [
      String(x.date||'').trim(),
      String(x.customer||'').trim().toLowerCase(),
      String(x.vehicle||x.reg||'').trim().toUpperCase(),
      String(x.type||'').trim().toLowerCase(),
      String(x.method||'').trim().toLowerCase(),
      Number(x.amount||0).toFixed(2),
      String(x.reason||'').trim().toLowerCase(),
      String(x.invoiceNo||'').trim().toLowerCase()
    ].join('|');

    if (seen.has(key)) continue;
    seen.add(key);
    out.push(x);
  }

  db.credits = out;
}

function dedupeAllExpensesAndCredits(){
  dedupeShowroomExpenses();
  dedupeVehicleExpenses();
  dedupeCredits();
}

function render(){
  if(!session){ showLogin(true); return; }
  renderNav();
  const app=document.getElementById('app'); app.innerHTML=''; document.getElementById('who').textContent='Logged in: '+session.username+' ('+session.role+')';
  const views={Dashboard:viewDashboard,Vehicles:viewVehicles,Expenses:viewExpenses,Showroom:viewShowroom,Sales:viewSales,Sold:viewSold,Credit:viewCredit,["Purchase Invoice"]:viewPurchaseInvoice,["Customer Complaints"]:viewComplaints,Directors:viewDirectors,Investors:viewInvestors,Reports:viewReports,["To-Do"]:viewTodo,Users:viewUsers,Settings:viewSettings};
  const f=views[currentTab]; if(f) app.appendChild(f()); else app.textContent='No view'; refreshLogoBox();
  
  // Re-apply push button state after rendering Settings tab
  if(currentTab === 'Settings') {
    setTimeout(function() {
      if(pushEnabled) {
        enablePushButton();
      } else {
        disablePushButton();
      }
    }, 100);
  }
  applyPullLockUI();
}

/* ========= Finance helpers ========= */

function validateSaleEdit(obj){
  const reg = (obj.reg||'').toUpperCase().trim();
  if(!reg || reg.length<5 || /[^A-Z0-9]/i.test(reg)){ 
    alert('Please enter a valid REG (letters/numbers only).'); 
    return false; 
  }
  return true;
}

function calcBalances(){
  let bank=Number(db.company.openingBank||0), cash=Number(db.company.openingCash||0);
  (db.partners||[]).forEach(p=> (p.tx||[]).forEach(t=>{ if(t.method==='cash'){ if(t.type==='invest'||t.type==='profit') cash+=+t.amount||0; if(t.type==='withdraw') cash-=+t.amount||0; } else { if(t.type==='invest'||t.type==='profit') bank+=+t.amount||0; if(t.type==='withdraw') bank-=+t.amount||0; }}));
  (db.investors||[]).forEach(i=> (i.tx||[]).forEach(t=>{ if(t.method==='cash'){ if(t.type==='fund_in') cash+=+t.amount||0; if(t.type==='withdraw') cash-=+t.amount||0; } else { if(t.type==='fund_in') bank+=+t.amount||0; if(t.type==='withdraw') bank-=+t.amount||0; }}));
  (db.sales||[]).forEach(s=>{ cash+=+s.cash||0; bank+=+s.card||0; bank+=+s.bank||0; bank+=+s.finance||0; cash+=+s.deposit||0; });
  (db.vehicleExpenses||[]).forEach(e=>{ if((e.method||'bank')==='cash') cash-=+e.amount||0; else bank-=+e.amount||0; });
  (db.showroomExpenses||[]).forEach(e=>{ if((e.method||'bank')==='cash') cash-=+e.amount||0; else bank-=+e.amount||0; });
  (db.credits||[]).forEach(c=>{ if((c.method||'bank')==='cash') cash-=+c.amount||0; else bank-=+c.amount||0; });
  return {bank,cash};
}

/* ========= Global helper ========= */
function findVehicleIdByReg(reg){
  reg = (reg || '').toUpperCase().trim();
  const v = (db.vehicles || []).find(x => (x.reg || '').toUpperCase() === reg);
  return v ? v.id : null;
}

/* ========= Invoice Number Helper ========= */
function getNextInvoiceNo() {
  const sales = db.sales || [];
  if (!sales.length) return '1000'; // starting number

  let maxNum = 999;

  sales.forEach(s => {
    const raw = (s.invNo == null ? '' : String(s.invNo)).trim();
    if (!raw) return;
    const n = parseInt(raw, 10);
    if (!isNaN(n) && n > maxNum) maxNum = n;
  });

  return String(maxNum + 1);
}

function syncSoldStatusFromSales() {
  const soldIds = new Set(
    (db.sales || [])
      .filter(s => !s.refunded)
      .map(s => s.vehicleId)
  );

  (db.vehicles || []).forEach(v => {
    if (!v) return;
    if (soldIds.has(v.id)) {
      v.status = 'sold';
    }
  });
}

/* ========= Dashboard ========= */
function viewDashboard(){
  syncSoldStatusFromSales();
  const card=document.createElement('div'); card.className='card';
  const options=(db.vehicles||[]).map(v=>`<option value="${(v.reg||'').toUpperCase()}">`).join('');
  const dirTotal=(db.partners||[]).reduce((t,p)=>t+Number(p.balance||0),0);
  const invTotal=(db.investors||[]).reduce((t,i)=>t+Number(i.balance||0),0);
  const vehSpend=(db.vehicles||[]).reduce((t,v)=>t+Number(v.purchase||0),0);
  const vExp=(db.vehicleExpenses||[]).reduce((t,e)=>t+Number(e.amount||0),0);
  const sExp=(db.showroomExpenses||[]).reduce((t,e)=>t+Number(e.amount||0),0);
  const bal=calcBalances();
  const inStockVehicles = (db.vehicles || []).filter(v => v.status !== 'sold');
  const inStock = inStockVehicles.length;
  const inStockIds = new Set(inStockVehicles.map(v => v.id));

  const stockPurchase = inStockVehicles
  .reduce((t, v) => t + Number(v.purchase || 0), 0);

  const stockVehExpTotal = (db.vehicleExpenses || [])
  .filter(e => inStockIds.has(e.vehicleId))
  .reduce((t, e) => t + Number(e.amount || 0), 0);

  const stockValue = stockPurchase + stockVehExpTotal;

  card.innerHTML=`<h2>Dashboard</h2>
  <div class="grid4">
    <div class="card"><div class="small">Directors Invested (balance)</div><div class="stat">${fmtMoney(dirTotal)}</div></div>
    <div class="card"><div class="small">Investors Funds (balance)</div><div class="stat">${fmtMoney(invTotal)}</div></div>
    <div class="card"><div class="small">Vehicles In Stock</div><div class="stat">${inStock}</div></div>
    <div class="card"><div class="small">Estimated Bank / Cash</div><div class="stat">${fmtMoney(bal.bank)} &nbsp;|&nbsp; ${fmtMoney(bal.cash)}</div></div>
  </div>
  <div class="grid3">
    <div class="card">
    <div class="small">Current Stock Purchase (in-stock vehicles)</div>
    <div class="stat">${fmtMoney(stockPurchase)}</div>
  </div>
  <div class="card">
    <div class="small">Current Stock Vehicle Expenses</div>
    <div class="stat">${fmtMoney(stockVehExpTotal)}</div>
  </div>
  <div class="card">
    <div class="small">Current Stock Value (purchase + expenses)</div>
    <div class="stat">${fmtMoney(stockValue)}</div>
  </div>
  </div>
  <div class="row">
    <input id="dash_reg" list="reglist" placeholder="Type REG‚Ä¶ (e.g., AB12CDE)" style="min-width:220px">
    <datalist id="reglist">${options}</datalist>
    <button id="dash_show" class="primary">Show</button>
  </div>
  <div id="dash_result" class="card" style="margin-top:10px"></div>`;
  
  const sum=(arr,p)=>(arr||[]).reduce((t,x)=>t+Number(p?p(x):x||0),0);
  
  function showResultByReg(reg){
    reg=(reg||'').toUpperCase().trim(); 
    const v=db.vehicles.find(x=>(x.reg||'').toUpperCase()===reg);
    const out=card.querySelector('#dash_result'); 
    
    if(!v){ 
      out.innerHTML='<span class="small">No vehicle found.</span>'; 
      return; 
    }
    
    const vexp=(db.vehicleExpenses||[]).filter(e=>e.vehicleId===v.id); 
    const totalExp=sum(vexp,e=>e.amount); 
    const totalCost=Number(v.purchase||0)+totalExp;
    
    let mediaHtml='';
    if((v.media||[]).length){ 
      mediaHtml += '<div class="previewStrip">'+v.media.map(u=>`<img src="${u}" alt="media">`).join('')+'</div>'; 
    }
    if(v.video){ 
      mediaHtml += `<div class="small">YouTube: ${v.video}</div>`; 
    }
    
    // Check if this vehicle was sold and generated a part-exchange
    let saleInfo = '';
    const generatedPx = db.vehicles.find(vh => vh.originalSaleId && vh.originalSaleId === v.id);
    if (generatedPx) {
      saleInfo = `
        <tr>
          <th>Generated Part-exchange</th>
          <td>
            Vehicle was sold and customer traded in: ${generatedPx.reg}
            <br>
            <small style="color:#ff6b6b;">
              Part-ex vehicle: ${generatedPx.make || ''} ${generatedPx.model || ''}
              <br>
              Part-ex value: ${fmtMoney(generatedPx.purchase || 0)}
              <br>
              ${generatedPx.status === 'sold' ? '‚ö†Ô∏è Part-ex already sold' : '‚úÖ Part-ex in stock'}
            </small>
          </td>
        </tr>
      `;
    }
    
    let rows=vexp.map(e=>`<tr><td>${ddmmyyyy(e.date||'')}</td><td>${e.type||''}</td><td class="right">${fmtMoney(e.amount)}</td><td>${e.note||''}</td></tr>`).join('');
    if(!rows) rows='<tr><td colspan="4" class="small">No expenses yet</td></tr>';
    
    out.innerHTML=`<div class="row"><span class="badge">${v.status||'for sale'}</span>&nbsp;<b>${v.reg}</b>&nbsp;${v.make||''} ${v.model||''}</div>
      ${mediaHtml}
      <table class="table"><tbody>
      <tr><th style="width:220px">Purchase</th><td class="right">${fmtMoney(v.purchase||0)}</td></tr>
      <tr><th>Total Expenses</th><td class="right">${fmtMoney(totalExp)}</td></tr>
      <tr><th>Total Cost (incl. expenses)</th><td class="right">${fmtMoney(totalCost)}</td></tr>
      ${v.supplier === 'PART-EX' ? `<tr><th>Supplier Type</th><td>PART-EX</td></tr>` : ''}
      ${v.supplierNote ? `<tr><th>Supplier Note</th><td>${v.supplierNote}</td></tr>` : ''}
      ${saleInfo}
      </tbody></table>
      <h4>Expenses</h4><table class="table"><thead><tr><th>Date</th><th>Type</th><th class="right">Amount</th><th>Note</th></tr></thead><tbody>${rows}</tbody></table>`;
  }
  
  card.querySelector('#dash_show').onclick=()=>showResultByReg(card.querySelector('#dash_reg').value);
  card.querySelector('#dash_reg').addEventListener('change',()=>showResultByReg(card.querySelector('#dash_reg').value));
  card.querySelector('#dash_reg').addEventListener('keydown',(e)=>{ if(e.key==='Enter') showResultByReg(card.querySelector('#dash_reg').value); });
  
  return card;
}

/* ========= Vehicles ========= */
function viewVehicles(){
  if(!canTab('Vehicles')) return document.createElement('div'); const wrap=document.createElement('div'); wrap.className='card';
  wrap.innerHTML=`<h2>Vehicles</h2>
  <div class="row">
    <label>REG *<input id="v_reg" placeholder="AB12CDE"><button id="v_mot" type="button">DVSA Lookup</button></label>
    <label>Make<input id="v_make"></label>
    <label>Model<input id="v_model"></label>
    <label>Colour<input id="v_colour"></label>
    <label>Fuel<input id="v_fuel" placeholder="PETROL/DIESEL/EV"></label>
    <label>Engine Size<input id="v_engineSize" placeholder="e.g. 1998"></label>
    <label>Mileage<input id="v_mileage" type="number" placeholder="0"></label>
    <label>Purchase ¬£<input id="v_purchase" type="number" placeholder="0"></label>
    <label>Purchase Date<input id="v_purchaseDate" type="date"></label>
    <label>Date of First Reg<input id="v_firstReg" type="date"></label>
    <label>Owner Type<select id="v_ownerType"><option value="owned">owned</option><option value="investor">investor</option></select></label>
    <label>Investor
  <select id="v_investor">
    <option value="">-- Select investor (if any) --</option>
  </select>
  </label>
    <label>Supplier Invoice #<input id="v_supplier" placeholder="INV-001"></label>
    <label>VIN (optional)<input id="v_vin"></label>
    <label>MOT Expiry<input id="v_motExpiry" type="date" placeholder="Optional"></label>
    <label>Status<select id="v_status"><option value="for sale">for sale</option><option value="sold">sold</option></select></label>
  </div>
  <div class="row">
    <button id="v_add" class="primary">Add / Update</button>
  </div>

  <div class="row" style="display: flex; align-items: center; gap: 12px; margin-top: 12px;">
    <button id="veh_mot_refresh" type="button">Update MOT Expiry (Stock)</button>
    <span id="veh_mot_progress" class="small" style="margin-left:auto;"></span>
    <input id="veh_search" placeholder="Search reg/make/model/supplier">
    <label class="small" style="display: flex; align-items: center; margin: 0;">
      <input type="checkbox" id="veh_instock" checked> In stock only
    </label>
    <label class="small" style="display: flex; align-items: center; margin: 0;">
      <input type="checkbox" id="veh_soldonly"> Sold only
    </label>
    <label class="small" style="display: flex; align-items: center; margin: 0;">
      <input type="checkbox" id="veh_investoronly"> Investor stock
    </label>
    <label class="small" style="display: flex; align-items: center; margin: 0;">
      <input type="checkbox" id="veh_pxonly"> Part-ex only
    </label>
    <!-- NEW: MOT Expiry Filter -->
    <label class="small" style="display: flex; align-items: center; margin: 0;">
      <select id="veh_motFilter" style="padding: 4px 6px; font-size: 12px; background: #0f1628; border: 1px solid var(--line); color: var(--ink); border-radius: 6px;">
        <option value="">MOT Expiry</option>
        <option value="expired">Expired</option>
        <option value="30">Less than 30 days</option>
        <option value="60">Less than 60 days</option>
        <option value="90">Less than 90 days</option>
        <option value="valid">Valid MOT</option>
      </select>
    </label>
    <button onclick="exportVehiclesCSV()">Export CSV</button>
  </div>

  <table class="table" style="margin-top:10px"><thead><tr><th>Reg</th><th>Make</th><th>Model</th><th>Colour</th><th>Mileage</th><th>Fuel</th><th>Engine Size</th><th>First Reg</th><th>Purchase Date</th><th>Type</th><th>Investor</th><th>Purchase</th><th>VIN</th><th>MOT Expiry</th><th>Supplier #</th><th>Actions</th></tr></thead><tbody id="vehBody"></tbody></table>
  <div class="small" style="margin-top:8px">Note: DVLA proxy required in Settings. DVLA may not return Model/VIN.</div>`;
  
  // Populate investor dropdown from db.investors
  const invSel = wrap.querySelector('#v_investor');
  if (invSel) {
    invSel.innerHTML =
      '<option value="">-- Select investor (if any) --</option>' +
      (db.investors || [])
        .map(i => `<option value="${i.id}">${i.name}</option>`)
        .join('');
  }

  let editId=null; const body=wrap.querySelector('#vehBody');

  function rows(q='', mode='instock'){
  body.innerHTML='';
  q=(q||'').toLowerCase().trim();
  
  // Get filter states
  const instockOnly = wrap.querySelector('#veh_instock')?.checked;
  const soldOnly = wrap.querySelector('#veh_soldonly')?.checked;
  const investorOnly = wrap.querySelector('#veh_investoronly')?.checked;
  const pxOnly = wrap.querySelector('#veh_pxonly')?.checked;
  const motFilter = wrap.querySelector('#veh_motFilter')?.value || '';
  
  (db.vehicles||[]).forEach(v=>{
    // Apply filters...
    if (instockOnly && v.status === 'sold') return;
    if (soldOnly && v.status !== 'sold') return;
    
    // Apply investor stock filter
    if (investorOnly && v.ownerType !== 'investor') return;
    
    // Apply part-ex filter
    if (pxOnly && v.supplier !== 'PART-EX') return;
    
    // Apply search filter
    if (q) {
      const hay = ((v.reg || '') + ' ' + (v.make || '') + ' ' + (v.model || '') + ' ' + (v.supplier || '')).toLowerCase();
      if (!hay.includes(q)) return;
    }
    
    // Apply MOT expiry filter
    if (motFilter) {
        const motDate = v.motExpiry || v.lastMotExpiry || '';
        if (!motDate) {
        return;
        }
        const expiry = new Date(motDate);
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        expiry.setHours(0, 0, 0, 0);
        const diffMs = expiry - today;
        const diffDays = Math.ceil(diffMs / (1000 * 60 * 60 * 24));
        
        switch(motFilter) {
          case 'expired':
            if (diffDays >= 0) return; // Skip if not expired
            break;
          case '30':
            if (diffDays <= 0 || diffDays > 30) return;
            break;
          case '60':
            if (diffDays <= 0 || diffDays > 60) return;
            break;
          case '90':
            if (diffDays <= 0 || diffDays > 90) return;
            break;
          case 'valid':
            if (diffDays < 0) return; // Skip if expired
            break;
        }
      }
    
    const tr=document.createElement('tr');
    const mcount=(v.media||[]).length + ((v.video&&1)||0);
    tr.innerHTML=`<td>${v.reg||''}</td>
    <td>${v.make||''}</td>
    <td>${v.model||''}</td>
    <td>${v.colour||''}</td>
    <td>${v.mileage||''}</td>
    <td>${v.fuel||''}</td>
    <td>${v.engineSize||''}</td>
    <td>${ddmmyyyy(v.firstReg||'')}</td>
    <td>${ddmmyyyy(v.purchaseDate||'')}</td>
    <td>${v.ownerType||'owned'}</td>
    <td>${v.investor||''}</td>
    <td class="right">${fmtMoney(v.purchase||0)}</td>
    <td style="text-align:center;" title="${v.vin || ''}">${v.vin ? 'üÜî' : ''}</td>
    <td>${(() => {const motDate = v.motExpiry || v.lastMotExpiry || '';if (!motDate) return '';const expiry = new Date(motDate);const today = new Date();today.setHours(0, 0, 0, 0);expiry.setHours(0, 0, 0, 0);const diffMs = expiry - today;const diffDays = Math.ceil(diffMs / (1000 * 60 * 60 * 24));let icon = 'üìÖ';let color = '#a3b2cc';if (diffDays < 0) {icon = '‚ö†Ô∏è';color = '#ff6b6b';} else if (diffDays <= 30) {icon = '‚è≥';color = '#ffa726';} else if (diffDays <= 90) {icon = '‚úÖ';color = '#2ecc71';}return `<span title="${ddmmyyyy(motDate)}" style="cursor:help;color:${color}">${icon}${Math.abs(diffDays)}</span>`;})()}</td>
    <td>${v.supplier||''}${v.supplierNote ? '<br><small style="color:#53a8ff;">' + v.supplierNote + '</small>' : ''}</td>
    <td>${canAction('edit')?`<button data-act="edit" data-id="${v.id}">Edit</button>`:''} ${canAction('del')?`<button class="danger" data-act="del" data-id="${v.id}">Delete</button>`:''} ${v.originalSaleId?`<button data-act="viewSale" data-id="${v.originalSaleId}" title="View original sale" style="margin-left:4px;">üìã</button>`:''}</td>`;
    body.appendChild(tr);
    });
  };
  rows('', 'instock');

  function applyVehFilter(){
  const q=(wrap.querySelector('#veh_search') && wrap.querySelector('#veh_search').value) || '';
  
  // Get all checkbox states
  const chkIn=wrap.querySelector('#veh_instock'); 
  const chkSold=wrap.querySelector('#veh_soldonly');
  const chkInvestor=wrap.querySelector('#veh_investoronly');
  const chkPx=wrap.querySelector('#veh_pxonly');
  
  // Determine mode based on checked checkboxes
  let mode = 'all';
  if (chkSold && chkSold.checked) mode = 'sold';
  else if (chkIn && chkIn.checked) mode = 'instock';
  
  // Call rows with all parameters
  rows(q, mode);
  }
  
  const SRCH=wrap.querySelector('#veh_search'); 
  if(SRCH) SRCH.addEventListener('input', applyVehFilter);

  const CHK_IN=wrap.querySelector('#veh_instock'); 
  if(CHK_IN) CHK_IN.addEventListener('change', (e)=>{
  if(e.target.checked){ 
    const s=wrap.querySelector('#veh_soldonly'); 
    if(s) s.checked=false; 
    const inv=wrap.querySelector('#veh_investoronly'); 
    if(inv) inv.checked=false; 
    const px=wrap.querySelector('#veh_pxonly'); 
    if(px) px.checked=false; 
  } 
  applyVehFilter(); 
  });

  const CHK_SOLD=wrap.querySelector('#veh_soldonly'); 
  if(CHK_SOLD) CHK_SOLD.addEventListener('change', (e)=>{ 
  if(e.target.checked){ 
    const s=wrap.querySelector('#veh_instock'); 
    if(s) s.checked=false; 
    const inv=wrap.querySelector('#veh_investoronly'); 
    if(inv) inv.checked=false; 
    const px=wrap.querySelector('#veh_pxonly'); 
    if(px) px.checked=false; 
  } 
  applyVehFilter(); 
  });

  const CHK_INVESTOR=wrap.querySelector('#veh_investoronly'); 
  if(CHK_INVESTOR) CHK_INVESTOR.addEventListener('change', (e)=>{ 
  if(e.target.checked){ 
    const s=wrap.querySelector('#veh_instock'); 
    if(s) s.checked=false; 
    const sold=wrap.querySelector('#veh_soldonly'); 
    if(sold) sold.checked=false; 
    const px=wrap.querySelector('#veh_pxonly'); 
    if(px) px.checked=false; 
  } 
  applyVehFilter(); 
  });

  const CHK_PX=wrap.querySelector('#veh_pxonly'); 
  if(CHK_PX) CHK_PX.addEventListener('change', (e)=>{ 
  if(e.target.checked){ 
    const s=wrap.querySelector('#veh_instock'); 
    if(s) s.checked=false; 
    const sold=wrap.querySelector('#veh_soldonly'); 
    if(sold) sold.checked=false; 
    const inv=wrap.querySelector('#veh_investoronly'); 
    if(inv) inv.checked=false; 
  } 
  applyVehFilter(); 
  });

  // NEW: MOT filter change listener
  const MOT_FILTER = wrap.querySelector('#veh_motFilter');
  if(MOT_FILTER) {
    MOT_FILTER.addEventListener('change', applyVehFilter);
  }

  wrap.addEventListener('click',(ev)=>{ const b=ev.target.closest('button'); if(!b) return; const id=b.dataset.id,act=b.dataset.act;
    if(act==='edit'){ 
      if(!canAction('edit')) return alert('No permission'); 
      const v=db.vehicles.find(x=>x.id===id); 
      editId=id;
      
      // Populate all standard fields
      ['v_reg','v_make','v_model','v_colour','v_fuel','v_engineSize','v_mileage','v_purchase',
       'v_purchaseDate','v_firstReg','v_ownerType','v_supplier','v_status','v_vin','v_motExpiry','v_video']
      .forEach(k => {
        const el = wrap.querySelector('#' + k);
        if (!el) return;
        const key = k.replace(/^v_/,'');
        el.value = (v[key] ?? '');
      });

      // Set investor dropdown from investorId (fallback to name)
      const invSel2 = wrap.querySelector('#v_investor');
      if (invSel2) {
        let invId = v.investorId || '';
        if (!invId && v.investor) {
          const found = (db.investors || []).find(i => (i.name || '') === v.investor);
          if (found) invId = found.id;
        }
        invSel2.value = invId || '';
      }
      
      // ADDED: Create hidden fields to preserve part-ex specific data
      // Remove any existing hidden fields first
      ['v_supplierNote', 'v_originalSaleId'].forEach(field => {
        const existing = wrap.querySelector(`#${field}`);
        if (existing) existing.remove();
      });
      
      // Add hidden fields for part-ex data if they exist
      if (v.supplierNote) {
        const hiddenNote = document.createElement('input');
        hiddenNote.type = 'hidden';
        hiddenNote.id = 'v_supplierNote';
        hiddenNote.value = v.supplierNote || '';
        wrap.appendChild(hiddenNote);
      }
      
      if (v.originalSaleId) {
        const hiddenSaleId = document.createElement('input');
        hiddenSaleId.type = 'hidden';
        hiddenSaleId.id = 'v_originalSaleId';
        hiddenSaleId.value = v.originalSaleId || '';
        wrap.appendChild(hiddenSaleId);
      }
      document.getElementById('app').scrollIntoView({ behavior: 'smooth' });

    
    }else if(act==='del'){ 
    if(!canAction('del')) return alert('No permission'); 
    if(!confirm('Delete vehicle?')) return; 
    const delV=db.vehicles.find(x=>x.id===id); 

    // Mark deletion so it syncs to other PCs
    markDeleted('vehicles', id);

    db.vehicles=db.vehicles.filter(x=>x.id!==id); 
    db.vehicleExpenses=db.vehicleExpenses.filter(e=>e.vehicleId!==id); 

    saveDB(); 
    try{renderAlertBell();}catch(e){}; 
    addAudit('delete','vehicle',id,delV?delV.reg:''); 
    rows(); 
    }
    
    else if(act==='viewSale'){
      const sale = db.sales.find(x => x.id === id);
      if(sale) {
        const originalVehicle = db.vehicles.find(x => x.id === sale.vehicleId);
        const buyer = sale.buyer || 'Unknown';
        const saleDate = ddmmyyyy(sale.date);
        const price = fmtMoney(sale.salePrice);
        alert(`Part-ex Source Details:\n\nSold to: ${buyer}\nDate: ${saleDate}\nPrice: ${price}\nVehicle: ${originalVehicle?.reg || ''} ${originalVehicle?.make || ''} ${originalVehicle?.model || ''}\nInvoice #: ${sale.invNo || ''}\nPart-ex Allowance: ${fmtMoney(sale.pxAllowance || 0)}`);
      }
    }
  });

  const motBtn = wrap.querySelector('#v_mot');
  if (motBtn) {
  motBtn.onclick = async () => {

  const reg = (wrap.querySelector('#v_reg').value || '').trim().toUpperCase();
  if (!reg) return alert('Enter REG first');

  // Use DVSA proxy (not DVLA) URL from settings
  const url = db.company.dvsaProxy || '';
  if (!url) return alert('Add DVSA / MOT Proxy URL in Settings first.');

  const btn = motBtn;
  const originalText = btn.textContent;
  btn.textContent = 'Checking MOT...';
  btn.disabled = true;

  // small helper to read a field from multiple possible paths
  const pick = (obj, ...paths) => {
    for (const p of paths) {
      if (!obj) continue;
      // allow nested path arrays like ['raw','make'] or simple string 'make'
      if (Array.isArray(p)) {
        let cur = obj;
        let ok = true;
        for (const k of p) {
          if (cur && (k in cur)) cur = cur[k]; else { ok = false; break; }
        }
        if (ok && cur != null) return cur;
      } else {
        if (p in obj && obj[p] != null) return obj[p];
      }
    }
    return undefined;
  };

  try {
    const res = await fetch(url, {
      method: 'POST',
      headers: { 'content-type': 'application/json' },
      body: JSON.stringify({ reg })
    });

    const text = await res.text();
    if (!res.ok) throw new Error('DVSA error ' + res.status + ': ' + text);

    let data;
    try { data = JSON.parse(text); } catch (e) { alert("DVSA returned invalid JSON"); return; }

    // Accept several possible shapes:
    // - array of vehicle objects
    // - single vehicle object with motTests
    // - object that wraps with .data or .vehicle
    if (!Array.isArray(data)) {
      if (data && typeof data === 'object') {
        if (Array.isArray(data.data)) data = data.data;
        else if (data.vehicle) data = [data.vehicle];
        else if (data.motTests || data.registration) data = [data];
        else if (data.results && Array.isArray(data.results)) data = data.results;
      }
    }

    if (!Array.isArray(data) || data.length === 0) {
      alert(
        "MOT proxy returned wrong format or no data.\n\nGot:\n" +
        JSON.stringify(data, null, 2).slice(0, 500)
      );
      return;
    }

    const vehicle = data[0];

    // tests list may be nested differently; prefer vehicle.motTests or vehicle.tests or vehicle.testsData
    const tests = pick(vehicle, 'motTests', 'tests', ['data','motTests']) || [];
    const latest = Array.isArray(tests) && tests.length ? tests[0] : null;

    // robust field picking: top-level, raw.*, alternative names
    const makeVal = pick(vehicle, 'make', ['raw','make'], 'vehicleMake', 'manufacturer');
    const modelVal = pick(vehicle, 'model', ['raw','model'], 'product', 'vehicleModel');
    const colourVal = pick(vehicle, 'primaryColour', 'colour', ['raw','colour'], 'vehicleColour');
    const fuelVal = pick(vehicle, 'fuelType', 'fuel', ['raw','fuelType']);
    const engineVal = pick(vehicle, 'engineSize', 'engine_size', ['raw','engineSize']);
    const regReturned = pick(vehicle, 'registration', 'reg', 'registrationNumber');
    const vinVal = pick(vehicle, 'vin', ['raw','vin'], 'vehicleIdentificationNumber');

    // first reg handling (various formats)
    if (pick(vehicle, 'registrationDate', ['raw','registrationDate'], 'firstRegistration')) {
      let s = pick(vehicle, 'registrationDate', ['raw','registrationDate'], 'firstRegistration');
      let val = '';
      s = String(s || '').trim();
      if (/^\d{4}-\d{2}$/.test(s)) val = s + '-01';
      else if (/^\d{4}-\d{2}-\d{2}$/.test(s)) val = s;
      else {
        const d = new Date(s);
        if (!isNaN(d)) val = d.toISOString().slice(0,10);
      }
      if (val) {
        const firstRegInput = wrap.querySelector('#v_firstReg');
        if (firstRegInput) firstRegInput.value = val;
      }
    }

    const setField = (selector, value, force = false) => {
      if (value == null || value === '') return;
      const el = wrap.querySelector(selector);
      if (!el) return;
      // If force=true, always overwrite. Otherwise overwrite only if empty.
      if (force || !el.value || String(el.value).trim() === '') el.value = String(value);
    };

    setField('#v_make', makeVal, true);
    setField('#v_model', modelVal || pick(vehicle, 'modelName', ['raw','modelName']), true);
    setField('#v_colour', colourVal ? String(colourVal).toUpperCase() : undefined, true);
    setField('#v_fuel', fuelVal ? String(fuelVal).toUpperCase() : undefined, true);
    setField('#v_engineSize', engineVal ? String(engineVal) : undefined, true);
    setField('#v_vin', vinVal, true);

    // Last MOT details
    if (latest) {
      if (latest.completedDate) {
        const motInput = wrap.querySelector('#v_motExpiry');
        if (motInput && (!motInput.value || motInput.value === '')) motInput.value = latest.expiryDate || latest.expiry || '';
      }
      // Also store lastMot* values on found vehicle if it exists in DB
      const found = (db.vehicles || []).find(v => (v.reg || '').toUpperCase() === reg);
      if (found) {
        if (latest.completedDate) found.lastMotDate = latest.completedDate || found.lastMotDate || '';
        if (latest.expiryDate || latest.expiry) {
          found.lastMotExpiry = latest.expiryDate || latest.expiry || found.lastMotExpiry || '';
          // Keep motExpiry in sync for filters/warnings (fallback)
          if (!found.motExpiry) found.motExpiry = found.lastMotExpiry;
        }
        if (latest.odometerValue || latest.odometer) found.lastMotMileage = latest.odometerValue || latest.odometer || found.lastMotMileage || '';
        found.updatedAt = new Date().toISOString();
        saveDB();
      }
    }

    // Build friendly message
    let msg = `Reg: ${regReturned || reg}\nMake/Model: ${makeVal || ''} ${modelVal || ''}\n\n`;
    if (latest) {
      msg += `Last MOT: ${latest.completedDate || latest.testDate || ''}\n`;
      msg += `Result: ${latest.testResult || latest.result || ''}\n`;
      msg += `Expiry: ${latest.expiryDate || latest.expiry || ''}\n`;
      msg += `Mileage: ${latest.odometerValue || latest.odometer || ''} ${latest.odometerUnit || latest.odometerUnit || ''}\n`;
    } else {
      msg += 'No MOT tests found.\n';
    }

    alert(msg);

  } catch (e) {
    alert('MOT lookup failed: ' + (e && e.message ? e.message : e));
  } finally {
    btn.textContent = originalText;
    btn.disabled = false;
  }
  };

  // ===== Bulk MOT refresh (All vehicles) =====
    function sleep(ms){ return new Promise(r=>setTimeout(r, ms)); }

    async function fetchLatestMot(reg){
      const url = db.company.dvsaProxy || '';
      if (!url) throw new Error('Add DVSA / MOT Proxy URL in Settings first.');

      const res = await fetch(url, {
        method: 'POST',
        headers: { 'content-type': 'application/json' },
        body: JSON.stringify({ reg })
      });

      const text = await res.text();
      if (!res.ok) throw new Error('DVSA error ' + res.status + ': ' + text);

      let data;
      try { data = JSON.parse(text); } catch(e){ throw new Error('DVSA returned invalid JSON'); }

      // ‚úÖ Accept both array and single-object formats
      if (!Array.isArray(data)) {
        if (data && typeof data === 'object' && data.motTests) data = [data];
        else if (Array.isArray(data.data)) data = data.data; // if your worker wraps: {data:[...]}
      }

      if (!Array.isArray(data) || !data.length) return null;

      const vehicle = data[0];
      const tests = vehicle.motTests || [];
      const latest = tests[0] || null;

      return { vehicle, latest };
    }

    const bulkBtn = wrap.querySelector('#veh_mot_refresh');
    const progEl = wrap.querySelector('#veh_mot_progress');

    if (bulkBtn) {
      bulkBtn.onclick = async () => {
        if (!confirm('Update MOT expiry for ALL vehicles? (This will take a few minutes)')) return;

        try {
          bulkBtn.disabled = true;

          const list = (db.vehicles || [])
            .filter(v => String(v.reg || '').trim())
            // default: only update in-stock vehicles (status not sold)
            .filter(v => String(v.status || '').toLowerCase() !== 'sold');

          let ok = 0, fail = 0, skipped = 0;

          for (let i = 0; i < list.length; i++) {
            const v = list[i];
            const reg = String(v.reg || '').trim().toUpperCase();

            if (progEl) progEl.textContent = `Checking ${i + 1}/${list.length}: ${reg}`;

            try {
              const out = await fetchLatestMot(reg);

              if (!out || !out.latest) { skipped++; }
              else {
                const latest = out.latest;

                v.lastMotDate = latest.completedDate || v.lastMotDate || '';
                v.lastMotExpiry = latest.expiryDate || v.lastMotExpiry || '';
                v.lastMotMileage = latest.odometerValue || v.lastMotMileage || '';

                // ‚úÖ auto-fill main motExpiry so your warnings/filters work everywhere
                v.motExpiry = latest.expiryDate || v.motExpiry || '';

                ok++;
              }
            } catch (e) {
              fail++;
            }

            // ‚úÖ throttle to avoid DVSA/proxy rate limits
            await sleep(1200);
          }

          saveDB();
          try { renderAlertBell(); } catch(e) {}

          alert(`MOT refresh complete.\n\nUpdated: ${ok}\nSkipped (no tests): ${skipped}\nFailed: ${fail}`);
        } finally {
          if (progEl) progEl.textContent = '';
          bulkBtn.disabled = false;
          // refresh the table view
          try { rows(); } catch(e) {}
        }
      };
    }
  }

  wrap.querySelector('#v_add').onclick=()=>{ if(!canAction('add')) return alert('No permission');
  const reg=(wrap.querySelector('#v_reg').value||'').toUpperCase().trim(); if(!reg){ alert('Reg is required'); return; }
  const dupe=(db.vehicles||[]).find(x=>x.reg===reg && x.id!==editId); if(dupe){ alert('Duplicate reg exists'); return; }
  const v={ 
    id:editId||uid(), 
    reg, 
    make:wrap.querySelector('#v_make').value.trim(), 
    model:wrap.querySelector('#v_model').value.trim(), 
    colour:wrap.querySelector('#v_colour').value.trim(), 
    fuel:wrap.querySelector('#v_fuel').value.trim(),
    engineSize:wrap.querySelector('#v_engineSize') ? wrap.querySelector('#v_engineSize').value.trim() : '',
    mileage:Number(wrap.querySelector('#v_mileage').value||0), 
    purchase:Number(wrap.querySelector('#v_purchase').value||0), 
    purchaseDate:wrap.querySelector('#v_purchaseDate').value,
    firstReg:wrap.querySelector('#v_firstReg').value,
    ownerType: wrap.querySelector('#v_ownerType').value,
    // investorId + investor name from dropdown
    ...(() => {
    const sel = wrap.querySelector('#v_investor');
    const invId = (sel && sel.value) || '';
    let invName = '';
    if (invId) {
    const inv = (db.investors || []).find(i => i.id === invId);
    if (inv) invName = inv.name;
    }
    return {
    investorId: invId || null,
    investor: invName // keep name for display / backwards-compat
  };
  })(),
  supplier:wrap.querySelector('#v_supplier').value.trim(), 
  // Preserve part-ex specific fields when editing
  supplierNote: wrap.querySelector('#v_supplierNote') ? wrap.querySelector('#v_supplierNote').value : (db.vehicles.find(x=>x.id===editId)?.supplierNote || ''),
  originalSaleId: wrap.querySelector('#v_originalSaleId') ? wrap.querySelector('#v_originalSaleId').value : (db.vehicles.find(x=>x.id===editId)?.originalSaleId || null),
  vin:wrap.querySelector('#v_vin').value.trim(), 
  motExpiry: wrap.querySelector('#v_motExpiry').value || '', // ADDED THIS LINE
  status:wrap.querySelector('#v_status').value,
  updatedAt: new Date().toISOString(),
  createdAt:(db.vehicles.find(x=>x.id===editId)?.createdAt)||new Date().toISOString(), 
  lastMotExpiry: (db.vehicles.find(x=>x.id===editId)?.lastMotExpiry) || '', // Preserve DVSA lookup data
  };
    if (!v.motExpiry) {
      v.lastMotExpiry = '';
      v.lastMotDate = '';
      v.lastMotMileage = '';
    }
    if(editId){ const i=db.vehicles.findIndex(x=>x.id===editId); db.vehicles[i]=v; saveDB(); try{renderAlertBell();}catch(e){}; addAudit('update','vehicle',v.id,v.reg+' '+(v.make||'')+' '+(v.model||'')); editId=null; }
    else { db.vehicles.unshift(v); saveDB(); try{renderAlertBell();}catch(e){}; addAudit('add','vehicle',v.id,v.reg+' '+(v.make||'')+' '+(v.model||'')); }
    rows(); ['v_reg','v_make','v_model','v_colour','v_fuel','v_engineSize','v_mileage','v_purchase','v_purchaseDate','v_firstReg','v_investor','v_supplier','v_vin','v_motExpiry'].forEach(k=>document.getElementById(k).value='');
    
    // Clean up hidden fields
    ['v_supplierNote', 'v_originalSaleId'].forEach(field => {
      const el = wrap.querySelector(`#${field}`);
      if (el) el.remove();
    });
  };
  return wrap;
}

// --- Expenses (with REG autocomplete) ---
function viewExpenses(){ if(!canTab('Expenses')) return document.createElement('div'); const wrap=document.createElement('div'); wrap.className='card';
  wrap.innerHTML=`<h2>Expenses (per vehicle)</h2>
  <div class="row">
    <label>Vehicle REG
      <datalist id="e_reg_list">
        ${(db.vehicles||[]).map(v=>`<option value="${(v.reg||'').toUpperCase()}">`).join('')}
      </datalist>
      <input id="e_vehicle" list="e_reg_list" placeholder="Type REG‚Ä¶" style="min-width:220px">
    </label>
    <input id="e_date" type="date"><input id="e_type" placeholder="Type (MOT/Repairs/Delivery/Advertising/Fuel‚Ä¶)"><select id="e_method"><option>bank</option><option>cash</option></select>
    <input id="e_amt" type="number" placeholder="Amount"><input id="e_note" placeholder="Note"><button id="e_add" class="primary">Add</button></div>
  <div class="row"><input id="e_search" placeholder="Search by reg to total (live calc)"></div>
  <div class="small" id="e_totHint"></div>
  <table class="table" style="margin-top:10px"><thead><tr><th>Reg</th><th>Date</th><th>Type</th><th>Method</th><th class="right">Amount</th><th>Note</th><th>Actions</th></tr></thead><tbody id="e_body"></tbody></table>`;
  const ebody=wrap.querySelector('#e_body'); let editId=null;
  function rows(list=db.vehicleExpenses){ ebody.innerHTML=''; list.forEach(e=>{ const v=db.vehicles.find(x=>x.id===e.vehicleId)||{}; const tr=document.createElement('tr');
    tr.innerHTML=`<td>${v.reg||''}</td><td>${ddmmyyyy(e.date)}</td><td>${e.type||''}</td><td>${e.method||'bank'}</td><td class="right">${fmtMoney(e.amount)}</td><td>${e.note||''}</td>
    <td>${canAction('edit')?`<button data-act="edit" data-id="${e.id}">Edit</button>`:''} ${canAction('del')?`<button class="danger" data-act="del" data-id="${e.id}">Delete</button>`:''}</td>`; ebody.appendChild(tr); }); }
  rows();
  wrap.querySelector('#e_add').onclick=()=>{ if(!canAction('add')) return alert('No permission');
    const regInput=(wrap.querySelector('#e_vehicle').value||'').toUpperCase().trim();
    const vid=findVehicleIdByReg(regInput);
    if(!vid){ return alert('Enter a valid REG from the suggestions');
    // ‚úÖ Block duplicate sales (manual typing protection)
    const vCheck = (db.vehicles || []).find(x => x.id === vid);
    const alreadySold = vCheck && String(vCheck.status || '').toLowerCase() === 'sold';
    const alreadyHasSale = (db.sales || []).some(sx => sx.vehicleId === vid && sx.id !== editId);

      if (!editId && (alreadySold || alreadyHasSale)) {
      return alert('This vehicle is already sold. You cannot record another sale for it.');
      }

    }
    const e={id:editId||uid(),vehicleId:vid,date:wrap.querySelector('#e_date').value,type:wrap.querySelector('#e_type').value.trim(),method:wrap.querySelector('#e_method').value,amount:Number(wrap.querySelector('#e_amt').value||0),note:wrap.querySelector('#e_note').value.trim()};
    if(editId){ db.vehicleExpenses=db.vehicleExpenses.map(x=>x.id===editId?e:x); addAudit('update','vehicleExpense',e.id,(db.vehicles.find(x=>x.id===e.vehicleId)||{}).reg+' '+e.type+' '+e.amount); editId=null; }
    else{ db.vehicleExpenses.unshift(e); addAudit('add','vehicleExpense',e.id,(db.vehicles.find(x=>x.id===e.vehicleId)||{}).reg+' '+e.type+' '+e.amount); }
    saveDB(); try{renderAlertBell();}catch(e){}; rows(); wrap.querySelector('#e_type').value=''; wrap.querySelector('#e_amt').value=''; wrap.querySelector('#e_note').value=''; hint();
  };
  wrap.addEventListener('click',(ev)=>{ const b=ev.target.closest('button'); if(!b) return; const id=b.dataset.id,act=b.dataset.act;
    if(act==='del'){ if(!canAction('del')) return alert('No permission'); const delE=db.vehicleExpenses.find(x=>x.id===id); if(!confirm('Delete expense?')) return; db.vehicleExpenses=db.vehicleExpenses.filter(x=>x.id!==id); saveDB(); try{renderAlertBell();}catch(e){}; addAudit('delete','vehicleExpense',id,delE?delE.type+' '+delE.amount:''); rows(); hint(); }
    else if(act==='edit'){ if(!canAction('edit')) return alert('No permission'); const e=db.vehicleExpenses.find(x=>x.id===id); editId=id; const v=db.vehicles.find(x=>x.id===e.vehicleId)||{}; wrap.querySelector('#e_vehicle').value=(v.reg||'').toUpperCase(); wrap.querySelector('#e_date').value=e.date; wrap.querySelector('#e_type').value=e.type||''; wrap.querySelector('#e_method').value=e.method||'bank'; wrap.querySelector('#e_amt').value=e.amount||0; wrap.querySelector('#e_note').value=e.note||''; document.getElementById('app').scrollIntoView({ behavior: 'smooth' });}
  });
  function hint(){ const bal=calcBalances(); wrap.querySelector('#e_totHint').textContent='Live balance after expenses ‚Äî Bank: '+fmtMoney(bal.bank)+' | Cash: '+fmtMoney(bal.cash); }
  hint();
  wrap.querySelector('#e_search').addEventListener('input',(e)=>{ const q=(e.target.value||'').toUpperCase().trim(); if(!q){ rows(); return; } const vids=db.vehicles.filter(v=>(v.reg||'').toUpperCase().includes(q)).map(v=>v.id);
    const filtered=(db.vehicleExpenses||[]).filter(x=>vids.includes(x.vehicleId)); rows(filtered); const tot=filtered.reduce((t,x)=>t+Number(x.amount||0),0); const tr=document.createElement('tr'); tr.innerHTML=`<td colspan="7" class="right"><b>Total for ${q}: ${fmtMoney(tot)}</b></td>`; ebody.appendChild(tr); });
  return wrap;
}

/* ========= Showroom ========= */
function viewShowroom(){ if(!canTab('Showroom')) return document.createElement('div'); const wrap=document.createElement('div'); wrap.className='card';
  wrap.innerHTML=`<h2>Showroom Expenses</h2>
<div class=\"row\"><input id=\"sx_month\" type=\"month\"><button id=\"sx_export\">Export PDF (month)</button></div>
  <div class="row"><input id="s_date" type="date"><input id="s_type" placeholder="Type (Rent/Wages/Web/Insurance‚Ä¶)"><select id="s_method"><option>bank</option><option>cash</option></select>
  <input id="s_amt" type="number" placeholder="Amount"><input id="s_note" placeholder="Note"><button id="s_add" class="primary">Add</button></div>
  <div class="small" id="s_totHint"></div>
  <table class="table" style="margin-top:10px"><thead><tr><th>Date</th><th>Type</th><th>Method</th><th class="right">Amount</th><th>Note</th><th>Actions</th></tr></thead><tbody id="s_body"></tbody></table>`;
  const body=wrap.querySelector('#s_body'); let editId=null; const sxMonth = wrap.querySelector('#sx_month'); if (sxMonth) sxMonth.value = new Date().toISOString().slice(0,7);
  
  function rows(){
    body.innerHTML='';

    const m = (wrap.querySelector('#sx_month')?.value || '').slice(0,7);
    const list = (db.showroomExpenses || [])
      .filter(e => !m || ymStr(e.date) === m)       // ‚úÖ show only selected month; if empty show all
      .sort((a,b) => (b.date||'').localeCompare(a.date||'')); // newest first

    list.forEach(e=>{
      const tr=document.createElement('tr');
      tr.innerHTML=`<td>${ddmmyyyy(e.date)}</td>
        <td>${e.type||''}${e.amount<0?' (credit)':''}</td>
        <td>${e.method||'bank'}</td>
        <td class="right">${e.amount<0?'<span class="bad">'+fmtMoney(e.amount)+'</span>':fmtMoney(e.amount)}</td>
        <td>${e.note||''}</td>
        <td>
          ${canAction('edit')?`<button data-act="edit" data-id="${e.id}">Edit</button>`:''}
          ${canAction('del')?`<button class="danger" data-act="del" data-id="${e.id}">Delete</button>`:''}
        </td>`;
      body.appendChild(tr);
    });
  }
  rows();
  wrap.querySelector('#sx_month')?.addEventListener('change', rows);
  
  // Guarded Showroom Export (single source of truth)
  (function(){
    const sxBtn = wrap.querySelector('#sx_export');
    if(!sxBtn || sxBtn._wired) return;
    sxBtn._wired = true;
    sxBtn.onclick = () => {
      const m = (wrap.querySelector('#sx_month')?.value || '').slice(0,7);
      if(!m) return alert('Pick a month');
      const exp = (db.showroomExpenses||[]).filter(e=>ymStr(e.date)===m);
      const html = '<html><head><meta charset="utf-8"><title>Showroom '+m+'</title>'
        + '<style>body{font:14px system-ui;padding:20px} .right{text-align:right} table{width:100%;border-collapse:collapse} th,td{border:1px solid #ccc;padding:6px}</style></head><body>'
        + '<h2>Showroom Expenses ‚Äî '+m+'</h2>'
        + '<table><thead><tr><th>Date</th><th>Type</th><th>Method</th><th class="right">Amount</th><th>Note</th></tr></thead><tbody>'
        + exp.map(e=>'<tr><td>'+ddmmyyyy(e.date)+'</td><td>'+(e.type||'')+'</td><td>'+(e.method||'')+'</td><td class="right">'+fmtMoney(e.amount)+'</td><td>'+(e.note||'')+'</td></tr>').join('')
        + '</tbody></table>'
        + '<p><b>Total (net):</b> '+fmtMoney(exp.reduce((t,x)=>t+Number(x.amount||0),0))+'</p>'
        + '</body></html>';
      openPrintable(html);
    };
  })();
// Guarded Showroom Export handler (single source)
  (function(){
    const sxBtn = wrap.querySelector('#sx_export');
    if(!sxBtn || sxBtn._wired) return;
    (sxBtn._wired=true); sxBtn.onclick = () => {
      const m = (wrap.querySelector('#sx_month')?.value || '').slice(0,7);
      if(!m) return alert('Pick a month');
      const exp = (db.showroomExpenses||[]).filter(e=>ymStr(e.date)===m);
      const html = '<html><head><meta charset="utf-8"><title>Showroom '+m+'</title>'
        + '<style>body{font:14px system-ui;padding:20px} .right{text-align:right} table{width:100%;border-collapse:collapse} th,td{border:1px solid #ccc;padding:6px}</style></head><body>'
        + '<h2>Showroom Expenses ‚Äî '+m+'</h2>'
        + '<table><thead><tr><th>Date</th><th>Type</th><th>Method</th><th class="right">Amount</th><th>Note</th></tr></thead><tbody>'
        + exp.map(e=>'<tr><td>'+ddmmyyyy(e.date)+'</td><td>'+(e.type||'')+'</td><td>'+(e.method||'')+'</td><td class="right">'+fmtMoney(e.amount)+'</td><td>'+(e.note||'')+'</td></tr>').join('')
        + '</tbody></table>'
        + '<p><b>Total (net):</b> '+fmtMoney(exp.reduce((t,x)=>t+Number(x.amount||0),0))+'</p>'
        + '</body></html>';
      openPrintable(html);
    };
  })();
function hint(){ const bal=calcBalances(); wrap.querySelector('#s_totHint').textContent='Live balance after showroom expenses ‚Äî Bank: '+fmtMoney(bal.bank)+' | Cash: '+fmtMoney(bal.cash); }
  hint();
  wrap.querySelector('#s_add').onclick=()=>{ if(!canAction('add')) return alert('No permission'); const e={id:editId||uid(),date:wrap.querySelector('#s_date').value,type:wrap.querySelector('#s_type').value,method:wrap.querySelector('#s_method').value,amount:Number(wrap.querySelector('#s_amt').value||0),note:wrap.querySelector('#s_note').value};
    if(editId){ db.showroomExpenses=db.showroomExpenses.map(x=>x.id===editId?e:x); addAudit('update','showroomExpense',e.id,e.type+' '+e.amount); editId=null; } else { db.showroomExpenses.unshift(e); addAudit('add','showroomExpense',e.id,e.type+' '+e.amount); }
    saveDB(); try{renderAlertBell();}catch(e){}; rows(); wrap.querySelector('#s_type').value=''; wrap.querySelector('#s_amt').value=''; wrap.querySelector('#s_note').value=''; hint();
  };
  wrap.addEventListener('click',(ev)=>{ const b=ev.target.closest('button'); if(!b) return; const id=b.dataset.id,act=b.dataset.act;
    if(act==='del'){ if(!canAction('del')) return alert('No permission'); const delS=db.showroomExpenses.find(x=>x.id===id); markDeleted('showroomExpenses', id); db.showroomExpenses=db.showroomExpenses.filter(x=>x.id!==id); saveDB(); try{renderAlertBell();}catch(e){}; addAudit('delete','showroomExpense',id,delS?delS.type+' '+delS.amount:''); rows(); hint(); }
    else if(act==='edit'){ if(!canAction('edit')) return alert('No permission'); const e=db.showroomExpenses.find(x=>x.id===id); editId=id; wrap.querySelector('#s_date').value=e.date; wrap.querySelector('#s_type').value=e.type||''; wrap.querySelector('#s_method').value=e.method||'bank'; wrap.querySelector('#s_amt').value=e.amount||0; wrap.querySelector('#s_note').value=e.note||''; document.getElementById('app').scrollIntoView({ behavior: 'smooth' });}
  });
  return wrap;
}

/* ========= Sales ========= */
function viewSales(){ 
  if(!canTab('Sales')) return document.createElement('div'); 
  const wrap=document.createElement('div'); 
  wrap.className='card';
  
  // ‚úÖ Only show vehicles that are NOT sold and do NOT already have a sale record
  const soldVehicleIds = new Set((db.sales || []).filter(isRealSale).map(s => s.vehicleId));
  const regOptions = (db.vehicles || [])
  .filter(v => v && String(v.status || '').toLowerCase() !== 'sold')
  .filter(v => !soldVehicleIds.has(v.id))
  .map(v => `<option value="${(v.reg || '').toUpperCase()}">`)
  .join('');

  
  wrap.innerHTML=`<h2>Sales</h2>
  <!-- Search and Filter Section -->
  <div class="row" style="margin-bottom: 16px; padding: 10px; background: rgba(19, 26, 43, 0.5); border-radius: 10px;">
    <div style="display: flex; gap: 12px; align-items: center; flex-wrap: wrap; width: 100%;">
      <div style="flex: 1; min-width: 200px;">
        <label class="small">Search by REG, Customer, or Invoice #</label>
        <input id="sales_search" placeholder="Type to search..." style="width: 100%;">
      </div>
      <div style="flex: 1; min-width: 200px;">
        <label class="small">Filter by Month</label>
        <input id="sales_month" type="month" style="width: 100%;">
      </div>
      <div style="display: flex; gap: 8px; align-items: flex-end;">
        <button id="sales_clear_search" style="margin-top: 20px;">Clear Search</button>
        <button id="sales_clear_month" style="margin-top: 20px;">Show All Time</button>
        <button onclick="exportSalesCSV()" style="margin-top: 20px;">Export CSV</button>
      </div>
    </div>
  </div>
  
  <!-- Sale Entry Form -->
  <div class="row">
    <label>Vehicle REG<datalist id="sale_reg_list">${regOptions}</datalist><input id="sale_reg" list="sale_reg_list" placeholder="Type REG to select vehicle"></label>
    <label>Sale Date<input id="sale_date" type="date"></label>
    <label>Customer Name<input id="sale_buyer" placeholder="Customer name"></label>
    <label>Customer Address<input id="sale_addr" placeholder="Address"></label>
    <label>Phone<input id="sale_phone" placeholder="Phone"></label>
    <label>Email<input id="sale_email" placeholder="Email"></label>
    <label>Mileage at Sale<input id="sale_mileage" type="number" placeholder="0"></label>
    <label>Date of First Reg<input id="sale_firstReg" type="date"></label>
  </div>
  <div class="row">
    <label>Sale Price ¬£<input id="sale_price" type="number" placeholder="0"></label>
    <label>Deposit ¬£<input id="sale_dep" type="number" placeholder="0"></label>
    <label>Cash ¬£<input id="sale_cash" type="number" placeholder="0"></label>
    <label>Card ¬£<input id="sale_card" type="number" placeholder="0"></label>
    <label>Bank Transfer ¬£<input id="sale_bank" type="number" placeholder="0"></label>
    <label>Finance ¬£<input id="sale_fin" type="number" placeholder="0"></label>
    <label>PX Allowance ¬£<input id="sale_pxAllowance" type="number" placeholder="0"></label>
    <button id="auto_balance">Auto-balance</button><span id="sale_warn" class="small"></span>
  </div>
  <div class="row">
    <label>Part-ex Notes<input id="sale_partex" style="min-width:320px" placeholder="Optional notes"></label>
    <label>PX Reg<input id="sale_pxReg" placeholder="AB12CDE"></label>
    <label>PX Make<input id="sale_pxMake" placeholder="Make"></label>
    <label>PX Model<input id="sale_pxModel" placeholder="Model"></label>
    <label>Finance Company<input id="sale_finCo" placeholder="Finance company"></label>
    <label>Agreement #<input id="sale_agree" placeholder="Agreement #"></label>
    <label>Deliver To<input id="sale_deliver" placeholder="Name/address"></label>
    <label>Keys<input id="sale_keys" placeholder="e.g. 2 keys"></label>
    <label>MOT Expiry<input id="sale_mot" type="date" placeholder="e.g. 2025-11-30"></label>
    <label>Service History<input id="sale_sh" placeholder="Full / Part / None"></label>
    <label>Invoice # (optional)<input id="sale_invNo" placeholder="Leave blank for auto"></label>
    <label>Sale Type<select id="sale_status"><option value="completed" selected>Completed Sale (customer bought car)</option><option value="proforma">Proforma / Finance Quote (NOT sold yet)</option><option value="cancelled">Cancelled / Finance Declined</option></select></label>
    <button id="sale_add" class="primary">Record / Update</button>
  </div>

  <table class="table" style="margin-top:10px"><thead><tr><th>Date</th><th>Reg</th><th>Customer</th><th class="right">Price</th><th>Breakdown</th>${canProfit()?'<th class="right">Profit</th>':''}<th>Actions</th></tr></thead><tbody id="sale_body"></tbody></table>
  <div id="sales_summary" class="small" style="margin-top: 10px; padding: 8px; background: var(--card); border-radius: 8px;"></div>`;
  
  let editId=null; 
  const body=wrap.querySelector('#sale_body');
  let currentFilter = {
    search: '',
    month: '' // Empty by default instead of current month
  };
  
  // Set default month to empty (show all time)
  wrap.querySelector('#sales_month').value = currentFilter.month;
  
  function getFilteredSales() {
    let sales = (db.sales || []).filter(s => !s.refunded);
    
    // Apply month filter if specified
    if (currentFilter.month) {
      sales = sales.filter(s => ymStr(s.date) === currentFilter.month);
    }
    
    // Apply search filter if specified
    if (currentFilter.search) {
      const searchTerm = currentFilter.search.toLowerCase();
      sales = sales.filter(s => {
        const v = db.vehicles.find(x => x.id === s.vehicleId) || {};
        return (
          (v.reg || '').toLowerCase().includes(searchTerm) ||
          (s.buyer || '').toLowerCase().includes(searchTerm) ||
          (s.invNo || '').toLowerCase().includes(searchTerm) ||
          (s.phone || '').toLowerCase().includes(searchTerm) ||
          (s.email || '').toLowerCase().includes(searchTerm)
        );
      });
    }
    
    // Sort by date (newest first) - FIXED: This ensures latest date shows first
    sales.sort((a, b) => {
      // Handle missing dates by putting them at the end
      if (!a.date && !b.date) return 0;
      if (!a.date) return 1;
      if (!b.date) return -1;
      
      // Compare dates (ISO format works for string comparison)
      return b.date.localeCompare(a.date);
    });
    
    return sales;
  }

  // Add function to clear the form
  function clearSaleForm() {
    const fields = [
      '#sale_reg', '#sale_date', '#sale_buyer', '#sale_addr', '#sale_phone',
      '#sale_email', '#sale_mileage', '#sale_firstReg', '#sale_price',
      '#sale_dep', '#sale_cash', '#sale_card', '#sale_bank', '#sale_fin',
      '#sale_pxAllowance', '#sale_partex', '#sale_pxReg', '#sale_pxMake',
      '#sale_pxModel', '#sale_finCo', '#sale_agree', '#sale_deliver',
      '#sale_keys', '#sale_mot', '#sale_sh'
    ];
    
    fields.forEach(selector => {
      const el = wrap.querySelector(selector);
      if (el) el.value = '';
    });
    
    // Clear warning message
    const warnEl = wrap.querySelector('#sale_warn');
    if (warnEl) warnEl.textContent = '';
    
    // Reset edit ID
    editId = null;
  }
  
  function rows(){ 
    const filteredSales = getFilteredSales();
    body.innerHTML=''; 
    
    if (filteredSales.length === 0) {
      const tr = document.createElement('tr');
      tr.innerHTML = `<td colspan="${canProfit() ? 7 : 6}" class="small" style="text-align: center; padding: 20px;">No sales found${currentFilter.search ? ' for "' + currentFilter.search + '"' : ''}${currentFilter.month ? ' in ' + currentFilter.month : ''}</td>`;
      body.appendChild(tr);
    } else {
      filteredSales.forEach(s => { 
        const v = db.vehicles.find(x => x.id === s.vehicleId) || {}; 
        const vexp = (db.vehicleExpenses||[]).filter(e => e.vehicleId === s.vehicleId).reduce((t,x) => t + Number(x.amount||0), 0);
        const profit = Number(s.salePrice||0) - Number(v.purchase||0) - vexp; 
        const br = `¬£${Number(s.deposit||0).toFixed(2)} dep, ¬£${Number(s.cash||0).toFixed(2)} cash, ¬£${Number(s.card||0).toFixed(2)} card, ¬£${Number(s.bank||0).toFixed(2)} bank, ¬£${Number(s.finance||0).toFixed(2)} finance, PX ¬£${Number(s.pxAllowance||0).toFixed(2)}`;
        const partexVehicle = (db.vehicles||[]).find(v => v.originalSaleId === s.id);
        const partexInfo = partexVehicle ? `<br><small style="color:#53a8ff;">PX: ${partexVehicle.reg} (in stock)</small>` : '';
        const tr = document.createElement('tr'); 
        tr.innerHTML = `<td>${ddmmyyyy(s.date)}</td>
        <td>${v.reg||''}</td>
        <td>${s.buyer||''}</td>
        <td class="right">${fmtMoney(s.salePrice)}</td>
        <td>${br}${partexInfo}</td>
        ${canProfit()?('<td class="right">'+fmtMoney(profit)+'</td>'):''}
        <td><button data-act="inv" data-id="${s.id}">Invoice</button><button data-act="proforma" data-id="${s.id}">Finance Proforma</button>${canAction('edit')?`<button data-act="edit" data-id="${s.id}">Edit</button>`:''}${canAction('del')?` <button class="danger" data-act="del" data-id="${s.id}">Delete</button>`:''}</td>`; 
        body.appendChild(tr); 
      });
    }
    
    // Update summary
    updateSummary();
  }
  
  function updateSummary() {
    const filteredSales = getFilteredSales();
    const totalSales = filteredSales.reduce((sum, s) => sum + Number(s.salePrice || 0), 0);
    const summary = wrap.querySelector('#sales_summary');
    
    let summaryText = `Showing ${filteredSales.length} sale${filteredSales.length !== 1 ? 's' : ''}`;
    if (currentFilter.month) {
      summaryText += ` for ${currentFilter.month}`;
    } else {
      summaryText += ` (all time)`;
    }
    if (currentFilter.search) {
      summaryText += ` matching "${currentFilter.search}"`;
    }
    summaryText += ` | Total: ${fmtMoney(totalSales)}`;
    
    summary.textContent = summaryText;
  }
  
  // Auto-fill "Date of First Reg" when entering the vehicle REG
  const vehicleRegInput = wrap.querySelector('#sale_reg');
  const firstRegInput = wrap.querySelector('#sale_firstReg');
  const saleMotInput = wrap.querySelector('#sale_mot');

    if (vehicleRegInput && firstRegInput) {
    vehicleRegInput.addEventListener('input', () => {
    const regInput = vehicleRegInput.value.trim().toUpperCase(); // Get entered REG
    const vehicle = (db.vehicles || []).find(v => (v.reg || '').toUpperCase() === regInput);
    if (vehicle && vehicle.firstReg) {
      firstRegInput.value = vehicle.firstReg; // Set the Date of First Reg field
    } else {
      firstRegInput.value = ''; // Clear if no matching vehicle found
    }

    if (saleMotInput) {
      if (vehicle && (vehicle.motExpiry || vehicle.lastMotExpiry)) {
        saleMotInput.value = vehicle.motExpiry || vehicle.lastMotExpiry || '';
      } else {
        saleMotInput.value = '';
      }
    }
  });
  }

  // Event listeners for search and filter
  wrap.querySelector('#sales_search').addEventListener('input', function(e) {
    currentFilter.search = e.target.value.trim();
    rows();
  });
  
  wrap.querySelector('#sales_month').addEventListener('change', function(e) {
    currentFilter.month = e.target.value || '';
    rows();
  });
  
  wrap.querySelector('#sales_clear_search').onclick = function() {
    wrap.querySelector('#sales_search').value = '';
    currentFilter.search = '';
    rows();
  };
  
  wrap.querySelector('#sales_clear_month').onclick = function() {
    wrap.querySelector('#sales_month').value = '';
    currentFilter.month = '';
    rows();
  };

  function getNums(){ return { price:Number(wrap.querySelector('#sale_price').value||0), dep:Number(wrap.querySelector('#sale_dep').value||0), cash:Number(wrap.querySelector('#sale_cash').value||0), card:Number(wrap.querySelector('#sale_card').value||0), bank:Number(wrap.querySelector('#sale_bank').value||0), fin:Number(wrap.querySelector('#sale_fin').value||0), px:Number(wrap.querySelector('#sale_pxAllowance').value||0) }; }
  function updateWarn(){ const {price,dep,cash,card,bank,fin,px}=getNums(); const sum=dep+cash+card+bank+fin+px; const w=wrap.querySelector('#sale_warn'); if(sum===price){ w.textContent='OK: payments + PX match price'; w.style.color=''; } else { const diff=price-sum; w.textContent='Remaining difference: '+fmtMoney(diff); w.style.color=diff===0?'':(diff<0?'#ffb3b3':''); } }
  ['#sale_price','#sale_dep','#sale_cash','#sale_card','#sale_bank','#sale_fin','#sale_pxAllowance'].forEach(sel=> wrap.querySelector(sel).addEventListener('input',updateWarn));
  wrap.querySelector('#auto_balance').onclick=()=>{ const {price,dep,cash,card,bank,px}=getNums(); const paid=dep+cash+card+bank+px; const fin=Math.max(0,price-paid); wrap.querySelector('#sale_fin').value=fin; updateWarn(); };

  wrap.addEventListener('click',(ev)=>{ const b=ev.target.closest('button'); if(!b)return; const s=db.sales.find(x=>x.id===b.dataset.id);
    if(b.dataset.act==='del'){ if(!canAction('del')) return alert('No permission'); if(!confirm('Delete sale? Vehicle will go back to stock.')) return; if(s){ 
    // Also delete any associated part-ex vehicle
    const pxVehicle = (db.vehicles||[]).find(v => v.originalSaleId === s.id);
    if(pxVehicle) {
      db.vehicles = db.vehicles.filter(v => v.id !== pxVehicle.id);
      db.vehicleExpenses = db.vehicleExpenses.filter(e => e.vehicleId !== pxVehicle.id);
    }
  
    const v=db.vehicles.find(x=>x.id===s.vehicleId); 
    if(v) v.status='for sale'; 
    db.sales=db.sales.filter(x=>x.id!==s.id); 
    saveDB(); 
    try{renderAlertBell();}catch(e){}; 
    addAudit('delete','sale',s.id,(v?v.reg:'')+' inv '+(s.invNo||'') + (pxVehicle ? ' and PX ' + pxVehicle.reg : '')); 
    rows(); 
    } }

    else if(b.dataset.act==='edit'){ if(!canAction('edit')) return alert('No permission'); editId=s.id; const v=db.vehicles.find(x=>x.id===s.vehicleId)||{};
      wrap.querySelector('#sale_reg').value=(v.reg||'').toUpperCase(); wrap.querySelector('#sale_date').value=s.date; wrap.querySelector('#sale_buyer').value=s.buyer||''; wrap.querySelector('#sale_addr').value=s.address||'';
      wrap.querySelector('#sale_phone').value=s.phone||''; wrap.querySelector('#sale_email').value=s.email||''; wrap.querySelector('#sale_mileage').value=s.mileage||0; wrap.querySelector('#sale_firstReg').value=s.firstReg||'';
      wrap.querySelector('#sale_price').value=s.salePrice||0; wrap.querySelector('#sale_dep').value=s.deposit||0; wrap.querySelector('#sale_cash').value=s.cash||0; wrap.querySelector('#sale_card').value=s.card||0; wrap.querySelector('#sale_bank').value=s.bank||0; wrap.querySelector('#sale_fin').value=s.finance||0;
      wrap.querySelector('#sale_partex').value=s.partex||''; wrap.querySelector('#sale_pxReg').value=s.pxReg||''; wrap.querySelector('#sale_pxMake').value=s.pxMake||''; wrap.querySelector('#sale_pxModel').value=s.pxModel||''; wrap.querySelector('#sale_pxAllowance').value=s.pxAllowance||0;
      wrap.querySelector('#sale_finCo').value=s.financeCompany||''; wrap.querySelector('#sale_agree').value=s.agreement||''; wrap.querySelector('#sale_deliver').value=s.deliverTo||''; wrap.querySelector('#sale_keys').value=s.keys||''; wrap.querySelector('#sale_mot').value=s.mot||''; wrap.querySelector('#sale_sh').value=s.serviceHistory||''; wrap.querySelector('#sale_invNo').value=s.invNo||''; const stField = wrap.querySelector('#sale_status'); if (stField) stField.value = s.status || 'completed'; updateWarn();
      document.getElementById('app').scrollIntoView({ behavior: 'smooth' });
    } else if(b.dataset.act==='inv'){ printInvoice(s.id); } else if(b.dataset.act==='proforma'){ printFinanceProforma(s.id); }
  });

  wrap.querySelector('#sale_add').onclick = () => { 
    if (!canAction('add')) return alert('No permission'); 

    const regInput = (wrap.querySelector('#sale_reg').value || '').toUpperCase().trim(); 
    const vid = findVehicleIdByReg(regInput); 
    if (!vid) return alert('Enter a valid REG (use the suggestions).');

    // üü° Sale type: completed / proforma / cancelled
    const statusEl = wrap.querySelector('#sale_status');
    const saleStatus = statusEl ? statusEl.value : 'completed';

    const prevSale = editId ? (db.sales || []).find(x => x.id === editId) : null;
    const prevStatus = prevSale ? (prevSale.status || 'completed') : null;

    // üîí Prevent *double completed sale* on NEW sale
    if (!editId) {
      const vehicle = (db.vehicles || []).find(x => x.id === vid);
      const hasRealSale = (db.sales || []).some(sale => sale.vehicleId === vid && isRealSale(sale));

      if ((vehicle && vehicle.status === 'sold') || hasRealSale) {
        return alert('This vehicle already has a completed sale. Use EDIT on the existing sale or cancel/refund it first.');
      }
    }

    // üî¢ Invoice number: auto + unique
    let invNoValue = (wrap.querySelector('#sale_invNo').value || '').trim();

    if (!invNoValue && !editId) {
      invNoValue = getNextInvoiceNo();
    }

    if (invNoValue) {
      const existing = new Set(
        (db.sales || [])
          .filter(sale => sale.id !== (prevSale && prevSale.id))
          .map(sale => (sale.invNo == null ? '' : String(sale.invNo).trim()))
    );

    let candidate = String(invNoValue).trim();
    if (existing.has(candidate)) {
      let n = parseInt(candidate, 10);
      if (!isNaN(n)) {
        while (existing.has(String(n))) n++;
        candidate = String(n);
      } else {
        let i = 2;
        while (existing.has(candidate + '-' + i)) i++;
        candidate = candidate + '-' + i;
      }
    }
    invNoValue = candidate;
  }

  const price = Number(wrap.querySelector('#sale_price').value || 0);

  // üîß Build sale object (keeping refunded flag etc. if editing)
  const base = prevSale || {};
  const s = {
    ...base,
    id: editId || uid(), 
    vehicleId: vid, 
    date: wrap.querySelector('#sale_date').value,
    firstReg: wrap.querySelector('#sale_firstReg').value,
    buyer: wrap.querySelector('#sale_buyer').value.trim(),
    address: wrap.querySelector('#sale_addr').value.trim(),
    phone: wrap.querySelector('#sale_phone').value.trim(),
    email: wrap.querySelector('#sale_email').value.trim(),
    mileage: Number(wrap.querySelector('#sale_mileage').value || 0),
    salePrice: price,
    deposit: Number(wrap.querySelector('#sale_dep').value || 0),
    cash: Number(wrap.querySelector('#sale_cash').value || 0),
    card: Number(wrap.querySelector('#sale_card').value || 0),
    bank: Number(wrap.querySelector('#sale_bank').value || 0),
    finance: Number(wrap.querySelector('#sale_fin').value || 0),
    partex: wrap.querySelector('#sale_partex').value.trim(),
    pxReg: (wrap.querySelector('#sale_pxReg').value || '').trim().toUpperCase(),
    pxMake: wrap.querySelector('#sale_pxMake').value.trim(),
    pxModel: wrap.querySelector('#sale_pxModel').value.trim(),
    pxAllowance: Number(wrap.querySelector('#sale_pxAllowance').value || 0),
    financeCompany: wrap.querySelector('#sale_finCo').value.trim(),
    agreement: wrap.querySelector('#sale_agree').value.trim(),
    deliverTo: wrap.querySelector('#sale_deliver').value.trim(),
    keys: wrap.querySelector('#sale_keys').value.trim(),
    mot: wrap.querySelector('#sale_mot').value.trim(),
    serviceHistory: wrap.querySelector('#sale_sh').value.trim(),
    invNo: invNoValue || (Date.now() + '').slice(-6),
    status: saleStatus // ‚úÖ NEW
  };
  
  const sumBreak = s.deposit + s.cash + s.card + s.bank + s.finance + s.pxAllowance;
  if (sumBreak !== s.salePrice) {
    if (!confirm('Payments + PX do not equal sale price. Continue?')) return;
  }

  // üß† Helper to create PX vehicle (only for completed sales)
  function ensurePartExVehicle(sale, vStat){
    if (!sale.pxReg || !(sale.pxAllowance > 0)) return;
    const existingPx = (db.vehicles || []).find(v => v.originalSaleId === sale.id);
    if (existingPx) return; // already created before

    const px = {
      id: uid(),
      reg: sale.pxReg,
      make: sale.pxMake,
      model: sale.pxModel,
      colour: '',
      fuel: '',
      mileage: 0,
      purchase: sale.pxAllowance,
      ownerType: 'owned',
      investor: '',
      supplier: 'PART-EX',
      supplierNote: `PX from sale ${sale.invNo} (${vStat?.reg || 'Unknown'})`,
      originalSaleId: sale.id,
      vin: '',
      status: 'for sale',
      createdAt: new Date().toISOString(),
      media: [],
      video: ''
    };
    db.vehicles.unshift(px);
    addAudit('add', 'vehicle', px.id, 'PX ' + px.reg + ' ' + px.make + ' ' + px.model + ' from sale ' + sale.invNo + ' (' + (vStat?.reg || 'Unknown') + ')');
  }

  if (editId) { 
    // üîÑ Update existing sale
    db.sales = (db.sales || []).map(x => x.id === s.id ? s : x); 
    addAudit('update', 'sale', s.id, (db.vehicles.find(x => x.id === s.vehicleId) || {}).reg + ' inv ' + s.invNo); 

    const vM = db.vehicles.find(x => x.id === s.vehicleId); 
    if (vM) vM.mileage = s.mileage || vM.mileage; 

    // Status transitions:
    if (prevStatus !== 'completed' && saleStatus === 'completed') {
      // became a real sale now ‚Üí mark sold + PX if needed
      if (vM) vM.status = 'sold';
      ensurePartExVehicle(s, vM);
    } else if (prevStatus === 'completed' && saleStatus !== 'completed') {
      // was completed, now proforma/cancelled ‚Üí put back to stock + remove PX
      if (vM) vM.status = 'for sale';
      const pxVehicle = (db.vehicles || []).find(v => v.originalSaleId === s.id);
      if (pxVehicle) {
        db.vehicles = db.vehicles.filter(v => v.id !== pxVehicle.id);
        db.vehicleExpenses = (db.vehicleExpenses || []).filter(e => e.vehicleId !== pxVehicle.id);
      }
    }

    editId = null;
  } else { 
    // üÜï New sale
    db.sales.unshift(s); 
    addAudit('add', 'sale', s.id, (db.vehicles.find(x => x.id === s.vehicleId) || {}).reg + ' inv ' + s.invNo); 
    
    const vStat = db.vehicles.find(x => x.id === vid); 
    if (vStat) { 
      if (saleStatus === 'completed') {
        vStat.status = 'sold';       // only completed = sold
      }
      vStat.mileage = s.mileage || vStat.mileage; 
    }

    if (saleStatus === 'completed' && vStat) {
      ensurePartExVehicle(s, vStat);
    }
  }

  saveDB(); 
  try{renderAlertBell();}catch(e){}; 
  rows(); 
  clearSaleForm();
};
  
  // Initial render
  rows();
  return wrap;
}

/* ========= Sold (new) ========= */
function viewSold(){
  if(!canTab('Sold')) return document.createElement('div'); 
  const wrap=document.createElement('div'); 
  wrap.className='card';
  
  wrap.innerHTML=`<h2>Sold</h2>
  <div class="row" style="margin-bottom: 16px; padding: 10px; background: rgba(19, 26, 43, 0.5); border-radius: 10px;">
    <div style="display: flex; gap: 12px; align-items: center; flex-wrap: wrap; width: 100%;">
      <div style="flex: 1; min-width: 200px;">
        <label class="small">Search by REG, Customer, or Phone</label>
        <input id="sold_search" placeholder="Type to search..." style="width: 100%;">
      </div>
      <div style="flex: 1; min-width: 200px;">
        <label class="small">Filter by Month</label>
        <input id="sold_month" type="month" style="width: 100%;">
      </div>
      <div style="display: flex; gap: 8px; align-items: flex-end;">
        <button id="sold_clear_search" style="margin-top: 20px;">Clear Search</button>
        <button id="sold_clear_month" style="margin-top: 20px;">Show All Time</button>
        <button id="sold_export" style="margin-top: 20px;">Export CSV</button>
      </div>
    </div>
  </div>
  <table class="table" style="margin-top:10px"><thead><tr>
    <th>Date</th><th>Reg</th><th>Make</th><th>Model</th><th>Customer</th><th>Address</th><th>Postcode</th><th>Phone</th><th>Email</th><th class="right">Price</th>
  </tr></thead><tbody id="sold_body"></tbody></table>
  <div id="sold_summary" class="small" style="margin-top: 10px; padding: 8px; background: var(--card); border-radius: 8px;"></div>`;
  
  const body=wrap.querySelector('#sold_body');
  const summary=wrap.querySelector('#sold_summary');
  
  // Filter state
  let currentFilter = {
    search: '',
    month: '' // Empty by default instead of current month
  };
  
  // Set default month to empty (show all time)
  wrap.querySelector('#sold_month').value = currentFilter.month;
  
  function postcodeFrom(addr){ 
    const m=(addr||'').match(/([A-Z]{1,2}\d{1,2}[A-Z]?)\s*\d[A-Z]{2}/i); 
    return m?m[0].toUpperCase():''; 
  }
  
  function getFilteredSales() {
    let sales = (db.sales || []).filter(isRealSale);
    
    // Apply month filter if specified
    if (currentFilter.month) {
      sales = sales.filter(s => ymStr(s.date) === currentFilter.month);
    }
    
    // Apply search filter if specified
    if (currentFilter.search) {
      const searchTerm = currentFilter.search.toLowerCase();
      sales = sales.filter(s => {
        const v = db.vehicles.find(x => x.id === s.vehicleId) || {};
        return (
          (v.reg || '').toLowerCase().includes(searchTerm) ||
          (s.buyer || '').toLowerCase().includes(searchTerm) ||
          (s.phone || '').toLowerCase().includes(searchTerm)
        );
      });
    }
    
    // Sort by date (newest first)
    sales.sort((a, b) => {
      if (!a.date && !b.date) return 0;
      if (!a.date) return 1;
      if (!b.date) return -1;
      return b.date.localeCompare(a.date);
    });
    
    return sales;
  }
  
  function renderSoldRows(){
    const filteredSales = getFilteredSales();
    body.innerHTML=''; 
    
    if (filteredSales.length === 0) {
      const tr = document.createElement('tr');
      tr.innerHTML = `<td colspan="10" class="small" style="text-align: center; padding: 20px;">No sold vehicles found${currentFilter.search ? ' for "' + currentFilter.search + '"' : ''}${currentFilter.month ? ' in ' + currentFilter.month : ''}</td>`;
      body.appendChild(tr);
    } else {
      filteredSales.forEach(s=>{
        const v=db.vehicles.find(x=>x.id===s.vehicleId)||{};
        const tr=document.createElement('tr'); 
        tr.innerHTML=`<td>${ddmmyyyy(s.date)}</td>
                     <td>${v.reg||''}</td>
                     <td>${v.make||''}</td>
                     <td>${v.model||''}</td>
                     <td>${s.buyer||''}</td>
                     <td>${s.address || ''}</td>
                     <td>${postcodeFrom(s.address)}</td>
                     <td>${s.phone||''}</td>
                     <td>${s.email||''}</td>
                     <td class="right">${fmtMoney(s.salePrice||0)}</td>`; 
        body.appendChild(tr);
      });
    }
    
    // Update summary
    updateSummary();
  }
  
  function updateSummary() {
    const filteredSales = getFilteredSales();
    const totalSales = filteredSales.reduce((sum, s) => sum + Number(s.salePrice || 0), 0);
    
    let summaryText = `Showing ${filteredSales.length} sold vehicle${filteredSales.length !== 1 ? 's' : ''}`;
    if (currentFilter.month) {
      summaryText += ` for ${currentFilter.month}`;
    } else {
      summaryText += ` (all time)`;
    }
    if (currentFilter.search) {
      summaryText += ` matching "${currentFilter.search}"`;
    }
    summaryText += ` | Total Sales: ${fmtMoney(totalSales)}`;
    
    summary.textContent = summaryText;
  }
  
  // Event listeners for search and filter
  wrap.querySelector('#sold_search').addEventListener('input', function(e) {
    currentFilter.search = e.target.value.trim();
    renderSoldRows();
  });
  
  wrap.querySelector('#sold_month').addEventListener('change', function(e) {
    currentFilter.month = e.target.value || '';
    renderSoldRows();
  });
  
  wrap.querySelector('#sold_clear_search').onclick = function() {
    wrap.querySelector('#sold_search').value = '';
    currentFilter.search = '';
    renderSoldRows();
  };
  
  wrap.querySelector('#sold_clear_month').onclick = function() {
    wrap.querySelector('#sold_month').value = '';
    currentFilter.month = '';
    renderSoldRows();
  };
  
  // Export CSV functionality (unchanged)
  wrap.querySelector('#sold_export').onclick=()=>{ 
    const rowsCSV=[["Date","Reg","Make","Model","Customer","Postcode","Phone","Email","Price"]]; 
    getFilteredSales().forEach(s=>{ 
      const v=db.vehicles.find(x=>x.id===s.vehicleId)||{}; 
      rowsCSV.push([
        ddmmyyyy(s.date),
        v.reg||'',
        v.make||'',
        v.model||'',
        s.buyer||'',
        (s.address||'').split(',').slice(-1)[0]||'',
        s.phone||'',
        s.email||'',
        Number(s.salePrice||0)
      ]); 
    }); 
    
    const csv=rowsCSV.map(r=>r.map(v=>'"'+String(v).replace(/"/g,'""')+'"').join(',')).join('\n'); 
    const a=document.createElement('a'); 
    a.href=URL.createObjectURL(new Blob([csv],{type:'text/csv'})); 
    a.download='sold_export_' + new Date().toISOString().slice(0,10) + '.csv'; 
    a.click(); 
    
    addAudit('export', 'sold', '', `Exported ${getFilteredSales().length} sold vehicles to CSV`);
  };
  
  // Initial render
  renderSoldRows();
  return wrap;
}

/* ========= Credit ========= */
function viewCredit(){
  if(!canTab('Credit')) return document.createElement('div'); 
  const wrap=document.createElement('div'); 
  wrap.className='card';

  wrap.innerHTML=`<h2>Credit Notes & Refunds</h2>
  <div class="row">
    <input id="cr_date" type="date">
    <input id="cr_customer" placeholder="Customer Name">
    <datalist id="cr_reg_list">
      ${(db.vehicles||[]).filter(v => String(v.status||'').toLowerCase() === 'sold').map(v => `<option value="${(v.reg||'').toUpperCase()}">`).join('')}
    </datalist>
    <input id="cr_vehicle" list="cr_reg_list" placeholder="Vehicle REG (select sold reg)">
    <select id="cr_type">
      <option value="refund">Refund (Return)</option>
      <option value="credit_note">Credit Note</option>
    </select>
    <select id="cr_method"><option value="bank">Bank</option><option value="cash">Cash</option></select>
    <input id="cr_amount" type="number" placeholder="Refund Paid ¬£">
    <input id="cr_reason" placeholder="Reason for credit/refund">
    <input id="cr_invoiceNo" placeholder="Invoice No (auto)">
    <button id="cr_add" class="primary">Add/Update Credit</button>
  </div>

  <div class="row" style="margin:10px 0 12px;">
    <div class="small" id="cr_saleHint" style="opacity:.85"></div>
  </div>

  <div class="row" style="margin-bottom:12px;">
    <input id="cr_search" placeholder="Search by customer, vehicle, invoice" style="min-width:320px">
    <button id="cr_clear_search">Clear</button>
  </div>

  <div class="row" id="cr_vehicleDetailsSection">
    <label>Make<input id="cr_make" placeholder="Vehicle Make"></label>
    <label>Model<input id="cr_model" placeholder="Vehicle Model"></label>
    <label>VIN<input id="cr_vin" placeholder="Vehicle VIN"></label>
    <label>Return Mileage<input id="cr_mileage" type="number" placeholder="Mileage on return"></label>
    <label>Colour<input id="cr_colour" placeholder="Vehicle Colour"></label>
    <label>Fuel<input id="cr_fuel" placeholder="Fuel Type"></label>
  </div>

  <table class="table" style="margin-top:10px">
    <thead>
      <tr>
        <th>Date</th>
        <th>Customer</th>
        <th>Vehicle</th>
        <th>Type</th>
        <th>Method</th>
        <th class="right">Refund Paid</th>
        <th>Reason</th>
        <th>Invoice No</th>
        <th>Returned To Stock</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody id="cr_body"></tbody>
  </table>`;

  const body = wrap.querySelector('#cr_body');
  let editId = null;

  // This holds the SOLD sale we auto-found from REG
  let linkedSale = null;
  let linkedVehicle = null;

  // Default date = today
  wrap.querySelector('#cr_date').value = new Date().toISOString().slice(0,10);

  function money(n){ return fmtMoney(Number(n||0)); }

  function findLatestSaleByReg(reg){
    reg = (reg||'').trim().toUpperCase();
    if(!reg) return null;

    // Find vehicle by reg (even if sold)
    const v = (db.vehicles||[]).find(x => (x.reg||'').toUpperCase() === reg);
    if(!v) return null;

    // Find latest sale for that vehicleId
    const sales = (db.sales||[]).filter(s => s.vehicleId === v.id);
    if(!sales.length) return null;

    sales.sort((a,b)=> String(b.date||'').localeCompare(String(a.date||'')));
    return { sale: sales[0], vehicle: v };
  }

  function setSaleHint(){
    const hint = wrap.querySelector('#cr_saleHint');
    if(!linkedSale || !linkedVehicle){
      hint.textContent = 'Tip: Type a REG that was sold and it will auto-load the sold invoice + price + buyer.';
      return;
    }
    hint.textContent =
      `Linked SOLD: ${linkedVehicle.reg} | Inv ${linkedSale.invNo||''} | Sold ${money(linkedSale.salePrice)} | Sold mileage ${linkedSale.mileage||0} | Buyer: ${linkedSale.buyer||''}`;
  }

  function loadFromReg(){
    const reg = (wrap.querySelector('#cr_vehicle').value||'').trim().toUpperCase();
    linkedSale = null; 
    linkedVehicle = null;

    // Clear auto fields first
    wrap.querySelector('#cr_invoiceNo').value = '';
    // Customer stays if user typed it, but we will overwrite if we find a sale.

    if(!reg){
      setSaleHint();
      return;
    }

    const res = findLatestSaleByReg(reg);
    if(!res){
      setSaleHint();
      return;
    }

    linkedSale = res.sale;
    linkedVehicle = res.vehicle;

    // Auto-fill from sale + vehicle
    wrap.querySelector('#cr_customer').value = linkedSale.buyer || wrap.querySelector('#cr_customer').value || '';
    wrap.querySelector('#cr_invoiceNo').value = linkedSale.invNo || '';
    wrap.querySelector('#cr_make').value = linkedVehicle.make || '';
    wrap.querySelector('#cr_model').value = linkedVehicle.model || '';
    wrap.querySelector('#cr_vin').value = linkedVehicle.vin || '';
    wrap.querySelector('#cr_colour').value = linkedVehicle.colour || '';
    wrap.querySelector('#cr_fuel').value = linkedVehicle.fuel || '';
    // Put sold mileage as default return mileage (user can change)
    wrap.querySelector('#cr_mileage').value = Number(linkedSale.mileage||linkedVehicle.mileage||0);

    setSaleHint();
  }

  // Auto-load when REG changes
  wrap.querySelector('#cr_vehicle').addEventListener('input', () => {
    // Avoid re-running on every keystroke if you want: keep as-is for now
    loadFromReg();
  });

  function renderCredits(){
    const searchTerm = (wrap.querySelector('#cr_search')?.value || '').toLowerCase().trim();
    body.innerHTML = '';

    const filtered = (db.credits || []).filter(cr => {
      return !searchTerm ||
        (cr.customer||'').toLowerCase().includes(searchTerm) ||
        (cr.vehicle||'').toLowerCase().includes(searchTerm) ||
        (cr.invoiceNo||'').toLowerCase().includes(searchTerm);
    });

    filtered.forEach(cr => {
      const inStock = !!(cr.vehicle && (db.vehicles||[]).some(v => (v.reg||'') === cr.vehicle && v.status === 'for sale'));
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${ddmmyyyy(cr.date)}</td>
        <td>${cr.customer||''}</td>
        <td>${cr.vehicle||''}</td>
        <td>${cr.type||''}</td>
        <td>${cr.method||'bank'}</td>
        <td class="right">${fmtMoney(cr.amount)}</td>
        <td>${cr.reason||''}</td>
        <td>${cr.invoiceNo||''}</td>
        <td>${cr.type==='refund' && inStock ? '‚úÖ' : ''}</td>
        <td>
          <button data-act="edit" data-id="${cr.id}">Edit</button>
          <button class="danger" data-act="del" data-id="${cr.id}">Delete</button>
        </td>`;
      body.appendChild(tr);
    });
  }

  wrap.querySelector('#cr_search').addEventListener('input', renderCredits);
  wrap.querySelector('#cr_clear_search').addEventListener('click', () => {
    wrap.querySelector('#cr_search').value = '';
    renderCredits();
  });

  function clearForm(){
    wrap.querySelector('#cr_customer').value = '';
    wrap.querySelector('#cr_vehicle').value = '';
    wrap.querySelector('#cr_amount').value = '';
    wrap.querySelector('#cr_reason').value = '';
    wrap.querySelector('#cr_invoiceNo').value = '';
    wrap.querySelector('#cr_make').value = '';
    wrap.querySelector('#cr_model').value = '';
    wrap.querySelector('#cr_vin').value = '';
    wrap.querySelector('#cr_mileage').value = '';
    wrap.querySelector('#cr_colour').value = '';
    wrap.querySelector('#cr_fuel').value = '';
    linkedSale = null;
    linkedVehicle = null;
    setSaleHint();
  }

  // MAIN: Add / Update credit
  wrap.querySelector('#cr_add').onclick = () => {
    if (!canAction('add')) return alert('No permission');

    const reg = (wrap.querySelector('#cr_vehicle').value || '').trim().toUpperCase();
    const type = wrap.querySelector('#cr_type').value;

    // Ensure we refresh linkage (in case user pasted reg)
    loadFromReg();

    const refundPaid = Number(wrap.querySelector('#cr_amount').value || 0);

    const cr = {
      id: editId || uid(),
      date: wrap.querySelector('#cr_date').value,
      customer: wrap.querySelector('#cr_customer').value.trim(),
      vehicle: reg,
      type: type,
      method: wrap.querySelector('#cr_method').value,
      amount: refundPaid,
      reason: wrap.querySelector('#cr_reason').value.trim(),
      invoiceNo: wrap.querySelector('#cr_invoiceNo').value.trim(),

      // NEW: link back to the sale + keep a snapshot
      saleId: linkedSale ? linkedSale.id : null,
      soldPrice: linkedSale ? Number(linkedSale.salePrice||0) : 0,
      soldInvNo: linkedSale ? (linkedSale.invNo||'') : '',
      soldMileage: linkedSale ? Number(linkedSale.mileage||0) : 0,
      returnMileage: Number(wrap.querySelector('#cr_mileage').value || 0),

      // NEW: expense link id (so we don't create duplicates)
      costAdjustExpenseId: (editId ? (db.credits||[]).find(x=>x.id===editId)?.costAdjustExpenseId : null) || null
    };

    if(!cr.date || !cr.customer || !cr.type || (!cr.amount && cr.type==='refund')){
      return alert('Date + Customer + Refund Paid are required.');
    }

    // If REFUND: return to stock + add negative expense to reduce cost
    if(type === 'refund' && reg){
      const v = (db.vehicles||[]).find(x => (x.reg||'').toUpperCase() === reg);
      if(v){
        // Return to stock
        v.status = 'for sale';
        if(cr.returnMileage) v.mileage = cr.returnMileage;

        // If we have a linked sale price, calculate "kept amount"
        const soldPrice = cr.soldPrice || 0;
        const kept = soldPrice - refundPaid; // e.g. 8399 - 8099 = 300

        // Only apply adjustment if we actually know sold price and kept > 0
        if(soldPrice > 0 && kept !== 0){
          db.vehicleExpenses = db.vehicleExpenses || [];
          let ex = cr.costAdjustExpenseId ? (db.vehicleExpenses||[]).find(e=>e.id===cr.costAdjustExpenseId) : null;

          const expObj = {
            id: ex ? ex.id : uid(),
            vehicleId: v.id,
            date: cr.date,
            type: 'Credit/Return Adjustment',
            method: cr.method || 'bank',
            amount: -Number(kept), // negative reduces total cost
            note: `Credit return: sold ${soldPrice}, refund paid ${refundPaid}, kept ${kept}. Inv ${cr.invoiceNo||cr.soldInvNo||''}`
          };

          if(ex){
            db.vehicleExpenses = db.vehicleExpenses.map(e => e.id===ex.id ? expObj : e);
          }else{
            db.vehicleExpenses.unshift(expObj);
          }
          cr.costAdjustExpenseId = expObj.id;
        }
      }
    }

    // Mark the original sale as refunded so it does not appear in sales/sold/reports
    if (type === 'refund' && linkedSale && linkedSale.id) {
      const sale = (db.sales||[]).find(s => s.id === linkedSale.id);
      if (sale) {
        sale.refunded = true;
        saveDB();
      }
    }

    if(editId){
      db.credits = (db.credits||[]).map(x => x.id===editId ? cr : x);
      addAudit('update','credit',cr.id,`${cr.type} for ${cr.customer} - ${fmtMoney(cr.amount)}`);
      editId = null;
    }else{
      db.credits = db.credits || [];
      db.credits.unshift(cr);
      addAudit('add','credit',cr.id,`${cr.type} for ${cr.customer} - ${fmtMoney(cr.amount)}`);
    }

    saveDB();
    try{renderAlertBell();}catch(e){}
    renderCredits();
    clearForm();
  };

  wrap.addEventListener('click',(ev)=>{
    const b=ev.target.closest('button');
    if(!b) return;

    const id=b.dataset.id, act=b.dataset.act;

    if(act==='del'){
      if(!canAction('del')) return alert('No permission');
      if(!confirm('Delete this credit/refund?')) return;

      const delCr = (db.credits||[]).find(x=>x.id===id);

      // Also delete linked adjustment expense (if any)
      if(delCr && delCr.costAdjustExpenseId){
        db.vehicleExpenses = (db.vehicleExpenses||[]).filter(e => e.id !== delCr.costAdjustExpenseId);
      }

      db.credits = (db.credits||[]).filter(x=>x.id!==id);

      saveDB();
      try{renderAlertBell();}catch(e){}
      addAudit('delete','credit',id,delCr?`${delCr.type} for ${delCr.customer}`:'');
      renderCredits();
    }

    if(act==='edit'){
      if(!canAction('edit')) return alert('No permission');
      const cr = (db.credits||[]).find(x=>x.id===id);
      if(!cr) return;

      editId=id;

      wrap.querySelector('#cr_date').value = cr.date || '';
      wrap.querySelector('#cr_customer').value = cr.customer || '';
      wrap.querySelector('#cr_vehicle').value = cr.vehicle || '';
      wrap.querySelector('#cr_type').value = cr.type || 'refund';
      wrap.querySelector('#cr_method').value = cr.method || 'bank';
      wrap.querySelector('#cr_amount').value = Number(cr.amount||0);
      wrap.querySelector('#cr_reason').value = cr.reason || '';
      wrap.querySelector('#cr_invoiceNo').value = cr.invoiceNo || '';

      wrap.querySelector('#cr_make').value = cr.make || '';
      wrap.querySelector('#cr_model').value = cr.model || '';
      wrap.querySelector('#cr_vin').value = cr.vin || '';
      wrap.querySelector('#cr_mileage').value = Number(cr.returnMileage||cr.mileage||0);
      wrap.querySelector('#cr_colour').value = cr.colour || '';
      wrap.querySelector('#cr_fuel').value = cr.fuel || '';

      // Reload linkage hint
      loadFromReg();

      document.getElementById('app').scrollIntoView({ behavior: 'smooth' });
    }
  });

  setSaleHint();
  renderCredits();
  return wrap;
}

function hasPX(s){
  return !!(
    (s && String(s.pxReg||'').trim()) ||
    (s && String(s.pxMake||'').trim()) ||
    (s && String(s.pxModel||'').trim()) ||
    (s && String(s.pxMileage||s.pxMilage||'').trim())
  );
}

/* ========= Credit Invoice Printing ========= */
function printCreditInvoice(creditId){
  const cr = db.credits.find(x => x.id === creditId);
  if (!cr) return;

  const co = db.company || {};
  const fontPx  = Number(co.invoiceFontPx || 12);
  const termsPx = Number(co.termsFontPx || 10);

  const title = cr.type === 'credit_note' ? 'CREDIT NOTE' : 'REFUND RECEIPT';
  const refNo = 'CR' + (cr.id || '').slice(-6).toUpperCase();

  const logo = (co.logo||'').trim()
    ? `<img src="${co.logo}" style="max-width:${Number(co.logoMaxW||140)}px;max-height:${Number(co.logoMaxH||80)}px;object-fit:contain">`
    : '';

  const headerHTML = `<div class="h"><div>${logo}</div>
    <div style="text-align:right"><h2 style="margin:0">${title}</h2><div>Ref #: ${refNo}</div><div>Date: ${ddmmyyyy(cr.date||'')}</div></div></div>
    <div style="margin-top:6px"><b>${co.name||'Star Cars London Ltd'}</b><br>${co.address||''}<br>P: ${co.phone||''} ${co.email||''}<br>COMPANY #: ${co.companyNumber||''} ‚Ä¢ VAT #: ${co.vatNumber||''} ‚Ä¢ FCA #: ${co.fcaNumber||''}</div>`;

  const html = `<!doctype html><html><head><meta charset="utf-8"><title>${title}</title>
  <style>
    @page{size:A4;margin:10mm 10mm}
    body{font-family:Arial;color:#111;font-size:${fontPx}px}
    .h{display:flex;justify-content:space-between;align-items:flex-start;border-bottom:2px solid #000;padding-bottom:6px;margin-bottom:6px}
    table{width:100%;border-collapse:collapse}
    th,td{border:1px solid #000;padding:6px 8px;font-size:${fontPx}px;vertical-align:top}
    th{background:#f5f5f5;text-align:left}
    .terms{font-size:${Math.max(8,termsPx)}px;line-height:1.35}
    .terms{ page-break-inside: avoid; break-inside: avoid; }
    .tight td{padding:4px 6px}
    .negative{color:#d00;font-weight:bold}
  </style></head><body>
  <button class="no-print" onclick="window.print()" style="margin:8px 0">Print / Save as PDF</button>
  ${headerHTML}
  <table class="tight">
    <tr><th>Customer</th><td>${cr.customer||''}</td></tr>
    ${cr.vehicle ? `<tr><th>Vehicle</th><td>${cr.vehicle}</td></tr>` : ''}
    <tr><th>Type</th><td>${cr.type === 'credit_note' ? 'Credit Note' : 'Refund'}</td></tr>
    <tr><th>Payment Method</th><td>${cr.method === 'cash' ? 'Cash' : 'Bank Transfer'}</td></tr>
    <tr><th>Reason</th><td>${cr.reason||''}</td></tr>
  </table>
  <h3>Amount</h3>
  <table class="tight">
    <tr><th>Total ${cr.type === 'credit_note' ? 'Credit' : 'Refund'}</th><td class="right negative">${fmtMoney(cr.amount)}</td></tr>
  </table>
  <p class="terms">
    <b>Terms:</b><br>
    ${cr.type === 'credit_note'
      ? 'This credit note may be used against future purchases with ' + (co.name || 'Star Cars London Ltd') + '. Valid for 12 months from date of issue.'
      : 'This refund has been processed as indicated above. Please allow 3-5 working days for bank transfers to clear.'}
  </p>
  <p>Customer signature: _______________________ &nbsp;&nbsp; Authorised by: _______________________</p>
  <p style="margin-top:20px;font-size:${Math.max(10,fontPx-2)}px;color:#666">
    Issued by: ${co.name || 'Star Cars London Ltd'} ‚Ä¢ ${ddmmyyyy(cr.date)} ‚Ä¢ Ref: ${refNo}
  </p>
  </body></html>`;

  openPrintable(html);
}

/* ========= Purchase Invoice ========= */
function viewPurchaseInvoice(){
  if(!canTab('Purchase Invoice')) return document.createElement('div'); 
  const wrap=document.createElement('div'); wrap.className='card';
  wrap.innerHTML=`<h2>Purchase Invoices (Buy from Customers)</h2>
  <div class="row">
    <input id="pi_date" type="date">
    <input id="pi_supplier" placeholder="Seller Name">
    <input id="pi_reg" placeholder="Vehicle REG *" style="min-width:120px">
    <input id="pi_make" placeholder="Make">
    <input id="pi_model" placeholder="Model">
    <input id="pi_vin" placeholder="VIN (optional)">
    <input id="pi_mileage" type="number" placeholder="Mileage">
    <input id="pi_amount" type="number" placeholder="Purchase Amount ¬£">
    <select id="pi_method"><option value="bank">Bank</option><option value="cash">Cash</option></select>
    <input id="pi_invoiceNo" placeholder="Invoice #">
    <button id="pi_add" class="primary">Add Purchase</button>
  </div>
  <div class="row">
    <label style="min-width:320px;flex:1">Notes<textarea id="pi_notes" placeholder="Additional notes"></textarea></label>
  </div>
  <div class="row" style="margin-bottom:12px">
    <input id="pi_search" placeholder="Search by seller, reg, invoice" style="min-width:320px">
    <button id="pi_clear_search">Clear</button>
  </div>
  <table class="table" style="margin-top:10px">
    <thead>
      <tr>
        <th>Date</th>
        <th>Seller</th>
        <th>Reg</th>
        <th>Make</th>
        <th>Model</th>
        <th>Mileage</th>
        <th class="right">Amount</th>
        <th>Method</th>
        <th>Invoice #</th>
        <th>In Stock</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody id="pi_body"></tbody>
  </table>`;
  
  const body=wrap.querySelector('#pi_body');
  let editId=null;
  
  function renderPurchases(filter = '') {
  body.innerHTML = '';
  
  // Filter purchase invoices based on the search term
  const filtered = (db.purchaseInvoices || []).filter(pi => {
    return !filter || 
           (pi.supplier || '').toLowerCase().includes(filter) || 
           (pi.reg || '').toLowerCase().includes(filter) || 
           (pi.invoiceNo || '').toLowerCase().includes(filter);
  });

  filtered.forEach(pi => {
    // Check if vehicle is in stock
    const inStock = (db.vehicles || []).some(v => v.reg === pi.reg && v.status === 'for sale');

    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${ddmmyyyy(pi.date)}</td>
      <td>${pi.supplier || ''}</td>
      <td>${pi.reg || ''}</td>
      <td>${pi.make || ''}</td>
      <td>${pi.model || ''}</td>
      <td>${pi.mileage || ''}</td>
      <td class="right">${fmtMoney(pi.amount)}</td>
      <td>${pi.method || 'bank'}</td>
      <td>${pi.invoiceNo || ''}</td>
      <td>${inStock ? '‚úÖ' : ''}</td>
      <td>
        <button data-act="print" data-id="${pi.id}">Print Invoice</button>
        ${canAction('edit') ? `<button data-act="edit" data-id="${pi.id}">Edit</button>` : ''}
        ${canAction('del') ? `<button class="danger" data-act="del" data-id="${pi.id}">Delete</button>` : ''}
        ${!inStock ? `<button data-act="addToStock" data-id="${pi.id}">Add to Stock</button>` : ''}
      </td>`;
    body.appendChild(tr);
  });
}

  wrap.querySelector('#pi_search').addEventListener('input', function () {
    const searchTerm = this.value.toLowerCase().trim();
    renderPurchases(searchTerm);
  });

  wrap.querySelector('#pi_clear_search').onclick = function () {
    wrap.querySelector('#pi_search').value = '';
    renderPurchases();
  };
  
  wrap.querySelector('#pi_add').onclick=()=>{
    if(!canAction('add')) return alert('No permission');
    
    const pi={
      id: editId||uid(),
      date: wrap.querySelector('#pi_date').value,
      supplier: wrap.querySelector('#pi_supplier').value.trim(),
      reg: wrap.querySelector('#pi_reg').value.trim().toUpperCase(),
      make: wrap.querySelector('#pi_make').value.trim(),
      model: wrap.querySelector('#pi_model').value.trim(),
      vin: wrap.querySelector('#pi_vin').value.trim(),
      mileage: Number(wrap.querySelector('#pi_mileage').value||0),
      amount: Number(wrap.querySelector('#pi_amount').value||0),
      method: wrap.querySelector('#pi_method').value,
      invoiceNo: wrap.querySelector('#pi_invoiceNo').value.trim(),
      notes: wrap.querySelector('#pi_notes').value.trim()
    };
    
    if(!pi.date || !pi.supplier || !pi.reg || !pi.amount) {
      return alert('Date, Seller, REG and Amount are required');
    }
    
    // Check for duplicate REG in purchase invoices (excluding current edit)
    const dupe = (db.purchaseInvoices||[]).find(x => x.reg === pi.reg && x.id !== editId);
    if(dupe) return alert('Duplicate REG in purchase invoices');
    
    if(editId){
      db.purchaseInvoices = db.purchaseInvoices.map(x => x.id === editId ? pi : x);
      addAudit('update','purchaseInvoice',pi.id,`Purchase from ${pi.supplier} - ${pi.reg} - ${fmtMoney(pi.amount)}`);
      editId = null;
    } else {
      db.purchaseInvoices = db.purchaseInvoices || [];
      db.purchaseInvoices.unshift(pi);
      addAudit('add','purchaseInvoice',pi.id,`Purchase from ${pi.supplier} - ${pi.reg} - ${fmtMoney(pi.amount)}`);
    }
    
    saveDB(); 
    try{renderAlertBell();}catch(e){}
    renderPurchases();
    
    // Clear form
    wrap.querySelector('#pi_supplier').value = '';
    wrap.querySelector('#pi_reg').value = '';
    wrap.querySelector('#pi_make').value = '';
    wrap.querySelector('#pi_model').value = '';
    wrap.querySelector('#pi_vin').value = '';
    wrap.querySelector('#pi_mileage').value = '';
    wrap.querySelector('#pi_amount').value = '';
    wrap.querySelector('#pi_invoiceNo').value = '';
    wrap.querySelector('#pi_notes').value = '';
  };
  
  wrap.addEventListener('click',(ev)=>{
    const b=ev.target.closest('button'); 
    if(!b) return; 
    const id=b.dataset.id, act=b.dataset.act;
    
    if(act==='del'){
    if(!canAction('del')) return alert('No permission');
    if(!confirm('Delete this purchase invoice?')) return;
    const delPi=db.purchaseInvoices.find(x=>x.id===id);

    // mark deletion for sync
    markDeleted('purchaseInvoices', id);

    db.purchaseInvoices=db.purchaseInvoices.filter(x=>x.id!==id);
    saveDB(); 
    try{renderAlertBell();}catch(e){}
    addAudit('delete','purchaseInvoice',id,delPi?`Purchase from ${delPi.supplier} - ${delPi.reg}`:'');
    renderPurchases();
  }

    else if(act==='edit'){
      if(!canAction('edit')) return alert('No permission');
      const pi=db.purchaseInvoices.find(x=>x.id===id);
      editId=id;
      wrap.querySelector('#pi_date').value=pi.date;
      wrap.querySelector('#pi_supplier').value=pi.supplier||'';
      wrap.querySelector('#pi_reg').value=pi.reg||'';
      wrap.querySelector('#pi_make').value=pi.make||'';
      wrap.querySelector('#pi_model').value=pi.model||'';
      wrap.querySelector('#pi_vin').value=pi.vin||'';
      wrap.querySelector('#pi_mileage').value=pi.mileage||0;
      wrap.querySelector('#pi_amount').value=pi.amount||0;
      wrap.querySelector('#pi_method').value=pi.method||'bank';
      wrap.querySelector('#pi_invoiceNo').value=pi.invoiceNo||'';
      wrap.querySelector('#pi_notes').value=pi.notes||'';
      document.getElementById('app').scrollIntoView({ behavior: 'smooth' });
    }
    else if(act==='print'){
      printPurchaseInvoice(id);
    }
    else if(act==='addToStock'){
      const pi=db.purchaseInvoices.find(x=>x.id===id);
      if(!pi) return;
      
      // Check if vehicle already exists in stock
      const existingVehicle = (db.vehicles||[]).find(v => v.reg === pi.reg);
      if(existingVehicle) {
        return alert(`Vehicle ${pi.reg} already exists in stock`);
      }
      
      // Add to vehicles
      const vehicle = {
        id: uid(),
        reg: pi.reg,
        make: pi.make,
        model: pi.model,
        colour: '',
        fuel: '',
        mileage: pi.mileage,
        purchase: pi.amount,
        ownerType: 'owned',
        investor: '',
        supplier: pi.supplier,
        vin: pi.vin,
        status: 'for sale',
        createdAt: pi.date || new Date().toISOString(),
        media: [],
        video: ''
      };
      
      db.vehicles.unshift(vehicle);
      saveDB();
      try{renderAlertBell();}catch(e){}
      addAudit('add','vehicle',vehicle.id,`Added to stock from purchase invoice - ${vehicle.reg}`);
      alert(`Vehicle ${pi.reg} added to stock`);
      renderPurchases();
    }
  });
  
  renderPurchases();
  return wrap;
}

/* ========= Purchase Invoice Printing ========= */
function printPurchaseInvoice(purchaseId){
  const pi = db.purchaseInvoices.find(x => x.id === purchaseId);
  if (!pi) return;

  const co = db.company || {};
  const fontPx  = Number(co.invoiceFontPx || 12);
  const termsPx = Number(co.termsFontPx || 10);

  const refNo = 'PI' + (pi.id || '').slice(-6).toUpperCase();

  const logo = (co.logo||'').trim()
    ? `<img src="${co.logo}" style="max-width:${Number(co.logoMaxW||140)}px;max-height:${Number(co.logoMaxH||80)}px;object-fit:contain">`
    : '';

  const headerHTML = `<div class="h"><div>${logo}</div>
    <div style="text-align:right"><h2 style="margin:0">PURCHASE INVOICE</h2><div>Ref #: ${refNo}</div><div>Date: ${ddmmyyyy(pi.date||'')}</div></div></div>
    <div style="margin-top:6px"><b>${co.name||'Star Cars London Ltd'}</b><br>${co.address||''}<br>P: ${co.phone||''} ${co.email||''}<br>COMPANY #: ${co.companyNumber||''} ‚Ä¢ VAT #: ${co.vatNumber||''} ‚Ä¢ FCA #: ${co.fcaNumber||''}</div>`;

  const html = `<!doctype html><html><head><meta charset="utf-8"><title>Purchase Invoice</title>
  <style>
    @page{size:A4;margin:10mm 10mm}
    body{font-family:Arial;color:#111;font-size:${fontPx}px}
    .h{display:flex;justify-content:space-between;align-items:flex-start;border-bottom:2px solid #000;padding-bottom:6px;margin-bottom:6px}
    table{width:100%;border-collapse:collapse}
    th,td{border:1px solid #000;padding:6px 8px;font-size:${fontPx}px;vertical-align:top}
    th{background:#f5f5f5;text-align:left}
    .terms{font-size:${Math.max(8,termsPx)}px;line-height:1.35}
    .terms{ page-break-inside: avoid; break-inside: avoid; }
    .tight td{padding:4px 6px}
    .no-print{margin:8px 0}
    @media print{.no-print{display:none !important}}
  </style></head><body>
  <button class="no-print" onclick="window.print()" style="margin:8px 0">Print / Save as PDF</button>
  ${headerHTML}
  <table class="tight">
    <tr><th>Seller</th><td>${pi.supplier||''}</td></tr>
    <tr><th>Invoice Number</th><td>${pi.invoiceNo||refNo}</td></tr>
    <tr><th>Payment Method</th><td>${pi.method === 'cash' ? 'Cash' : 'Bank Transfer'}</td></tr>
  </table>

  <h3>Vehicle Details</h3>
  <table class="tight">
    <tr><th>Registration</th><td><b>${pi.reg||''}</b></td></tr>
    <tr><th>Make</th><td>${pi.make||''}</td></tr>
    <tr><th>Model</th><td>${pi.model||''}</td></tr>
    <tr><th>VIN</th><td>${pi.vin||''}</td></tr>
    <tr><th>Mileage</th><td>${pi.mileage||''}</td></tr>
  </table>

  <h3>Purchase Details</h3>
  <table class="tight">
    <tr><th>Purchase Amount</th><td class="right">${fmtMoney(pi.amount)}</td></tr>
  </table>

  <div class="terms">
    <b>Purchase Terms:</b><br>
    Vehicle purchased as seen. Payment made as indicated above. All relevant documentation and keys exchanged at time of purchase.
    ${pi.notes ? `<br><br><b>Additional Notes:</b><br>${pi.notes}` : ''}
  </div>

  <p>Seller signature: _______________________ &nbsp;&nbsp; Buyer signature: _______________________</p>

  <p style="margin-top:20px;font-size:${Math.max(10,fontPx-2)}px;color:#666">
    Issued by: ${co.name || 'Star Cars London Ltd'} ‚Ä¢ ${ddmmyyyy(pi.date)} ‚Ä¢ Ref: ${refNo}
  </p>
  </body></html>`;

  openPrintable(html);
}

/* ========= Directors ========= */
function viewDirectors(){ if(!canTab('Directors')) return document.createElement('div'); const wrap=document.createElement('div'); wrap.className='card';
  wrap.innerHTML=`<h2>Directors</h2><div class="row"><select id="d_sel">${(db.partners||[]).map((p,i)=>`<option value="${i}">${p.name}</option>`).join('')}</select><input id="d_rename" placeholder="Rename selected"><button id="d_renbtn">Rename</button></div><div id="d_box" class="card"></div>`;
  // Ensure Delete button exists next to Rename
  (function(){
    const row = wrap.querySelector('.row');
    const ren = wrap.querySelector('#d_renbtn');
    if(ren && !wrap.querySelector('#d_delbtn')){
      const btn=document.createElement('button');
      btn.id='d_delbtn'; btn.className='danger'; btn.textContent='Delete';
      ren.parentNode.insertBefore(btn, ren.nextSibling);
    }
  })();
  const sel=()=>wrap.querySelector('#d_sel');
  
  // Delete selected director
  var __del=wrap.querySelector('#d_delbtn'); if(__del) __del.onclick=()=>{
    const i=Number(sel().value||0); const p=(db.partners||[])[i]; if(!p) return;
    if(!confirm('Delete director \"'+(p.name||'')+'\"? This will remove their record.')) return;
    (db.partners||[]).splice(i,1);
    saveDB(); try{renderAlertBell();}catch(e){}; addAudit('delete','director',p.id,(p.name||'')); setTab('Directors');
  };
function renderBox(){ const i=Number(sel().value||0); const p=db.partners[i]; if(!p){ wrap.querySelector('#d_box').innerHTML=''; return; }
    const tx=(p.tx||[]).map(t=>`<tr><td>${ddmmyyyy(t.date||'')}</td><td>${t.type}</td><td>${t.method||'bank'}</td><td class="right">${fmtMoney(t.amount)}</td><td>${t.note||''}</td><td>${canAction('edit')?`<button data-act="edit" data-id="${t.id}">Edit</button>`:''} ${canAction('del')?`<button class="danger" data-act="del" data-id="${t.id}">Delete</button>`:''}</td></tr>`).join('')||'<tr><td colspan="6" class="small">No transactions</td></tr>';
    wrap.querySelector('#d_box').innerHTML=`<div class="row"><input id="d_date" type="date"><select id="d_type"><option value="invest">invest</option><option value="withdraw">withdraw</option><option value="profit">profit</option></select><select id="d_method"><option>bank</option><option>cash</option></select><input id="d_amt" type="number" placeholder="Amount"><input id="d_note" placeholder="Note"><button id="d_add" class="primary">Add / Update</button></div>
    <div class="row small"><b>Balance:</b> ${fmtMoney(p.balance||0)}</div><table class="table" style="margin-top:10px"><thead><tr><th>Date</th><th>Type</th><th>Method</th><th class="right">Amount</th><th>Note</th><th>Actions</th></tr></thead><tbody id="d_body">${tx}</tbody></table>`;
    let editTxId=null; wrap.querySelector('#d_add').onclick=()=>{ if(!canAction('add')) return alert('No permission'); const t={id:editTxId||uid(),date:wrap.querySelector('#d_date').value,type:wrap.querySelector('#d_type').value,method:wrap.querySelector('#d_method').value,amount:Number(wrap.querySelector('#d_amt').value||0),note:wrap.querySelector('#d_note').value.trim()};
      if(editTxId){ p.tx=p.tx.map(x=>x.id===editTxId?t:x); addAudit('update','directorTx',t.id,(p?.name||'')+' '+t.type+' '+t.amount); editTxId=null; } else { p.tx=p.tx||[]; p.tx.unshift(t); addAudit('add','directorTx',t.id,(p?.name||'')+' '+t.type+' '+t.amount); }
      p.balance=(p.tx||[]).reduce((bal,x)=> bal+((x.type==='invest'||x.type==='profit')?+x.amount:-x.amount),0); saveDB(); try{renderAlertBell();}catch(e){}; renderBox(); };
    wrap.querySelector('#d_body').addEventListener('click',(ev)=>{ const b=ev.target.closest('button'); if(!b) return; const id=b.dataset.id,act=b.dataset.act; const t=(p.tx||[]).find(x=>x.id===id);
      if(act==='edit'){ if(!canAction('edit')) return alert('No permission'); editTxId=t.id; wrap.querySelector('#d_date').value=t.date; wrap.querySelector('#d_type').value=t.type; wrap.querySelector('#d_method').value=t.method||'bank'; wrap.querySelector('#d_amt').value=t.amount||0; wrap.querySelector('#d_note').value=t.note||''; document.getElementById('app').scrollIntoView({ behavior: 'smooth' });}
      else if(act==='del'){ if(!canAction('del')) return alert('No permission'); if(!confirm('Delete transaction?'))return; p.tx=p.tx.filter(x=>x.id!==id); p.balance=(p.tx||[]).reduce((bal,x)=> bal+((x.type==='invest'||x.type==='profit')?+x.amount:-x.amount),0); saveDB(); try{renderAlertBell();}catch(e){}; addAudit('delete','directorTx',id,(p?.name||'')); renderBox(); } });
  }
  wrap.querySelector('#d_sel').onchange=renderBox; renderBox();
  wrap.querySelector('#d_renbtn').onclick=()=>{ if(!canAction('edit')) return alert('No permission'); const i=Number(sel().value||0); const p=db.partners[i]; if(!p) return; const nm=wrap.querySelector('#d_rename').value.trim(); if(!nm) return; p.name=nm; saveDB(); try{renderAlertBell();}catch(e){}; addAudit('update','director','rename',nm); setTab('Directors'); };
  return wrap;
}

/* ========= Investors ========= */
function viewInvestors(){ if(!canTab('Investors')) return document.createElement('div'); const wrap=document.createElement('div'); wrap.className='card';
  wrap.innerHTML=`<h2>Investors</h2><div class="row"><input id="i_name" placeholder="Investor name"><button id="i_addInv" class="primary">Add investor</button><span class="small">Track funds in/out & balance; tag investor on vehicle.</span></div>
  <div class="row"><select id="i_sel"><option value="">Select investor‚Ä¶</option>${(db.investors||[]).map(i=>`<option value="${i.id}">${i.name}</option>`).join('')}</select></div><div id="i_box" class="card"></div>`;
  
  // Hard-wire Delete button next to "Add investor"
  (function(){
    const addBtn = wrap.querySelector('#i_addInv');
    if(addBtn && !wrap.querySelector('#i_delbtn')){
      const del = document.createElement('button');
      del.id='i_delbtn'; del.className='danger'; del.textContent='Delete';
      addBtn.parentNode.insertBefore(del, addBtn.nextSibling);
    }
  })();
  
  wrap.querySelector('#i_addInv').onclick=()=>{ 
    if(!canAction('add')) return alert('No permission'); 
    const name=wrap.querySelector('#i_name').value.trim(); 
    if(!name) return alert('Enter name'); 
    const inv={id:uid(),name,balance:0,tx:[]}; 
    (db.investors=db.investors||[]).unshift(inv); 
    saveDB(); 
    try{renderAlertBell();}catch(e){}; 
    addAudit('add','investor',inv.id,name); 
    setTab('Investors'); 
  };
  
  // Investor deletion - single clean implementation
  (function(){
    const delBtn = wrap.querySelector('#i_delbtn');
    if(!delBtn || delBtn._wired) return;
    delBtn._wired = true;
    delBtn.onclick = () => {
      if(!canAction('del')) return alert('No permission to delete investors');
      
      const sel = wrap.querySelector('#i_sel');
      const id = (sel && sel.value) || '';
      if(!id) return alert('Select an investor to delete');
      
      const inv = (db.investors||[]).find(x => x.id === id);
      if(!inv) return alert('Investor not found');
      
      // Check for linked vehicles
      const linked = (db.vehicles || []).filter(v => {
        const byId   = v.investorId && v.investorId === inv.id;
        const byName = (v.investor || '') === inv.name;
        return byId || byName;
      });

      if (linked.length > 0) {
        const others = (db.investors || []).filter(x => x !== inv);
        let choice = 'dealer';

        if (others.length > 0) {
          const names = others.map(o => o.name).join(', ');
          const ans = prompt(
            'Investor "' + inv.name + '" has ' + linked.length + ' vehicle(s).\n' +
            'Type a new investor name to reassign (' + names + '), or leave blank for DEALER:',
            ''
          );
          if (ans && ans.trim()) {
            choice = ans.trim();
          }
        }

        // Reassign vehicles
        linked.forEach(v => {
          if (choice === 'dealer') {
            v.ownerType = 'owned';
            v.investor = '';
            v.investorId = null;
          } else {
            const newInv = (db.investors || []).find(x => x.name === choice);
            v.ownerType = 'investor';
            v.investor = choice;
            v.investorId = newInv ? newInv.id : null;
          }
        });
      }

    const soldIds = new Set((db.sales || []).map(s => s.vehicleId));
    const live = linked.filter(v => !soldIds.has(v.id));

    assigned = live.reduce((t, v) => {
      const vx = (db.vehicleExpenses || [])
        .filter(e => e.vehicleId === v.id)
        .reduce((u, e) => u + Number(e.amount || 0), 0);
      return t + Number(v.purchase || 0) + vx;
    }, 0);
    unassigned = Number(inv.balance || 0) - assigned;
      
      if(linked.length > 0){
        const others = (db.investors||[]).filter(x => x !== inv);
        let choice = 'dealer';
        
        if(others.length > 0){
          const names = others.map(o => o.name).join(', ');
          const ans = prompt(
            'Investor \"' + inv.name + '\" has ' + linked.length + ' vehicle(s).\n' +
            'Type a new investor name to reassign (' + names + '), or leave blank for DEALER:',
            ''
          );
          if(ans && others.some(o => o.name === ans)) {
            choice = ans;
          } else {
            choice = 'dealer';
          }
        }
        
        // Reassign vehicles
        linked.forEach(v => {
          if(choice === 'dealer'){
            v.ownerType = 'owned';
            v.investor = '';
          } else {
            v.ownerType = 'investor';
            v.investor = choice;
          }
        });
      }
      
      if(!confirm('Delete investor \"' + (inv.name||'') + '\"?')) return;
      
      db.investors = (db.investors||[]).filter(x => x !== inv);
      saveDB(); 
      try{renderAlertBell();}catch(e){}
      addAudit('delete','investor',inv.id,(inv.name||''));
      setTab('Investors'); // Refresh the view
    };
  })();

  function renderDetails(id){ 
    let assigned = 0, unassigned = 0;
    const inv=(db.investors||[]).find(x=>x.id===id); 
    if(!inv){ wrap.querySelector('#i_box').innerHTML=''; return; }
    
    let ins=0,outs=0; 
    (inv.tx||[]).forEach(x=>{ 
      if(x.type==='fund_in') ins+=+x.amount||0; 
      if(x.type==='withdraw') outs+=+x.amount||0; 
    }); 
    inv.balance=ins-outs;
    
    const linked=(db.vehicles||[]).filter(v=> v.ownerType==='investor' && (v.investor||'')===inv.name);
    const soldIds=new Set((db.sales||[]).map(s=>s.vehicleId));
    const live=linked.filter(v=>!soldIds.has(v.id));
    assigned = live.reduce((t,v)=>{ 
      const vx=(db.vehicleExpenses||[]).filter(e=>e.vehicleId===v.id).reduce((u,e)=>u+Number(e.amount||0),0); 
      return t + Number(v.purchase||0) + vx; 
    },0);
    unassigned = Number(inv.balance||0) - assigned;

    const txRows=(inv.tx||[]).map(t=>`<tr><td>${ddmmyyyy(t.date||'')}</td><td>${t.type}</td><td>${t.method||'bank'}</td><td class="right">${fmtMoney(t.amount)}</td><td>${t.note||''}</td><td>${canAction('edit')?`<button data-act="edit" data-id="${t.id}">Edit</button>`:''} ${canAction('del')?`<button class="danger" data-act="del" data-id="${t.id}">Delete</button>`:''}</td></tr>`).join('')||'<tr><td colspan="6" class="small">No transactions</td></tr>';
    
    wrap.querySelector('#i_box').innerHTML=`<div class="row"><input id="i_date" type="date"><select id="i_type"><option value="fund_in">fund_in</option><option value="withdraw">withdraw</option></select><select id="i_method"><option>bank</option><option>cash</option></select><input id="i_amt" type="number" placeholder="Amount"><input id="i_note" placeholder="Note"><button id="i_tx" class="primary">Add / Update</button></div>
    <div class="row small"><b>Balance:</b> ${fmtMoney(inv.balance||0)}</div>
    <div class=\"row small\"><b>Assigned to vehicles (unsold):</b> ${fmtMoney(assigned)} &nbsp; <b>Unassigned:</b> ${fmtMoney(unassigned)}</div><table class="table" style="margin-top:10px"><thead><tr><th>Date</th><th>Type</th><th>Method</th><th class="right">Amount</th><th>Note</th><th>Actions</th></tr></thead><tbody id="i_body">${txRows}</tbody></table>`;
    
    let editTxId=null; 
    wrap.querySelector('#i_tx').onclick=()=>{ 
      if(!canAction('add')) return alert('No permission'); 
      const t={id:editTxId||uid(),date:wrap.querySelector('#i_date').value,type:wrap.querySelector('#i_type').value,method:wrap.querySelector('#i_method').value,amount:Number(wrap.querySelector('#i_amt').value||0),note:wrap.querySelector('#i_note').value.trim()};
      if(editTxId){ 
        inv.tx=inv.tx.map(x=>x.id===editTxId?t:x); 
        addAudit('update','investorTx',t.id,inv.name+' '+t.type+' '+t.amount); 
      } else { 
        inv.tx=inv.tx||[]; 
        inv.tx.unshift(t); 
        addAudit('add','investorTx',t.id,inv.name+' '+t.type+' '+t.amount); 
      }
      let ins=0,outs=0; 
      (inv.tx||[]).forEach(x=>{ 
        if(x.type==='fund_in') ins+=+x.amount||0; 
        if(x.type==='withdraw') outs+=+x.amount||0; 
      }); 
      inv.balance=ins-outs; 
      saveDB(); 
      try{renderAlertBell();}catch(e){}; 
      editTxId=null; 
      wrap.querySelector('#i_amt').value=''; 
      wrap.querySelector('#i_note').value=''; 
      renderDetails(id);
    };
    
    wrap.querySelector('#i_body').addEventListener('click',(ev)=>{ 
      const b=ev.target.closest('button'); 
      if(!b) return; 
      const t=(inv.tx||[]).find(x=>x.id===b.dataset.id);
      if(b.dataset.act==='edit'){ 
        if(!canAction('edit')) return alert('No permission'); 
        editTxId=t.id; 
        wrap.querySelector('#i_date').value=t.date; 
        wrap.querySelector('#i_type').value=t.type; 
        wrap.querySelector('#i_method').value=t.method||'bank'; 
        wrap.querySelector('#i_amt').value=t.amount||0; 
        wrap.querySelector('#i_note').value=t.note||'';
        document.getElementById('app').scrollIntoView({ behavior: 'smooth' }); 
      }
      else if(b.dataset.act==='del'){ 
        if(!canAction('del')) return alert('No permission'); 
        if(!confirm('Delete?')) return; 
        inv.tx=inv.tx.filter(x=>x.id!==t.id); 
        let ins=0,outs=0; 
        (inv.tx||[]).forEach(x=>{ 
          if(x.type==='fund_in') ins+=+x.amount||0; 
          if(x.type==='withdraw') outs+=+x.amount||0; 
        }); 
        inv.balance=ins-outs; 
        saveDB(); 
        try{renderAlertBell();}catch(e){}; 
        addAudit('delete','investorTx',t.id,inv.name); 
        renderDetails(id); 
      }
    });
  }
  
  wrap.querySelector('#i_sel').onchange=(e)=>renderDetails(e.target.value); 
  return wrap;
}

/* ========= Invoice / Proforma printing ========= */
function price(n){ return '¬£'+Number(n||0).toFixed(2); }
function invoiceHeaderHTML(title, refNo, date){
  const co=db.company||{};
  const logo = (co.logo||'').trim()
    ? `<img src="${co.logo}" style="max-width:${Number(co.logoMaxW||140)}px;max-height:${Number(co.logoMaxH||80)}px;object-fit:contain">`
    : '';
  const now = new Date();
  const timeStr = now.toLocaleTimeString('en-GB',{hour:'2-digit',minute:'2-digit'});
  return `<div class="h"><div>${logo}</div>
    <div style="text-align:right"><h2 style="margin:0">${title}</h2><div>Invoice #: ${refNo||''}</div><div>Date: ${ddmmyyyy(date||'')}</div><div>Time: ${timeStr}</div></div></div>
    <div style="margin-top:6px"><b>${co.name||'Star Cars London Ltd'}</b><br>${co.address||''}<br>P: ${co.phone||''} ${co.email||''}<br>COMPANY #: ${co.companyNumber||''} ‚Ä¢ VAT #: ${co.vatNumber||''} ‚Ä¢ FCA #: ${co.fcaNumber||''}</div>`;
}

function printInvoice(saleId){
  const s = db.sales.find(x => x.id === saleId);
  if (!s) return;

  const v  = db.vehicles.find(x => x.id === s.vehicleId) || {};
  const co = db.company || {};
  const fontPx  = Number(co.invoiceFontPx || 12);
  const termsPx = Number(co.termsFontPx || 10);

  const html = `<!doctype html><html><head><meta charset="utf-8"><title>Invoice</title>
  <style>
    @page{size:A4;margin:10mm 10mm}
    body{font-family:Arial;color:#111;font-size:${fontPx}px}
    .h{display:flex;justify-content:space-between;align-items:flex-start;border-bottom:2px solid #000;padding-bottom:6px;margin-bottom:6px}
    .title{font-size:26px;font-weight:800;letter-spacing:.5px}
    .right{text-align:right}
    .co{margin-top:6px}
    table{width:100%;border-collapse:collapse}
    th,td{border:1px solid #000;padding:8px 10px;font-size:${fontPx}px;vertical-align:top}
    th{background:#fff;text-align:left;font-weight:700}
    .tight td,.tight th{padding:6px 8px}
    .no-border{border:none !important}
    .terms{font-size:${Math.max(8,termsPx)}px;line-height:1.35;white-space:normal}
    .terms{ page-break-inside: avoid; break-inside: avoid; }
    .no-print{margin:8px 0}
    @media print{.no-print{display:none !important}}

    /* Bottom layout like your PDF */
    .sigRow{margin:18px 0 10px}

  .sigLine{
  display:inline-block;
  width:180px;              /* ‚¨Ö shorter line */
  border-bottom:1px solid #000;
  height:14px;
  vertical-align:baseline;
  }

  .sigFlex{
  display:flex;
  gap:12px;
  align-items:center;
  white-space:nowrap;       /* ‚¨Ö forces single line */
  margin-bottom:18px;
  }

    .pxBox{width:62%}
    .payBox{width:38%}
    .pxInner{width:100%;border-collapse:collapse}
    .pxInner th,.pxInner td{border:1px solid #000;padding:10px;font-size:${fontPx}px}
    .pxTitle{font-family:Georgia,"Times New Roman",serif;font-size:28px;text-align:center;font-weight:500}
    .payTbl{width:100%;border-collapse:collapse}
    .payTbl th,.payTbl td{border:1px solid #000;padding:8px 10px;font-size:${fontPx}px}
    .payTbl th{width:70%;font-weight:700}
    .payTbl td{text-align:right}
  </style></head><body>

  <button class="no-print" onclick="window.print()" style="margin:8px 0">Print / Save as PDF</button>

  ${invoiceHeaderHTML('SALES INVOICE', s.invNo, s.date)}

  <!-- Invoice To / Deliver To -->
  <table class="tight">
    <tr>
      <th style="width:30%">Invoice To:</th>
      <td>${s.buyer||''}<br>${s.address||''}<br>${s.phone||''} ${s.email||''}</td>
    </tr>
    ${s.deliverTo && s.deliverTo.trim() ? `
    <tr>
      <th>Deliver To:</th>
      <td>${s.deliverTo||''}</td>
    </tr>
    ` : ``}
  </table>

  <!-- Vehicle block -->
  <table class="tight" style="margin-top:0">
    <tr>
      <th style="width:26%">Vehicle</th>
      <td>
        <b>${v.make||''} ${v.model||''}</b><br>
        Colour: ${v.colour||''}<br>
        REG: <b>${v.reg||''}</b> &nbsp; VIN: ${v.vin||''}<br>
        Mileage: ${(s.mileage||v.mileage||'')} &nbsp; First Reg: ${ddmmyyyy(s.firstReg||'')}
      </td>
    </tr>
    <tr>
      <th>Keys / MOT / History</th>
      <td>
        Keys: ${s.keys||'N/A'} &nbsp;&nbsp;
        MOT Exp: ${s.mot||'N/A'} &nbsp;&nbsp;
        Service History: ${s.serviceHistory||'N/A'}
      </td>
    </tr>
  </table>

  <!-- Terms -->
  <div style="margin-top:10px">
    <div style="font-weight:700;margin-bottom:4px">Terms:</div>
    <div class="terms">${String(co.terms||'').replace(/\n/g,'<br>')}</div>
  </div>

  <!-- Signatures -->
  <div class="sigRow">
  <div class="sigFlex">
    <span><b>Customer Date:</b></span>
    <span class="sigLine"></span>
    <span><b>Customer Signature:</b></span>
    <span class="sigLine"></span>
  </div>

  <div class="sigFlex">
    <span><b>Dealer Date:</b></span>
    <span class="sigLine"></span>
    <span><b>Dealer Signature:</b></span>
    <span class="sigLine"></span>
  </div>

  ${hasPX(s) ? `
  <div class="bottomWrap">
  <table class="bottomTbl" style="width:100%;border-collapse:collapse">
    <tr>
      <td class="pxBox" style="padding-right:14px;border:none">
        <table class="pxInner">
          <tr><th class="pxTitle" colspan="2"><b>PART EX</b></th></tr>
          <tr>
            <td style="width:50%"><b>MAKE:</b><br>${s.pxMake || '‚Äî'}</td>
            <td style="width:50%"><b>MODEL:</b><br>${s.pxModel || '‚Äî'}</td>
          </tr>
          <tr>
            <td><b>REG:</b><br>${s.pxReg || '‚Äî'}</td>
            <td><b>MILEAGE:</b><br>${s.pxMileage || s.pxMilage || '‚Äî'}</td>
          </tr>
          <tr>
            <td colspan="2" style="height:40px"></td>
          </tr>
        </table>
      </td>

      <td class="payBox" style="border:none">
        <table class="payTbl">
          <tr><th>Cash Price</th><td>${price(s.salePrice)}</td></tr>
          <tr><th>Deposit</th><td>${price(s.deposit)}</td></tr>
          <tr><th>Cash</th><td>${price(s.cash)}</td></tr>
          <tr><th>Card</th><td>${price(s.card)}</td></tr>
          <tr><th>Bank</th><td>${price(s.bank)}</td></tr>
          <tr><th>Finance</th><td>${price(s.finance)}</td></tr>
          <tr><th>Part-ex Allowance</th><td>${price(s.pxAllowance)}</td></tr>
          <tr><th>Total Paid</th><td>${price((+s.deposit||0)+(+s.cash||0)+(+s.card||0)+(+s.bank||0)+(+s.finance||0)+(+s.pxAllowance||0))}</td></tr>
        </table>
      </td>
    </tr>
  </table>
  </div>
  ` : `
  <div class="bottomWrap">
  <table style="width:100%;border-collapse:collapse">
    <tr>
      <td style="border:none">
        <table class="payTbl" style="width:50%;margin-left:auto">
          <tr><th>Cash Price</th><td>${price(s.salePrice)}</td></tr>
          <tr><th>Deposit</th><td>${price(s.deposit)}</td></tr>
          <tr><th>Cash</th><td>${price(s.cash)}</td></tr>
          <tr><th>Card</th><td>${price(s.card)}</td></tr>
          <tr><th>Bank Transfer</th><td>${price(s.bank)}</td></tr>
          <tr><th>Finance</th><td>${price(s.finance)}</td></tr>
          <tr><th>Total Paid</th><td>${price((+s.deposit||0)+(+s.cash||0)+(+s.card||0)+(+s.bank||0)+(+s.finance||0))}</td></tr>
        </table>
      </td>
    </tr>
  </table>
  </div>
  `}

  </body></html>`;

  openPrintable(html);
}

function printFinanceProforma(saleId){
  const s = db.sales.find(x => x.id === saleId);
  if (!s) return;

  const v  = db.vehicles.find(x => x.id === s.vehicleId) || {};
  const co = db.company || {};
  const fontPx  = Number(co.invoiceFontPx || 12);
  const termsPx = Number(co.termsFontPx || 10);

  const logo = (co.logo||'').trim()
    ? `<img src="${co.logo}" style="max-width:${Number(co.logoMaxW||140)}px;max-height:${Number(co.logoMaxH||80)}px;object-fit:contain">`
    : '';
  const now    = new Date();
  const timeStr = now.toLocaleTimeString('en-GB',{hour:'2-digit',minute:'2-digit'});

  const headerHTML = `<div class="h">
    <div>${logo}</div>
    <div class="right">
      <div class="title">PROFORMA INVOICE ‚Äî FINANCE</div>
      <div>Invoice #: ${s.invNo||''}</div>
      <div>Date: ${ddmmyyyy(s.date||'')}</div>
      <div>Time: ${timeStr}</div>
    </div>
  </div>
  <div class="co">
    <b>${co.name||'Star Cars London Ltd'}</b><br>
    ${co.address||''}<br>
    P: ${co.phone||''} ${co.email||''}<br>
    COMPANY #: ${co.companyNumber||''} ‚Ä¢ VAT #: ${co.vatNumber||''} ‚Ä¢ FCA #: ${co.fcaNumber||''}
  </div>`;

  const financeTerms = (co.financeTerms || co.terms || '');

  const html = `<!doctype html><html><head><meta charset="utf-8"><title>Finance Proforma</title>
  <style>
    @page{size:A4;margin:10mm 10mm}
    body{font-family:Arial;color:#111;font-size:${fontPx}px}
    .h{display:flex;justify-content:space-between;align-items:flex-start;border-bottom:2px solid #000;padding-bottom:6px;margin-bottom:6px}
    .title{font-size:18px;font-weight:800;letter-spacing:.5px}
    .right{text-align:right}
    .co{margin-top:6px}
    table{width:100%;border-collapse:collapse}
    th,td{border:1px solid #000;padding:8px 10px;font-size:${fontPx}px;vertical-align:top}
    th{background:#fff;text-align:left;font-weight:700}
    .tight td,.tight th{padding:6px 8px}
    .terms{font-size:${Math.max(8,termsPx)}px;line-height:1.35;white-space:normal}
    .terms{ page-break-inside: avoid; break-inside: avoid; }
    .print-btn-proforma{margin:8px 0}
    @media print{.print-btn-proforma{display:none !important}}

    /* Bottom layout like your PDF */
    .sigRow{margin:18px 0 10px}

    .sigLine{
    display:inline-block;
    width:180px;              /* ‚¨Ö shorter line */
    border-bottom:1px solid #000;
    height:14px;
    vertical-align:baseline;
    }

    .sigFlex{
    display:flex;
    gap:12px;
    align-items:center;
    white-space:nowrap;       /* ‚¨Ö forces single line */
    margin-bottom:18px;
    }

    .pxBox{width:62%}
    .payBox{width:38%}
    .pxInner{width:100%;border-collapse:collapse}
    .pxInner th,.pxInner td{border:1px solid #000;padding:10px;font-size:${fontPx}px}
    .pxTitle{font-family:Georgia,"Times New Roman",serif;font-size:28px;text-align:center;font-weight:500}
    .payTbl{width:100%;border-collapse:collapse}
    .payTbl th,.payTbl td{border:1px solid #000;padding:8px 10px;font-size:${fontPx}px}
    .payTbl th{width:70%;font-weight:700}
    .payTbl td{text-align:right}
    </style></head><body>

  <button class="print-btn-proforma" onclick="window.print()" style="margin:8px 0">Print / Save as PDF</button>

  ${headerHTML}

  <!-- Invoice To / Deliver To -->
  <table class="tight">
    <tr>
      <th style="width:30%">Invoice To:</th>
      <td>${s.buyer||''}<br>${s.address||''}<br>${s.phone||''} ${s.email||''}</td></td>
    </tr>
    ${s.deliverTo && s.deliverTo.trim() ? `
    <tr>
      <th>Deliver To:</th>
      <td>${s.deliverTo||''}</td>
    </tr>
    ` : ``}
  </table>

  <!-- Vehicle block -->
  <table class="tight" style="margin-top:0">
    <tr>
      <th style="width:26%">Vehicle</th>
      <td>
        <b>${v.make||''} ${v.model||''}</b><br>
        Colour: ${v.colour||''}<br>
        REG: <b>${v.reg||''}</b> &nbsp; VIN: ${v.vin||''}<br>
        Mileage: ${(s.mileage||v.mileage||'')} &nbsp; First Reg: ${ddmmyyyy(s.firstReg||'')}
      </td>
    </tr>
    <tr>
      <th>Keys / MOT / History</th>
      <td>
        Keys: ${s.keys||'N/A'} &nbsp;&nbsp;
        MOT Exp: ${s.mot||'N/A'} &nbsp;&nbsp;
        Service History: ${s.serviceHistory||'N/A'}
      </td>
    </tr>
  </table>

  <!-- Terms -->
  <div style="margin-top:10px">
    <div style="font-weight:700;margin-bottom:4px">Terms:</div>
    <div class="terms">${String(financeTerms).replace(/\n/g,'<br>')}</div>
  </div>

  <!-- Signatures -->
  <div class="sigRow">
  <div class="sigFlex">
    <span><b>Customer Date:</b></span>
    <span class="sigLine"></span>
    <span><b>Customer Signature:</b></span>
    <span class="sigLine"></span>
  </div>

  <div class="sigFlex">
    <span><b>Dealer Date:</b></span>
    <span class="sigLine"></span>
    <span><b>Dealer Signature:</b></span>
    <span class="sigLine"></span>
  </div>

  ${hasPX(s) ? `
  <div class="bottomWrap">
  <table class="bottomTbl" style="width:100%;border-collapse:collapse">
    <tr>
      <td class="pxBox" style="padding-right:14px;border:none">
        <table class="pxInner">
          <tr><th class="pxTitle" colspan="2"><b>PART EX</b></th></tr>
          <tr>
            <td style="width:50%"><b>MAKE:</b><br>${s.pxMake || '‚Äî'}</td>
            <td style="width:50%"><b>MODEL:</b><br>${s.pxModel || '‚Äî'}</td>
          </tr>
          <tr>
            <td><b>REG:</b><br>${s.pxReg || '‚Äî'}</td>
            <td><b>MILEAGE:</b><br>${s.pxMileage || s.pxMilage || '‚Äî'}</td>
          </tr>
          <tr>
            <td colspan="2" style="height:40px"></td>
          </tr>
        </table>
      </td>

      <td class="payBox" style="border:none">
        <table class="payTbl">
          <tr><th>Cash Price</th><td>${price(s.salePrice)}</td></tr>
          <tr><th>Deposit</th><td>${price(s.deposit)}</td></tr>
          <tr><th>Cash</th><td>${price(s.cash)}</td></tr>
          <tr><th>Card</th><td>${price(s.card)}</td></tr>
          <tr><th>Bank</th><td>${price(s.bank)}</td></tr>
          <tr><th>Finance</th><td>${price(s.finance)}</td></tr>
          <tr><th>Part-ex Allowance</th><td>${price(s.pxAllowance)}</td></tr>
          <tr><th>Total Paid</th><td>${price((+s.deposit||0)+(+s.cash||0)+(+s.card||0)+(+s.bank||0)+(+s.finance||0)+(+s.pxAllowance||0))}</td></tr>
        </table>
      </td>
    </tr>
  </table>
  </div>
  ` : `
  <div class="bottomWrap">
  <table style="width:100%;border-collapse:collapse">
    <tr>
      <td style="border:none">
        <table class="payTbl" style="width:50%;margin-left:auto">
          <tr><th>Cash Price</th><td>${price(s.salePrice)}</td></tr>
          <tr><th>Deposit</th><td>${price(s.deposit)}</td></tr>
          <tr><th>Cash</th><td>${price(s.cash)}</td></tr>
          <tr><th>Card</th><td>${price(s.card)}</td></tr>
          <tr><th>Bank Transfer</th><td>${price(s.bank)}</td></tr>
          <tr><th>Finance</th><td>${price(s.finance)}</td></tr>
          <tr><th>Total Paid</th><td>${price((+s.deposit||0)+(+s.cash||0)+(+s.card||0)+(+s.bank||0)+(+s.finance||0))}</td></tr>
        </table>
      </td>
    </tr>
  </table>
  </div>
  `}

  </body></html>`;

  openPrintable(html);
}

function isRealSale(s) {
  if (!s) return false;
  if (s.refunded) return false;
  const st = s.status || 'completed'; // old sales have no status ‚Üí completed
  return st === 'completed';
}

/* ========= Reports (inc. Month Close) ========= */
function viewReports(){
  if(!canTab('Reports')) return document.createElement('div'); const wrap=document.createElement('div'); wrap.className='card';
  wrap.innerHTML=`<h2>Reports</h2>
  <div class="card"><h3>Audit Log</h3><div class="row"><input id="r_from" type="date"><input id="r_to" type="date"><select id="r_user"><option value="">All users</option>${(db.users||[]).map(u=>'<option>'+u.username+'</option>').join('')}</select>
  <select id="r_entity"><option value="">All entities</option><option>vehicle</option><option>sale</option><option>vehicleExpense</option><option>showroomExpense</option><option>directorTx</option><option>investorTx</option><option>todo</option></select>
  <button id="r_run">Run</button><button id="r_export">Export CSV</button></div><div id="r_out" class="small"></div>
  <details id="r_fold"><summary>Show audit entries (<span id="r_count">0</span>)</summary><div id="r_tblwrap"><table class="table" style="margin-top:8px"><thead><tr><th>When</th><th>User</th><th>Action</th><th>Entity</th><th>Details</th></tr></thead><tbody id="r_body"></tbody></table></div></details></div>

  <div class="card"><h3>Monthly Summary</h3><div class="row"><input id="rm_month" type="month" value="${new Date().toISOString().slice(0,7)}"><label class="small"><input type="checkbox" id="rm_cover"> Pretend showroom expenses covered by monthly profit</label><button id="rm_go">Calculate</button></div><div id="rm_box"></div></div>

  <div class="card"><h3>Month Close (Directors & Investors)</h3>
    <div class="row"><input id="mc_month" type="month" value="${new Date().toISOString().slice(0,7)}"> <button id="mc_prev">Preview</button><button id="mc_post" class="primary">Post</button><button id="mc_export">Export PDF</button><span id="mc_warn" class="small" style="margin-left:8px;color:#ffb3b3"></span></div><div id="mc_box" class="small"></div>
  </div>`;
  
  /* Audit Log */
  const body=wrap.querySelector('#r_body'); const out=wrap.querySelector('#r_out');
  function run(){ const f=wrap.querySelector('#r_from').value; const t=wrap.querySelector('#r_to').value; const user=wrap.querySelector('#r_user').value; const ent=wrap.querySelector('#r_entity').value;
    let rows=(db.audit||[]).slice(); if(f) rows=rows.filter(a=>a.ts>=f); if(t) rows=rows.filter(a=>a.ts<=t+'T23:59:59'); if(user) rows=rows.filter(a=>a.user===user); if(ent) rows=rows.filter(a=>a.entity===ent);
    body.innerHTML=''; rows.forEach(a=>{ const d=new Date(a.ts); body.insertAdjacentHTML('beforeend','<tr><td>'+ddmmyyyy(d.toISOString().slice(0,10))+'</td><td>'+(a.user||'')+'</td><td>'+a.action+'</td><td>'+a.entity+'</td><td>'+(a.details||'')+'</td></tr>'); }); out.textContent=rows.length+' entr'+(rows.length===1?'y':'ies'); }
  wrap.querySelector('#r_run').onclick=run; run();
  wrap.querySelector('#r_export').onclick=()=>{ const rows=[["When","User","Action","Entity","Details"]].concat((db.audit||[]).map(a=>[a.ts,a.user,a.action,a.entity,(a.details||'')])); const csv=rows.map(r=>r.map(v=>'"'+String(v).replace(/"/g,'""')+'"').join(',')).join('\n'); const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([csv],{type:'text/csv'})); a.download='audit.csv'; a.click(); };

  /* Monthly Summary - UPDATED to use purchaseDate instead of createdAt */
  wrap.querySelector('#rm_go').onclick=()=>{ 
    const k=(wrap.querySelector('#rm_month').value||'').slice(0,7); 
    let purchases=0,vehExp=0,showExp=0,sales=0,buyCount=0,sellCount=0;
    
    // Count vehicles purchased in this month - using purchaseDate or dateAdded field
    (db.vehicles||[]).forEach(v=>{ 
      // Try purchaseDate first, then dateAdded, then createdAt as fallback
      const purchaseDate = v.purchaseDate || v.dateAdded || v.createdAt || '';
      if(purchaseDate.slice(0,7)===k){ 
        purchases+=Number(v.purchase||0); 
        buyCount++; 
      }
    });
    
    (db.vehicleExpenses||[]).forEach(e=>{ if((e.date||'').slice(0,7)===k) vehExp+=Number(e.amount||0); });
    (db.showroomExpenses||[]).forEach(e=>{ if((e.date||'').slice(0,7)===k) showExp+=Number(e.amount||0); });
    
    // Count vehicles sold in this month
    (db.sales||[]).forEach(s=>{ 
      if ((s.date||'').slice(0,7)===k && isRealSale(s)) { 
        sales+=Number(s.salePrice||0); 
        sellCount++; 
      }
    });
    
    const cover = wrap.querySelector('#rm_cover').checked; 
    const showExpShown = cover ? 0 : showExp; 
    const net = sales - purchases - vehExp - showExpShown;
    
    const box=wrap.querySelector('#rm_box'); 
    box.innerHTML='<table class="table"><tbody>'
      +'<tr><th>Sold (count)</th><td class="right">'+sellCount+'</td></tr>'
      +'<tr><th>Purchased (count)</th><td class="right">'+buyCount+'</td></tr>'
      +'<tr><th>Total Sales</th><td class="right">'+fmtMoney(sales)+'</td></tr>'
      +'<tr><th>Total Vehicle Purchases (purchased this month)</th><td class="right">'+fmtMoney(purchases)+'</td></tr>'
      +'<tr><th>Vehicle Expenses (this month)</th><td class="right">'+fmtMoney(vehExp)+'</td></tr>'
      +'<tr><th>Showroom Expenses '+(cover?'(covered by profit, shown as ¬£0)':'')+'</th><td class="right">'+fmtMoney(showExpShown)+'</td></tr>'
      +'<tr><th>Net Profit/Loss</th><td class="right">'+fmtMoney(net)+'</td></tr>'
      +'</tbody></table>';
  };

  /* Month Close */
  function calcMonthClose(k){
    const showroomMonthTotal = (db.showroomExpenses||[]).filter(e=>ymStr(e.date)===k).reduce((t,e)=>t+Number(e.amount||0),0);
    const sold=(db.sales||[]).filter(s=>ymStr(s.date)===k && isRealSale(s));
    const items=sold.map(s=>{
      const v=db.vehicles.find(x=>x.id===s.vehicleId)||{};
      const vexp=(db.vehicleExpenses||[]).filter(e=>e.vehicleId===s.vehicleId).reduce((t,x)=>t+Number(x.amount||0),0);
      const gross = Number(s.salePrice || 0) - Number(v.purchase || 0) - vexp;
      const isInvestor = (v.ownerType === 'investor' && v.investor);

      // Mgmt fees only if car made a profit
      const mgmtFlat = (isInvestor && gross > 0) ? 175 : 0;
      const mgmtBase = Math.max(0, gross - mgmtFlat);
      const mgmtPct  = (isInvestor && gross > 0) ? (0.20 * mgmtBase) : 0;

      let investorShare = 0;
      let afterInvestor = gross;

      if (isInvestor && gross > 0) {
        // Step 1: subtract ¬£175 (mgmtFlat) and 20% of remaining (mgmtPct)
        const baseAfterFees = Math.max(0, gross - mgmtFlat - mgmtPct);

        // Step 2: investor gets 30% of the remaining
        investorShare = 0.30 * baseAfterFees;

        // Step 3: remainder from this car for directors pot (before showroom / post-expenses)
        afterInvestor = Math.max(0, baseAfterFees - investorShare);
      } else {
        // Dealer-owned car: all gross goes to directors pot (before showroom / post-expenses)
        afterInvestor = gross;
      }

      return { s, v, gross, mgmtFlat, mgmtPct, investorShare, afterInvestor, isInvestor, investorName: v.investor || '' };
    });

    const totalGross=items.reduce((t,x)=>t+x.gross,0);
    const totalFlat=items.reduce((t,x)=>t+x.mgmtFlat,0);
    const totalPct=items.reduce((t,x)=>t+x.mgmtPct,0);
    const totalInvestor=items.reduce((t,x)=>t+x.investorShare,0);

    // Post-sale expenses this month for vehicles sold earlier
    const postExp = (db.vehicleExpenses||[]).filter(e=>ymStr(e.date)===k).map(e=>{
      const v=db.vehicles.find(x=>x.id===e.vehicleId);
      if(!v) return null;
      const s = (db.sales||[]).find(s0=>s0.vehicleId===e.vehicleId && isRealSale(s0));
      if(!s) return null;
      if(ymStr(s.date) >= k) return null;
      return { e, v, amount: Number(e.amount||0) };
    }).filter(Boolean);
    const postExpTotal = postExp.reduce((t,x)=>t + x.amount, 0);

    const remainderBeforeShowroom = items.reduce((t,x)=>t+x.afterInvestor,0) - postExpTotal;
    const remainder = remainderBeforeShowroom - showroomMonthTotal;
    const directorHalf = remainder/2;
    return {items,totalGross,totalFlat,totalPct,totalInvestor,remainder,directorHalf,postExp,postExpTotal,showroomMonthTotal,remainderBeforeShowroom};
  }
    function purgeMonthClose(k){
    const marker='MonthClose '+k;
    // Remove prior director profit entries for this month
    (db.partners||[]).forEach(p=>{ p.tx=(p.tx||[]).filter(t=>!(t.type==='profit' && (t.note||'').includes(marker))); p.balance=(p.tx||[]).reduce((bal,x)=> bal+((x.type==='invest'||x.type==='profit')?+x.amount:-x.amount),0); });
    // Remove prior investor postings for this month
    (db.investors||[]).forEach(inv=>{ inv.tx=(inv.tx||[]).filter(t=>!(t.type==='fund_in' && (t.note||'').includes(marker))); inv.balance=(inv.tx||[]).reduce((bal,x)=> bal+((x.type==='fund_in')?+x.amount:-x.amount),0); });
    // Remove showroom mgmt entries dated in that month
    db.showroomExpenses=(db.showroomExpenses||[]).filter(e=>{
      const ym = (e.date||'').slice(0,7);
      if(ym!==k) return true;
      const t=String(e.type||'');
      return !(t.includes('Mgmt flat ¬£175') || t.includes('Mgmt 20%'));
    });
  }
function alreadyPosted(k){
    // Heuristic: if both directors have a 'profit' tx on k month with same note marker, block.
    const marker='MonthClose '+k;
    const both=(db.partners||[]).filter(p=>(p.tx||[]).some(t=>t.type==='profit' && (t.note||'').includes(marker))).length>=2;
    return both;
  }
  function previewClose(){
    const k=(wrap.querySelector('#mc_month').value||'').slice(0,7);
    const c=calcMonthClose(k);
    const box=wrap.querySelector('#mc_box');
    box.innerHTML = '<b>Month:</b> '+k+'<br>'
      + 'Gross profit on sold vehicles: '+fmtMoney(c.totalGross)+'<br>'
      + 'Showroom mgmt (flat ¬£175 each investor car): '+fmtMoney(c.totalFlat)+'<br>'
      + 'Showroom mgmt (20% each investor car): '+fmtMoney(c.totalPct)+'<br>'
      + 'Investor 30% total: '+fmtMoney(c.totalInvestor)+'<br>'
      + 'Showroom expenses this month (net): ' + fmtMoney(c.showroomMonthTotal) + '<br>'
      + 'Post-sale expenses (this month on earlier sales): '+fmtMoney(c.postExpTotal)+'<br>'
      + '<b>Remainder for directors (50/50):</b> '+fmtMoney(c.remainder)+' ‚áí '+fmtMoney(c.directorHalf)+' each<br><br>'
      + '<div class="card small" style="margin:8px 0;padding:8px">'
      + '<b>Breakdown</b><br>'
      + '<table class="table"><tbody>'
      + '<tr><td>Gross profit on sold vehicles</td><td class="right">'+fmtMoney(c.totalGross)+'</td></tr>'
      + '<tr><td>Mgmt flat (¬£175) ‚Äî investor cars</td><td class="right">'+fmtMoney(c.totalFlat)+'</td></tr>'
      + '<tr><td>Mgmt 20% ‚Äî investor cars</td><td class="right">'+fmtMoney(c.totalPct)+'</td></tr>'
      + '<tr><td>Investor 30% total</td><td class="right">'+fmtMoney(c.totalInvestor)+'</td></tr>'
      + '<tr><td>Post-sale expenses (this month on earlier sales)</td><td class="right">'+fmtMoney(c.postExpTotal)+'</td></tr>'
      + '<tr><td><b>Remainder before showroom</b></td><td class="right"><b>'+fmtMoney(c.remainderBeforeShowroom)+'</b></td></tr>'
      + '<tr><td>Showroom expenses this month (net)</td><td class="right">'+fmtMoney(c.showroomMonthTotal)+'</td></tr>'
      + '<tr><td><b>Remainder after showroom</b></td><td class="right"><b>'+fmtMoney(c.remainder)+'</b></td></tr>'
      + '<tr><td><b>Directors share (each)</b></td><td class="right"><b>'+fmtMoney(c.directorHalf)+'</b></td></tr>'
      + '</tbody></table>'
      + '</div>'
      + '<table class="table"><thead><tr><th>Date</th><th>Reg</th><th>Investor</th><th>Gross</th><th>¬£175</th><th>20%</th><th>Investor 30%</th><th>Remainder</th></tr></thead><tbody>'
      + c.items.map(x=>`<tr><td>${ddmmyyyy(x.s.date)}</td><td>${x.v.reg||''}</td><td>${x.investorName}</td><td class="right">${fmtMoney(x.gross)}</td><td class="right">${fmtMoney(x.mgmtFlat)}</td><td class="right">${fmtMoney(x.mgmtPct)}</td><td class="right">${fmtMoney(x.investorShare)}</td><td class="right">${fmtMoney(x.afterInvestor)}</td></tr>`).join('')
      + '</tbody></table>'
      + (c.postExp.length ? ('<br><div class="small"><b>Post-sale expenses this month:</b><ul>'
          + c.postExp.map(pe=>`<li>${ddmmyyyy(pe.e.date)} ‚Äî ${pe.v.reg||''} ‚Äî ${pe.e.type||''}: ${fmtMoney(pe.amount)}</li>`).join('')
          + '</ul></div>') : '');
    const warn=wrap.querySelector('#mc_warn'); warn.textContent = alreadyPosted(k) ? ('Already posted for '+k+' ‚Äî new posting will replace the previous one.') : '';}
  function postClose(){
    const k=(wrap.querySelector('#mc_month').value||'').slice(0,7); if(!k) return alert('Pick a month');
    if(alreadyPosted(k)) { if(!confirm('This month was already posted. Recalculate and re-post?')) return; purgeMonthClose(k); }
    const c=calcMonthClose(k);

    // 1) Post mgmt fees to Showroom Expenses (175 + 20% for PROFITABLE investor cars only)
    c.items.forEach(x=>{
      if(x.isInvestor && x.gross > 0){  // Only if car made profit
        db.showroomExpenses.unshift({id:mcId(k, 'showroom_flat175', x.v.reg, '', ''),date:lastDayOfMonth(k),type:'Mgmt flat ¬£175',method:'bank',amount:-175,note:(x.v.reg||'')});
        const pct=+(x.mgmtPct||0);
        if(pct>0) db.showroomExpenses.unshift({id:mcId(k, 'showroom_20pct', x.v.reg, '', ''),date:lastDayOfMonth(k),type:'Mgmt 20% (investor car)',method:'bank',amount:-pct,note:(x.v.reg||'')});
      }
    });

    // 2) Post investor 30% total aggregated by investor (only for profitable cars)
    const byInvestor={};
    c.items.forEach(x=>{
      if(x.isInvestor && x.investorShare>0 && x.gross > 0){  // Only if car made profit
        byInvestor[x.investorName]=(byInvestor[x.investorName]||0)+x.investorShare;
      }
    });
    Object.keys(byInvestor).forEach(name=>{
      let inv=(db.investors||[]).find(i=>i.name===name);
      if(!inv){ inv={id:uid(),name,balance:0,tx:[]}; (db.investors=db.investors||[]).push(inv); }
      const amt=byInvestor[name];
      inv.tx.unshift({id:mcId(k, 'investor_30pct', inv.id, '', ''),date:lastDayOfMonth(k),type:'fund_in',method:'bank',amount:amt,note:'MonthClose '+k});
      inv.balance+=(+amt||0);
    });

    // 3) Directors single entry each (50/50)
    const marker='MonthClose '+k;
    (db.partners||[]).forEach(p=>{
      const amt=c.directorHalf;
      p.tx=p.tx||[]; p.tx.unshift({id:mcId(k, 'director_profit', p.id, '', ''),date:lastDayOfMonth(k),type:'profit',method:'bank',amount:amt,note:marker});
      p.balance=(p.tx||[]).reduce((bal,x)=> bal+((x.type==='invest'||x.type==='profit')?+x.amount:-x.amount),0);
    });

    saveDB(); try{renderAlertBell();}catch(e){}; addAudit('monthClose','reports','monthClose',marker); alert('Month close posted.');
    previewClose();
  }

  wrap.querySelector('#mc_prev').onclick=previewClose;
  wrap.querySelector('#mc_post').onclick=postClose;

  
  wrap.querySelector('#mc_export').onclick=()=>{
    const k=(wrap.querySelector('#mc_month').value||'').slice(0,7); if(!k) return alert('Pick a month');
    const c=calcMonthClose(k);
    const html = '<html><head><meta charset=\"utf-8\"><title>Month Close '+k+'</title>'+
      '<style>body{font:14px system-ui;padding:20px} .right{text-align:right} table{width:100%;border-collapse:collapse} th,td{border:1px solid #ccc;padding:6px}</style></head><body>'+
      '<h2>Month Close '+k+'</h2>'+
      '<p><b>Gross:</b> '+fmtMoney(c.totalGross)+'<br>'+
      'Mgmt flat (¬£175): '+fmtMoney(c.totalFlat)+'<br>'+
      'Mgmt 20%: '+fmtMoney(c.totalPct)+'<br>'+
      'Investor 30% total: '+fmtMoney(c.totalInvestor)+'<br>'+
      'Post-sale expenses: '+fmtMoney(c.postExpTotal)+'<br>'+
      '<b>Remainder before showroom:</b> '+fmtMoney(c.remainderBeforeShowroom)+'<br>'+
      'Showroom (net): '+fmtMoney(c.showroomMonthTotal)+'<br>'+
      '<b>Remainder after showroom:</b> '+fmtMoney(c.remainder)+'<br>'+
      '<b>Directors share (each):</b> '+fmtMoney(c.directorHalf)+'</p>'+
      '<table><thead><tr><th>Date</th><th>Reg</th><th>Investor</th><th class=\"right\">Gross</th><th class=\"right\">¬£175</th><th class=\"right\">20%</th><th class=\"right\">Inv 30%</th><th class=\"right\">Remainder</th></tr></thead><tbody>'+
      c.items.map(x=>'<tr><td>'+ddmmyyyy(x.s.date)+'</td><td>'+(x.v.reg||'')+'</td><td>'+(x.investorName||'')+'</td><td class=\"right\">'+fmtMoney(x.gross)+'</td><td class=\"right\">'+fmtMoney(x.mgmtFlat)+'</td><td class=\"right\">'+fmtMoney(x.mgmtPct)+'</td><td class=\"right\">'+fmtMoney(x.investorShare)+'</td><td class=\"right\">'+fmtMoney(x.afterInvestor)+'</td></tr>').join('')+
      '</tbody></table>'+
      '</body></html>';
    openPrintable(html);
  };
return wrap;
}

/* ========= To-Do ========= */
function viewTodo(){ if(!canTab('To-Do')) return document.createElement('div'); const wrap=document.createElement('div'); wrap.className='card';
  wrap.innerHTML=`<h2>To-Do</h2><div class="row"><input id="t_date" type="date"><input id="t_text" placeholder="Task"><select id="t_user"><option value="">‚Äî assign ‚Äî</option>${(db.users||[]).map(u=>`<option>${u.username}</option>`).join('')}</select><select id="t_entity"><option value="">entity‚Ä¶</option><option>vehicle</option><option>sale</option><option>investor</option><option>director</option></select><input id="t_eid" placeholder="Entity id/reg"><button id="t_add" class="primary">Add</button></div>
  <table class="table" style="margin-top:10px"><thead><tr><th>Date</th><th>Task</th><th>Assigned</th><th>Entity</th><th>Done</th><th>Actions</th></tr></thead><tbody id="t_body"></tbody></table>`;
  const body=wrap.querySelector('#t_body'); function rows(){ body.innerHTML=''; (db.todo||[]).forEach(t=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${ddmmyyyy(t.date||'')}</td><td>${t.text||''}</td><td>${t.assignedTo||''}</td><td>${t.entity||''} ${t.entityId||''}</td><td><input type="checkbox" ${t.done?'checked':''} data-act="toggle" data-id="${t.id}"></td><td>${canAction('del')?`<button class="danger" data-act="del" data-id="${t.id}">Delete</button>`:''}</td>`; body.appendChild(tr); }); }
  rows();
  wrap.querySelector('#t_add').onclick=()=>{ if(!canAction('add')) return alert('No permission'); const t={id:uid(),date:document.getElementById('t_date').value,text:document.getElementById('t_text').value.trim(),assignedTo:document.getElementById('t_user').value,entity:document.getElementById('t_entity').value,entityId:document.getElementById('t_eid').value.trim(),done:false}; if(!t.text) return alert('Task text required'); (db.todo=db.todo||[]).unshift(t); saveDB(); try{renderAlertBell();}catch(e){}; addAudit('add','todo',t.id,t.text); rows(); document.getElementById('t_text').value=''; };
  wrap.addEventListener('change',(ev)=>{ const cb=ev.target.closest('input[type=checkbox][data-act=toggle]'); if(!cb) return; const t=(db.todo||[]).find(x=>x.id===cb.dataset.id); if(!t) return; t.done=cb.checked; saveDB(); try{renderAlertBell();}catch(e){}; addAudit('update','todo',t.id,t.text+' done='+t.done); });
  wrap.addEventListener('click',(ev)=>{ const b=ev.target.closest('button'); if(!b) return; if(b.dataset.act==='del'){ if(!canAction('del')) return alert('No permission'); db.todo=db.todo.filter(x=>x.id!==b.dataset.id); saveDB(); try{renderAlertBell();}catch(e){}; addAudit('delete','todo',b.dataset.id,''); rows(); } });
  return wrap;
}

/* ========= Customer Complaints ========= */
function viewComplaints(){
  if(!canTab('Customer Complaints')) return document.createElement('div'); 
  const wrap=document.createElement('div'); 
  wrap.className='card';
  
  wrap.innerHTML=`<h2>Customer Complaints</h2>
  <div class="row">
    <input id="comp_date" type="date">
    <input id="comp_customer" placeholder="Customer Name *" style="min-width:180px">
    
    <datalist id="comp_reg_list">
      ${(db.vehicles||[]).map(v => {
        const reg = (v.reg||'').toUpperCase();
        const m = v.make||'';
        const mo = v.model||'';
        return `<option value="${reg}">${reg} ‚Äî ${m} ${mo}</option>`;
      }).join('')}
    </datalist>
    <input id="comp_vehicle" list="comp_reg_list" placeholder="Vehicle REG" style="min-width:180px">
    
    <input id="comp_type" placeholder="Complaint Type" style="min-width:180px">
    <select id="comp_severity">
      <option value="low">Low</option>
      <option value="medium" selected>Medium</option>
      <option value="high">High</option>
      <option value="urgent">Urgent</option>
    </select>
  </div>

  <div class="row small" id="comp_saleHint" style="margin-top:4px;margin-bottom:8px;color:var(--mut)"></div>

  <div class="row">
    <textarea id="comp_details" placeholder="Complaint details *" style="flex:1;min-height:80px"></textarea>
  </div>
  <div class="row">
    <textarea id="comp_resolution" placeholder="Resolution taken / plan" style="flex:1;min-height:80px"></textarea>
  </div>

  <!-- LOG FIELDS -->
  <div class="row" style="flex-wrap:wrap;gap:8px">
    <input id="comp_mileageNow" type="number" placeholder="Mileage now" style="max-width:150px">
    <button id="comp_autofill" type="button">Auto-fill from sale</button>
    <input id="comp_mechBook" type="datetime-local" placeholder="Booked with mechanic">
    <input id="comp_mechName" placeholder="Mechanic / Garage name">
    <input id="comp_delivered" type="datetime-local" placeholder="Delivered to mechanic">
    <input id="comp_work" placeholder="Work carried out / fault found" style="flex:1;min-width:200px">
  </div>

  <div class="row" style="flex-wrap:wrap;gap:8px;margin-top:6px">
    <input id="comp_collected" type="datetime-local" placeholder="Customer collected">
    <input id="comp_collectedMileage" type="number" placeholder="Mileage at collection" style="max-width:170px">
    <input id="comp_handler" placeholder="Staff dealing with complaint">
  </div>

  <div class="row" style="margin-top:10px">
    <select id="comp_status">
      <option value="new">New</option>
      <option value="investigating">Investigating</option>
      <option value="resolved">Resolved</option>
      <option value="closed">Closed</option>
      <option value="escalated">Escalated</option>
    </select>
    <input id="comp_assigned" placeholder="Assigned to (optional)">
    <input id="comp_followup" type="date" placeholder="Follow-up date">
    <input id="comp_cost" type="number" placeholder="Cost ¬£ (if any)">
    <button id="comp_add" class="primary">Add / Update</button>
  </div>
  
  <div class="row" style="margin-top:16px;margin-bottom:8px">
    <input id="comp_search" placeholder="Search customer/reg/details." style="flex:1">
    <select id="comp_filter_status">
      <option value="">All Status</option>
      <option value="new">New</option>
      <option value="investigating">Investigating</option>
      <option value="resolved">Resolved</option>
      <option value="closed">Closed</option>
      <option value="escalated">Escalated</option>
    </select>
    <select id="comp_filter_severity">
      <option value="">All Severity</option>
      <option value="low">Low</option>
      <option value="medium">Medium</option>
      <option value="high">High</option>
      <option value="urgent">Urgent</option>
    </select>
    <button id="comp_clear">Clear Filters</button>
    <button id="comp_export">Export CSV</button>
    <button id="comp_print">Print</button>
  </div>
  
  <table class="table" style="margin-top:10px">
    <thead>
      <tr>
        <th>Date</th>
        <th>Customer / Summary</th>
        <th>Vehicle</th>
        <th>Type</th>
        <th>Severity</th>
        <th>Status</th>
        <th>Assigned</th>
        <th>Follow-up</th>
        <th>Cost</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody id="comp_body"></tbody>
  </table>`;

  // ===== Helpers =====
  db.complaints = db.complaints || [];
  const body = wrap.querySelector('#comp_body');
  let editId = null;

  function findSaleByReg(reg){
    reg = (reg||'').toUpperCase().trim();
    if(!reg) return null;
    const v = (db.vehicles||[]).find(x => (x.reg||'').toUpperCase() === reg) || null;
    if(!v) return null;
    const sale = (db.sales||[]).find(s => s.vehicleId === v.id && isRealSale(s)) || null;
    return { vehicle: v, sale };
  }

  function buildSaleHint(reg, comp){
    const hintEl = wrap.querySelector('#comp_saleHint');
    const found = findSaleByReg(reg);
    if(!found || !found.sale){
      hintEl.textContent = reg ? `No sale found for ${reg} (may be unsold / purchase only).` : '';
      return;
    }
    const v = found.vehicle;
    const s = found.sale;
    const buyer = s.buyer || (comp && comp.customer) || '';
    const soldDate = s.date ? ddmmyyyy(s.date) : '';
    const soldMileage = Number(s.mileage || 0);
    const compMileage = Number((comp && comp.mileageNow) || wrap.querySelector('#comp_mileageNow').value || 0) || 0;

    let daysSinceSale = '';
    if (s.date) {
      const dSale = new Date(s.date);
      const dComp = comp && comp.date ? new Date(comp.date) : new Date();
      const diff = Math.round((dComp - dSale) / (1000*60*60*24));
      daysSinceSale = isNaN(diff) ? '' : `${diff} days`;
    }

    // Optional warranty months from Settings (db.company.defaultWarrantyMonths)
    let warrantyText = '';
    const wMonths = Number((db.company || {}).defaultWarrantyMonths || 0);
    if (s.date && wMonths > 0){
      const d = new Date(s.date);
      d.setMonth(d.getMonth() + wMonths);
      const iso = d.toISOString().slice(0,10);
      warrantyText = `‚Ä¢ Warranty approx until ${ddmmyyyy(iso)} (${wMonths} months)`;
    }

    let bits = [];
    if (soldDate) bits.push(`Sold: ${soldDate}${daysSinceSale ? ' ('+daysSinceSale+' before complaint)' : ''}`);
    if (soldMileage) bits.push(`Mileage at sale: ${soldMileage.toLocaleString()} miles`);
    if (compMileage) {
      const diffMiles = soldMileage ? (compMileage - soldMileage) : null;
      bits.push(`Mileage now: ${compMileage.toLocaleString()} miles` + (diffMiles!=null ? ` (${diffMiles.toLocaleString()} since sale)` : ''));
    }
    if (warrantyText) bits.push(warrantyText);

    const line = `Logging for: ${buyer || 'Unknown'} ‚Äî ${(v.reg||'').toUpperCase()} (${v.make||''} ${v.model||''})`;
    hintEl.innerHTML = line + (bits.length ? `<br><span style="color:var(--mut);font-size:12px">${bits.join(' ‚Ä¢ ')}</span>` : '');
  }

  function renderComplaints(filter = {}) {
    body.innerHTML = '';
    
    let complaints = db.complaints || [];
    
    // Filters
    if (filter.search) {
      const searchTerm = filter.search.toLowerCase();
      complaints = complaints.filter(c => 
        (c.customer || '').toLowerCase().includes(searchTerm) ||
        (c.vehicle || '').toLowerCase().includes(searchTerm) ||
        (c.details || '').toLowerCase().includes(searchTerm) ||
        (c.resolution || '').toLowerCase().includes(searchTerm)
      );
    }
    if (filter.status) {
      complaints = complaints.filter(c => c.status === filter.status);
    }
    if (filter.severity) {
      complaints = complaints.filter(c => c.severity === filter.severity);
    }
    
    // Sort by date (newest first)
    complaints.sort((a, b) => new Date(b.date || 0) - new Date(a.date || 0));
    
    if (complaints.length === 0) {
      const tr = document.createElement('tr');
      tr.innerHTML = `<td colspan="10" class="small" style="text-align: center; padding: 20px;">No complaints found${filter.search ? ' for "' + filter.search + '"' : ''}</td>`;
      body.appendChild(tr);
      return;
    }
    
    complaints.forEach(c => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${ddmmyyyy(c.date)}</td>
        <td>${c.customer || ''}<br><small style="color:var(--mut)">${(c.details || '').substring(0, 50)}${(c.details || '').length > 50 ? '...' : ''}</small></td>
        <td>${c.vehicle || ''}</td>
        <td>${c.type || ''}</td>
        <td>${c.severity || ''}</td>
        <td>${c.status || ''}</td>
        <td>${c.assigned || ''}</td>
        <td>${ddmmyyyy(c.followup)}</td>
        <td class="right">${c.cost ? fmtMoney(c.cost) : ''}</td>
        <td>
          <button data-act="view" data-id="${c.id}" title="View Details">View</button>
          ${canAction('edit') ? `<button data-act="edit" data-id="${c.id}">Edit</button>` : ''}
          ${canAction('del') ? `<button class="danger" data-act="del" data-id="${c.id}">Delete</button>` : ''}
        </td>
      `;
      body.appendChild(tr);
    });
  }

  // Initial table
  renderComplaints();

  // Add/Update complaint
  wrap.querySelector('#comp_add').onclick = () => {
    if(!canAction('add')) return alert('No permission');
    
    const compReg = (wrap.querySelector('#comp_vehicle').value || '').toUpperCase().trim();
    const current = editId ? (db.complaints||[]).find(x => x.id === editId) : null;

    const baseDate = wrap.querySelector('#comp_date').value || (current && current.date) || new Date().toISOString().split('T')[0];

    const comp = {
      id: editId || uid(),
      date: baseDate,
      customer: wrap.querySelector('#comp_customer').value.trim(),
      vehicle: compReg,
      type: wrap.querySelector('#comp_type').value,
      severity: wrap.querySelector('#comp_severity').value,
      details: wrap.querySelector('#comp_details').value.trim(),
      resolution: wrap.querySelector('#comp_resolution').value.trim(),
      status: wrap.querySelector('#comp_status').value,
      assigned: wrap.querySelector('#comp_assigned').value.trim(),
      followup: wrap.querySelector('#comp_followup').value,
      cost: Number(wrap.querySelector('#comp_cost').value || 0),

      // LOG FIELDS
      mileageNow: Number(wrap.querySelector('#comp_mileageNow').value || 0),
      mechanicBooked: wrap.querySelector('#comp_mechBook').value,
      mechanicName: wrap.querySelector('#comp_mechName').value.trim(),
      deliveredDate: wrap.querySelector('#comp_delivered').value,
      workDone: wrap.querySelector('#comp_work').value.trim(),
      collectedDate: wrap.querySelector('#comp_collected').value,
      collectedMileage: Number(wrap.querySelector('#comp_collectedMileage').value || 0),
      handler: wrap.querySelector('#comp_handler').value.trim(),

      createdAt: editId && current ? current.createdAt : new Date().toISOString(),
      updatedAt: new Date().toISOString()
    };

    // Snapshot sale info when adding (optional but useful)
    const found = findSaleByReg(compReg);
    if (found && found.sale){
      comp.saleId = found.sale.id;
      comp.saleDate = found.sale.date || '';
      comp.saleMileage = Number(found.sale.mileage || 0);
      comp.salePrice = Number(found.sale.salePrice || 0);
      comp.saleInvNo = found.sale.invNo || '';
    }

    if(!comp.customer || !comp.details) {
      return alert('Customer name and complaint details are required');
    }

    if(editId) {
      db.complaints = db.complaints.map(x => x.id === editId ? comp : x);
      addAudit('update', 'complaint', comp.id, `${comp.customer} - ${comp.type} - ${comp.status}`);
      editId = null;
    } else {
      db.complaints.unshift(comp);
      addAudit('add', 'complaint', comp.id, `${comp.customer} - ${comp.type} - ${comp.severity}`);

      // Auto notification: create TODO when urgent/escalated
      if (comp.severity === 'urgent' || comp.status === 'escalated') {
        db.todo = db.todo || [];
        const task = {
          id: uid(),
          date: comp.date,
          text: `URGENT complaint: ${comp.customer} / ${comp.vehicle} ‚Äî ${comp.type}`,
          assignedTo: comp.assigned || '',
          entity: 'complaint',
          entityId: comp.id,
          done: false
        };
        db.todo.unshift(task);
        addAudit('add', 'todo', task.id, task.text);
      }
    }
    
    saveDB();
    try{renderAlertBell();}catch(e){}
    renderComplaints();

    // Clear form
    wrap.querySelector('#comp_customer').value = '';
    wrap.querySelector('#comp_vehicle').value = '';
    wrap.querySelector('#comp_type').value = '';
    wrap.querySelector('#comp_details').value = '';
    wrap.querySelector('#comp_resolution').value = '';
    wrap.querySelector('#comp_assigned').value = '';
    wrap.querySelector('#comp_followup').value = '';
    wrap.querySelector('#comp_cost').value = '';
    wrap.querySelector('#comp_mileageNow').value = '';
    wrap.querySelector('#comp_mechBook').value = '';
    wrap.querySelector('#comp_mechName').value = '';
    wrap.querySelector('#comp_delivered').value = '';
    wrap.querySelector('#comp_work').value = '';
    wrap.querySelector('#comp_collected').value = '';
    wrap.querySelector('#comp_collectedMileage').value = '';
    wrap.querySelector('#comp_handler').value = '';
    wrap.querySelector('#comp_saleHint').textContent = '';
  };

  // Search / filter / clear
  wrap.querySelector('#comp_search').addEventListener('input', () => {
    renderComplaints({
      search: wrap.querySelector('#comp_search').value,
      status: wrap.querySelector('#comp_filter_status').value,
      severity: wrap.querySelector('#comp_filter_severity').value
    });
  });
  wrap.querySelector('#comp_filter_status').addEventListener('change', () => {
    renderComplaints({
      search: wrap.querySelector('#comp_search').value,
      status: wrap.querySelector('#comp_filter_status').value,
      severity: wrap.querySelector('#comp_filter_severity').value
    });
  });
  wrap.querySelector('#comp_filter_severity').addEventListener('change', () => {
    renderComplaints({
      search: wrap.querySelector('#comp_search').value,
      status: wrap.querySelector('#comp_filter_status').value,
      severity: wrap.querySelector('#comp_filter_severity').value
    });
  });
  wrap.querySelector('#comp_clear').onclick = () => {
    wrap.querySelector('#comp_search').value = '';
    wrap.querySelector('#comp_filter_status').value = '';
    wrap.querySelector('#comp_filter_severity').value = '';
    renderComplaints();
  };

  // Auto-fill from sale
  wrap.querySelector('#comp_autofill').onclick = () => {
    const reg = (wrap.querySelector('#comp_vehicle').value || '').toUpperCase().trim();
    if (!reg) return alert('Enter vehicle REG first.');
    const found = findSaleByReg(reg);
    if (!found || !found.sale) {
      alert('No sale found for this REG.');
      return;
    }
    const s = found.sale;
    if (!wrap.querySelector('#comp_customer').value.trim()) {
      wrap.querySelector('#comp_customer').value = s.buyer || '';
    }
    // Put the mileage at sale as a starting point (you can then overwrite with current mileage)
    if (!wrap.querySelector('#comp_mileageNow').value) {
      wrap.querySelector('#comp_mileageNow').value = s.mileage || 0;
    }
    buildSaleHint(reg, {
      date: wrap.querySelector('#comp_date').value || new Date().toISOString().slice(0,10),
      mileageNow: Number(wrap.querySelector('#comp_mileageNow').value || 0)
    });
  };

  // Update hint when REG changes
  wrap.querySelector('#comp_vehicle').addEventListener('change', () => {
    const reg = (wrap.querySelector('#comp_vehicle').value || '').toUpperCase().trim();
    if (!reg) {
      wrap.querySelector('#comp_saleHint').textContent = '';
      return;
    }
    buildSaleHint(reg, {
      date: wrap.querySelector('#comp_date').value || new Date().toISOString().slice(0,10),
      mileageNow: Number(wrap.querySelector('#comp_mileageNow').value || 0)
    });
  });

  // Export CSV
  wrap.querySelector('#comp_export').onclick = () => {
    const rows = (db.complaints||[]).map(c => ([
      c.date || '',
      c.customer || '',
      c.vehicle || '',
      c.type || '',
      c.severity || '',
      c.status || '',
      c.assigned || '',
      c.followup || '',
      c.cost || 0,
      c.mileageNow || '',
      c.mechanicBooked || '',
      c.mechanicName || '',
      c.deliveredDate || '',
      c.workDone || '',
      c.collectedDate || '',
      c.collectedMileage || '',
      c.handler || '',
      c.saleDate || '',
      c.saleMileage || '',
      c.salePrice || '',
      c.saleInvNo || ''
    ]));

    const header = [
      'Complaint Date','Customer','Vehicle REG','Type','Severity','Status','Assigned',
      'Follow-up','Cost','Mileage Now','Mechanic Booked','Mechanic Name',
      'Delivered Date','Work Done','Collected Date','Collected Mileage',
      'Handled By','Sale Date','Sale Mileage','Sale Price','Sale Invoice'
    ];

    const csv = [header].concat(rows)
      .map(r => r.map(v => `"${String(v).replace(/"/g,'""')}"`).join(','))
      .join('\n');

    const a = document.createElement('a');
    a.href = URL.createObjectURL(new Blob([csv],{type:'text/csv'}));
    a.download = 'complaints_'+new Date().toISOString().slice(0,10)+'.csv';
    a.click();
  };

  // Print summary
  wrap.querySelector('#comp_print').onclick = () => {
    const list = db.complaints || [];
    if (!list.length) {
      alert('No complaints to print.');
      return;
    }
    let html = `<!doctype html><html><head><meta charset="utf-8"><title>Customer Complaints</title>
    <style>
      body{font-family:Arial;font-size:11px;color:#111}
      table{width:100%;border-collapse:collapse}
      th,td{border:1px solid #000;padding:4px 6px;vertical-align:top}
      th{background:#f0f0f0}
      h2{margin:0 0 10px 0}
      .small{font-size:10px;color:#666}
      .no-print{margin:8px 0}
      @media print{.no-print{display:none}}
    </style>
    </head><body>
    <button class="no-print" onclick="window.print()">Print / Save PDF</button>
    <h2>Customer Complaints Log</h2>
    <table><thead><tr>
      <th>Date</th><th>Customer</th><th>Vehicle</th><th>Summary</th><th>Status</th>
      <th>Severity</th><th>Handler</th><th>Log (mileage/mechanic)</th>
    </tr></thead><tbody>`;

    list.sort((a,b)=>new Date(b.date||0)-new Date(a.date||0)).forEach(c => {
      const reg = (c.vehicle||'').toUpperCase();
      const found = findSaleByReg(reg);
      const v = found && found.vehicle ? found.vehicle : {};
      const s = found && found.sale ? found.sale : null;

      const soldBit = s && s.date ? `Sold ${ddmmyyyy(s.date)}${s.mileage ? ' @ ' + s.mileage + ' miles' : ''}` : '';
      const mileageBit = (c.mileageNow || c.collectedMileage) ? 
        `Mileage now: ${c.mileageNow||''} ‚Ä¢ At collection: ${c.collectedMileage||''}` : '';
      const mechBit = (c.mechanicName || c.workDone) ? 
        `${c.mechanicName||''} ‚Äî ${c.workDone||''}` : '';
      
      html += `<tr>
        <td>${ddmmyyyy(c.date)}</td>
        <td>${c.customer||''}</td>
        <td>${reg}<br><span class="small">${v.make||''} ${v.model||''}</span></td>
        <td>${(c.details||'').replace(/\n/g,'<br>')}</td>
        <td>${c.status||''}</td>
        <td>${c.severity||''}</td>
        <td>${c.handler || c.assigned || ''}</td>
        <td class="small">
          ${soldBit ? soldBit + '<br>' : ''}
          ${mileageBit ? mileageBit + '<br>' : ''}
          ${c.mechanicBooked ? 'Booked: '+c.mechanicBooked+'<br>' : ''}
          ${c.deliveredDate ? 'Delivered: '+c.deliveredDate+'<br>' : ''}
          ${c.collectedDate ? 'Collected: '+c.collectedDate+'<br>' : ''}
          ${mechBit}
        </td>
      </tr>`;
    });

    html += '</tbody></table></body></html>';
    openPrintable(html);
  };

  // Row buttons (view/edit/delete)
  wrap.addEventListener('click', (ev) => {
    const b = ev.target.closest('button');
    if(!b || !b.dataset.act) return;
    const id = b.dataset.id;
    const act = b.dataset.act;
    const comp = (db.complaints||[]).find(x => x.id === id);
    if(!comp) return;
    
    if(act === 'view') {
      const reg = (comp.vehicle||'').toUpperCase();
      const found = findSaleByReg(reg);
      const v = found && found.vehicle ? found.vehicle : {};
      const s = found && found.sale ? found.sale : null;

      let headerRow = '';
      if (s && v) {
        const buyer = s.buyer || comp.customer || '';
        const soldDate = s.date ? ddmmyyyy(s.date) : '';
        const soldMileage = Number(s.mileage || 0);

        const compMileage = Number(comp.mileageNow || comp.collectedMileage || 0) || 0;
        let daysSinceSale = '';
        if (s.date) {
          const dSale = new Date(s.date);
          const dComp = comp.date ? new Date(comp.date) : new Date();
          const diff = Math.round((dComp - dSale) / (1000*60*60*24));
          daysSinceSale = isNaN(diff) ? '' : `${diff} days`;
        }
        const diffMiles = (compMileage && soldMileage) ? (compMileage - soldMileage) : null;

        // warranty from settings
        let warrantyText = '';
        const wMonths = Number((db.company||{}).defaultWarrantyMonths || 0);
        if (s.date && wMonths > 0) {
          const d = new Date(s.date);
          d.setMonth(d.getMonth()+wMonths);
          const iso = d.toISOString().slice(0,10);
          warrantyText = `‚Ä¢ Warranty approx until ${ddmmyyyy(iso)} (${wMonths} months)`;
        }

        let bits = [];
        if (soldDate) bits.push(`Sold: ${soldDate}${daysSinceSale ? ' ('+daysSinceSale+' before complaint)' : ''}`);
        if (soldMileage) bits.push(`Mileage at sale: ${soldMileage.toLocaleString()} miles`);
        if (compMileage) bits.push(`Mileage now: ${compMileage.toLocaleString()} miles` + (diffMiles!=null ? ` (${diffMiles.toLocaleString()} since sale)` : ''));
        if (warrantyText) bits.push(warrantyText);

        const headerLine = `Logging for: ${buyer || 'Unknown'} ‚Äî ${reg} (${v.make||''} ${v.model||''})`;
        headerRow = `<tr><td colspan="2" style="padding:8px 4px;background:#0f1628;color:#cbd4ff;font-size:12px;border-bottom:1px solid var(--line);">
            ${headerLine}<br>
            <span style="color:#cbd4ffb3;font-size:11px">${bits.join(' ‚Ä¢ ')}</span>
          </td></tr>`;
      }

      const html = `
        <div style="padding:10px;max-width:700px">
          <h3>Complaint Details</h3>
          <table style="width:100%;border-collapse:collapse">
            ${headerRow}
            <tr><th style="text-align:left;padding:6px 4px;width:130px">Date:</th><td style="padding:6px 4px">${ddmmyyyy(comp.date)}</td></tr>
            <tr><th style="text-align:left;padding:6px 4px">Customer:</th><td style="padding:6px 4px">${comp.customer}</td></tr>
            <tr><th style="text-align:left;padding:6px 4px">Vehicle:</th><td style="padding:6px 4px">${(comp.vehicle||'')}${v.make||v.model ? ' ‚Äî ' + (v.make||'') + ' ' + (v.model||'') : ''}</td></tr>
            <tr><th style="text-align:left;padding:6px 4px">Type:</th><td style="padding:6px 4px">${comp.type || ''}</td></tr>
            <tr><th style="text-align:left;padding:6px 4px">Severity:</th><td style="padding:6px 4px">${comp.severity || ''}</td></tr>
            <tr><th style="text-align:left;padding:6px 4px">Status:</th><td style="padding:6px 4px">${comp.status || ''}</td></tr>
            <tr><th style="text-align:left;padding:6px 4px">Assigned:</th><td style="padding:6px 4px">${comp.assigned || 'Not assigned'}</td></tr>
            <tr><th style="text-align:left;padding:6px 4px">Follow-up:</th><td style="padding:6px 4px">${ddmmyyyy(comp.followup) || 'Not set'}</td></tr>
            <tr><th style="text-align:left;padding:6px 4px">Cost:</th><td style="padding:6px 4px">${comp.cost ? fmtMoney(comp.cost) : 'None'}</td></tr>

            <tr><th style="text-align:left;padding:6px 4px">Mileage now:</th><td style="padding:6px 4px">${comp.mileageNow || ''}</td></tr>
            <tr><th style="text-align:left;padding:6px 4px">Booked with mechanic:</th><td style="padding:6px 4px">${comp.mechanicBooked || ''}</td></tr>
            <tr><th style="text-align:left;padding:6px 4px">Mechanic / Garage:</th><td style="padding:6px 4px">${comp.mechanicName || ''}</td></tr>
            <tr><th style="text-align:left;padding:6px 4px">Delivered to mechanic:</th><td style="padding:6px 4px">${comp.deliveredDate || ''}</td></tr>
            <tr><th style="text-align:left;padding:6px 4px">Work carried out:</th><td style="padding:6px 4px">${(comp.workDone || '').replace(/\n/g,'<br>')}</td></tr>
            <tr><th style="text-align:left;padding:6px 4px">Customer collected:</th><td style="padding:6px 4px">${comp.collectedDate || ''}</td></tr>
            <tr><th style="text-align:left;padding:6px 4px">Mileage at collection:</th><td style="padding:6px 4px">${comp.collectedMileage || ''}</td></tr>
            <tr><th style="text-align:left;padding:6px 4px">Handled by:</th><td style="padding:6px 4px">${comp.handler || comp.assigned || ''}</td></tr>

            <tr><th style="text-align:left;padding:6px 4px;vertical-align:top">Details:</th><td style="padding:6px 4px">${(comp.details || '').replace(/\n/g, '<br>')}</td></tr>
            <tr><th style="text-align:left;padding:6px 4px;vertical-align:top">Resolution:</th><td style="padding:6px 4px">${(comp.resolution || '').replace(/\n/g, '<br>') || 'None recorded'}</td></tr>
          </table>
        </div>`;
      alert(html);
    }
    else if(act === 'edit') {
      if(!canAction('edit')) return alert('No permission');
      editId = comp.id;

      wrap.querySelector('#comp_date').value = comp.date || '';
      wrap.querySelector('#comp_customer').value = comp.customer || '';
      wrap.querySelector('#comp_vehicle').value = comp.vehicle || '';
      wrap.querySelector('#comp_type').value = comp.type || '';
      wrap.querySelector('#comp_severity').value = comp.severity || 'medium';
      wrap.querySelector('#comp_details').value = comp.details || '';
      wrap.querySelector('#comp_resolution').value = comp.resolution || '';
      wrap.querySelector('#comp_status').value = comp.status || 'new';
      wrap.querySelector('#comp_assigned').value = comp.assigned || '';
      wrap.querySelector('#comp_followup').value = comp.followup || '';
      wrap.querySelector('#comp_cost').value = comp.cost || '';

      wrap.querySelector('#comp_mileageNow').value = comp.mileageNow || '';
      wrap.querySelector('#comp_mechBook').value = comp.mechanicBooked || '';
      wrap.querySelector('#comp_mechName').value = comp.mechanicName || '';
      wrap.querySelector('#comp_delivered').value = comp.deliveredDate || '';
      wrap.querySelector('#comp_work').value = comp.workDone || '';
      wrap.querySelector('#comp_collected').value = comp.collectedDate || '';
      wrap.querySelector('#comp_collectedMileage').value = comp.collectedMileage || '';
      wrap.querySelector('#comp_handler').value = comp.handler || '';

      buildSaleHint(comp.vehicle, comp);
      document.getElementById('app').scrollIntoView({ behavior: 'smooth' });
    }
    else if(act === 'del') {
      if(!canAction('del')) return alert('No permission');
      if(!confirm('Delete this complaint?')) return;
      db.complaints = (db.complaints||[]).filter(x => x.id !== id);
      saveDB();
      try{renderAlertBell();}catch(e){}
      addAudit('delete', 'complaint', id, comp.customer || '');
      renderComplaints();
    }
  });

  return wrap;
}

/* ========= Users ========= */
function viewUsers(){ if(!canTab('Users')) return document.createElement('div'); const wrap=document.createElement('div'); wrap.className='card'; const tabs=DEFAULT_TABS;
  function renderTable(){ wrap.innerHTML=`<h2>Users</h2>
<div class="row"><button id="u_reset_admin" class="danger">Reset admin password</button></div>
<div class="row"><input id="u_name" placeholder="username"><input id="u_pass" placeholder="password"><select id="u_role"><option value="user">user</option><option value="admin">admin</option></select><button id="u_add" class="primary">Add user</button></div>
  <table class="table" style="margin-top:10px"><thead><tr><th>User</th><th>Role</th><th>Permissions</th><th>Actions</th></tr></thead><tbody id="u_body"></tbody></table>`;
    
  /* users dedupe */
  (function(){
    const seen=new Set(); const out=[];
    (db.users||[]).forEach(u=>{ const key=(u.username||u.name||'')+'|'+(u.role||''); if(!seen.has(key)){ seen.add(key); out.push(u); }});
    if(out.length !== (db.users||[]).length){ db.users=out; saveDB(); }
  })();
const body=wrap.querySelector('#u_body'); (db.users||[]).forEach(u=>{ const p=normalizePerms(u.perms);
      const tabChecks=tabs.map(t=>`<label class="small" style="display:inline-block;min-width:110px"><input data-user="${u.id}" data-k="tab" data-tab="${t}" type="checkbox" ${p.tabs[t]?'checked':''}> ${t}</label>`).join(' ');
      const actionChecks=['view','add','edit','del'].map(a=>`<label class="small"><input data-user="${u.id}" data-k="act" data-act="${a}" type="checkbox" ${p.actions[a]?'checked':''}> ${a}</label>`).join(' ');
      const extraChecks=`<label class="small"><input data-user="${u.id}" data-k="profit" type="checkbox" ${p.profit?'checked':''}> can see profit</label> <label class="small"><input data-user="${u.id}" data-k="settings" type="checkbox" ${p.settings?'checked':''}> can edit settings</label>`;
      const tr=document.createElement('tr'); tr.innerHTML=`<td>${u.username}</td><td>${u.role}</td><td>${tabChecks}<div style="margin-top:6px">${actionChecks} &nbsp; ${extraChecks}</div></td>
      <td><button data-act="chpass" data-id="${u.id}">Change Password</button> <button data-act="reset" data-id="${u.id}">Reset pass to '1234'</button> <button class="danger" data-act="del" data-id="${u.id}">Delete</button></td>`; body.appendChild(tr); });
    wrap.addEventListener('change',(ev)=>{ const el=ev.target; if(!el.dataset||!el.dataset.user) return; const u=(db.users||[]).find(x=>x.id===el.dataset.user); if(!u) return; u.perms=normalizePerms(u.perms);
      if(el.dataset.k==='tab'){ u.perms.tabs[el.dataset.tab]=el.checked; } if(el.dataset.k==='act'){ u.perms.actions[el.dataset.act]=el.checked; } if(el.dataset.k==='profit'){ u.perms.profit=el.checked; } if(el.dataset.k==='settings'){ u.perms.settings=el.checked; } saveDB(); try{renderAlertBell();}catch(e){}; if(u.username===session.username) render(); });
    wrap.addEventListener('click',(ev)=>{ const b=ev.target.closest('button'); if(!b) return; const u=(db.users||[]).find(x=>x.id===b.dataset.id);
      if(b.dataset.act==='chpass'){ const p1=prompt("New password for '"+u.username+"':"); if(p1===null) return; if(!p1.trim()) return alert('Password cannot be empty'); const p2=prompt('Confirm new password:'); if(p2===null) return; if(p1!==p2) return alert('Passwords do not match'); u.password=p1; saveDB(); try{renderAlertBell();}catch(e){}; addAudit('update','userPass',u.id,'Admin changed for '+u.username); alert('Password updated for '+u.username); return; }
      if(b.dataset.act==='reset'){ u.password='1234'; saveDB(); try{renderAlertBell();}catch(e){}; addAudit('update','user',u.id,u.username+' reset'); alert("Password reset to '1234'"); return; }
      if(b.dataset.act==='del'){ if(u.username==='admin') return alert('Cannot delete admin'); db.users=db.users.filter(x=>x.id!==u.id); saveDB(); try{renderAlertBell();}catch(e){}; addAudit('delete','user',u.id,u.username); renderTable(); return; } });
    wrap.querySelector('#u_add').onclick=()=>{ const name=wrap.querySelector('#u_name').value.trim(); if(!name) return alert('Username required'); const u={id:uid(),username:name,password:(wrap.querySelector('#u_pass').value||'1234'),role:wrap.querySelector('#u_role').value,perms:defaultPerms()}; (db.users=db.users||[]).push(u); saveDB(); try{renderAlertBell();}catch(e){}; addAudit('add','user',u.id,u.username); renderTable(); };
  }
  renderTable(); return wrap;
}

/* ========= Settings ========= */
function viewSettings(){ 
  // Check if user has permission to access settings at all
  if(!canTab('Settings') || !canSettings()){ 
    const w=document.createElement('div'); 
    w.className='card'; 
    w.innerHTML='<div class="small">No permission to edit settings. Ask admin.</div>'; 
    return w; 
  } 
  
  const wrap=document.createElement('div'); 
  wrap.className='card'; 
  const tokenCurrent=getGhToken();
  const currentUserObj = currentUser();
  const isAdmin = currentUserObj && currentUserObj.role === 'admin';
  
  // Format last push timestamp for display
  let lastPushInfo = '';
  if (db.lastPush && db.lastPush.timestamp) {
    const pushDate = new Date(db.lastPush.timestamp);
    const formattedDate = pushDate.toLocaleDateString('en-GB', {
        day: '2-digit',
        month: '2-digit',
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit'
    });
    lastPushInfo = `<div class="small" style="margin-top: 8px; padding: 8px; background: rgba(19, 26, 43, 0.7); border-radius: 8px;">
        <strong>Last Push to Gist:</strong><br>
        üìÖ ${formattedDate}<br>
        üë§ By: ${db.lastPush.user || 'unknown'}<br>
        üîó Gist ID: ${db.lastPush.gistId || 'not specified'}
    </div>`;
  } else {
    lastPushInfo = `<div class="small" style="margin-top: 8px; padding: 8px; background: rgba(19, 26, 43, 0.7); border-radius: 8px;">
        <em>No push history recorded yet.</em>
    </div>`;
  }

  wrap.innerHTML=`<h2>Settings</h2><div class="grid2">
  <div class="card" ${!isAdmin ? 'style="display:none"' : ''}><h3>Company</h3>
    <div class="row"><input id="c_name" placeholder="Company name" value="${db.company.name||''}"></div>
    <div class="row"><input id="c_addr" placeholder="Address" value="${db.company.address||''}" style="min-width:420px"></div>
    <div class="row"><input id="c_phone" placeholder="Phone" value="${db.company.phone||''}"><input id="c_email" placeholder="Email" value="${db.company.email||''}"></div>
    <div class="row"><input id="c_vat" placeholder="VAT Number" value="${db.company.vatNumber||''}"><input id="c_co" placeholder="Company Number" value="${db.company.companyNumber||''}"><input id="c_fca" placeholder="FCA Number" value="${db.company.fcaNumber||''}"></div>
    <div class="row"><input id="c_logo" placeholder="Logo URL (optional)" value="${db.company.logo||''}"></div>
    <div class="row"><label>Upload Logo<input id="c_logoUpload" type="file" accept="image/*"></label><span class="small">Stored locally as data-URL</span></div>
    <div class="row"><label class="small">Opening Bank ¬£ <input id="c_bank" type="number" value="${db.company.openingBank||0}"></label><label class="small">Opening Cash ¬£ <input id="c_cash" type="number" value="${db.company.openingCash||0}"></label></div>
    <div class="row"><textarea id="c_terms" placeholder="Terms & Conditions">${db.company.terms||''}</textarea></div>
    <div class="row"><textarea id="c_finTerms" placeholder="Finance-specific Terms (optional) ‚Äî used on the Finance Proforma only if filled.">${db.company.financeTerms||''}</textarea></div>
    <div class="row">
      <label class="small">Invoice Font Size px <input id="c_invFont" type="number" min="9" max="18" value="${db.company.invoiceFontPx||12}"></label>
      <label class="small">Terms Font Size px <input id="c_termsFont" type="number" min="8" max="14" value="${db.company.termsFontPx||10}"></label>
      <label class="small">Logo Max-W px <input id="c_logoW" type="number" min="80" max="300" value="${db.company.logoMaxW||140}"></label>
      <label class="small">Logo Max-H px <input id="c_logoH" type="number" min="50" max="200" value="${db.company.logoMaxH||80}"></label>
    </div>
    <button id="c_save" class="primary">Save</button>
  </div>
  <div class="card"><h3>Integrations</h3>
    <div class="row"><input id="c_dvlaProxy" placeholder="DVLA Proxy URL" value="${db.company.dvlaProxy||''}" style="min-width:420px"></div>
    <div class="row"><input id="c_dvlaKey" placeholder="DVLA API Key (optional)" value="${db.company.dvlaKey||''}"></div>
    <div class="row"><input id="c_dvsaProxy" placeholder="DVSA Proxy URL" value="${db.company.dvsaProxy||''}" style="min-width:420px"></div>
    <div class="row"><input id="c_dvsaKey" placeholder="DVSA API Key (optional)" value="${db.company.dvsaKey||''}"></div>
    <div class="row"><input id="c_testReg" placeholder="Test REG (e.g. KR21UYL)" style="min-width:220px"><button id="c_dvlaTest">DVLA Test</button></div><hr style="width:100%;border:0;border-top:1px solid var(--line)">
    <div class="row"><input id="c_gistId" placeholder="GitHub Gist ID (where starcars.json lives)" value="${db.company.gistId||''}" style="min-width:420px"></div>
    <div class="row"><input id="c_ghToken" placeholder="GitHub Token (gist scope)" value="${tokenCurrent||''}" type="password" style="min-width:420px"></div>
    <div class="row"><button id="c_isave" class="primary">Save Integrations</button><button id="c_pull">Pull (Gist ‚Üí App)</button><button id="syncPullHard">Pull (REPLACE ALL from Gist)</button><button id="c_push" ${pushEnabled ? '' : 'disabled'}>Push (App ‚Üí Gist)</button></div>
    ${lastPushInfo}
    <div class="small">Token is stored only in your browser (LocalStorage), not inside backups.</div>
  </div></div>`;

  // After wrap.innerHTML is set, add Auto Sync controls into the Integrations card
  const cards = wrap.querySelectorAll('.card');
  const integrationsCard = cards[1]; // 0 = Company, 1 = Integrations (in your layout)

  if (integrationsCard) {
    const row = document.createElement('div');
    row.className = 'row';
    row.innerHTML = `
      <label class="small">
        <input id="c_autoSync" type="checkbox" ${db.company.autoSyncEnabled ? 'checked' : ''}>
        Auto Sync (auto pull from Gist)
        &nbsp;every&nbsp;
        <input id="c_autoSyncSec" type="number" min="30" max="600"
               value="${db.company.autoSyncSeconds || 120}"
               style="width:80px">
        seconds
      </label>
    `;
    integrationsCard.appendChild(row);
  }
  
  // Only show save button for company settings if user is admin
  if (isAdmin) {
    wrap.querySelector('#c_save').onclick=()=>{
        db.company.name=document.getElementById('c_name').value;
        db.company.address=document.getElementById('c_addr').value;
        db.company.phone=document.getElementById('c_phone').value;
        db.company.email=document.getElementById('c_email').value;
        db.company.vatNumber=document.getElementById('c_vat').value;
        db.company.companyNumber=document.getElementById('c_co').value;
        db.company.fcaNumber = document.getElementById('c_fca').value;
        db.company.logo=document.getElementById('c_logo').value;
        db.company.openingBank=Number(document.getElementById('c_bank').value||0);
        db.company.openingCash=Number(document.getElementById('c_cash').value||0);
        db.company.terms=document.getElementById('c_terms').value;
        db.company.financeTerms=document.getElementById('c_finTerms').value;
        db.company.invoiceFontPx=Number(document.getElementById('c_invFont').value||12);
        db.company.termsFontPx=Number(document.getElementById('c_termsFont').value||10);
        db.company.logoMaxW=Number(document.getElementById('c_logoW').value||140);
        db.company.logoMaxH=Number(document.getElementById('c_logoH').value||80);
        db.company.dvlaProxy=document.getElementById('c_dvlaProxy').value||'';
        db.company.dvsaProxy=document.getElementById('c_dvsaProxy').value||'';
        db.company.dvlaKey=document.getElementById('c_dvlaKey').value||'';
        db.company.dvsaKey=document.getElementById('c_dvsaKey').value||'';
        
        saveDB();
        try{renderAlertBell();}catch(e){}
        addAudit('update','company','company','Updated company profile');
        refreshLogoBox();
        alert('Saved');
    };
    } else {
    // Hide company save button for non-admin users with settings permission
    const saveBtn = wrap.querySelector('#c_save');
    if (saveBtn) saveBtn.style.display = 'none';
  }
  
  // Integration settings are available for all users with settings permission
  wrap.querySelector('#c_isave').onclick=()=>{ 
    db.company.dvlaProxy = document.getElementById('c_dvlaProxy').value; 
    db.company.dvlaKey   = document.getElementById('c_dvlaKey').value;
    db.company.dvsaProxy = document.getElementById('c_dvsaProxy').value; 
    db.company.dvsaKey   = document.getElementById('c_dvsaKey').value; 
    db.company.gistId    = document.getElementById('c_gistId').value.trim(); 
    setGhToken(document.getElementById('c_ghToken').value.trim()); 

    // Read auto-sync controls if present
    const chk = document.getElementById('c_autoSync');
    const sec = document.getElementById('c_autoSyncSec');
    if (chk && sec) {
    db.company.autoSyncEnabled = chk.checked;
    db.company.autoSyncSeconds = Number(sec.value || 120);
  }

  saveDB(); 
  try { renderAlertBell(); } catch(e) {} 
  addAudit('update','integrations','integrations','Updated DVLA, Gist & Auto Sync'); 

  // Restart auto sync with new settings
  if (typeof startAutoSyncFromSettings === 'function') {
    startAutoSyncFromSettings();
  }

  alert('Saved integrations'); 
  };

  
  wrap.querySelector('#c_pull').onclick=()=>syncPull();
  wrap.querySelector('#c_push').onclick=()=>smartPush();

  const hardBtn = wrap.querySelector('#syncPullHard');
if (hardBtn) {
  hardBtn.onclick = () => {
    if (confirm('This will REPLACE ALL local data with the Gist version. Unsynced changes on this PC will be LOST. Are you sure?')) {
      syncPullHard();
    }
  };
}
  
  // Fixed DVLA Test function - available for all users with settings permission
  wrap.querySelector('#c_dvlaTest').onclick = async () => { 
    const url = (document.getElementById('c_dvlaProxy').value || '').trim(); 
    const key = (document.getElementById('c_dvlaKey').value || '').trim(); 
    const reg = (document.getElementById('c_testReg').value || '').trim().toUpperCase(); 
    
    if (!url) return alert('Enter Proxy URL');
    if (!reg) return alert('Enter a test REG');
    
    const btn = wrap.querySelector('#c_dvlaTest');
    const originalText = btn.textContent;
    btn.textContent = 'Testing...';
    btn.disabled = true;
    
    try { 
      const response = await fetch(url, {
        method: 'POST',
        headers: {'content-type': 'application/json'},
        body: JSON.stringify({reg: reg, apiKey: key})
      }); 
      
      const result = await response.text();
      
      if (!response.ok) {
        alert('DVLA Test Failed: ' + response.status + ' - ' + result);
      } else {
        try {
          const data = JSON.parse(result);
          alert('DVLA Test Successful!\n\nResponse: ' + JSON.stringify(data, null, 2).substring(0, 500));
        } catch (e) {
          alert('DVLA Test Successful!\n\nResponse: ' + result.substring(0, 500));
        }
      }
    } catch (e) { 
      alert('DVLA Test Failed: ' + e.message); 
    } finally {
      btn.textContent = originalText;
      btn.disabled = false;
    }
  };
  
  // Logo upload to data-URL - only for admin users
  if (isAdmin) {
    wrap.querySelector('#c_logoUpload').addEventListener('change', (e)=>{
      const f=e.target.files&&e.target.files[0]; if(!f) return;
      const r=new FileReader(); r.onload=()=>{ db.company.logo=r.result; document.getElementById('c_logo').value=r.result; saveDB(); try{renderAlertBell();}catch(e){}; addAudit('update','company','logo','Uploaded logo'); refreshLogoBox(); alert('Logo updated.'); };
      r.readAsDataURL(f);
    });
  } else {
    // Hide logo upload for non-admin users
    const logoUpload = wrap.querySelector('#c_logoUpload');
    if (logoUpload) {
      logoUpload.parentNode.parentNode.style.display = 'none';
    }
  }
  
  return wrap;
}

startAutoSyncFromSettings();
render();
</script>
</body>
</html>